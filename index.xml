<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Emmie' s Workspace</title><link>/</link><description>Recent content on Emmie' s Workspace</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 19 May 2024 00:00:00 +0000</lastBuildDate><atom:link href="/index.xml" rel="self" type="application/rss+xml"/><item><title>Validate Facebook Limited Login JWT Token in Golang</title><link>/posts/validate-facebook-limited-login-jwt-token/</link><pubDate>Sun, 19 May 2024 00:00:00 +0000</pubDate><guid>/posts/validate-facebook-limited-login-jwt-token/</guid><description>
&lt;h2 id="å‰æ">
&lt;a href="#%e5%89%8d%e6%8f%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰æ
&lt;/h2>
&lt;p>Facebook ios sdk åœ¨ 17.0.0 ç‰ˆæœ¬å¾Œï¼Œè¦æ±‚å¿…é ˆå¯¦ä½œ Limited Loginï¼Œä¸¦ä½¿ç”¨ JWT token é€²è¡Œé©—è­‰ï¼Œå¦å‰‡åœ¨æŸäº›æƒ…æ³ä¸‹æœƒæœ‰éé æœŸéŒ¯èª¤(&lt;a href="https://github.com/facebook/facebook-ios-sdk/issues/2365">ref&lt;/a>)ã€‚&lt;/p>
&lt;p>æµç¨‹ç‚ºï¼š&lt;/p>
&lt;p>client ç«¯ï¼ˆios Appï¼‰ æœƒå°‡ä»¥ä¸‹è³‡è¨Šï¼š&lt;/p>
&lt;ul>
&lt;li>ç™»å…¥å˜—è©¦è¦æ±‚çš„æ¬Šé™&lt;/li>
&lt;li>è¿½è¹¤åå¥½è¨­å®š&lt;/li>
&lt;li>nonceï¼ˆéš¨æ©Ÿç”Ÿç”¢çš„äº‚æ•¸ï¼Œæ¯æ¬¡è«‹æ±‚éƒ½é ˆä¸åŒï¼Œç”¨ä¾†åšå¾ŒçºŒçš„é©—è­‰ï¼‰&lt;/li>
&lt;/ul>
&lt;p>å¸¶å…¥è«‹æ±‚ï¼Œå‘ FB å–å¾—ç”¨æˆ¶è³‡æ–™èˆ‡ä¸€çµ„ JWT tokenã€‚ï¼ˆå¯¦ä½œç¯„ä¾‹å¯åƒè€ƒ&lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/ios">å®˜æ–¹æ–‡ä»¶&lt;/a>ï¼‰&lt;/p>
&lt;p>æ¥è‘— client æœƒå°‡ token å‚³çµ¦æˆ‘å€‘çš„å¾Œç«¯ serverï¼Œå¾Œç«¯éœ€è¦é©—è­‰ token æ˜¯å¦åˆæ³•ã€‚&lt;/p>
&lt;p>é‡é»å°±åœ¨æ–¼å¾Œç«¯é©—è­‰ token é€™æ®µï¼Œ&lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/validating">å®˜æ–¹æ–‡ä»¶&lt;/a>éå¸¸ç°¡æ˜æ¦‚è¦ï¼Œä¸¦æ²’æœ‰é™„ä¸Šå¯¦ä½œç¯„ä¾‹ã€‚æ‰€ä»¥ç‰¹æ­¤ç´€éŒ„ä¸€ä¸‹&lt;del>è¸©å‘éç¨‹&lt;/del>ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•é©—è­‰-jwt-token">
&lt;a href="#%e5%a6%82%e4%bd%95%e9%a9%97%e8%ad%89-jwt-token" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¦‚ä½•é©—è­‰ JWT Token
&lt;/h2>
&lt;p>é¦–å…ˆï¼Œ&lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/validating">æ–‡ä»¶&lt;/a>è¦æˆ‘å€‘ç¢ºèªä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š&lt;/p>
&lt;h5 id="1-that-the-jwt-is-well-formedhttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingjwt-well-formed">
&lt;a href="#1-that-the-jwt-is-well-formedhttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingjwt-well-formed" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
1. &lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/validating#jwt-well-formed">That the JWT is well formed&lt;/a>
&lt;/h5>
&lt;p>token é ˆç‚ºåˆæ³•çš„ JWT tokenã€‚ä¹Ÿå°±æ˜¯åŒ…å«ä¸€çµ„ç”¨ Base64Url-encoded çš„ header, payload, signatureï¼Œæ¯å€‹éƒ¨åˆ†è§£ç¢¼å¾Œéƒ½å¿…é ˆç‚ºåˆæ³•çš„ json æ ¼å¼ã€‚&lt;/p>
&lt;h5 id="2-the-signaturehttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingsignature">
&lt;a href="#2-the-signaturehttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingsignature" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
2. &lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/validating#signature">The signature&lt;/a>
&lt;/h5>
&lt;p>è§£ç¢¼å¾Œçš„ signature éƒ¨åˆ†éœ€è¦å’Œä»¥ä¸‹æ­¥é©Ÿç”¢ç”Ÿçš„çµæœç›¸åŒï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>è—‰ç”±å‘¼å« &lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/#jwks">JWKS endpoint&lt;/a> å–å¾—ä¸€çµ„ public key&lt;/p>
&lt;blockquote>
&lt;p>æ‰“ &lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/#jwks">JWKS endpoint&lt;/a> æœƒå¾—åˆ°ä¸€å€‹ json ç‰©ä»¶ï¼Œå›å‚³å¤šçµ„ pub keyï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;keys&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;kid&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;d458ab5237807dc6718901e522cebcd8e8157791&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;kty&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;RSA&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;alg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;RS256&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;use&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sig&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;n&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;uPyWMhNfNsO9EtiraYI0tr78vnkiJmzsmAAUd8hLHF5vPXDn683aQKZQ2Ny5lObigNmbHI5tt5y0o5m0RuZjJTj081uWm7Z901boO-p4VLwEONzjh4vTp2ZQ7aMjo17kMBzInHqz9iruWeB94dEu_LKYdQnDI6rweD_-chWWTR4mc7xbeaNozLHYzjEisSrIM3xIry2lZv5Mh334ZoahcTXGouFtU2XV_HvStXthwhoAtizQK7s2yJlBz8qlQK2lFNojRzd95f2bkynRnIvcpoF-qHZbOBTCIf-6TLp23qShs-XvbCkwHMhzvCPxcuZx3GNfCQkyTxeM5IGIMlWZ8w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;e&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;AQAB&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œè¦ä½¿ç”¨å“ªä¸€çµ„ keyï¼Œéœ€è¦ç”¨è§£ç¢¼çš„ header ç•¶ä¸­æ‰€å¸¶çš„ä¸€å€‹å±¬æ€§ &lt;code>kid&lt;/code> å»æ¯”å°ï¼Œæ‰¾å‡ºç›¸åŒ &lt;code>kid&lt;/code> çš„é‚£æŠŠ keyã€‚&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨è§£ç¢¼å¾Œçš„ header ç•¶ä¸­æŒ‡å®šçš„æ¼”ç®—æ³•(æ¬„ä½ï¼š &lt;code>alg&lt;/code>)ä»¥åŠä¸Šè¿°çš„ public key å° Base64Url-encoded çš„ header è·Ÿ payload é€£æ¥çš„å€¼(&lt;code>Base64url-encoded header + &amp;quot;.&amp;quot; + Base64url-encoded payload&lt;/code>) åŠ å¯†è™•ç†å¾Œçš„çµæœé€²è¡Œ Base64url-encodeã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h5 id="3-the-standard-claimshttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingstandard-claims">
&lt;a href="#3-the-standard-claimshttpsdevelopersfacebookcomdocsfacebook-loginlimited-logintokenvalidatingstandard-claims" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
3. &lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/validating#standard-claims">The standard claims&lt;/a>
&lt;/h5>
&lt;p>æª¢æŸ¥è§£ç¢¼å¾Œçš„ payload å¹¾å€‹å±¬æ€§å€¼æ˜¯å¦ç¬¦åˆé æœŸï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æª¢æŸ¥ token æœ‰ç„¡éæœŸï¼ˆæ¬„ä½ï¼š &lt;code>exp&lt;/code>ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Token issuer æ˜¯å¦æ­£ç¢ºï¼ˆæ¬„ä½ï¼š &lt;code>iss&lt;/code> ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>æ–‡ä»¶ä¸Šæ²’æœ‰èªªæ˜ issuer çš„å€¼ç‚ºä½•ï¼ˆç…§ç†ä¾†èªªæœƒæ˜¯ Facebook çš„æŸå€‹ç¶²åŸŸæˆ–ç«¯é»ï¼‰ï¼Œå¾Œä¾†æ˜¯åœ¨æŸç¯‡è¨è«–ä¸²ç•¶ä¸­æ‰¾åˆ°ï¼Œåœ¨&lt;a href="https://developers.facebook.com/docs/facebook-login/limited-login/token/">é™åˆ¶ç™»å…¥çš„ OIDC æ¬Šæ–&lt;/a>çš„ &lt;strong>OIDC ç«¯é» &amp;gt; &lt;a href="https://limited.facebook.com/.well-known/openid-configuration/">æ¢ç´¢ç«¯é»&lt;/a>&lt;/strong> è£¡é¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;issuer&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://www.facebook.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>Audience æ˜¯å¦èˆ‡ FB App ID ç›¸åŒ ï¼ˆæ¬„ä½ï¼š &lt;code>aud&lt;/code> ï¼‰&lt;/p>
&lt;p>App ID å¯ä»¥åˆ° Facebook developer å¾Œå°æŸ¥çœ‹&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Nonce æ˜¯å¦æ­£ç¢ºï¼ˆæ¬„ä½ï¼š &lt;code>nonce&lt;/code> ï¼‰&lt;/p>
&lt;p>å°±æ˜¯ä¸Šé¢å‰ç«¯å‚³çµ¦ FB ç”¢ token æ™‚å¸¶çš„äº‚æ•¸ï¼Œå‰ç«¯åœ¨ç™¼ request çµ¦å¾Œç«¯æ™‚éœ€ä¸€ä½µæ”œå¸¶éä¾†ã€‚ï¼ˆå¾Œç«¯æ‰èƒ½é©—è­‰ payload ç•¶ä¸­çš„ nonce æ˜¯å¦èˆ‡ä¹‹ç›¸åŒï¼‰&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="å¯¦ä½œ">
&lt;a href="#%e5%af%a6%e4%bd%9c" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¯¦ä½œ
&lt;/h2>
&lt;p>ä»¥ä¸Šè§£æ JWT token èˆ‡é©—è­‰ signature çš„éƒ¨åˆ†éƒ½æœ‰ç¾æˆçš„ JWT å¥—ä»¶å¯ä»¥æ›¿æˆ‘å€‘å®Œæˆï¼Œåœ¨é€™é‚Šä½¿ç”¨ golang æ­é…ä»¥ä¸‹å…©å€‹å¥—ä»¶ä¾†å¯¦ä½œï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://pkg.go.dev/github.com/golang-jwt/jwt/v5">golang-jwt/jwt/v5&lt;/a>ï¼šè§£æ JWT token èˆ‡é©—è­‰ signature&lt;/li>
&lt;li>&lt;a href="https://github.com/lestrrat-go/jwx">lestrrat-go/jwx/jwk&lt;/a>ï¼šè§£æ JWKS public key&lt;/li>
&lt;/ul>
&lt;p>é¦–å…ˆå®šç¾© structs æ¥æ”¶éœ€è¦çš„è³‡æ–™ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Auth&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">JWTToken&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Nonce&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">APIHost&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">AppID&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">JWKSEndpoint&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æª¢æŸ¥ token æœ‰ç„¡éæœŸã€é©—è­‰ issuer èˆ‡ audience éƒ½æ˜¯å±¬æ–¼ JWT è¦ç¯„ä¸­å®šç¾©çš„ä¸€äº›å¸¸è¦‹è²æ˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¯ä»¥ä½¿ç”¨ jwt.RegisteredClaims å³å¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä½†å› ç‚ºæˆ‘å€‘æœ‰æ”œå¸¶ `Nonce`ï¼Œç‚º FB è‡ªå®šç¾©çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¨‚ Claim
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">ClientClaims&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisteredClaims&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Nonce&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;nonce&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewFBAuth&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">jwtToken&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">nonce&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Auth&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Auth&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">JWTToken&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">jwtToken&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Nonce&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nonce&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//å±¬æ–¼æ•æ„Ÿè³‡è¨Šï¼Œä»¥ env config å½¢å¼å–å¾—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">APIHost&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FacebookAuth&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIHost&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// é æœŸçš„ issuer å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">AppID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FacebookAuth&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AppID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// é æœŸçš„ audience å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">JWKSEndpoint&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FacebookAuth&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">JWKSEndpoint&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Timeout&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—å¯¦ä½œé©—è­‰æ–¹æ³•çš„éƒ¨åˆ†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Auth&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ValidateJWTToken&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">set&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">fetchPublicKeySet&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// å–å¾— JWKS Public key
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">token&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewParser&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="c1">// ä½¿ç”¨å¥—ä»¶å…§å»ºçš„ validator é©—è­‰æ¨™æº–è²æ˜çš„æ¬„ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithExpirationRequired&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="c1">// æª¢æŸ¥ token æœ‰ç„¡éæœŸ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithIssuer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIHost&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">// Token issuer æ˜¯å¦æ­£ç¢ºï¼ˆç­‰æ–¼ a.APIHostï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithAudience&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AppID&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">// Audience æ˜¯å¦æ­£ç¢ºï¼ˆç­‰æ–¼ a.AppIDï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">).&lt;/span>&lt;span class="nf">ParseWithClaims&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">JWTToken&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ClientClaims&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">token&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">jwt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Token&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å–å¾— header çš„ kid å€¼ï¼Œç”¨ä¾†å°‹æ‰¾ JWKS ç«¯é»å›å‚³ json ç•¶ä¸­åŒ¹é…çš„ pub key
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">keyID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">token&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;kid&amp;#34;&lt;/span>&lt;span class="p">].(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;expecting JWT header to have string kid&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">keys&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">set&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">LookupKeyID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keyID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;can not find kid&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">keys&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nf">Raw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">claims&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">token&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Claims&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">ClientClaims&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç”±æ–¼ Nonce ç‚ºè‡ªå®šç¾©çš„è²æ˜å±¬æ€§ï¼Œéœ€è¦é¡å¤–æ‰‹å‹•é©—è­‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">claims&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nonce&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nonce&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;nonce mismatch: %s != %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">claims&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nonce&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nonce&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;expecting *ClientClaims, got %T&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">token&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Claims&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Auth&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">fetchPublicKeySet&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">jwk&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">JWKSEndpoint&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">respBody&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">resp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">jwk&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">respBody&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é©—è­‰æˆåŠŸå³å¯å‘å‰ç«¯å›å‚³ä½¿ç”¨è€…ç™»å…¥æˆåŠŸã€‚&lt;/p>
&lt;h2 id="ç¢ç¢å¿µ">
&lt;a href="#%e7%a2%8e%e7%a2%8e%e5%bf%b5" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ç¢ç¢å¿µ
&lt;/h2>
&lt;p>çŒœæ¸¬æ˜¯å› ç‚ºå¾Œç«¯èªè¨€å¤ªå¤šï¼Œå„èªè¨€ä¹Ÿéƒ½æœ‰è‡ªå·±çš„ jwt å¥—ä»¶ï¼Œæ‰€ä»¥å®˜æ–¹æ‰æ²’æœ‰æ”¾é©—è­‰ Token çš„å¯¦ä½œç¯„ä¾‹ï¼Œä½†åƒä¸Šé¢æåˆ°çš„ kidã€issuer æ‡‰è©²å¯ä»¥èªªæ˜æ›´æ¸…æ¥šä¸€é»ã€‚ä¸éä¹Ÿç®—æ˜¯è—‰æ©Ÿå­¸ç¿’äº†ï¼Œ&lt;del>æ„Ÿè¬ Facebookã€‚ï¼ˆï¼Ÿï¼‰&lt;/del>&lt;/p></description></item><item><title>åŸ¹é¤Šè»Ÿé«”æ¶æ§‹æ€ç¶­ï¼Œæ‹’çµ•éåº¦è¨­è¨ˆâ€”â€”è»Ÿé«”è¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…å¿ƒå¾—</title><link>/posts/design-pattern-by-waterballsa-learning-experience/</link><pubDate>Wed, 16 Aug 2023 23:56:54 +0800</pubDate><guid>/posts/design-pattern-by-waterballsa-learning-experience/</guid><description>
&lt;h2 id="å‰è¨€">
&lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰è¨€
&lt;/h2>
&lt;p>å¾å»å¹´å…«æœˆå·¦å³é–‹å§‹åƒåŠ ä¸€å ‚æ°´çƒè»Ÿé«”å­¸é™¢æ‰€é–‹è¨­çš„ã€Œ&lt;a href="https://waterballsa.tw/design-pattern">ç²¾é€šè»Ÿé«”è¨­è¨ˆæ¨¡å¼ä¹‹æ—…&lt;/a>ã€ç·šä¸Šèª²ç¨‹ï¼Œè‡³ä»Šä¹Ÿç®—æ˜¯å®Œæˆäº†ä¸€å€‹é‡Œç¨‹ç¢‘ï¼Œæƒ³èªªæ˜¯æ™‚å€™å¯ä»¥ä¾†åˆ†äº«ä¸€ä¸‹å¾åƒåŠ æ—…ç¨‹è‡³ä»Šçš„é»é»æ»´æ»´ï¼Œå¾åƒåŠ å‹•æ©Ÿã€èª²ç¨‹é«”é©—åˆ°å­¸ç¿’å¿ƒå¾—ï¼Œç®—æ˜¯ç‚ºè‡ªå·±é€™æ®µå­¸ç¿’åšä¸€å€‹å›é¡§æ€§çš„ç´€éŒ„ã€‚&lt;/p>
&lt;h2 id="åƒåŠ å‹•æ©Ÿèˆ‡èª²ç¨‹é«”é©—">
&lt;a href="#%e5%8f%83%e5%8a%a0%e5%8b%95%e6%a9%9f%e8%88%87%e8%aa%b2%e7%a8%8b%e9%ab%94%e9%a9%97" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åƒåŠ å‹•æ©Ÿèˆ‡èª²ç¨‹é«”é©—
&lt;/h2>
&lt;p>å¤§æ¦‚åœ¨ä¸€å¹´å¤šå‰å¾ç¶²è·¯ç¤¾ç¾¤ä¸Šé¢å¾—çŸ¥æœ‰é€™æ¨£ä¸€å€‹èª²ç¨‹æº–å‚™å±•é–‹ï¼Œä½†é‚£æ™‚å€™é‚„åªæœ‰æ¨å‡ºã€Œå…è²»è©¦åƒã€èª²ç¨‹ï¼Œå¡«å¯«è¡¨å–®å°±å¯ä»¥æ’éšŠæŠ½ç±¤ï¼ŒæŠ½ä¸­çš„æ‰æœ‰åƒåŠ è©¦åƒèª²ç¨‹çš„è³‡æ ¼ã€‚çµæœä¸€ç›´æ²’è¢«æŠ½ä¸­ï¼Œå¾Œä¾†çµ‚æ–¼ç­‰åˆ°äº†ç¬¬ä¸€æ¢¯æ¬¡æ­£å¼æ”¶è²»çš„èª²ç¨‹é–‹è·‘å°±ç›´æ¥å ±åäº†ã€‚æ‰€ä»¥ç•¶åˆåˆ°åº•æ˜¯ä»€éº¼å¸å¼•äº†æˆ‘ï¼Œè®“æˆ‘é€™éº¼æƒ³å ±åé€™å€‹èª²ç¨‹å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="è¡è‘—è€å¸«å’ŒæŒ‘æˆ°é¡Œè€Œä¾†">
&lt;a href="#%e8%a1%9d%e8%91%97%e8%80%81%e5%b8%ab%e5%92%8c%e6%8c%91%e6%88%b0%e9%a1%8c%e8%80%8c%e4%be%86" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è¡è‘—è€å¸«å’ŒæŒ‘æˆ°é¡Œè€Œä¾†
&lt;/h3>
&lt;p>å…¶å¯¦åœ¨æ¥è§¸èª²ç¨‹ä¹‹å‰ï¼Œå°±æ›¾ç¶“åœ¨èª²ç¨‹è€å¸«æ°´çƒæ½˜çš„ YouTube é »é“çœ‹éä»–è¬›è§£çš„&lt;a href="https://www.youtube.com/watch?v=CG4FUo3Oh7E&amp;amp;list=PLicQRHHL75d7EXEI9nWfUYJyrPdI79M70&amp;amp;index=6&amp;amp;ab_channel=%E6%B0%B4%E7%90%83%E6%BD%98%E7%9A%84%E8%BB%9F%E9%AB%94%E5%B7%A5%E7%A8%8B%E9%9B%9E%E6%B9%AF">è¨­è¨ˆæ¨¡å¼ä¹‹è·¯ç³»åˆ—å½±ç‰‡&lt;/a>ï¼Œ ç•¶æ™‚ç¬¬ä¸€æ¬¡è¦ºå¾—å±…ç„¶æœ‰äººæœ‰è¾¦æ³•æŠŠè¨­è¨ˆæ¨¡å¼çš„æ¦‚å¿µè¬›è§£å¾—é€™éº¼æœ‰è¶£ï¼Œè®“äººæœƒæƒ³è¦åƒçœ‹åŠ‡ä¸€æ¨£ç¹¼çºŒè¿½ä¸‹å»ã€‚ä¸éå› ç‚ºè©²ç³»åˆ—å½±ç‰‡ä¼¼ä¹å› ç‚ºæ°´çƒæœ¬äººçš„èª²æ¥­å› ç´ æ‰€ä»¥å¾Œä¾†åœæ›´äº†ï¼Œè¦ºå¾—å¯æƒœä¹‹å¤–ï¼Œä¹Ÿåªèƒ½æœŸå¾…å“ªå¤©ä»–æœƒçªç„¶é–‹å§‹æ›´æ–°ã€‚çµæœå¾Œä¾†åœ¨ç¤¾ç¾¤çœ‹åˆ°ä»–æœ¬äººç™¼æ–‡æ¨å‡ºæ–°èª²ç¨‹æ™‚ï¼ŒçœŸçš„æ˜¯å°±åƒæ˜¯è¿½è¨±ä¹…çš„ YT æ²ˆå¯‚ä¸€é™£å­å¾Œçªç„¶å¾©å‡ºä¸€æ¨£çš„é©šå–œï¼&lt;/p>
&lt;p>æ­¤å¤–ï¼Œèª²ç¨‹ä¸­é™¤äº†æ•™å­¸å½±ç‰‡ï¼Œé‚„åŒ…å«è¨±å¤šå¯¦æˆ°é¡Œä½œæ¥­ã€‚å°æˆ‘ä¾†èªªï¼Œé€™ä¸€é»çœŸçš„æ˜¯ä¸€å€‹å¾ˆå¤§çš„å¸å¼•åŠ›ã€‚åœ¨è‡ªå·²éå»çš„è»Ÿé«”é–‹ç™¼ç¶“æ­·ä¸­ï¼Œå¾ˆå¤šæ™‚å€™å¹¾ä¹æ˜¯é€éå‹•æ‰‹å¯¦ä½œæ‰çœŸæ­£ç†è§£ä¸€å€‹æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘èªç‚ºå¯¦ä½œåœ¨å­¸ç¿’è»Ÿé«”é–‹ç™¼ç›¸é—œæŠ€èƒ½æ™‚æ˜¯å¾ˆé‡è¦çš„ä¸€ç’°ã€‚
åŒæ™‚ï¼Œç”±æ–¼ä»¥å¾€å°è¨­è¨ˆæ¨¡å¼çš„ç†è§£å¯ä»¥èªªåƒ…æ­¢æ–¼çŸ¥é“å¹¾å€‹åè©ï¼Œé›–ç„¶æ›¾çœ‹éç›¸é—œæ›¸ç±ï¼Œä½†å› ç‚ºå¹³å¸¸ä¹Ÿæ²’æœ‰ä»€éº¼æ‡‰ç”¨å ´æ™¯æˆ–å¯¦ä½œçš„æ©Ÿæœƒï¼Œè¦ºå¾—æ˜¯æ™‚å€™è©²æŠŠé€™å¡Šè£œèµ·ä¾†ã€‚&lt;/p>
&lt;h3 id="æ—…ç¨‹ä¸­ä¸éŒ¯çš„æœå‹™">
&lt;a href="#%e6%97%85%e7%a8%8b%e4%b8%ad%e4%b8%8d%e9%8c%af%e7%9a%84%e6%9c%8d%e5%8b%99" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
æ—…ç¨‹ä¸­ä¸éŒ¯çš„æœå‹™
&lt;/h3>
&lt;p>å¦å¤–é‚„æœ‰ä¸€äº›æ—…ç¨‹æ‰€æä¾›çš„æœå‹™ï¼Œæ˜¯æˆ‘åœ¨æ—…ç¨‹ç•¶ä¸­é€æ¼¸é«”æœƒåˆ°ä¹Ÿå¾ˆé‡è¦çš„éƒ¨åˆ†ï¼š&lt;/p>
&lt;h5 id="å”åŠ©æª¢é©—å­¸ç¿’æˆæœ">
&lt;a href="#%e5%8d%94%e5%8a%a9%e6%aa%a2%e9%a9%97%e5%ad%b8%e7%bf%92%e6%88%90%e6%9e%9c" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å”åŠ©æª¢é©—å­¸ç¿’æˆæœ
&lt;/h5>
&lt;p>è¼¸å‡ºçš„çµæœï¼Œå¾€å¾€ä¹Ÿéœ€è¦ç¶“éæª¢é©—ï¼Œæ‰èƒ½ç¢ºä¿æœ‰å¸æ”¶åˆ°æ­£ç¢ºçš„çŸ¥è­˜ã€‚èª²ç¨‹ç•¶ä¸­æœƒå®‰æ’æ¯é€±å›ºå®šæ™‚é–“çš„ã€ŒTA Hourã€ä¾†é‡å°ä½œæ¥­é€²è¡Œ Code Reviewï¼Œé™¤äº†æª¢è¨ä½œæ¥­ä¹‹å¤–ï¼Œè‹¥éç¨‹ä¸­æœ‰é‡åˆ°ä»€éº¼å•é¡Œæˆ–å›°é›£ï¼Œéƒ½èƒ½å¤ åœ¨ TA Hour ä¸­æå‡ºï¼Œä¸¦å¾—åˆ°ç«‹å³çš„åé¥‹ã€‚&lt;/p>
&lt;h5 id="æ´»èºçš„å­¸ç¿’ç¤¾ç¾¤">
&lt;a href="#%e6%b4%bb%e8%ba%8d%e7%9a%84%e5%ad%b8%e7%bf%92%e7%a4%be%e7%be%a4" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
æ´»èºçš„å­¸ç¿’ç¤¾ç¾¤
&lt;/h5>
&lt;p>ä»¥å¾€åƒåŠ éæŸäº›ç·šä¸Šèª²ç¨‹ï¼Œæœ‰çš„ä¹Ÿæ˜¯æœƒä¸»æ‰“å¡‘é€ å­¸ç¿’ç¤¾ç¾¤ï¼Œä½†å¯èƒ½å‰›å¥½æˆ‘åƒåŠ éçš„èª²ç¨‹åœ¨é€™éƒ¨åˆ†éƒ½è·Ÿæƒ³åƒä¸­æœ‰å·®è·ï¼Œå­¸å“¡ä¹‹é–“å¯¦éš›ä¸Šä¸¦ä¸æœƒæœ‰å¤ªå¤šäº’å‹•ï¼Œå› æ­¤ä¸€é–‹å§‹å°æ–¼é€™éƒ¨åˆ†æ²’æœ‰æŠ±å¤ªå¤§æœŸå¾…ã€‚åˆæœŸä¹ŸçœŸçš„å¹¾ä¹æ˜¯å–®æ‰“ç¨é¬¥ï¼Œé ‚å¤šæœ‰æ™‚å€™æœ‰å•é¡Œåœ¨ç¾¤çµ„ç™¼å•ï¼Œæœ‰æ»¿å¤šç†±å¿ƒå¤§å¤§æœƒå›æ‡‰ï¼Œä½†æ­¤æ™‚çš„äº’å‹•æ€§ä¹Ÿä¸é«˜ï¼ˆå°æ–¼ä¸€å€‹å®³ç¾å…§å‘çš„äººï¼ˆæœƒè¢«æ‰“ã„‡ï¼Œæ‡‰è©²ä¸æœƒå§é€™æ˜¯æˆ‘çš„éƒ¨è½æ ¼æ¬¸ï¼‰ä¾†èªªï¼Œä¸ç®—æ˜¯å€‹èƒ½å¾ˆè‡ªåœ¨çš„ç™¼è¨€çš„å ´æ‰€ï¼‰ã€‚ä½†å¾Œä¾†æ¨å‡ºäº†æ‰€è¬‚çš„ã€Œå…¬æœƒç³»çµ±ã€ï¼Œè®“å­¸å“¡ï¼ˆåœ¨æ—…ç¨‹ä¸­éƒ½ç¨±ç‚ºå†’éšªè€…ï¼‰èƒ½å¤ è‡ªç”±çµ„æˆå­¸ç¿’å°çµ„ï¼Œèƒ½å¤ å½¼æ­¤è¨è«–ä½œæ¥­æˆ–åˆ†äº«é€²åº¦ç­‰ç­‰ï¼Œæ–¼æ˜¯æˆ‘å°±é †å‹¢åŠ å…¥äº†å…¶ä¸­ä¸€å€‹å…¬æœƒï¼Œèªè­˜äº†å¥½å¹¾å€‹å²å®³çš„å¤¥ä¼´ï¼Œé€™æ‰çœŸçš„é«”æœƒåˆ°äº’ç›¸äº¤æµæˆé•·çš„æ„Ÿè¦ºï¼Œæœ‰äººä¸€èµ·å¯«ä½œæ¥­çœŸçš„æœƒæ¯”è¼ƒæœ‰å‹•åŠ›ï¼&lt;/p>
&lt;p>ä»¥ä¸Šé€™å…©é»æˆ‘å¾Œä¾†æƒ³æƒ³çœŸçš„ç®—æ˜¯æ»¿é‡è¦è®“æˆ‘å¯ä»¥æŒçºŒèª²ç¨‹çš„éƒ¨åˆ†ï¼Œå› ç‚ºä»¥å‰å…©é»ï¼ˆ&lt;em>1.è€å¸«æ•™å­¸å“è³ªé«˜&lt;/em> &lt;em>2.è±å¯Œçš„å¯¦ä½œç·´ç¿’&lt;/em>ï¼‰ä¾†èªªï¼Œæˆ‘å°±æ›¾ç¶“ä¸Šé Berkeley ä¸€å€‹å¾ˆæœ‰åçš„ç·šä¸Šå…¬é–‹èª²ç¨‹ &lt;a href="https://sp19.datastructur.es/">CS 61B&lt;/a>ï¼Œå…§å®¹æ˜¯çœŸçš„éå¸¸å„ªè³ªï¼Œä¹Ÿæœ‰é…åˆå¤§é‡çš„ç·´ç¿’é¡Œï¼Œä½†æˆ‘æœ€å¾Œé‚„æ˜¯æ²’èƒ½å®Œèª²ï¼ˆå¤§æ¦‚ä¸Šåˆ°ä¸€åŠè€Œå·²ğŸ¥²ï¼‰ã€‚&lt;/p>
&lt;p>ç•¶åˆæ²’æœ‰ç¹¼çºŒçš„ä¸»å› ç•¶ç„¶æ˜¯æˆ‘å°±æ‡¶å˜›ï¼Œä½†åˆ°äº†è»Ÿé«”è¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…ï¼Œå¤šäº†&lt;strong>æœ‰äººå”åŠ© Code Review æª¢é©—å­¸ç¿’æˆæœï¼‹æœ‰åŒå„•èƒ½äº’ç›¸äº¤æµè¨è«–&lt;/strong>ï¼Œå±…ç„¶å¯ä»¥è®“æˆ‘é€™ç¨®æœƒåŠé€”æ”¾æ£„çš„äººç¹¼çºŒä¸Šèª²å¯«ä½œæ¥­ï¼Œå¯è¦‹é€™å…©é»çœŸçš„æ˜¯éå¸¸æœ‰å¹«åŠ©çš„ï¼&lt;/p>
&lt;h2 id="å­¸ç¿’å¿ƒå¾—">
&lt;a href="#%e5%ad%b8%e7%bf%92%e5%bf%83%e5%be%97" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å­¸ç¿’å¿ƒå¾—
&lt;/h2>
&lt;h3 id="é‡æ–°èªè­˜ç‰©ä»¶å°å‘å¾-ooa-é–‹å§‹">
&lt;a href="#%e9%87%8d%e6%96%b0%e8%aa%8d%e8%ad%98%e7%89%a9%e4%bb%b6%e5%b0%8e%e5%90%91%e5%be%9e-ooa-%e9%96%8b%e5%a7%8b" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
é‡æ–°èªè­˜ç‰©ä»¶å°å‘ï¼Œå¾ OOA é–‹å§‹
&lt;/h3>
&lt;p>é€™é–€èª²é›–ç„¶ç¨±ä¹‹ç‚ºã€Œè¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…ã€ï¼Œä½†ä¸¦æ²’æœ‰åƒä¸€èˆ¬å¤§éƒ¨åˆ†æ›¸ç±æˆ–æ•™å­¸åŠˆé ­å°±æŠŠ GoF çš„ 23 å€‹è¨­è¨ˆæ¨¡å¼å…¨éƒ¨ä¸Ÿçµ¦æˆ‘å€‘ï¼Œåå€’æ˜¯å¾é‡æ–°èªè­˜ç‰©ä»¶å°å‘é–‹å§‹ï¼Œä»¥åŠé‡æ–°é‡æ¸…ã€Œç‰©ä»¶ã€å’Œã€Œé¡åˆ¥ã€çš„æ¦‚å¿µï¼Œé‚„æœ‰ã€Œé¡åˆ¥ã€ä¹‹é–“çš„é—œä¿‚ã€‚è€Œé€™ä¸€åˆ‡ï¼Œéƒ½æ˜¯ç‚ºäº†è¦å…ˆæ‰“å¥½åŸºæœ¬åŠŸï¼Œä¹Ÿå°±æ˜¯åœ¨åšè¨­è¨ˆä¹‹å‰çš„ç¬¬ä¸€æ­¥ï¼Œå…ˆå»ºç«‹å‡ºã€Œé ˜åŸŸæ¨¡å‹ã€ï¼Œå°‡ UML é¡åˆ¥åœ–ç•«å‡ºä¾†ï¼Œæ•æ‰å„å€‹ç‰©ä»¶/é¡åˆ¥çš„å±¬æ€§å’Œè¡Œç‚ºï¼Œä¸¦ä¸”æ¨™ç¤ºä»–å€‘ä¹‹é–“çš„é—œè¯ï¼Œè€Œé€™éšæ®µä¹Ÿç¨±ä¹‹ç‚º OOA(Object-Oriented Analysis)/ç‰©ä»¶å°å‘åˆ†æã€‚&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/ooa.png"
alt="é€²è¡Œ OOA ç¹ªè£½ UML é¡åˆ¥åœ–ï¼Œå°‡å„å€‹ç‰©ä»¶/é¡åˆ¥çš„å±¬æ€§å’Œè¡Œç‚ºå®šç¾©å‡ºä¾†ï¼Œä¸¦ä¸”æ¨™ç¤ºä»–å€‘ä¹‹é–“çš„é—œè¯"
width=1792
height="1034" />
&lt;small>â¬†ï¸é€²è¡Œ OOA ç¹ªè£½ UML é¡åˆ¥åœ–ï¼Œå°‡å„å€‹ç‰©ä»¶/é¡åˆ¥çš„å±¬æ€§å’Œè¡Œç‚ºå®šç¾©å‡ºä¾†ï¼Œä¸¦ä¸”æ¨™ç¤ºä»–å€‘ä¹‹é–“çš„é—œè¯&lt;/small>&lt;/p>
&lt;p>OOA æ˜¯æ•´é–€èª²ç•¶ä¸­æœ€åŸºç¤ä¹Ÿæœ€é‡è¦çš„ä¸€æ­¥ï¼Œå› ç‚ºç•¶æœ‰äº† OOA æˆ‘å€‘æ‰èƒ½é€²è¡Œæ¥ä¸‹ä¾†çš„è¨­è¨ˆï¼Œä¹Ÿå°±æ˜¯ OOD(Object-Oriented Design)/ç‰©ä»¶å°å‘è¨­è¨ˆï¼Œè€Œé€™æ™‚æ‰æ˜¯è¨­è¨ˆæ¨¡å¼ã€Œå¯èƒ½ã€æœƒå‡ºå ´çš„æ™‚å€™ã€‚ç‚ºä»€éº¼é€™é‚Šæœƒèªªã€Œå¯èƒ½ã€ï¼Ÿå› ç‚ºè¨­è¨ˆæ¨¡å¼ä¸¦ä¸æ˜¯ç”Ÿä¾†å°±è®“ä½ æƒ³å¥—å°±å¥—çš„ï¼Œç•¶ç„¶é€™æ¨£ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œåªæ˜¯é€šå¸¸é€™ç¨®æ¯«ç„¡ç†ç”±å¥—ç”¨è¨­è¨ˆæ¨¡å¼çš„è¡Œç‚ºï¼Œé€šå¸¸æœƒè¢«èªç‚ºæ˜¯ã€Œéåº¦è¨­è¨ˆ/Over Designã€çš„ï¼Œä¹Ÿæ˜¯èª²ç¨‹ä¸­å¾ˆå¸¸å‘¼ç±²å¤§å®¶ä¸è¦ä¸€ä¸å°å¿ƒæˆç‚ºäº†è»Ÿé«”é…’é§•éåº¦è¨­è¨ˆå¸«ã€‚&lt;/p>
&lt;h3 id="ood-è¨­è¨ˆè¦é»è¦ºå¯Ÿ-forceså¾—å‡º-problemæ‰¾åˆ°-patternsolution">
&lt;a href="#ood-%e8%a8%ad%e8%a8%88%e8%a6%81%e9%bb%9e%e8%a6%ba%e5%af%9f-forces%e5%be%97%e5%87%ba-problem%e6%89%be%e5%88%b0-patternsolution" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
OOD è¨­è¨ˆè¦é»ï¼šè¦ºå¯Ÿ Forcesï¼Œå¾—å‡º Problemï¼Œæ‰¾åˆ° Pattern(Solution)
&lt;/h3>
&lt;p>å…ˆå›åˆ°ä¸€é–‹å§‹çš„å®šç¾©ï¼Œæ‰€è¬‚çš„æ¨¡å¼ï¼Œå°±æ˜¯ä¸€å¥—å¯ä»¥è§£æ±ºç‰¹å®šæƒ…å¢ƒåº•ä¸‹çš„å•é¡Œçš„æ–¹æ³•ï¼Œä¸”é€™å¥—æ–¹æ³•ç¶“éå‰äººåè¦†é©—è­‰ä¸¦è¢«å‚³æ‰¿ä¸‹ä¾†ï¼Œç™½è©±æ–‡å°±æ˜¯è§£æ±ºç‰¹å®šå•é¡Œçš„ä¸€å¥— SOPã€‚æ¯å€‹è¨­è¨ˆæ¨¡å¼èƒŒå¾Œéƒ½æ˜¯ç‚ºäº†è§£æ±ºæŸå€‹ &lt;strong>ç‰¹å®šæƒ…å¢ƒ(Context)åº•ä¸‹çš„å•é¡Œ(Problem)&lt;/strong> è€Œç”Ÿï¼Œæ‰€ä»¥èªªå‡ä½¿å•é¡Œä¸å­˜åœ¨ï¼Œé‚£éº¼ä¹Ÿå°±æ²’æœ‰å¥—ç”¨è¨­è¨ˆçš„å¿…è¦ã€‚å¦‚æœå†å°‡é€™äº›æ‰€è¬‚çš„å•é¡Œä¸€ä¸€æ”¤é–‹ä¾†çœ‹ï¼Œæœƒç™¼ç¾å…¶å¯¦æ­£æ˜¯å› ç‚ºä¸€é“é“ Forces å½¼æ­¤ç›¸äº’è¡çªï¼Œé€²è€Œè®“å•é¡Œå‘¼ä¹‹æ¬²å‡ºï¼Œæ­¤æ™‚æ‰æœƒéœ€è¦é€éç‰¹å®šæ¨¡å¼(Pattern)çš„ Form ä¾†è§£æ±ºå•é¡Œâ€”â€”æ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆ(Solution)ï¼Œæœ€å¾Œå¾—åˆ°å¥—ç”¨æ¨¡å¼ä¹‹å¾Œçš„çµæœ(Resulting Context)æˆåŠŸåŒ–è§£è¡çªçš„ Forcesã€‚&lt;/p>
&lt;blockquote>
&lt;p>é€™è£¡æ‰€æŒ‡çš„ Forcesï¼Œèˆ‰ä¾‹ä¾†èªªåƒæ˜¯ã€Œæœªä¾†å¯èƒ½æœƒç¹¼çºŒæ“´å……æ–°çš„è¡Œç‚ºã€ã€ã€Œå°ç¨‹å¼ç¢¼ç¶­è­·æ€§çš„è¦æ±‚ã€ã€ã€Œé ˆæ»¿è¶³ç‰¹å®šçš„å•†æ¥­é‚è¼¯ã€ï¼Œæ¯ä¸€é …éƒ½æ˜¯ä¸€é“ Forceï¼Œè€Œå¤šé“ Forces è‹¥åŒæ™‚å­˜åœ¨åˆå½¼æ­¤äº’ç›¸è¡çªï¼Œå°±æœƒä»¤å·¥ç¨‹å¸«æ„Ÿå—åˆ°æ»¿æ»¿çš„å£“æŠ‘æ„Ÿã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img loading="lazy"
src="/images/ood.png"
alt="OODï¼šä»¥ç‚º OOA åŸºç¤ï¼Œå¯Ÿè¦ºå½¼æ­¤è¡çªçš„ Forces ä¹‹å¾Œå®šç¾©å‡º Problemï¼Œä¸¦æ‰¾åˆ° Problem å°æ‡‰çš„ Solutionï¼Œå¥—ç”¨ Pattern å¾Œçš„ Resultinng Context"
width=1984
height="902" />&lt;/p>
&lt;p>&lt;small>â¬†ï¸OODï¼šä»¥ç‚º OOA åŸºç¤ï¼Œå¯Ÿè¦ºå½¼æ­¤è¡çªçš„ Forces ä¹‹å¾Œå®šç¾©å‡º Problemï¼Œä¸¦æ‰¾åˆ° Problem å°æ‡‰çš„ Solutionï¼Œå¥—ç”¨ Pattern å¾Œçš„ Resultinng Context&lt;/small>&lt;/p>
&lt;p>&lt;strong>ã€å¦‚æœæ²’æœ‰å¯Ÿè¦ºåˆ° Forcesï¼Œå°±èªªæ˜æ²’æœ‰è¨­è¨ˆé›£é¡Œ Problemï¼Œä¹Ÿå°±ä¸å¿…è¦è¨è«– Solutionï¼Œæ›´æ²’å¿…è¦æ€è€ƒ Patternã€‚ã€&lt;/strong>&lt;/p>
&lt;p>å”¯æœ‰ç²¾æº–çš„å¯Ÿè¦ºåˆ°æ¯ä¸€é“å½¼æ­¤è¡çªçš„ Forces å¾Œï¼Œæ‰èƒ½çœ‹å‡ºå•é¡Œæ‰€åœ¨ï¼Œå†å¾è…¦è¢‹ä¸­ç´¢å¼•è©²å•é¡Œé©åˆçš„è§£æ±ºæ–¹æ¡ˆï¼Œæœ€å¾Œä¸€æ­¥æ‰æ˜¯å¥—ç”¨è¨­è¨ˆæ¨¡å¼ã€‚æˆ‘èªç‚ºçœŸæ­£å›°é›£çš„é»éƒ½æ˜¯åœ¨å¯Ÿè¦º Forcesï¼Œå°¤å…¶åœ¨åšé­”ç‹é¡Œæ™‚ï¼Œå¶çˆ¾æœƒæœ‰æ„Ÿå—ä¸åˆ° Forces çš„ç‹€æ³ï¼Œé€™ç¨®æ™‚å€™é€šå¸¸éƒ½æ˜¯ç”±æ–¼æ²’æœ‰æŠŠéœ€æ±‚çœ‹ä»”ç´°ï¼Œä¹Ÿå°±æ˜¯åœ¨åš OOA æ™‚ï¼Œå¯èƒ½æ¼æ•æ‰äº†æŸäº›é‡è¦çš„å…ƒç´ æˆ–è¡Œç‚ºã€‚ä½†é€£ä½œæ¥­éƒ½æœƒæœ‰é€™ç¨®æƒ…æ³ç™¼ç”Ÿäº†ï¼Œæ›´ä½•æ³æ˜¯ç¾å¯¦çš„å•†æ¥­é–‹ç™¼ç’°å¢ƒï¼Œä½œæ¥­å› ç‚ºæ˜¯åˆ»æ„è¦è¨“ç·´æˆ‘å€‘ï¼Œä¸€å®šæœƒæš—è— Forcesï¼Œä¸”éœ€æ±‚èªªæ˜é€™éº½å®Œæ•´ï¼Œæˆ‘ç¡¬æ‰¾å‡ºä¾†å³å¯ï¼›ä½†ç¾å¯¦ç•¶ä¸­ï¼Œæˆ‘æ€éº¼å¯èƒ½çŸ¥é“å“ªäº›æ˜¯æš—è—çš„ï¼Ÿå¸¸å¸¸é€£éœ€æ±‚éƒ½ä¸æ¸…ä¸æ¥šäº†ã€‚ä¸éé€™ä¹Ÿä»£è¡¨å¯Ÿè¦º Forces çš„èƒ½åŠ›é‚„éœ€è¦æ›´é€²ä¸€æ­¥çš„æå‡ï¼Œåœ¨æœªä¾†é¢å°å¯¦éš›éœ€æ±‚æ™‚ï¼Œæ‰æ›´æœ‰å¯èƒ½æ´¾å¾—ä¸Šç”¨å ´ã€‚&lt;/p>
&lt;h3 id="oop-å°±æ˜¯æŒ‰ç…§-ooad-è—åœ–æ–½å·¥">
&lt;a href="#oop-%e5%b0%b1%e6%98%af%e6%8c%89%e7%85%a7-ooad-%e8%97%8d%e5%9c%96%e6%96%bd%e5%b7%a5" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
OOP å°±æ˜¯æŒ‰ç…§ OOAD è—åœ–æ–½å·¥
&lt;/h3>
&lt;p>æœ€å¾Œï¼Œçµ‚æ–¼å¾—åˆ°äº†å®Œæˆ OOD çš„ UML é¡åˆ¥åœ–ç‰ˆæœ¬ï¼Œé€™æ™‚å€™æ‰çœŸçš„è¦é–‹å§‹å‹•æ‰‹å¯«ç¨‹å¼ï¼Œé€²å…¥ OOP(Object-oriented programming)/ç‰©ä»¶å°å‘ç¨‹å¼é–‹ç™¼çš„éšæ®µã€‚é€™æ™‚å€™åŸºæœ¬ä¸Šä¸ç®¡ä½¿ç”¨ä»€éº¼èªè¨€ï¼Œéƒ½å¯ä»¥ç…§è‘— OOD é€™å¼µè—åœ–ï¼Œå¿«é€Ÿåœ°å»å®Œæˆç¨‹å¼å¯¦ä½œçš„éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>æŒ‰ç…§é€™å€‹ SOP (OOA â†’ OOD â†’ OOP) é€²è¡Œå¹¾æ¬¡ä½œæ¥­ä¹‹å¾Œï¼Œæ˜é¡¯æ„Ÿå—åˆ°å¤§å¤šæ•¸æ€è€ƒç¨‹å¼æ¶æ§‹çš„éƒ¨åˆ†éƒ½æ˜¯åœ¨ OOA èˆ‡ OOD éšæ®µï¼Œè€Œé€²å…¥ OOP å¾Œï¼Œé€šå¸¸éƒ½æ˜¯é–‹å§‹é€²å…¥ç¢¼è¾²æ¨¡å¼ï¼ˆé™¤äº†ä¸€äº›æ¯”è¼ƒè¤‡é›œçš„é¡Œç›®ï¼Œè¦å¯¦ç¾ç‰¹å®šæ¼”ç®—æ³•æˆ–æ˜¯è™•ç†éåŒæ­¥æ©Ÿåˆ¶éœ€è¦æ¯”è¼ƒå¤šæ€è€ƒï¼‰ï¼Œå°±åƒå·¥äººä¾ç…§å»ºç¯‰è—åœ–å»æ–½å·¥ä¸€æ¨£ã€‚&lt;/p>
&lt;h3 id="æŒæ¡è»Ÿé«”è¨­è¨ˆç²¾é«“é¿å…éåº¦è¨­è¨ˆ">
&lt;a href="#%e6%8e%8c%e6%8f%a1%e8%bb%9f%e9%ab%94%e8%a8%ad%e8%a8%88%e7%b2%be%e9%ab%93%e9%81%bf%e5%85%8d%e9%81%8e%e5%ba%a6%e8%a8%ad%e8%a8%88" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
æŒæ¡è»Ÿé«”è¨­è¨ˆç²¾é«“ï¼Œé¿å…éåº¦è¨­è¨ˆ
&lt;/h3>
&lt;p>æˆ‘æƒ³ OOAD çš„éƒ¨åˆ†ï¼Œæ­£æ˜¯è»Ÿé«”è¨­è¨ˆçš„ç²¾é«“æ‰€åœ¨ï¼Œé€™ä¹Ÿæ˜¯æˆ‘åœ¨éå¾€é–‹ç™¼ç¶“æ­·ä¸­å¹¾ä¹æ²’æœ‰åŸ¹é¤Šéçš„èƒ½åŠ›ï¼Œç•¢ç«Ÿè‡ªå·±å¹³å¸¸å·¥ä½œä¸Šå¤§å¤šæ˜¯ CRUDï¼Œæ‰‹é‚Šå¤§æ¦‚ 80% ä»¥ä¸Šçš„å·¥ä½œéƒ½æ˜¯é‹ç”¨æ¡†æ¶æˆ–å·¥å…·å³å¯è™•ç†çš„æ¥­å‹™éœ€æ±‚ï¼Œå¦‚æœç•¶åˆè¦å«æˆ‘å¯«ä¸€å€‹ Domain Logic éå¸¸è±å¯Œçš„å¡ç‰ŒéŠæˆ²ï¼Œæˆ‘å¯èƒ½æ ¹æœ¬å¯«ä¸å‡ºä¾†ã€‚è€Œæ—…ç¨‹ç•¶ä¸­å·²ç¶“å¯«éäº†æ¯”å¤§å°ã€å¤§è€äºŒå’Œ RPG éŠæˆ²ï¼Œæœªä¾†é‚„æœƒç¹¼çºŒæŒ‘æˆ°åˆ° IoC å®¹å™¨æ¡†æ¶ã€Web Framework ç­‰ç­‰é›£åº¦æ›´é€²éšçš„é¡Œç›®ï¼Œé›–ç„¶ä¸ç¢ºå®šè‡ªå·±èƒ½å¦èµ°åˆ°æœ€å¾Œä¸€é—œï¼ˆä½†é¡˜ï¼‰ï¼Œä¸éå¾ç¾å›é ­çœ‹ï¼Œè‡ªå·±çš„è»Ÿé«”è¨­è¨ˆæŠ€èƒ½å·²ç¶“æˆé•·äº†ä¸å°‘ã€‚&lt;/p>
&lt;p>ä¸€é–‹å§‹çš„æˆ‘ç´”ç²¹åªæ˜¯æƒ³å­¸ç¿’å¦‚ä½•ä½¿ç”¨è¨­è¨ˆæ¨¡å¼ï¼Œå»å®Œå…¨å¿½ç•¥äº†ã€Œçˆ²ä»€éº¼è¦å­¸ç¿’/ä½¿ç”¨è¨­è¨ˆæ¨¡å¼ã€ï¼Œç›´æ¥åœ¨æ—…ç¨‹çš„ä¸€é–‹å§‹å°±è¢«é»å‡ºäº†è‡ªå·±å¾æœªæ€è€ƒéï¼Œå»éå¸¸æ ¸å¿ƒçš„å•é¡Œã€‚è¦æ˜¯æ²’æœ‰åƒåŠ æ—…ç¨‹ï¼Œæˆ‘å¯èƒ½å°±æœƒç¹¼çºŒç”¨ä»¥å¾€çš„æ€ç¶­ï¼Œåªæ˜¯å› ç‚ºç†Ÿæ‚‰æŸäº›è¨­è¨ˆæ¨¡å¼æˆ–å–®ç´”ç‚ºäº†ç‚«æŠ€è€Œå¥—æ¨¡å¼ã€‚è€Œå°±ä»¥ä¸€å€‹å¹³å¸¸å¤§å¤šæ•¸ä½¿ç”¨æ¡†æ¶å’Œå·¥å…·å°±èƒ½å®Œæˆæ—¥å¸¸ 80% å·¥ä½œçš„äººä¾†èªªï¼Œè¨­è¨ˆæ¨¡å¼ç¢ºå¯¦å¾ˆå°‘æ©Ÿæœƒæ´¾å¾—ä¸Šç”¨ä¸Šï¼ˆå¤§å¤šæ•¸æœƒä½¿ç”¨æ¨¡å¼çš„éƒ¨åˆ†ï¼Œæ¡†æ¶æˆ–å·¥å…·éƒ½å¹«æˆ‘å€‘åšæ‰äº†ï¼‰ï¼Œä½†æˆ‘èªç‚ºé€™è¶Ÿæ—…ç¨‹æ‰€å¸¶ä¾†æœ€å¤§çš„æ”¶ç©«å°±æ˜¯å°æ–¼ OOAD çš„æŒæ¡èƒ½åŠ›ï¼ŒåŒæ™‚åŸ¹é¤Šäº†è»Ÿé«”æ¶æ§‹æ€ç¶­ï¼Œæ‡‚å¾—å¦‚ä½•é¿å…éåº¦è¨­è¨ˆï¼Œå…‰é€™ä¸€é»å°±è®“æˆ‘è¦ºå¾—éå¸¸å€¼å¾—äº†ã€‚&lt;/p></description></item><item><title>[leetcode ç­†è¨˜] 160.Â Intersection of Two Linked Lists</title><link>/posts/leetcode-160-intersection-of-two-linked-lists/</link><pubDate>Mon, 31 Jul 2023 23:54:43 +0800</pubDate><guid>/posts/leetcode-160-intersection-of-two-linked-lists/</guid><description>
&lt;h2 id="é¡Œç›®æ¦‚è¿°">
&lt;a href="#%e9%a1%8c%e7%9b%ae%e6%a6%82%e8%bf%b0" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
é¡Œç›®æ¦‚è¿°
&lt;/h2>
&lt;p>çµ¦å®šå…©å€‹å–®å‘ Linked List çš„ç¬¬ä¸€å€‹ç¯€é» (head)ï¼Œå…©å€‹ List å¯èƒ½æœƒåœ¨æŸå€‹ç¯€é»æœƒåˆæˆç‚ºä¸€å€‹ Listï¼Œè¦æ±‚æ‰¾å‡ºæœƒåˆç¯€é»ä¸¦å›å‚³ã€‚è‹¥å…©å€‹ List ä¸¦ç„¡æœƒåˆï¼Œå‰‡å›å‚³ nullã€‚&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/leetcode-160-intersection-of-two-linked-lists.png"
alt="160. Intersection of Two Linked Lists"
width=742
height="241" />&lt;/p>
&lt;p>å…¶ä¸­ï¼Œæœƒåˆç¯€é»å¿…é ˆæ˜¯æŒ‡å‘åŒä¸€å€‹å¯¦ä¾‹ï¼ˆæŒ‡æ¨™ï¼‰ï¼Œä¹Ÿå°±æ˜¯å³ä½¿å…©å€‹ç¯€é»çš„å€¼ç›¸åŒï¼Œä½†ç‚ºä¸åŒå¯¦ä¾‹ï¼Œä¸èƒ½ç®—æ˜¯æœƒåˆç¯€é»ã€‚&lt;/p>
&lt;p>&lt;a href="https://leetcode.com/problems/intersection-of-two-linked-lists/description/">é¡Œç›®é€£çµ&lt;/a>&lt;/p>
&lt;h2 id="è§£æ³•ä¸€hashmap">
&lt;a href="#%e8%a7%a3%e6%b3%95%e4%b8%80hashmap" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è§£æ³•ä¸€ï¼šHashMap
&lt;/h2>
&lt;p>ä¹Ÿæ˜¯ç¬¬ä¸€æ™‚é–“æƒ³åˆ°çš„æ–¹æ³•ï¼Œå…ˆéæ­·å…¶ä¸­ä¸€å€‹ Listï¼Œä½¿ç”¨ä¸€å€‹ Hashmap ç´€éŒ„ key ç‚ºå¯¦ä¾‹æŒ‡æ¨™ï¼Œå€¼ç‚ºç¯€é»çš„å€¼ï¼ˆå…¶å¯¦å€¼ç‚ºä½•ä¸¦ä¸é‡è¦ï¼‰ï¼Œæ¥è‘—å†éæ­·ç¬¬äºŒå€‹ Listï¼Œåˆ¤æ–·ç•¶å‰ç¯€é»æ˜¯å¦å­˜åœ¨æ–¼ map ç•¶ä¸­ï¼Œæœ‰çš„è©±å‰‡ç«‹å³è¿”å›ï¼Œéƒ½éæ­·å®Œçš„è©±ä»£è¡¨å…©å€‹ List ä¸¦ç„¡ç›¸åŒå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ä¸å­˜åœ¨æœƒåˆç¯€é»ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">getIntersectionNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">headA&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">headB&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ListNode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ListNode&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">ListNode&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curA&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">headA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">curA&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">m1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">curA&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">curA&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Val&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curA&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">curA&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curB&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">headB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">curB&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">curB&lt;/span>&lt;span class="p">];&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">curB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">curB&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">curB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†é€™å€‹æ–¹æ³•å…¶å¯¦æœƒéœ€è¦ O(n) çš„ç©ºé–“è¤‡é›œåº¦ï¼Œé›–ç„¶å¯ä»¥è¢« Acceptedï¼Œä½†ä¸¦éæœ€ä½³è§£ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç„¡æ³•æ»¿è¶³ follow up è¦æ±‚ï¼šç©ºé–“è¤‡é›œåº¦ O(1)ï¼Œæ™‚é–“è¤‡é›œåº¦ O(m+n)&lt;/p>
&lt;/blockquote>
&lt;h2 id="è§£æ³•äºŒé›™æŒ‡é‡">
&lt;a href="#%e8%a7%a3%e6%b3%95%e4%ba%8c%e9%9b%99%e6%8c%87%e9%87%9d" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è§£æ³•äºŒï¼šé›™æŒ‡é‡
&lt;/h2>
&lt;p>é€å‡ºå¾Œæ»‘äº†ä¸€ä¸‹ Solutions ç•¶ä¸­å…¶ä»–å¼·è€…çš„è§£æ³•ï¼Œæ‰çœ‹åˆ°é€™å€‹è°æ˜çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>é…ç½®å…©å€‹æŒ‡é‡ï¼Œéƒ½å„è‡ªå¾ List A å’Œ List B çš„ head é–‹å§‹ï¼ŒæŒ‡é‡1 å°‡ List A èµ°åˆ°åº•å¾Œæ¥è‘—èµ° List Bï¼ŒåŒæ™‚ï¼ŒæŒ‡é‡2 å°‡ List B èµ°åˆ°åº•å¾Œæ¥è‘—èµ° List Aã€‚çŸ­çš„ List æœƒè¢«å…ˆèµ°å®Œå°±æœƒæ›åˆ°é•·çš„ List å»ï¼Œè€Œé•·çš„ List èµ°å®Œä¹Ÿæœƒæ›åˆ°çŸ­ List å»èµ°ï¼Œæœ€çµ‚å…©å€‹æŒ‡é‡å°±æœƒèµ°åˆ°äº¤æœƒçš„ç¯€é»ä¸Šã€‚&lt;/p>
&lt;p>åšäº†å€‹ç°¡å–®çš„å‹•ç•«ï¼Œç›´æ¥çœ‹æ¯”è¼ƒæ¸…æ¥šï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/leetcode-160-intersection-of-two-linked-lists.gif"
alt="Intersection of Two Linked Lists é›™æŒ‡é‡è§£æ³•å‹•ç•«"
width=1516
height="838" />&lt;/p>
&lt;p>ä¸ç®¡æ˜¯å…ˆèµ°å®Œ A å†èµ° Bï¼Œé‚„æ˜¯å…ˆèµ°å®Œ B å†èµ° Aï¼Œç•¶èµ°åˆ°äº’æ› List é‚£é‚Šå»ä¹‹å¾Œï¼Œæœƒåœ¨é¢è‡¨äº¤æœƒé»ä¹‹å‰åŒæ­¥ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>a1 â†’ a2&lt;/code> â†’ &lt;code>c1 â†’ c2 â†’ c3&lt;/code> â†’ &lt;code>null&lt;/code>(aèµ°å®Œæ›b) â†’ &lt;code>b1 â†’ b2 â†’ b3&lt;/code> â†’ &lt;code>c1&lt;/code>&lt;/p>
&lt;p>&lt;code>b1 â†’ b2 â†’ b3&lt;/code> â†’ &lt;code>c1 â†’ c2 â†’ c3&lt;/code> â†’ &lt;code>null&lt;/code>(bèµ°å®Œæ›a) â†’ &lt;code>a1 â†’ a2&lt;/code> â†’ &lt;code>c1&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>b3&lt;/code> çš„ next ç‚º &lt;code>c1&lt;/code> ï¼Œ &lt;code>a2&lt;/code> çš„ next ä¹Ÿç‚º &lt;code>c1&lt;/code> ï¼Œå¾—å‡ºäº¤æœƒé»ç‚º &lt;code>c1&lt;/code> ã€‚&lt;/p>
&lt;p>é‚£å¦‚æœç•¶æ²’æœ‰äº¤æœƒé»çš„æ™‚å€™æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿç”¨åŒæ¨£çš„æ€è€ƒæ–¹å¼ä¾†çœ‹ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>a1 â†’ a2 â†’ a3 â†’ a4&lt;/code> â†’ &lt;code>null&lt;/code>(aèµ°å®Œæ›b) â†’ &lt;code>b1 â†’ b2 â†’ b3&lt;/code> â†’ &lt;code>null&lt;/code>&lt;/p>
&lt;p>&lt;code>b1 â†’ b2 â†’ b3&lt;/code> â†’ &lt;code>null&lt;/code>(bèµ°å®Œæ›a) â†’ &lt;code>a1 â†’ a2 â†’ a3 â†’ a4&lt;/code> â†’ &lt;code>null&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>ç”±æ–¼ &lt;code>b3&lt;/code> å’Œ &lt;code>a4&lt;/code> çš„ next éƒ½æ˜¯ nullï¼Œå¾—å‡ºäº¤æœƒé»ç‚º nullã€‚&lt;/p>
&lt;blockquote>
&lt;p>å¦‚æœList A å’Œ List B çš„é•·åº¦ç›¸åŒï¼Œå‰‡æ­¤è§£æ±ºæ–¹æ¡ˆå°‡åœ¨ä¸è¶…é1æ¬¡éæ­·çš„æƒ…æ³ä¸‹çµ‚æ­¢ï¼›å¦‚æœå…©å€‹ List çš„é•·åº¦ä¸åŒï¼Œå‰‡æ­¤è§£æ±ºæ–¹æ¡ˆå°‡åœ¨ä¸è¶…é2æ¬¡éæ­·çš„æƒ…æ³ä¸‹çµ‚æ­¢ &amp;ndash; åœ¨ç¬¬äºŒæ¬¡éæ­·ä¸­ï¼Œäº¤æ› A å’Œ B æœƒä½¿ A å’Œ B åœ¨ç¬¬äºŒæ¬¡éæ­·çµæŸå‰åŒæ­¥ã€‚åœ¨ç¬¬äºŒæ¬¡éæ­·ä¸­ï¼Œå®ƒå€‘éƒ½å…·æœ‰ç›¸åŒçš„å‰©é¤˜æ­¥é©Ÿï¼Œä»¥ç¢ºä¿å®ƒå€‘åŒæ™‚ï¼ˆå¾æŠ€è¡“ä¸Šä¾†èªªï¼Œæ˜¯åœ¨åŒä¸€æ¬¡è¿­ä»£ä¸­ï¼‰åˆ°é”ç¬¬ä¸€å€‹äº¤æœƒç¯€é»ï¼Œæˆ–è€…åŒæ™‚åˆ°é” nullã€‚
by &lt;a href="https://leetcode.com/problems/intersection-of-two-linked-lists/solutions/49785/java-solution-without-knowing-the-difference-in-len/">Java solution without knowing the difference in len!&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>æœ€å¾Œçš„ codeï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Solution&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">getIntersectionNode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">headA&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ListNode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">headB&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ListNode&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">Optional&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">ListNode&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">headA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">headB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p1&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">p2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">headB&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">p1&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">p1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">headA&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">p2&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">p2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">next&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">p1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="reference">
&lt;a href="#reference" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Reference
&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://leetcode.com/problems/intersection-of-two-linked-lists/solutions/49785/java-solution-without-knowing-the-difference-in-len/">Java solution without knowing the difference in len!&lt;/a>ï¼š
é€™ç¯‡ Solution åº•ä¸‹æœ‰ä¸€å€‹ BryanBoCao å¤§å¤§çš„ï¼ˆæ‡‰è©²æ˜¯ç¬¬ä¸€å€‹ï¼‰ç•™è¨€ï¼Œç•¶ä¸­æœ‰è©³ç´°çš„åœ–è§£èªªæ˜ï¼Œéå¸¸æœ‰åŠ©æ–¼ç†è§£ã€‚&lt;/li>
&lt;/ul></description></item><item><title>GraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸‹ï¼‰</title><link>/posts/golang-graphql-dataloader-2/</link><pubDate>Sun, 04 Jun 2023 17:44:11 +0800</pubDate><guid>/posts/golang-graphql-dataloader-2/</guid><description>
&lt;p>æ¥çºŒä¸Šä¸€ç¯‡æ–‡ç« ï¼š&lt;a href="/posts/golang-graphql-dataloader-1/">GraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸Šï¼‰&lt;/a>ã€‚&lt;/p>
&lt;p>åœ¨é€²å…¥åŸå§‹ç¢¼ä¹‹å‰ï¼Œå…ˆè¤‡ç¿’ä¸€ä¸‹ use caseã€‚é¦–å…ˆå¾ resolver é–‹å§‹çœ‹èµ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// IconURL is the resolver for the icon_url field.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">roomFeatureResolver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">IconURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeature&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IconUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ä¸­å‘¼å«äº†æˆ‘å€‘çš„è‡ªå®šç¾©æ–¹æ³• &lt;code>storage.GetFeature&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureID&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeatureWithData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">thunk&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">loaders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FeatureLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">DataLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureID&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">thunk&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeatureWithData&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡é»å°±æ˜¯é€™è£¡ä½¿ç”¨åˆ°çš„ &lt;code>loaders.FeatureLoader.Load&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>FeatureLoader&lt;/code> é›–ç‚ºè‡ªå®šç¾©å±¬æ€§ï¼Œä½†æ˜¯é€é DataLoader å¥—ä»¶æä¾›çš„ &lt;code>*DataLoader.Loader&lt;/code> å»ºæ§‹å­ &lt;code>DataLoader.NewBatchedLoader&lt;/code> æ‰€å‰µå»ºå‡ºï¼Œæ‰€ä»¥æœ¬èº«å°±å…·å‚™äº† Load æ–¹æ³•ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æ·±å…¥æ¢ç©¶ &lt;code>Load&lt;/code> æ–¹æ³•ä¹‹å‰ï¼Œå…ˆé‡æ¸…ä¸€ä¸‹é€™å€‹ &lt;code>GetFeature&lt;/code> æ–¹æ³•ä»€éº¼æ™‚å€™æœƒè¢«åŸ·è¡Œåˆ°ã€‚å›åˆ°ä¸€é–‹å§‹çš„æ¡ˆä¾‹ï¼Œ
ç•¶ Client é€²è¡Œå¦‚ä¸‹ Query æ™‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-graphql" data-lang="graphql">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nc">content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="py">hotel_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nc">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">rooms&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">features&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">icon_url&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæœ‰ n å€‹ roomsï¼Œæ¯å€‹ room æœ‰ m å€‹ featuresï¼Œç¸½å…±æœƒåŸ·è¡Œ n * m æ¬¡ &lt;code>IconURL&lt;/code> ä¾†å–å¾—æ¯å€‹ feature çš„ icon URLï¼Œä¹Ÿå°±æ˜¯åŸ·è¡Œ m * n æ¬¡ &lt;code>GetFeature&lt;/code>ã€‚è€Œåœ¨æ¯å€‹ &lt;code>GetFeature&lt;/code> æ–¹æ³•ç•¶ä¸­åˆå‘¼å«äº† &lt;code>loaders.FeatureLoader.Load&lt;/code> æ–¹æ³•ï¼Œé€éå›å‚³çš„å‡½æ•¸å–å¾— feature è³‡æ–™ã€‚&lt;/p>
&lt;p>å–®ç´”ä»¥ä½¿ç”¨ä¸Šçš„è§’åº¦ï¼Œå¯ä»¥æŠŠ &lt;code>Load&lt;/code> æ–¹æ³•ç•¶æˆæ˜¯ä¸€å€‹é»‘ç›’å­ï¼Œç•¶æˆ‘å€‘å‘ä»–ç´¢å–éœ€è¦çš„è³‡æ–™æ™‚ï¼Œä»–å°±æœƒå›å‚³çµ¦æˆ‘å€‘ã€‚&lt;/p>
&lt;p>æƒ³åƒå¦‚æœé€™äº›æ–¹æ³•éƒ½æ˜¯åŒæ­¥è¢«åŸ·è¡Œçš„ï¼Œå‡è¨­ç¬¬ä¸€æ¬¡å‚³å…¥ &lt;code>GetFeature&lt;/code> çš„ feature id ç‚º 1ï¼Œæ­¤æ™‚è¦å‘ DataLoader å– id ç‚º 1 çš„ feature è³‡æ–™ï¼Œç…§ç†ä¾†èªªæ‡‰è©²é‚„æ²’æœ‰è¾¦æ³•å–å¾—ï¼Œå› ç‚ºé€™æ™‚å€™ DataLoader å°šæœªè’é›†åˆ°æ‰€æœ‰ rooms çš„ featuresï¼Œï¼ˆè¦æœé›†å®Œæ‰€æœ‰ id æ‰æœƒå‘è³‡æ–™åº«æŸ¥è©¢ï¼‰ï¼Œæ‰€ä»¥æ‡‰è©²æœƒæš«æ™‚ block ä½ï¼Œç­‰å¾…æ‰€æœ‰ id è’é›†å®Œå¾Œæ‰å–å¾—æ‰€æœ‰è³‡æ–™ï¼Œæ‰èƒ½å–å¾— id 1 çš„è³‡æ–™ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œé€™å€‹åŠŸèƒ½èƒŒå¾Œä¸€å®šæ˜¯æœ‰&lt;strong>éåŒæ­¥&lt;/strong>çš„æ”¯æŒæ‰æœ‰å¯èƒ½è¾¦åˆ°ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åˆ°åº• DataLoader æ˜¯åœ¨ä»€éº¼æ™‚å€™è’é›†åˆ°æ‰€æœ‰ rooms çš„ features æ¯å€‹ id çš„ï¼Ÿåˆæ˜¯åœ¨ä»€éº¼æ™‚å€™å‘¼å«å‘è³‡æ–™åº«æŸ¥è©¢çš„æ–¹æ³•ï¼Ÿå°±ä¾†çœ‹çœ‹é€™å€‹ &lt;code>Load&lt;/code> æ–¹æ³•åˆ°åº•åšäº†ä»€éº¼å§ï¼&lt;/p>
&lt;p>&lt;em>ç„¶å¾Œå› ç‚ºé€™å€‹æ–¹æ³•æœ‰é»é•·ï¼Œæ‰€ä»¥æˆ‘æœƒæŒ‰ç…§é †åºåˆ†æ®µè²¼ä¸Šä¾†ï¼Œä½†ä¸æœƒå…¨éƒ¨è²¼ï¼Œæ¯”è¼ƒéæ ¸å¿ƒåŠŸèƒ½çš„éƒ¨åˆ†ä¹Ÿæœƒæš«æ™‚çœç•¥ã€‚æœ‰èˆˆè¶£çš„è®€è€…å¯ä»¥è‡ªè¡Œå»çœ‹åŸå§‹ç¢¼ã€‚&lt;/em>&lt;/p>
&lt;p>é¦–å…ˆå‰µå»ºä¸€å€‹æ¥æ”¶çµæœçš„ channelï¼Œä»¥åŠä¸€å€‹ result è®Šæ•¸ï¼Œæ¥è‘—è©¦åœ–åˆ° &lt;code>Loader&lt;/code> çš„ cache ç•¶ä¸­å°‹æ‰¾ key å°æ‡‰çš„å€¼å­˜ä¸å­˜åœ¨ï¼Œæœ‰çš„è©±å°±ç›´æ¥è¿”å›å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//github.com/graph-gophers/DataLoader@v5.0.0+incompatible/DataLoader.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="nx">Key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Thunk&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">finish&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tracer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TraceLoad&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">value&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...ä¸‹é¢çºŒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿”å›å€¼æ˜¯ &lt;code>Thunk&lt;/code> é¡å‹ï¼Œå…¶å¯¦å°±æ˜¯ä¸€å€‹é€™æ¨£å½¢ç‹€çš„ functionï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Thunk&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ï¼Œç•¶åœ¨ cache ç•¶ä¸­æ‰¾ä¸åˆ°å°æ‡‰å€¼æ™‚ï¼Œå°±æ–°å»ºä¸€å€‹ thunk å‡½æ•¸ï¼Œç•¶ä¸­æœƒä½¿ç”¨ä¸Šé¢å»ºç«‹çš„ result è®Šæ•¸ï¼Œå¦‚æœ result è£¡çš„å€¼ç‚ºç©ºï¼Œå°±ä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰è³‡æ–™å‚³é€² channelï¼Œ ç„¶å¾Œå°‡ result çš„å€¼æ›´æ–°ç‚ºå‚³å…¥çš„ valueã€‚æœ€å¾Œå¯«å…¥ cacheã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="nx">Key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Thunk&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...æ¥çºŒä¸Šé¢
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">thunk&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RLock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//ä¸Šè®€é–ï¼Œé¿å…åœ¨è®€å–è³‡æ–™æ™‚ï¼ŒåŒæ™‚æœ‰å…¶ä»–ç·šç¨‹æƒ³æ›´æ–°è©²è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">resultNotSet&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RUnlock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// é‡‹æ”¾è®€é–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">resultNotSet&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//ä¸Šç¨å é–ï¼Œé¿å…åœ¨æ›´æ–°è³‡æ–™æ™‚ï¼ŒåŒæ™‚æœ‰å…¶ä»–ç·šç¨‹æƒ³æ›´æ–°è©²è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// block ä½ç›´åˆ° c æœ‰ result å‚³å…¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//é‡‹æ”¾ç¨ä½”é–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RLock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RUnlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">thunk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">thunk&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...ä¸‹é¢çºŒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å†ä¾†ï¼Œæ–°å¢ä¸€å€‹ batchRequestï¼Œä¸¦æª¢æŸ¥ loader ç•¶ä¸­çš„ curBatcher å­˜åœ¨èˆ‡å¦ï¼Œä¸å­˜åœ¨å°±å‰µå»ºæ–°çš„ã€‚é€™å€‹ curBatcher å…§éƒ¨æœƒæœ‰åŸ·è¡Œè‡ªå®šç¾©æ–¹æ³•â€”â€”ä¹Ÿå°±æ˜¯åœ¨ NewBatchedLoader æ™‚å‚³å…¥çš„ &lt;code>featureReader.GetFeature&lt;/code> æ–¹æ³•â€”â€”çš„é‚è¼¯ã€‚&lt;/p>
&lt;p>æ¥è‘—å¦é–‹ä¸€å€‹ goroutine åŸ·è¡Œ curBatcher çš„ &lt;code>batch&lt;/code> æ–¹æ³•ä¹‹å¾Œï¼Œåˆé–‹äº†ä¸€å€‹ goroutine åŸ·è¡Œ loader çš„ sleeper æ–¹æ³•ã€‚&lt;/p>
&lt;p>ç„¶å¾ŒæŠŠ batchRequest å‚³å…¥åˆ°äº† curBatcher çš„ input channelï¼Œæœ€å¾Œå›å‚³ thunk å‡½æ•¸ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">batchRequest&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span> &lt;span class="nx">Key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">channel&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">batcher&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">input&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">batchRequest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batchFn&lt;/span> &lt;span class="nx">BatchFunc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="nx">Key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Thunk&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...æ¥çºŒä¸Šé¢
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// req åŒ…å«äº†è¦æŸ¥è©¢çš„ key å’Œ ç­‰å¾…æ¥æ”¶çµæœçš„ channel
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">batchRequest&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">newBatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">silent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tracer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">batch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endSleeper&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">go&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">sleeper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endSleeper&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">input&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">req&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¦‚æœæœ‰é¡å¤–è¨­å®š batchCapï¼Œå¯ä»¥é™åˆ¶ä¸€æ¬¡æœ€å¤šå¯ä»¥æ¥å—çš„ req æ•¸é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchCap&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// ä½†æˆ‘å€‘ä¸¦æ²’æœ‰è¨­å®šï¼Œæ‰€ä»¥ batchCap ç‚º 0ï¼Œä¸æœƒé€²å…¥é€™é‚Š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">thunk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ™‚ï¼Œç™¼ç¾é‚è¼¯é€²åˆ°äº† &lt;code>curBatcher.batch&lt;/code> æ–¹æ³•ç•¶ä¸­ï¼Œæ‰€ä»¥ç·Šæ¥è‘—ä¾†çœ‹é€™æ®µæ–¹æ³•ï¼š&lt;/p>
&lt;p>é€ä¸€æ¥æ”¶ input çš„è³‡æ–™ä¹‹å¾Œï¼Œçµ‚æ–¼çœ‹åˆ°äº†åŸ·è¡Œ &lt;code>b.batchFn(ctx, keys)&lt;/code> ä¹Ÿå°±æ˜¯æˆ‘å€‘è‡ªå®šç¾©çš„è³‡æ–™åº«æŸ¥è©¢æ–¹æ³•ï¼
ç„¶å¾Œå°±æ˜¯æŠŠæŸ¥è©¢åˆ°çš„è³‡æ–™ï¼Œä¾åºæ”¾å…¥æ¯å€‹ request çš„ channelï¼Œå†é—œé–‰ channelï¼Œå¦‚æ­¤ä¸€ä¾† thunk å‡½æ•¸ç•¶ä¸­ç­‰å¾…è©² channel å‚³å› result é‚£ä¸€è¡Œå°±æœƒå–å¾—å€¼è€Œç¹¼çºŒå¾€ä¸‹åŸ·è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">batcher&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">batch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">keys&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Keys&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">batchRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">items&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">panicErr&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// keys çš„é †åº ç­‰åŒ reqs çš„é †åº
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">item&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">input&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">keys&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">reqs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">reqs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">finish&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tracer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TraceBatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">originalContext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">keys&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">finish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">items&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">items&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">batchFn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">keys&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// åŸ·è¡Œè‡ªå®šç¾©çš„è³‡æ–™åº«æŸ¥è©¢æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å› ç‚ºè‡ªå®šç¾©æ–¹æ³•ç•¶ä¸­ä¹Ÿæœ‰ä¾ç…§ keys çš„é †åºå›å‚³ resultï¼Œä¸” keys çš„é †åº ç­‰åŒ reqs çš„é †åº
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ‰€ä»¥é€™æ¨£æ”¾å…¥é †åºä¸æœƒäº‚
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">reqs&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">channel&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">items&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">channel&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†æ˜¯åˆ¥å¿˜äº†ï¼Œ&lt;code>b.input&lt;/code> ä¹Ÿæ˜¯ä¸€å€‹ channelï¼Œé€™é‚Šåˆä½¿ç”¨äº† for..range èªæ³•ä¾†éæ­· channelï¼Œç…§ç†ä¾†èªªï¼Œé™¤éåˆ¥çš„ goroutine ç•¶ä¸­æœ‰æŠŠé€™å€‹ channel çµ¦é—œäº†ï¼Œå¦å‰‡æ‡‰è©²æœƒé€ æˆ deadlock æ‰å°ã€‚è€Œåœ¨å“ªè£¡æœƒå°‡ input é€™å€‹ channel é—œé–‰å‘¢ï¼Ÿ&lt;/p>
&lt;p>ç¸½å…±æœ‰å…©å€‹åœ°æ–¹éƒ½åœ¨ Load æ–¹æ³•ç•¶ä¸­ï¼Œä¸€å€‹æ˜¯ç•¶ &lt;code>l.batchCap &amp;gt; 0&lt;/code> æ™‚ï¼Œå¦‚æœç¬¦åˆæŒ‡å®šæ¢ä»¶(åŸ·è¡Œçš„ req æ•¸é‡ç­‰æ–¼ batchCap æ•¸é‡æ™‚)ï¼Œæœƒå‘¼å«
&lt;code>l.curBatcher.end()&lt;/code> é—œé–‰ input chanã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchCap&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchCap&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">curBatcher&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">end&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// ç›´æ¥çµ‚æ­¢æ¥æ”¶ reqï¼Œä¸å†ç¹¼çºŒç­‰å¾…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endSleeper&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// é—œé–‰ç­‰å¾…ç‰¹å®šä¸€æ®µæ™‚é–“çš„ channel
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">reset&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦ä¸€å€‹æ˜¯ä½æ–¼ &lt;code>go l.sleeper(l.curBatcher, l.endSleeper)&lt;/code> é€™ä¸€è¡Œï¼Œæ‰€ä»¥é‚„å¾—å†çœ‹ä¸€ä¸‹é€™å€‹æ–¹æ³•åšäº†ä»€éº¼æ‰è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">sleeper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">batcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">close&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åªæœ‰åœ¨ Load æ–¹æ³•ä¸­é€²å…¥ `l.batchCap &amp;gt; 0` çš„ if å€å¡Šæ™‚ï¼Œæœƒå° close channel å‚³é€è¨Šè™Ÿ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// é€™é‚Šæ”¶åˆ°è¨Šè™Ÿè¡¨ç¤ºå·²ç¶“æå‰é—œé–‰äº† input channelï¼Œä¹Ÿä¸éœ€ç¹¼çºŒç­‰å¾…ä¸‹å»
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">close&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">After&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wait&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">batchLock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">end&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// &amp;lt;-----here
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">batcher&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">end&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">finished&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œç•¶ç­‰å¾…æ™‚é–“ä¸€åˆ°(&lt;code>time.After(l.wait)&lt;/code>æ”¶åˆ°è¨Šè™Ÿå¾Œ)ï¼Œå°±æœƒå¾€ä¸‹åŸ·è¡Œåˆ° &lt;code>b.end()&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é—œé–‰ input channel çš„æ–¹æ³•ï¼Œè€Œç­‰å¾…çš„æ™‚é–“ &lt;code>l.wait&lt;/code> é è¨­å€¼æ˜¯ 16msï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewBatchedLoader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">batchFn&lt;/span> &lt;span class="nx">BatchFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loader&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Loader&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">batchFn&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">batchFn&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">inputCap&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">wait&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">16&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// &amp;lt;-----here
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœ loader çš„ input channel åœ¨ 16ms ä¹‹å¾Œéƒ½æ²’æœ‰å†æ”¶åˆ° request çš„è©±ï¼Œå°±æœƒè‡ªå‹•é—œé–‰äº†ã€‚&lt;/p>
&lt;h2 id="ç¸½çµ">
&lt;a href="#%e7%b8%bd%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ç¸½çµ
&lt;/h2>
&lt;p>çœ‹å®Œä»¥ä¸Šçš„åŸå§‹ç¢¼ä¹‹å¾Œï¼Œç®—æ˜¯æ­é–‹äº† DataLoader çš„é»‘ç›’å­ï¼Œç†è§£äº†å®ƒçš„é‹ä½œåŸç†ã€‚æœ€å¾Œå†é‡é»æ•´ç†ä¸€ä¸‹ Dataloader é‹ä½œçš„æµç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç•¶ç¬¬ä¸€æ¬¡èª¿ç”¨ loader çš„ &lt;code>Load&lt;/code> æ–¹æ³•æ™‚ï¼Œloader å…§éƒ¨æœƒé–‹å•Ÿä¸€å€‹ input channel ä¾†æ¥æ”¶æŸ¥è©¢è³‡æ–™çš„ requestï¼Œä¸¦é–‹å§‹ç­‰å¾… request å‚³å…¥ã€‚&lt;/li>
&lt;li>æ¯æ¬¡èª¿ç”¨ &lt;code>Load&lt;/code> æ–¹æ³•æ™‚ï¼Œéƒ½æœƒå»ºç«‹ä¸€å€‹ requestï¼ˆè£é¢åŒ…å« key å’Œä¸€å€‹æ¥æ”¶æŸ¥è©¢çµæœçš„ channelï¼‰ä¸¦å°‡å…¶å‚³å…¥ input channelã€‚&lt;/li>
&lt;li>&lt;code>Load&lt;/code> æ–¹æ³•è¿”å›ä¸€å€‹åŒ¿åå‡½æ•¸ï¼Œå‡½æ•¸å…§éƒ¨å¦‚æœæ²’æœ‰å¯ä»¥ç«‹å³è¿”å›çš„çµæœï¼Œæœƒè©¦åœ–å¾ request channel ä¸­å–å€¼ï¼Œå› æ­¤åœ¨å°šæœªæœ‰å€¼é€å…¥ channel ä¹‹å‰æœƒæš«æ™‚é˜»å¡ã€‚&lt;/li>
&lt;li>loader çš„ input channel æœƒç­‰å¾…ä¸€æ®µæ™‚é–“ï¼ˆé è¨­ç‚º 16msï¼‰ï¼Œæ™‚é–“ä¸€åˆ°å°±é—œé–‰æ¥æ”¶ requestã€‚ï¼ˆå¦‚æœæœ‰è¨­å®šæ¥æ”¶ request çš„æœ€å¤§æ•¸é‡ï¼Œä¹Ÿæœ‰å¯èƒ½æå‰é—œé–‰ï¼‰&lt;/li>
&lt;li>input channel é—œé–‰å¾Œï¼Œå°±æœƒå°‡æ‰€æœ‰æœé›†åˆ°çš„ request keys å‚³çµ¦è‡ªè¨‚æ‰¹æ¬¡è™•ç†æ–¹æ³•ï¼Œå–å¾—æ‰€æœ‰è³‡æ–™ï¼ˆç‚º key - value å½¢å¼ï¼‰ã€‚&lt;/li>
&lt;li>è³‡æ–™è¼‰å…¥å®Œæˆå¾Œï¼Œå°‡é€™äº›è³‡æ–™ä¾ç…§ key æ¨é€²å°æ‡‰çš„ request channelï¼Œæ¥æ”¶åˆ°è©² channel å›å‚³å€¼çš„åŒ¿åå‡½æ•¸å°±æœƒåœæ­¢é˜»å¡ï¼Œå°‡çµæœç·©å­˜å¾Œï¼Œå›å‚³çµ¦ clientã€‚&lt;/li>
&lt;/ul></description></item><item><title>GraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸Šï¼‰</title><link>/posts/golang-graphql-dataloader-1/</link><pubDate>Sun, 04 Jun 2023 17:43:11 +0800</pubDate><guid>/posts/golang-graphql-dataloader-1/</guid><description>
&lt;h2 id="the-problem">
&lt;a href="#the-problem" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
The Problem
&lt;/h2>
&lt;p>ä½¿ç”¨ GraphQL æ™‚ï¼Œé‡åˆ°ä»¥ä¸‹çš„æŸ¥è©¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-graphql" data-lang="graphql">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">query&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nc">content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="py">hotel_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nc">1&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">rooms&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">features&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">icon_url&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="py">zh_tw&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è³‡æ–™çš„é—œè¯ä¸Šï¼Œcontent åº•ä¸‹æœ‰è¨±å¤š roomsï¼Œæ¯å€‹ room åº•ä¸‹éƒ½æœ‰å¤šå€‹ featuresã€‚ä½†åœ¨è³‡æ–™è¡¨çµæ§‹ä¸Šï¼Œroom æœ‰ä¸€å€‹ &lt;code>content_id&lt;/code> æ¬„ä½ï¼Œä»¥åŠä¸€å€‹ &lt;code>features&lt;/code> æ¬„ä½ï¼Œè£é¢å„²å­˜äº†æ‰€æœ‰ features çš„ idã€‚&lt;/p>
&lt;p>è€Œç¾åœ¨ Client å¸Œæœ›ï¼Œç•¶ query features æ™‚å¦‚æœå¤¾å¸¶äº† &lt;code>icon_url&lt;/code> æˆ– &lt;code>text&lt;/code> æ¬„ä½ï¼Œserver å¿…é ˆå¤šå›å‚³ feature çš„é€™å…©å€‹æ¬„ä½ã€‚ä¹Ÿå°±æ˜¯åœ¨ room.feature çš„ resolver çš„é€™å…©å€‹æ–¹æ³•ç•¶ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">roomFeatureResolver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">IconURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeature&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// maybe query feature data from DB by obj.id ...?
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IconUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">roomFeatureResolver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Text&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeature&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">I18nString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// maybe query feature data from DB by obj.id ...?
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Text&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éƒ½éœ€è¦å‘ DB å–å¾— feature è³‡æ–™ã€‚&lt;/p>
&lt;p>ä½†é€™éº¼ä¸€ä¾†ï¼Œåªè¦æœ‰ n å€‹ roomsï¼Œm å€‹ featureï¼Œå°±å¾— query &lt;code>n * m * 2&lt;/code>(å–å¾— icon_url å’Œ text 2 å€‹æ¬„ä½) æ¬¡ï¼Œå—¯..éå¸¸ç†Ÿæ‚‰çš„ N+1 å•é¡Œã€‚
è¦è§£æ±ºé€™å€‹å•é¡Œï¼ŒGraphQL å®˜æ–¹æœ‰æä¾›ä¸€å€‹æ–¹æ³•ï¼Œé‚£å°±æ˜¯ä½¿ç”¨ DataLoaderã€‚&lt;/p>
&lt;h2 id="ä»€éº¼æ˜¯-dataloader">
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-dataloader" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä»€éº¼æ˜¯ Dataloaderï¼Ÿ
&lt;/h2>
&lt;p>DataLoader æ˜¯ GraphQL å®˜æ–¹æä¾›çš„ä¸€å€‹&lt;a href="https://github.com/graphql/DataLoader">å¥—ä»¶&lt;/a>ï¼Œä¸»è¦ç”¨æ–¼è§£æ±ºè³‡æ–™è¼‰å…¥æ™‚çš„æ•ˆèƒ½å•é¡Œã€‚é€éå°‡å¤šå€‹è«‹æ±‚æ”¶é›†åˆ°æ‰¹æ¬¡ä¸­ï¼Œç„¶å¾Œä¸€æ¬¡æ€§ç²å–çµæœï¼Œå¾è€Œæ¸›å°‘é‡è¤‡çš„æŸ¥è©¢æˆ–è¨ˆç®—ã€‚
å…·é«”è€Œè¨€ï¼ŒDataLoader æœ‰ä»¥ä¸‹ç‰¹é»ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>ä»¥ä¸‹æ‰€æåˆ°çš„ã€Œè«‹æ±‚ã€éƒ½æ˜¯æŒ‡åœ¨åŒä¸€å€‹ API Request ç”Ÿå‘½é€±æœŸç•¶ä¸­ï¼Œå°åŒä¸€è³‡æ–™çš„è®€å–è«‹æ±‚ã€‚&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>
&lt;p>æ‰¹æ¬¡è™•ç†ï¼šDataLoader æœƒå°‡ä¸€æ®µæ™‚é–“å…§æˆ–ä¸€å®šæ•¸é‡çš„è«‹æ±‚é€²è¡Œæ‰¹æ¬¡è™•ç†è¼‰å…¥æ•¸æ“šï¼Œä»¥æ¸›å°‘è³‡æ–™åº«çš„æŸ¥è©¢æ¬¡æ•¸å’Œè¨ˆç®—æˆæœ¬ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç·©å­˜ï¼šDataLoader å…§éƒ¨ä½¿ç”¨ç·©å­˜æ©Ÿåˆ¶ï¼Œå°‡å·²ç¶“è¼‰å…¥çš„è³‡æ–™æš«å­˜åœ¨è¨˜æ†¶é«”ä¸­ã€‚ç•¶ä¸‹æ¬¡è«‹æ±‚éœ€è¦ç›¸åŒçš„è³‡æ–™æ™‚ï¼Œå¯ä»¥ç›´æ¥å¾ç·©å­˜ä¸­è¿”å›ï¼Œé¿å…å†æ¬¡æŸ¥è©¢è³‡æ–™åº«ã€‚(ä½†é€™äº›ç·©å­˜æ•¸æ“šåªæœƒå­˜åœ¨æ–¼åŒä¸€å€‹ API Request çš„ç”Ÿå‘½é€±æœŸç•¶ä¸­ï¼Œç•¶ Request çµæŸå¾Œå°±æœƒè¢«æ¸…é™¤)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é¿å…é‡è¤‡è¼‰å…¥ï¼šDataLoader æœƒç¢ºä¿åŒä¸€å€‹è³‡æ–™åªè¢«è¼‰å…¥ä¸€æ¬¡ï¼Œå³ä½¿åŒä¸€æ™‚é–“æœ‰å¤šå€‹è«‹æ±‚è¦æ±‚è¼‰å…¥ç›¸åŒçš„è³‡æ–™ï¼Œä¹ŸåªæœƒåŸ·è¡Œä¸€æ¬¡è¼‰å…¥æ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ä½†å› ç‚ºå®˜æ–¹å¥—ä»¶åªæœ‰ nodejs ç‰ˆæœ¬ï¼Œå…¶ä»–èªè¨€çš„è©±å®˜æ–¹æ˜¯è¡¨ç¤ºç•™çµ¦é–‹ç™¼è€…å€‘è‡ªå·±å»å¯¦ç¾&amp;hellip;&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>&amp;ldquo;DataLoader is provided so that it may be useful not just to build GraphQL services for Node.js but also as a publicly available reference implementation of this concept in the hopes that it can be ported to other languages.â€œ&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;p>ç•¶ç„¶ä½¿ç”¨ Golang çš„æˆ‘å€‘å¾ˆå¹¸é‹åœ°é‚„æ˜¯å¯ä»¥ç¹¼çºŒç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œåœ¨ gqlgenï¼ˆä¸€å€‹æä¾›å¿«é€Ÿæ­å»º GraphQL Server çš„å¥—ä»¶ï¼‰çš„æ–‡ä»¶ç•¶ä¸­ï¼Œå°±ç›´æ¥ç«¯å‡ºäº†é€™å€‹ Golang ç‰ˆæœ¬çš„å¥—ä»¶ï¼š&lt;a href="https://github.com/graph-gophers/DataLoader">graph-gophers/DataLoader&lt;/a>ã€‚æ‰€ä»¥ä¸‹æ‰€è¨è«–çš„ä½¿ç”¨æ–¹æ³•ä»¥åŠåŸå§‹ç¢¼ï¼Œéƒ½æ˜¯æœƒä»¥é€™å€‹å¥—ä»¶çš„å…§å®¹ç‚ºä¸»ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨-dataloader">
&lt;a href="#%e4%bd%bf%e7%94%a8-dataloader" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä½¿ç”¨ Dataloader
&lt;/h2>
&lt;p>é‚£éº½å°±ä¾†é€é DataLoader å¯¦ç¾æˆ‘å€‘çš„éœ€æ±‚å§ï¼&lt;/p>
&lt;p>é æœŸé”åˆ°çš„æ•ˆæœæ˜¯ï¼š&lt;strong>å°‡ Query ç•¶ä¸­æ‰€æœ‰ rooms.features çš„ id éƒ½æœé›†èµ·ä¾†ï¼Œä¸€æ¬¡å‘è³‡æ–™åº«ç™¼é€æŸ¥è©¢ï¼Œå–å¾—æ‰€æœ‰ feature è³‡æ–™å¾Œï¼Œå°‡å…¶æš«å­˜åœ¨è¨˜æ†¶é«”ï¼Œç•¶éœ€è¦ç‰¹å®š id çš„ feature è³‡æ–™æ™‚ä¾¿å¾ä¸­å–å‡ºå›å‚³ã€‚&lt;/strong>&lt;/p>
&lt;p>é›–ç„¶ä½¿ç”¨æ–¹å¼åœ¨å‰›å‰›æåˆ°çš„ gqlgen &lt;a href="https://gqlgen.com/reference/dataloaders/">å®˜æ–¹æ–‡ä»¶æ‰€æä¾›çš„ç¯„ä¾‹&lt;/a>ç•¶ä¸­éƒ½å·²ç¶“å¯«å¾—å¾ˆæ¸…æ¥šï¼Œä½†ä¸‹é¢é‚„æ˜¯æœƒå®Œæ•´å‘ˆç¾ï¼Œè£œå……ç•¶ä¸­å¹¾å€‹æ–¹æ³•è·Ÿåƒæ•¸çš„é—œä¿‚ï¼Œä»¥ä¾¿åœ¨å¾ŒçºŒçš„åŸå§‹ç¢¼é–±è®€ä¸­å¯ä»¥æ›´å®¹æ˜“ç†è§£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// my_repo/graph/storage/storage.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">storage&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ctxKey&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loadersKey&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">ctxKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dataloaders&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">FeatureReader&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featureRepo&lt;/span> &lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FeatureRepository&lt;/span> &lt;span class="c1">// å°‡å‘DBæŸ¥è©¢çš„éƒ¨åˆ†å°è£åˆ° Repository ç•¶ä¸­
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¯¦éš›ä¸Šæœƒè¢« dataloader æ‰€å‘¼å«ï¼Œç”¨ä¾†ä¸€æ¬¡å–å¾—æ‰€æœ‰ features çš„æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// é€™é‚Šçš„åƒæ•¸ keys çš„ä¾†æºæ˜¯ä¸‹æ–¹å¦ä¸€å€‹åŒåçš„è‡ªå®šç¾©æ–¹æ³•ç•¶ä¸­ï¼Œå‘¼å«äº† dataloader çš„ Load æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è€Œ Load æ–¹æ³•éƒ½æœƒæ¥æ”¶ä¸€å€‹ key åƒæ•¸
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç•¶æœé›†å®Œæˆæ‰€æœ‰çš„ keys å¾Œå°±æœƒè¢«å‚³é€²é€™é‚Šä¾†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">FeatureReader&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">keys&lt;/span> &lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Keys&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featuresIDs&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">ix&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">keys&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featureID&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Atoi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featuresIDs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">ix&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">featureID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featuresById&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">u&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">featureRepo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetFeaturesByIDs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featuresIDs&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å¯¦éš›å‘DBå–è³‡æ–™çš„æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¿…é ˆå°‡è³‡æ–™çš„é †åºæŒ‰ç…§ keys çš„é †åºæ’åˆ—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">output&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">keys&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureKey&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">keys&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">feature&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">featuresById&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">featureKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">()]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">output&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">feature&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Error&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;feature not found %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureKey&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">output&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Error&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">output&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Loaders&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">FeatureLoader&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Loader&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¾…æœƒæœƒåœ¨ä¸»ç¨‹å¼è£é¢å‘¼å«ï¼Œå¯¦ä¾‹åŒ–æ‰€æœ‰ loaders ä»¥ä¾¿å‚³å…¥ middleware ç•¶ä¸­
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewLoaders&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">MySqlFeatureRepository&lt;/span> &lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FeatureRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loaders&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featureReader&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">FeatureReader&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">featureRepo&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">MySqlFeatureRepository&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loaders&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Loaders&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//æ–°å¢ä¸€å€‹ Loader ä¸¦å‚³å…¥è‡ªå®šç¾©çš„æ‰¹æ¬¡è™•ç†æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">FeatureLoader&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewBatchedLoader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">featureReader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetFeature&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">loaders&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// é€é middleware å°‡ loaders æ³¨å…¥åˆ° context è£é¢
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä»¥åˆ©å…¶ä»–åœ°æ–¹å¯ä»¥é€éåŒä¸€å€‹ ctx ç‰©ä»¶å–å¾— loaderï¼ˆä¸€å€‹ API Request ç•¶ä¸­æœƒæœ‰ä¸€å€‹ ctx ç‰©ä»¶ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Middleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loaders&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loaders&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HandlerFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">nextCtx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Context&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">loadersKey&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">loaders&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">r&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithContext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nextCtx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">next&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å°‡ loaders å¾ context ç•¶ä¸­å–å‡ºçš„ helper method
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">For&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Loaders&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">loadersKey&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Loaders&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æœƒåœ¨ resolver ç•¶ä¸­è¢«å‘¼å«ï¼Œåªè¦å‚³å…¥ feature id å°±æœƒå›å‚³åœ¨ dataloader ç•¶ä¸­æº–å‚™å¥½çš„å°æ‡‰è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureID&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeatureWithData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">loaders&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">For&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€™é‚Šæ‰€å‚³å…¥ Load çš„ç¬¬äºŒå€‹åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è‡ªå®šç¾©æ–¹æ³• FeatureReader.GetFeature è¨»è§£ç•¶ä¸­æ‰€æåˆ°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ¯å€‹å‚³é€² Load çš„ç¬¬äºŒå€‹åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯ key
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// éƒ½æœƒè¢«æœé›†ä¸‹ä¾†ï¼Œç›´åˆ°æ‰€æœ‰ keys æœé›†å®Œç•¢å¾Œï¼Œå°±æœƒè§¸ç™¼ FeatureReader.GetFeature æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸¦å°‡æ‰€æœ‰æœé›†çš„ keys å‚³å…¥è©²æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">thunk&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">loaders&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FeatureLoader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dataloader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StringKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">featureID&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="c1">// ç•™æ„ key å¿…é ˆç‚ºå­—ä¸²é¡å‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">thunk&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeatureWithData&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ï¼Œåˆ° resolver ç•¶ä¸­ï¼Œå°‡å–å¾—è³‡æ–™çš„é‚è¼¯æ”¹æˆå‘¼å« &lt;code>stroage.GetFeature&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">roomFeatureResolver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">IconURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeature&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IconUrl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">roomFeatureResolver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Text&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">obj&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoomFeature&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">I18nString&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetFeature&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">obj&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ID&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Text&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾Œåœ¨ä¸»ç¨‹å¼ç•¶ä¸­ï¼ˆæˆ–æ˜¯å®šç¾©è·¯ç”±çš„æª”æ¡ˆï¼‰ï¼ŒåŠ ä¸Š middlerwareï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">router&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ¯æ¬¡ request éƒ½æœ‰è‡ªå·±çš„ dataloader
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Middleware&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewLoaders&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">featureRepo&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‡³æ­¤ï¼Œä¸ç®¡å¾€å¾Œç¸½å…±æœ‰å¹¾å€‹ featuresï¼Œéƒ½åªæœƒåŸ·è¡Œä¸€æ¬¡çš„è³‡æ–™åº«æŸ¥è©¢ï¼Œè§£æ±ºäº† N+1 å•é¡Œã€‚
ç¤™æ–¼ç¯‡å¹…æœ‰é»å¤ªé•·ï¼Œæƒ³èªªæ‹†æˆä¸Šä¸‹å…©ç¯‡æ¯”è¼ƒå¥½é–±è®€ï¼Œæ‰€ä»¥åˆ†æ Dataloader åŸå§‹ç¢¼çš„éƒ¨åˆ†ï¼Œå°±ç•™åˆ°&lt;a href="/posts/golang-graphql-dataloader-2/">ä¸‹ä¸€ç¯‡&lt;/a>äº†ï½&lt;/p></description></item><item><title>Golang çš„è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦ Part 2 - ä½¿ç”¨ Testcontainers</title><link>/posts/golang-database-testing-with-testcontainer/</link><pubDate>Wed, 17 May 2023 15:43:34 +0800</pubDate><guid>/posts/golang-database-testing-with-testcontainer/</guid><description>
&lt;h2 id="å‰è¨€">
&lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰è¨€
&lt;/h2>
&lt;p>ä¸Šä¸€ç¯‡æ–‡ç«  &lt;a href="/posts/golang-database-testing/">Golang è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦&lt;/a> ç•¶ä¸­æåˆ°äº†åœ¨ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«ä½œç‚ºæ¸¬è©¦è³‡æ–™åº«æ™‚ï¼Œé‚„å¯ä»¥ä½¿ç”¨ &lt;a href="https://golang.testcontainers.org/">testcontainers&lt;/a> è®“æˆ‘å€‘èƒ½å¤ åœ¨æ¸¬è©¦ç•¶ä¸­ç›´æ¥æ“ä½œ Docker Containerï¼Œå»å»ºç«‹æ¸¬è©¦æ™‚éœ€è¦çš„è³‡æ–™åº«ç’°å¢ƒã€‚é€™æ¨£ä¸€ä¾†ï¼Œä¹Ÿä¸ç”¨åƒä¸€é–‹å§‹é‚£æ¨£ï¼Œå¾—å¦å¤–æ‰‹å‹•é…ç½®ä¸€å€‹å°ˆé–€æ‹¿ä¾†è·‘æ¸¬è©¦ç”¨çš„è³‡æ–™åº«ï¼Œå°‡æ¸¬è©¦æ•´åˆåˆ° CI/CD æµç¨‹ä¸Šæ™‚ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ã€‚&lt;/p>
&lt;p>&lt;small> ç„¶å¾Œæ‡‰è©²æ˜¯ä¸æœƒæœ‰ Part 3 å•¦ã€‚ &lt;/small>&lt;/p>
&lt;h2 id="testcontainers-ç°¡ä»‹">
&lt;a href="#testcontainers-%e7%b0%a1%e4%bb%8b" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Testcontainers ç°¡ä»‹
&lt;/h2>
&lt;p>&lt;a href="https://golang.testcontainers.org/">Testcontainers&lt;/a> ç‚ºå¤šç¨®èªè¨€æä¾›å¥—ä»¶ï¼ˆGolangã€Javaã€Python ç­‰ç­‰ï¼‰ï¼Œé–‹ç™¼äººå“¡å¯ä»¥é€éè©²å¥—ä»¶æ‰€æä¾›çš„ APIï¼Œåœ¨ç¨‹å¼ç•¶ä¸­å»ºç«‹å’Œæ¸…é™¤åŸºæ–¼å®¹å™¨çš„ä¾è³´é …ï¼Œä»¥é€²è¡Œè‡ªå‹•åŒ–æ•´åˆæ¸¬è©¦ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å°±å»¶çºŒä½¿ç”¨ä¸Šç¯‡æ–‡ç« ç•¶ä¸­çš„ç¯„ä¾‹ï¼ŒæŠŠå®ƒæ”¹æˆä½¿ç”¨ Testcontainers çš„ç‰ˆæœ¬å§ï¼&lt;/p>
&lt;h2 id="ä½¿ç”¨-testcontainers">
&lt;a href="#%e4%bd%bf%e7%94%a8-testcontainers" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä½¿ç”¨ Testcontainers
&lt;/h2>
&lt;h3 id="requirement">
&lt;a href="#requirement" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Requirement
&lt;/h3>
&lt;p>é¦–å…ˆå¿…é ˆå…ˆç¢ºä¿ç’°å¢ƒç•¶ä¸­æœ‰å®‰è£ Dockerï¼Œç‹€æ…‹ç‚º runningï¼Œä¸”ä½¿ç”¨è€…è¦æœ‰æ¬Šé™å¯ä»¥åŸ·è¡Œ docker æŒ‡ä»¤ã€‚
ä¸åŒçš„ä½œæ¥­ç³»çµ±æœƒæœ‰ä¸åŒçš„å»ºè­°ç‰ˆæœ¬å’Œæ³¨æ„äº‹é …ï¼Œå¯ä»¥åƒè€ƒ&lt;a href="https://www.testcontainers.org/supported_docker_environment/">å®˜æ–¹æ–‡ä»¶&lt;/a>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>note: åŸæœ¬åœ¨ local è·‘ï¼Œé›»è…¦æ˜¯ Mac åˆæ˜¯ M1 æ™¶ç‰‡ï¼Œé‡åˆ°ä¸€å †ç’°å¢ƒå•é¡Œå¿«è¢«æç˜‹ï¼Œå¾Œä¾†ç´¢æ€§æ”¾æ£„ï¼Œæ”¹æˆåœ¨ linux ä¸»æ©Ÿä¸Šé¢è·‘å°±éƒ½ä¸€åˆ‡æ­£å¸¸QQ&lt;/p>
&lt;/blockquote>
&lt;h3 id="å®‰è£-testcontainers-for-go-åŒ…">
&lt;a href="#%e5%ae%89%e8%a3%9d-testcontainers-for-go-%e5%8c%85" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å®‰è£ Testcontainers for Go åŒ…
&lt;/h3>
&lt;pre tabindex="0">&lt;code>go get github.com/testcontainers/testcontainers-go
&lt;/code>&lt;/pre>&lt;h3 id="å®‰è£-mysql-module-åŒ…">
&lt;a href="#%e5%ae%89%e8%a3%9d-mysql-module-%e5%8c%85" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å®‰è£ MySql Module åŒ…
&lt;/h3>
&lt;p>ç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ MariaDB ç‚º MySql æ—ç³»è¡€è¦ªï¼Œæ‰€ä»¥å¯ä»¥å®‰è£å®˜æ–¹æä¾›çš„ &lt;a href="https://golang.testcontainers.org/modules/mysql/">MySql Module åŒ…&lt;/a>ï¼Œç›´æ¥ç”¨åŒ…æä¾›çš„ API å¯ä»¥å†å¤šçœä¸‹ä¸€äº›ç¨‹å¼ç¢¼ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>go get github.com/testcontainers/testcontainers-go/modules/mysql
&lt;/code>&lt;/pre>&lt;h3 id="èª¿æ•´ç¨‹å¼ç¢¼">
&lt;a href="#%e8%aa%bf%e6%95%b4%e7%a8%8b%e5%bc%8f%e7%a2%bc" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
èª¿æ•´ç¨‹å¼ç¢¼
&lt;/h3>
&lt;p>ä¸Šå›æˆ‘å€‘å°‡é‡ç½®è³‡æ–™åº«çš„æ­¥é©Ÿæ”¾åœ¨ suite çš„ setup ç•¶ä¸­ï¼Œé‚£æˆ‘å€‘å‹¢å¿…å¾—åœ¨é€™å€‹å‹•ä½œä¹‹å‰å…ˆæº–å‚™å¥½è³‡æ–™åº«ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆæŠŠ MariaDB container èµ·èµ·ä¾†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="hl">&lt;span class="lnt">10
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">11
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">12
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">13
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">14
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">15
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">16
&lt;/span>&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="hl">&lt;span class="lnt">20
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">21
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">22
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">23
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">24
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">25
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">26
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">27
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">28
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">29
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">30
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">31
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">32
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">33
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">34
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">35
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">36
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">37
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">38
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">39
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">40
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">41
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">42
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">43
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">44
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">45
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">46
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">47
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">48
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">49
&lt;/span>&lt;/span>&lt;span class="hl">&lt;span class="lnt">50
&lt;/span>&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/testcontainers/testcontainers-go&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/testcontainers/testcontainers-go/wait&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">testcontainermysql&lt;/span> &lt;span class="s">&amp;#34;github.com/testcontainers/testcontainers-go/modules/mysql&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ·»åŠ äº†å¹¾å€‹å±¬æ€§åˆ° struct è£¡é¢
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">MysqlRepoTestSuite&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suite&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">dbUser&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">dbPassword&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">dbName&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">dbHost&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">dbPort&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">mariadbC&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testcontainermysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MySQLContainer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MysqlRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetupSuite&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="c1">// ------é–‹å§‹å•Ÿå‹• container çš„ä½œæ¥­------
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">mariadbC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">testcontainermysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RunContainer&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">testcontainers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithImage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;mariadb:10.5&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">testcontainermysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithPassword&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dbPassword&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">testcontainermysql&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithDatabase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dbName&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">testcontainers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithWaitStrategy&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">wait&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ForLog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;mysqld: ready for connections.&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nf">WithOccurrence&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nf">WithStartupTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Minute&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to start MariaDB container: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mariadbC&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Host&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å–å¾— container çš„ host
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to get MariaDB container host: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="c1">// å°‡ container 3306 port æ˜ å°„åˆ°ä¸»æ©Ÿä¸Šï¼Œä¸¦å–å¾—æ˜ å°„åˆ°ä¸»æ©Ÿä¸Šçš„ port
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// (ç­‰åŒä¸‹ docker run æŒ‡ä»¤æ™‚çš„ -P {ä¸»æ©Ÿport}:{container port} æ“ä½œ)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">mappedPort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">mariadbC&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MappedPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;3306/tcp&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">container&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">mariadbC&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Itoa&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mappedPort&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Failed to get MariaDB container port: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">freshDatabase&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‚³å…¥ &lt;code>testcontainermysql.RunContainer()&lt;/code> çš„åƒæ•¸é™¤äº† ctx ä¹‹å¤–éƒ½æ˜¯é¸å¡«ï¼Œåˆ†åˆ¥è§£é‡‹ä¸Šé¢å‚³å…¥å„å€‹åƒæ•¸çš„æ„ç¾©ï¼š&lt;/p>
&lt;h5 id="testcontainerswithimagemariadb105">
&lt;a href="#testcontainerswithimagemariadb105" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>testcontainers.WithImage(&amp;quot;mariadb:10.5&amp;quot;)&lt;/code>
&lt;/h5>
&lt;p>æŒ‡å®šä½¿ç”¨ mariadb 10.5 ç‰ˆæœ¬çš„ docker imageï¼ˆä¸å‚³å…¥è©²åƒæ•¸çš„è©±ï¼Œé è¨­æœƒæŠ“å– mysql:8 çš„ docker imageï¼‰&lt;/p>
&lt;h5 id="testcontainermysqlwithpasswordsuitedbpassword">
&lt;a href="#testcontainermysqlwithpasswordsuitedbpassword" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>testcontainermysql.WithPassword(suite.dbPassword)&lt;/code>
&lt;/h5>
&lt;p>æŒ‡å®šå•Ÿå‹• container æ™‚å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸ &lt;code>MYSQL_PASSWORD&lt;/code>ï¼ˆä¸å‚³å…¥çš„é è¨­å€¼æ˜¯ &lt;code>test&lt;/code>ï¼‰&lt;/p>
&lt;h5 id="testcontainermysqlwithdatabasesuitedbname">
&lt;a href="#testcontainermysqlwithdatabasesuitedbname" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>testcontainermysql.WithDatabase(suite.dbName)&lt;/code>
&lt;/h5>
&lt;p>æŒ‡å®šå•Ÿå‹• container æ™‚å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸ &lt;code>MYSQL_DATABASE&lt;/code>ï¼Œå»ºç«‹ä¸€å€‹åç‚º &lt;code>suite.dbName&lt;/code>(è®Šæ•¸) çš„ databaseï¼ˆä¸å‚³å…¥çš„é è¨­å€¼æ˜¯ &lt;code>test&lt;/code>ï¼‰&lt;/p>
&lt;h5 id="testcontainerswithwaitstrategywaitforlogmysqld-ready-for-connectionswithoccurrence2withstartuptimeout2timeminute">
&lt;a href="#testcontainerswithwaitstrategywaitforlogmysqld-ready-for-connectionswithoccurrence2withstartuptimeout2timeminute" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>testcontainers.WithWaitStrategy(wait.ForLog(&amp;quot;mysqld: ready for connections.&amp;quot;).WithOccurrence(2).WithStartupTimeout(2*time.Minute))&lt;/code>
&lt;/h5>
&lt;p>ç”±æ–¼ä¸‹å»ºç«‹ container çš„æŒ‡ä»¤ä¹‹å¾Œï¼Œéœ€ç­‰å¾… container å®Œå…¨å•Ÿå‹•ï¼Œæ‰èƒ½ä¿è­‰å¾ŒçºŒçš„ä½¿ç”¨å¯ä»¥æ­£å¸¸åœ°é€£æ¥ä¸Š containerï¼Œå› æ­¤é€™å€‹åƒæ•¸æ˜¯è®“æˆ‘å€‘å¯ä»¥è¨­å®šç­‰å¾…çš„ç­–ç•¥ã€‚åˆ†åˆ¥è§£é‡‹éˆçš„å„å€‹æ–¹æ³•æ„ç¾©ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>wait.ForLog()&lt;/code>ï¼šç¨‹å¼æœƒè¢« blocking ä½ï¼Œç›´åˆ° container ç•¶ä¸­ç‰¹å®šçš„ log å‡ºç¾å¾Œï¼Œæ‰ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œ&lt;/li>
&lt;li>&lt;code>WithOccurrence()&lt;/code>ï¼šæŒ‡å®š log å¿…é ˆå‡ºç¾çš„æ¬¡æ•¸&lt;/li>
&lt;li>&lt;code>WithStartupTimeout()&lt;/code>ï¼šæŒ‡å®šç­‰å¾…çš„è¶…æ™‚æ™‚é–“&lt;/li>
&lt;/ul>
&lt;p>ç”¨äººè©±ä¾†ç¸½çµé€™ä¸€è¡Œçš„æ“ä½œï¼š ç­‰å¾… log ç•¶ä¸­å‡ºç¾ &lt;code>mysqld: ready for connections.&lt;/code>é€™æ®µæ–‡å­— &lt;code>2&lt;/code> æ¬¡ä¹‹å¾Œæ‰ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Œå¦‚æœ &lt;code>2&lt;/code> åˆ†é˜ä¹‹å…§æ²’ç­‰åˆ°çš„è©±å°±è·³ timeout éŒ¯èª¤ã€‚&lt;/p>
&lt;p>æ¥è‘—ï¼Œå°±æ˜¯è¦è¨˜å¾—åœ¨ suite çš„ teardown ç•¶ä¸­ï¼Œé—œé–‰ container é‡‹æ”¾è³‡æºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MysqlRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TearDownSuite&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mariadbC&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Terminate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€å¾Œå°±å¯ä»¥ä¾†è·‘çœ‹çœ‹æ¸¬è©¦äº†ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>go test
&lt;/code>&lt;/pre>&lt;p>&lt;img loading="lazy"
src="/images/testcontainer-go.png"
alt="database-testing-in-golang"
width=1474
height="656" />
æˆåŠŸå›‰ğŸ‰&lt;/p>
&lt;h2 id="å°çµ">
&lt;a href="#%e5%b0%8f%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å°çµ
&lt;/h2>
&lt;p>å…¶å¯¦ä½¿ç”¨çš„æ–¹å¼æ»¿ç°¡æ˜“çš„ï¼Œæ¦‚å¿µä¸Šä¹Ÿä¸é›£ï¼Œå°±æ˜¯åœ¨ setup ç•¶ä¸­æœ€ä¸€é–‹å§‹å¤šä¸€å€‹ã€Œå•Ÿå‹•è³‡æ–™åº« Server çš„ Docker Containerã€ä»¥åŠæœ€å¾Œ teardown æ™‚ã€Œé—œé–‰ containerã€çš„æ­¥é©Ÿè€Œå·²ï¼Œå¾Œé¢å°±å¯ä»¥ç¹¼çºŒåŸæœ¬çš„æµç¨‹(é‡ç½®è³‡æ–™åº«ã€é–‹å•Ÿé€£ç·š&amp;hellip;ç­‰ç­‰)ï¼Œä½†æ¯”è¼ƒæœƒé‡åˆ°å•é¡Œçš„éƒ¨åˆ†å¯èƒ½æœƒæ˜¯åœ¨ç’°å¢ƒé…ç½®ä»¥åŠ API çš„ä½¿ç”¨ï¼Œå› ç‚ºå®˜æ–¹æ–‡ä»¶çš„ç¯„ä¾‹éƒ½æ²’æœ‰åˆ°å¾ˆå®Œæ•´ï¼Œä½¿ç”¨æ™‚æœƒéœ€è¦æ‘¸ç´¢ä¸€é™£å­ï¼Œå› æ­¤æ‰ç‰¹åˆ¥å¯«ä¸€ç¯‡ç­†è¨˜è¨˜éŒ„ã€‚&lt;/p>
&lt;p>æœ€å¾Œé™„ä¸Šå®Œæ•´çš„ç¨‹å¼ç¢¼ç¯„ä¾‹ï¼š
&lt;a href="https://gist.github.com/linxinemily/276905e0145218538cb0be3a79a36153">https://gist.github.com/linxinemily/276905e0145218538cb0be3a79a36153&lt;/a>&lt;/p></description></item><item><title>Golang çš„è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦</title><link>/posts/golang-database-testing/</link><pubDate>Sun, 23 Apr 2023 00:00:00 +0000</pubDate><guid>/posts/golang-database-testing/</guid><description>
&lt;p>&lt;img loading="lazy"
src="/images/golang-database-testing-1.png"
alt="database-testing-in-golang"
width=1243
height="654" />&lt;/p>
&lt;h2 id="tldr">
&lt;a href="#tldr" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
TL;DR
&lt;/h2>
&lt;p>æœ¬æ–‡è¨˜éŒ„äº†æ¢ç´¢åœ¨ Golang ç•¶ä¸­æ’°å¯«è³‡æ–™åº«æ•´åˆæ¸¬è©¦çš„éç¨‹åŠæ–¹æ³•ã€‚åŒ…å«å¹¾å€‹é‡é»çš„è¨è«–ï¼š&lt;/p>
&lt;ol>
&lt;li>é€²è¡Œè³‡æ–™åº«æ¸¬è©¦æ™‚ï¼Œè©²ä½¿ç”¨çœŸå¯¦çš„æ¸¬è©¦è³‡æ–™åº«æˆ–æ˜¯æ¸¬è©¦æ›¿èº«(Test Double)ï¼Ÿ&lt;/li>
&lt;li>ä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«çš„è©±ï¼Œè©²å¦‚ä½•é‡ç½®è³‡æ–™åº«ç‹€æ…‹ï¼Œæ‰èƒ½é¿å…ä¸åŒæ¸¬è©¦æ–¹æ³•ä¹‹é–“çš„è³‡æ–™ç›¸äº’å½±éŸ¿ï¼Ÿ&lt;/li>
&lt;li>æœ€å¾Œæä¾›è®“ä¸åŒæ¸¬è©¦æ–¹æ³•ä¹‹é–“è³‡æ–™ä¸äº’ç›¸å½±éŸ¿ï¼Œä¸¦èƒ½å¹³è¡Œè·‘æ¸¬è©¦çš„å¯¦ä½œæ–¹æ³•&lt;/li>
&lt;/ol>
&lt;h2 id="å‰è¨€">
&lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰è¨€
&lt;/h2>
&lt;p>æœ‰ç¶“é©—çš„å·¥ç¨‹å¸«éƒ½çŸ¥é“å¯«æ¸¬è©¦å°æ–¼è»Ÿé«”é–‹ç™¼çš„é‡è¦æ€§ï¼Œè€Œç•¶ä¸­æœ€åŸºæœ¬çš„å°±æ˜¯å–®å…ƒæ¸¬è©¦ã€‚ç‹¹ç¾©æˆ–è€…èªªæ¯”è¼ƒåš´æ ¼å®šç¾©çš„å–®å…ƒæ¸¬è©¦ï¼Œå¦‚æœä»¥ Clean Architechture çš„è§€é»ä¾†çœ‹ï¼Œé€šå¸¸æ˜¯é‡å° Domain Layer ä»¥åŠ Application(Use Case) Layer ï¼Œä¹Ÿå°±æ˜¯ä¸æ¶‰åŠå¤–éƒ¨æœå‹™æˆ–å¥—ä»¶/æ¶ç­‰ç­‰çš„æ¸¬è©¦ã€‚ä½†å°æ–¼ä¸€äº›å°å‹å°ˆæ¡ˆä¾†èªªï¼ŒDomain é‚è¼¯é€šå¸¸ä¸å¤šï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å°è³‡æ–™åº«çš„ CRUD æ“ä½œï¼Œåˆæˆ–è€…ä½¿ç”¨çš„æ¡†æ¶åŸæœ¬å°±æŠŠ ORM è·Ÿ Model ç¶æ­»åœ¨ä¸€èµ·ï¼Œæ¡†æ¶æä¾›çš„æ¸¬è©¦é›†æˆ API ä¹Ÿæ˜¯ç›´æ¥é è¨­å¥½å°çœŸå¯¦è³‡æ–™åº«çš„é€£æ¥ï¼Œæ•´å€‹å°ˆæ¡ˆå¯èƒ½å¹¾ä¹æ²’æœ‰å¹¾å€‹ç‹¹ç¾©çš„å–®å…ƒæ¸¬è©¦äº†ã€‚&lt;/p>
&lt;p>ä¸éç¡¬æ˜¯è¦ç•«åˆ†å‡ºå–®å…ƒæ¸¬è©¦æˆ–è€…æ•´åˆæ¸¬è©¦å…¶å¯¦æ²’ä»€éº¼æ„ç¾©ï¼Œé€™é‚Šåªæ˜¯æƒ³è¦ç¨å¾®é»å‡ºä¸€é“ç¾å¯¦ï¼Œåœ¨å’Œè³‡æ–™åº«é«˜åº¦æ›é‰¤æˆ–è€…æ‰€è¬‚è³‡æ–™å¯†é›†å‹çš„æœå‹™åº•ä¸‹ï¼Œè³‡æ–™åº«æ¸¬è©¦å‹¢å¿…æ˜¯æ¥µé‡è¦çš„ä¸€ç’°ã€‚&lt;/p>
&lt;p>ç„¶è€Œåœ¨ Golang ç•¶ä¸­ï¼Œä¸¦æ²’æœ‰åƒæ˜¯ Spring Boot or Laravel é€™ç¨®åŒ…å±±åŒ…æµ·çš„æ¡†æ¶ï¼ˆä¼¼ä¹ä¹Ÿä¸å¤ªå¯èƒ½å‡ºç¾ï¼Œç•¢ç«Ÿé•åäº† Golang çš„è¨­è¨ˆå“²å­¸ï¼‰ï¼Œæ¸¬è©¦çš„éƒ¨åˆ†ï¼Œé›–ç„¶æ¨™æº–åº«æœ‰æä¾›ä¸€å€‹&lt;a href="https://pkg.go.dev/testing">æ¸¬è©¦å¥—ä»¶&lt;/a>ï¼Œä½†åƒ…æ˜¯å°æ–¼å–®å…ƒæ¸¬è©¦ä»¥åŠæ€§èƒ½æ¸¬è©¦çš„è¼”åŠ©ï¼Œè‡³æ–¼è³‡æ–™åº«æ¸¬è©¦ï¼Ÿå¾—è‡ªå·±æƒ³è¾¦æ³•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é‚„æ˜¯å¯ä»¥æ‰¾å¾—åˆ°å°æ–¼è³‡æ–™åº«æ¸¬è©¦çš„è¼”åŠ©å¥—ä»¶ï¼Œä½†å› çˆ²æ³›ç”¨æ€§æ²’æœ‰åˆ°éå¸¸å»£ï¼Œä¸”å¯¦ç¾è³‡æ–™åº«æ¸¬è©¦çš„æ–¹æ³•å…¶å¯¦ä¹Ÿä¸¦ä¸é›£ï¼Œæ‰€ä»¥å°±æ²’æœ‰ç‰¹åˆ¥å»ä½¿ç”¨ï¼Œé€™é‚Šä¹Ÿä¸å¤šåŠ ä»‹ç´¹ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="æƒ…å¢ƒæ¦‚è¿°">
&lt;a href="#%e6%83%85%e5%a2%83%e6%a6%82%e8%bf%b0" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
æƒ…å¢ƒæ¦‚è¿°
&lt;/h2>
&lt;p>åƒè€ƒ Clean Architecture çš„æ¶æ§‹ï¼Œå°ˆæ¡ˆç•¶ä¸­æœ‰åŠƒåˆ† Domainã€Applicationã€Adapter ä»¥åŠ Port Layerã€‚è€Œåœ¨ Domain Layer ç•¶ä¸­æˆ‘å€‘å®šç¾©äº† &lt;code>UniqidRepository&lt;/code> ä»‹é¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//domain layer
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">UniqidRepository&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">GetUniqidsWithDevicesFilterByUniqId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">uniqid&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Uniqid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™å€‹ä»‹é¢æœƒç”± Adapter Layer ç•¶ä¸­ä¸åŒçš„ Repository å»å¯¦ä½œï¼Œåœ¨é€™é‚Šæˆ‘å€‘å®šç¾©ä¸€å€‹ &lt;code>PostgresUniqidRepository&lt;/code> ï¼Œå¯¦ç¾ &lt;code>UniqidRepository&lt;/code> ä»‹é¢ï¼Œä¸¦ä¸”å…§åµŒä¸€å€‹è³‡æ–™åº«é€£ç·šç‰©ä»¶(ä½¿ç”¨ äº† gorm æä¾›çš„ struct)ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">PostgresUniqidRepository&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">u&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresUniqidRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">GetUniqidsWithDevicesFilterByUniqId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">uniqid&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Uniqid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// to retrieve data from DB by GORM...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">uniqids&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="è³‡æ–™åº«æ¸¬è©¦çš„é¸æ“‡æ¸¬è©¦æ›¿èº«-vs-çœŸå¯¦è³‡æ–™åº«">
&lt;a href="#%e8%b3%87%e6%96%99%e5%ba%ab%e6%b8%ac%e8%a9%a6%e7%9a%84%e9%81%b8%e6%93%87%e6%b8%ac%e8%a9%a6%e6%9b%bf%e8%ba%ab-vs-%e7%9c%9f%e5%af%a6%e8%b3%87%e6%96%99%e5%ba%ab" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è³‡æ–™åº«æ¸¬è©¦çš„é¸æ“‡ï¼šæ¸¬è©¦æ›¿èº« VS çœŸå¯¦è³‡æ–™åº«
&lt;/h2>
&lt;p>ç‚ºäº†è¦æ’°å¯« &lt;code>PostgresUniqidRepository&lt;/code> çš„æ¸¬è©¦ï¼Œæˆ‘å€‘æœƒéœ€è¦ä¾è³´ä¸€å€‹ &lt;code>db&lt;/code> ç‰©ä»¶ï¼Œé‚£é€™æ™‚å€™æ‡‰è©²é€£æ¥ä¸€å€‹çœŸå¯¦çš„æ¸¬è©¦è³‡æ–™åº«ï¼Œé‚„æ˜¯ä½¿ç”¨æ¸¬è©¦æ›¿èº«(Test Double)å‘¢ï¼Ÿå…ˆä¾†çœ‹çœ‹é€™å…©è€…å„è‡ªçš„å„ªç¼ºé»ï¼š&lt;/p>
&lt;h3 id="ä½¿ç”¨æ¸¬è©¦æ›¿èº«">
&lt;a href="#%e4%bd%bf%e7%94%a8%e6%b8%ac%e8%a9%a6%e6%9b%bf%e8%ba%ab" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä½¿ç”¨æ¸¬è©¦æ›¿èº«
&lt;/h3>
&lt;p>æ¸¬è©¦æ›¿èº«æ˜¯ä¸€å€‹æ¨¡æ“¬è³‡æ–™åº«è¡Œç‚ºçš„ç‰©ä»¶æˆ–ç¨‹å¼ï¼Œç”¨ä¾†æ›¿ä»£çœŸå¯¦çš„è³‡æ–™åº«é€£æ¥ã€‚æ–¹æ³•å°±æ˜¯å°‡åŸæœ¬å¯¦ä½œé€£æ¥çœŸå¯¦è³‡æ–™åº«çš„ç‰©ä»¶è—‰ç”±ä¾è³´æ³¨å…¥æŠ½æ›æˆæ¸¬è©¦æ›¿èº«ï¼ˆä¹‹æ‰€ä»¥å¯ä»¥æŠ½æ›ï¼Œé€šå¸¸æ˜¯å› ç‚ºæœ‰å®šç¾©äº†ä¸€å€‹ä»‹é¢ï¼Œä¸è«–æ˜¯é€£æ¥çœŸå¯¦è³‡æ–™åº«çš„ç‰©ä»¶æˆ–æ˜¯æ¸¬è©¦æ›¿èº«ï¼Œéƒ½æœƒå»å¯¦ç¾é€™å€‹ä»‹é¢ï¼‰é€éæ¸¬è©¦æ›¿èº«å»æ¨¡æ“¬è³‡æ–™åº«çš„è¡Œç‚ºå’Œå›å‚³å€¼ã€‚&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ Golang ç•¶ä¸­ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ SQL é¡å‹çš„è³‡æ–™åº«ï¼Œå®˜æ–¹æ¨™æº–åº«å°±æœ‰å®šç¾©äº† &lt;code>sql.DB&lt;/code> ä»‹é¢ï¼Œä¹Ÿæœ‰ç›¸é—œçš„ library åƒæ˜¯ &lt;a href="https://github.com/DATA-DOG/go-sqlmock">go-sqlmock&lt;/a> ç•¶ä¸­å°±æä¾›äº†å¯¦ç¾è©²ä»‹é¢æ–¹æ³•çš„æ¸¬è©¦æ›¿èº«ï¼Œè®“é–‹ç™¼è€…èƒ½åœ¨æ¸¬è©¦æ™‚èƒ½å¤ æª¢æŸ¥æ‰€åŸ·è¡Œçš„ SQL èªå¥æ˜¯å¦å¦‚é æœŸï¼Œä¸¦æ¨¡æ“¬è³‡æ–™åº«çš„å›å‚³å€¼ã€‚å¦‚æœæ˜¯ä½¿ç”¨å…¶ä»–é¡å‹çš„è³‡æ–™åº«ï¼Œä¾‹å¦‚ AWS çš„ DynamoDBï¼Œå…¶æä¾›çš„ client sdk ç•¶ä¸­ä¹Ÿæœ‰åŒ…æ‹¬ &lt;a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/dynamodbiface/">dynamodb ä»‹é¢&lt;/a>ï¼Œä¹Ÿæ˜¯ç›¸åŒçš„æ¦‚å¿µã€‚&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>å„ªé»ï¼š
&lt;ul>
&lt;li>æä¾›äº†è¼ƒé«˜çš„æ¸¬è©¦æ§åˆ¶ï¼Œå®¹æ˜“æ¨¡æ“¬éŒ¯èª¤æƒ…å¢ƒ(ex: æ¨¡æ“¬è³‡æ–™åº«é€£æ¥å¤±æ•—)ã€‚&lt;/li>
&lt;li>ç”±æ–¼ä¸éœ€è¦çœŸå¯¦çš„è³‡æ–™åº«é€£æ¥ï¼Œæ¸¬è©¦é€Ÿåº¦å¯èƒ½æœƒæ›´å¿«ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ç¼ºé»ï¼š
&lt;ul>
&lt;li>å¯èƒ½ç„¡æ³•å®Œå…¨æ¨¡æ“¬çœŸå¯¦è³‡æ–™åº«çš„è¡Œç‚ºï¼Œå› æ­¤æ¸¬è©¦çµæœå¯èƒ½èˆ‡å¯¦éš›é‹è¡Œæ™‚çš„è¡Œç‚ºä¸ä¸€è‡´ã€‚&lt;/li>
&lt;li>éœ€è¦é¡å¤–çš„é–‹ç™¼å’Œç¶­è­·å·¥ä½œï¼ŒåŒ…æ‹¬æ¨¡æ“¬è³‡æ–™åº«çš„è¡Œç‚ºå’Œç¶­è­·æ¸¬è©¦æ›¿èº«çš„ç‹€æ…‹ï¼Œå¯èƒ½å¢åŠ é–‹ç™¼å’Œç¶­è­·æˆæœ¬ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å‰›å‰›æœ‰æåˆ°èªªåŒ…å±±åŒ…æµ·çš„æ¡†æ¶ä¸­ï¼Œä¾‹å¦‚ Laravelï¼Œå®˜æ–¹æ˜¯æ²’æœ‰ç›´æ¥æä¾›ä½¿ç”¨æ¸¬è©¦æ›¿èº«è³‡æ–™åº«çš„é¸é …ï¼Œä¸éæœ‰ Memory è³‡æ–™åº«(sqlite)ï¼Œé€™åˆæ˜¯å¦ä¸€ç¨®è³‡æ–™åº«æ¸¬è©¦çš„é¸æ“‡ï¼Œä½†é€™é‚Šä¸ç‰¹åˆ¥ä»‹ç´¹ï¼Œæš«ä¸”æŠŠä»–æ­¸é¡åœ¨ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«çš„ç¯„ç–‡ï¼Œå› ç‚ºä¾ç„¶æ˜¯ä¾è³´å¤–éƒ¨æœå‹™ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«">
&lt;a href="#%e4%bd%bf%e7%94%a8%e7%9c%9f%e5%af%a6%e8%b3%87%e6%96%99%e5%ba%ab" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«
&lt;/h3>
&lt;p>ä¸€å€‹å¯¦éš›é‹è¡Œåœ¨ä¸»æ©Ÿæˆ–å®¹å™¨ä¸Šçš„è³‡æ–™åº«ï¼Œé€šå¸¸å°ˆé–€ for æ¸¬è©¦ç”¨ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æœ‰ç¶²å‹è£œå……ï¼Œé‚„å¯ä»¥ä½¿ç”¨åƒæ˜¯ &lt;a href="https://github.com/testcontainers/testcontainers-go">testcontainers-go&lt;/a> é€™ç¨®å·¥å…·ï¼Œè®“é–‹ç™¼è€…å¯ä»¥é€éå‘¼å«å…¶ API ä¾†ç®¡ç†å’Œä½¿ç”¨ Docker å®¹å™¨ï¼Œé€²è¡Œæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦ã€‚èƒ½å¤ åœ¨æ¸¬è©¦ç•¶ä¸­æ›´æ–¹ä¾¿åœ°ç®¡ç†è³‡æ–™åº«ä¾è³´ã€‚ä»‹ç´¹èˆ‡ç”¨æ³•å¯åƒè€ƒ&lt;a href="/posts/golang-database-testing-with-testcontainer/">ä¸‹ä¸€ç¯‡ç­†è¨˜&lt;/a>ã€‚&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>å„ªé»ï¼š
&lt;ul>
&lt;li>æä¾›æ›´æ¥è¿‘å¯¦éš›é‹è¡Œç’°å¢ƒçš„æ¸¬è©¦ï¼Œæ¸¬è©¦çµæœæ›´åŠ çœŸå¯¦å¯é ã€‚&lt;/li>
&lt;li>å¯ä»¥æ¸¬è©¦åˆ°çœŸå¯¦è³‡æ–™åº«çš„ç‰¹å®šè¡Œç‚ºã€æ•ˆèƒ½ç­‰æ–¹é¢çš„å•é¡Œï¼Œæ›´å…¨é¢åœ°é©—è­‰ç³»çµ±çš„å“è³ªã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ç¼ºé»ï¼š
&lt;ul>
&lt;li>æ¸¬è©¦çµæœå¯èƒ½å—åˆ°çœŸå¯¦è³‡æ–™åº«ç‹€æ…‹å’Œç’°å¢ƒçš„å½±éŸ¿ï¼Œè¼ƒé›£ä»¥æ§åˆ¶æ¸¬è©¦æƒ…å¢ƒã€‚&lt;/li>
&lt;li>å¯èƒ½æœƒå› ç‚ºè³‡æ–™åº«ä¸­çš„è®Šå‹•è€Œå°è‡´æ¸¬è©¦çµæœä¸ç©©å®šï¼Œåƒæ˜¯ä¸åŒæ¸¬è©¦æ¡ˆä¾‹ä¹‹é–“çš„è³‡æ–™ç›¸äº’å½±éŸ¿ï¼Œéœ€å¦å¤–é€éé©ç•¶åœ°èª¿æ•´æ¸¬è©¦é †åºã€ç·¨å¯«æ¸…ç†è…³æœ¬æˆ–ç¢ºä¿ä¸åŒæ¸¬è©¦æ¡ˆä¾‹ä½¿ç”¨è³‡æ–™çš„ç¨ç«‹æ€§ç­‰æ–¹æ³•ä¾†é¿å…ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>æ‰€ä»¥åˆ°åº•è¦ç”¨ä½¿ç”¨æ¸¬è©¦æ›¿èº«é‚„æ˜¯çœŸå¯¦è³‡æ–™åº«å‘¢ï¼Ÿ&lt;/p>
&lt;p>å›åˆ°ä¸€é–‹å§‹ç¯„ä¾‹çš„æƒ…å¢ƒï¼Œæœ‰ä¸€å€‹ Repository å°ˆé–€ç”¨ä¾†é€£æ¥ Postgres è³‡æ–™åº«ï¼ŒåŒæ™‚åˆç”¨äº† gorm é€™å€‹ ORM å¥—ä»¶åŒ…è£çœŸå¯¦çš„ SQL èªæ³•ã€‚å¦‚æœè¦ä½¿ç”¨æ¸¬è©¦æ›¿èº«çš„è©±ï¼Œå¯ä»¥å€ŸåŠ© &lt;a href="https://github.com/DATA-DOG/go-sqlmock">go-sqlmock&lt;/a> é€™å€‹å¥—ä»¶ã€‚ä½†ä»”ç´°æƒ³æƒ³ï¼Œä»¥ &lt;code>GetUniqidsWithDevicesFilterByUniqId&lt;/code> é€™å€‹æ–¹æ³•ä¾†çœ‹ï¼Œåƒ…æœ‰çš„é‚è¼¯å°±æ˜¯å–å¾—æ‰€æœ‰/è¢«éæ¿¾çš„ Uniqid è³‡æ–™è€Œå·²ï¼Œå¦‚æœåˆç”¨äº†æ¸¬è©¦æ›¿èº«ï¼Œé‚£éº½é€™å€‹æ¸¬è©¦å°±è®Šæˆåªå‰©ä¸‹æª¢æŸ¥ SQL èªæ³•æœ‰æ²’æœ‰çµ„å°ã€‚é€™æ¨£ç®—æ˜¯ä¸€å€‹æœ‰ç”¨çš„æ¸¬è©¦å—ï¼Ÿ&lt;/p>
&lt;p>ä»¥é€™å€‹é‡å° Repository æ¸¬è©¦çš„æƒ…å¢ƒè€Œè¨€ï¼Œ&lt;strong>æ˜¯å¦æœ‰ç¢ºå¯¦å¾è³‡æ–™åº«ä¸­å–å‡ºæ­£ç¢ºçš„è³‡æ–™&lt;/strong>ï¼Œæ‰æ˜¯æˆ‘å€‘çœŸæ­£æƒ³è¦é©—è­‰çš„äº‹æƒ…ã€‚å› æ­¤ï¼Œæˆ‘èªç‚ºä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æœƒæ˜¯æ¯”è¼ƒé©åˆçš„åšæ³•ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æŸ¥è©¢è³‡æ–™çš„éç¨‹ä¸­ï¼Œæœ‰çœ‹åˆ°ä¸€ç¯‡ç”± Github å·¥ç¨‹å¸«æ‰€æ’°å¯«çš„&lt;a href="https://markphelps.me/posts/writing-tests-for-your-database-code-in-go/">éƒ¨è½æ ¼æ–‡ç« &lt;/a>ï¼Œç•¶ä¸­ä¹Ÿæœ‰æåˆ°ï¼Œâ€&lt;strong>You need to actually test your SQL code.â€&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;h2 id="è³‡æ–™åº«æ•´åˆæ¸¬è©¦é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼">
&lt;a href="#%e8%b3%87%e6%96%99%e5%ba%ab%e6%95%b4%e5%90%88%e6%b8%ac%e8%a9%a6%e9%87%8d%e7%bd%ae%e8%b3%87%e6%96%99%e5%ba%ab%e7%8b%80%e6%85%8b%e7%9a%84%e6%96%b9%e5%bc%8f" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è³‡æ–™åº«æ•´åˆæ¸¬è©¦ï¼šé‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼
&lt;/h2>
&lt;p>å¦‚æœè¦é€²è¡Œé€£æ¥å¯¦éš›è³‡æ–™åº«çš„æ•´åˆæ¸¬è©¦ï¼Œç‚ºäº†é¿å…æ¯å€‹æ¸¬è©¦å½¼æ­¤ä¹‹é–“çš„è³‡æ–™äº’ç›¸å½±éŸ¿ï¼Œé€šå¸¸æœƒåœ¨æ¯æ¬¡è·‘æ¸¬è©¦ä¹‹å‰å…ˆé‡ç½®è³‡æ–™åº«ç‹€æ…‹ã€‚é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œåƒè€ƒäº†æ‰‹é‚Šæœ€å¸¸ä½¿ç”¨çš„ Laravel æ¡†æ¶ï¼Œç•¶ä¸­æœ‰æä¾›è¨±å¤šå”åŠ©åœ¨æ¸¬è©¦æ™‚é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„ Traitï¼Œéƒ½æ˜¯å¹³å¸¸é–‹ç®±å³ä½¿ç”¨çš„æ–¹æ³•ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://laravel.com/api/9.x/Illuminate/Foundation/Testing/DatabaseMigrations.html">DatabaseMigration&lt;/a>ï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œå…ˆåˆªé™¤è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™è¡¨ï¼Œä¸¦é‡æ–° migrateï¼Œç­‰è©²æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œå† rollback æ‰€æœ‰ migrationsã€‚&lt;/li>
&lt;li>&lt;a href="https://laravel.com/api/9.x/Illuminate/Foundation/Testing/DatabaseTransactions.html">DatabaseTransactions&lt;/a>ï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œé–‹å§‹ä¸€å€‹ transactionï¼Œç­‰è©²æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œå†å°‡ transaction rollbackï¼Œå›å¾©åˆ°è³‡æ–™åº«åŸæœ¬çš„ç‹€æ…‹ã€‚&lt;/li>
&lt;li>&lt;a href="https://laravel.com/api/9.x/Illuminate/Foundation/Testing/RefreshDatabase.html">RefreshDatabase&lt;/a>ï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œ(éä½¿ç”¨å…§å­˜è³‡æ–™åº«çš„ç‹€æ³ä¸‹)æœƒå…ˆåˆ¤æ–·è³‡æ–™åº«çš„ç‹€æ…‹æ˜¯å¦å·²ç¶“ migrate éï¼Œå¦‚æœé‚„æ²’å°±åˆªé™¤è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™è¡¨ã€é‡æ–° migrateï¼Œä¸¦å°‡ migrate ç‹€æ…‹æ¨™ç¤ºç‚ºå·²ç¶“ migrate é ï¼Œæ¥è‘—ç¹¼çºŒåŸ·è¡Œå’Œ DatabaseTransaction ç›¸åŒçš„è¡Œç‚ºã€‚&lt;/li>
&lt;/ul>
&lt;p>å¾é€™äº› Laravel æ‰€æä¾›çš„ Trait ç•¶ä¸­ï¼Œå¤§æ¦‚å¯ä»¥æ•´ç†å‡ºå…©å€‹æ–¹æ¡ˆï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>åœ¨æ¯æ¬¡è·‘æ¸¬è©¦æ–¹æ³•ä¹‹å‰ï¼Œå…ˆè·‘ migrationï¼Œç­‰æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå®Œç•¢å¾Œï¼Œå† rollback migrationã€‚&lt;/strong>
å¥½è™•å°±æ˜¯ç°¡å–®æ–¹ä¾¿ï¼Œä½†ç”±æ–¼éœ€è¦åœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­éƒ½è·‘ä¸€é migration å† rollbackï¼Œé€£æ¥çœŸå¯¦è³‡æ–™åº«çš„æƒ…æ³ä¸‹ï¼Œé€Ÿåº¦æœƒæ¯”è¼ƒæ…¢ã€‚ï¼ˆæ‰€ä»¥å¤§å¤šæ˜¯ä½¿ç”¨å…§å­˜è³‡æ–™åº«å¦‚ sqlite æ™‚æ‰æœƒä½¿ç”¨é€™å€‹æ–¹æ³•ï¼‰&lt;/li>
&lt;li>&lt;strong>åœ¨æ¯æ¬¡è·‘æ¸¬è©¦æ–¹æ³•ä¹‹å‰å…ˆé–‹å•Ÿä¸€å€‹è³‡æ–™åº«äº¤æ˜“(begin transaction)ï¼Œç­‰æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå®Œç•¢å¾Œï¼Œå†å›æ»¾äº¤æ˜“(rollback transaction)ã€‚&lt;/strong>
ä¸éœ€è¦è·‘æ¯å€‹æ¸¬è©¦æ–¹æ³•æ™‚éƒ½çœŸçš„æŠŠæ•´å€‹è³‡æ–™åº«é‡ç½®ï¼Œè€Œæ˜¯åˆ©ç”¨äº¤æ˜“çš„ç‰¹æ€§ï¼Œå°‡æ¯å€‹æ¸¬è©¦ç•¶ä¸­å°è³‡æ–™åº«é€²è¡Œçš„æ“ä½œéƒ½è¦–ç‚ºåŸå­æ€§çš„æ“ä½œï¼ŒåŸ·è¡Œé€Ÿåº¦è¼ƒå¿«ã€‚ä½†éœ€å¦å¤–æ³¨æ„çš„æ˜¯ï¼Œä¸åŒæ¸¬è©¦æ–¹æ³•å¦‚æœéƒ½å°åŒä¸€ç­†æˆ–åŒä¸€å€é–“çš„è³‡æ–™åšæ“ä½œï¼Œå¯èƒ½æœƒç”¢ç”Ÿéé æœŸçš„è³‡æ–™ï¼Œé€²è€Œå½±éŸ¿åˆ°æ¸¬è©¦çš„çµæœã€‚æ‰€ä»¥ä½¿ç”¨é€™å€‹æ–¹æ³•æ™‚ï¼Œé€šå¸¸æœƒåœ¨æ¯å€‹æ¸¬è©¦ç•¶ä¸­å‰µå»ºè©²æ¸¬è©¦éœ€è¦ç”¨åˆ°çš„è³‡æ–™ï¼Œè€Œéå’Œå…¶ä»–æ¸¬è©¦å…±äº«è³‡æ–™ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œå¯ä»¥é™ä½æ¸¬è©¦ä¹‹é–“ç›¸äº’å½±éŸ¿çš„é¢¨éšªï¼Œç¢ºä¿æ¯å€‹æ¸¬è©¦çš„ç¨ç«‹æ€§ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä½†ç”±æ–¼è¦ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«ä¾†æ¸¬è©¦ï¼Œä»¥æˆ‘å€‘çš„æƒ…å¢ƒä¾†çœ‹ï¼Œä½¿ç”¨ç¬¬äºŒç¨®æ–¹å¼æœƒæ˜¯æ¯”è¼ƒé©ç•¶çš„é¸æ“‡ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å…¶å¯¦é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼ä¸åªé€™å¹¾ç¨®ï¼Œä½† Laravel Trait æ‰€æä¾›çš„æ–¹å¼å·²ç¶“èƒ½æ»¿è¶³æˆ‘å€‘åŸºæœ¬çš„éœ€æ±‚ï¼Œå°±ä¸å†é¡å¤–æ¢è¨ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¯¦ä½œè³‡æ–™åº«æ•´åˆæ¸¬è©¦">
&lt;a href="#%e5%af%a6%e4%bd%9c%e8%b3%87%e6%96%99%e5%ba%ab%e6%95%b4%e5%90%88%e6%b8%ac%e8%a9%a6" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¯¦ä½œè³‡æ–™åº«æ•´åˆæ¸¬è©¦
&lt;/h2>
&lt;p>ç¸½ç®—é€²å…¥åˆ°å¯¦ä½œæ¸¬è©¦çš„éƒ¨åˆ†äº†ï¼&lt;/p>
&lt;p>åœ¨é€™é‚Šæœƒä½¿ç”¨åˆ°å¹¾å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ä¾†è¼”åŠ©æ¸¬è©¦ä»¥åŠè³‡æ–™åº«çš„é€£æ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/stretchr/testify#suite-package">testify/suite&lt;/a>ï¼štestify æ¸¬è©¦æ¡†æ¶ç•¶ä¸­çš„ suite package æ–¹ä¾¿ç”¨ä¾†å°æ•´é«”/åˆ†çµ„/å–®ç¨çš„æ¸¬è©¦æ–¹æ³•å‰µå»º setup ä»¥åŠ teardown æ–¹æ³•ã€‚åªè¦å…§åµŒ&lt;code>suite.Suite&lt;/code> structï¼Œå°±å¯ä»¥è—‰ç”±è¤‡å¯«ä»¥ä¸‹æ–¹æ³•ï¼Œä¾†å¯¦ç¾ç‚ºä¸åŒçš„æ¸¬è©¦è¡Œç‚ºåŠ å…¥å‰/å¾Œç½®è™•ç†ï¼š
&lt;ul>
&lt;li>&lt;code>SetupSuite()&lt;/code> ï¼šåŸ·è¡Œ suite ç•¶ä¸­&lt;strong>æ‰€æœ‰&lt;/strong>æ¸¬è©¦æ–¹æ³•ä¹‹å‰çš„å‰ç½®è™•ç†&lt;/li>
&lt;li>&lt;code>TearDownSuite()&lt;/code> ï¼šåŸ·è¡Œ suite ç•¶ä¸­&lt;strong>æ‰€æœ‰&lt;/strong>æ¸¬è©¦æ–¹æ³•ä¹‹å¾Œçš„å¾Œç½®è™•ç†&lt;/li>
&lt;li>&lt;code>SetupTest()&lt;/code>ï¼šåŸ·è¡Œ suite ç•¶ä¸­&lt;strong>æ¯å€‹&lt;/strong>æ¸¬è©¦æ–¹æ³•ä¹‹å‰çš„å‰ç½®è™•ç†&lt;/li>
&lt;li>&lt;code>TearDownTest()&lt;/code> ï¼šåŸ·è¡Œ suite ç•¶ä¸­&lt;strong>æ¯å€‹&lt;/strong>æ¸¬è©¦æ–¹æ³•ä¹‹å¾Œçš„å¾Œç½®è™•ç†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img loading="lazy"
src="/images/golang-database-testing.png"
alt="suite æœ‰é»é¡ä¼¼æ¸¬è©¦æ–¹æ³•çš„é›†åˆ(çµ„)ï¼ŒSetupSuite() / TearDownSuite() ç‚ºæ•´çµ„æ¸¬è©¦å‰/å¾Œçš„è™•ç†ã€ SetupTest() / TearDownTest() ç‚ºçµ„å…§æ¯å€‹å–®ç¨æ¸¬è©¦/å‰å¾Œçš„è™•ç†"
width=1205
height="594" />&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/golang-migrate/migrate">go-migrate&lt;/a>ï¼šä½¿ç”¨ CLI æˆ–æ˜¯åœ¨ç¨‹å¼ç•¶ä¸­å‘¼å«ç‰¹å®šæ–¹æ³•åŸ·è¡Œå®šç¾©å¥½çš„ migration æª”æ¡ˆã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/go-gorm/gorm">gorm&lt;/a>ï¼šGolang ç•¶ä¸­è‘—åçš„ ORM æ¡†æ¶ã€‚ç”±æ–¼ Repository ç•¶ä¸­ä½¿ç”¨äº†è©²å¥—ä»¶å­˜å–è³‡æ–™åº«ï¼Œæ‰€ä»¥åŸ·è¡Œ Repository æ–¹æ³•æ™‚éœ€è¦ä½¿ç”¨åˆ°ã€‚&lt;/li>
&lt;/ul>
&lt;p>æˆ‘å€‘å¯ä»¥åœ¨ suite çš„ setup ç•¶ä¸­ï¼Œå…ˆé‡ç½®è³‡æ–™åº«ä¸¦é–‹å•Ÿä¸€å€‹é€£ç·šã€‚ç„¶å¾Œå°‡æ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½ç”¨ä¸€å€‹ transaction åŒ…ä½ï¼ˆåœ¨é–‹å§‹å‰å…ˆ begin TXã€çµæŸå¾Œ rollback TXï¼‰ï¼Œæœ€å¾Œåœ¨ suite teardown æ™‚é—œé–‰è³‡æ–™åº«é€£ç·šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">PostgresRepoTestSuite&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suite&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetupSuite&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é‡ç½®è³‡æ–™åº«ï¼Œå…ˆæŠŠè³‡æ–™åº« rollback æˆ–æ•´å€‹ reset å¾Œå†è·‘ migrations
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// é€™é‚Šçš„ migrations æ‡‰åƒ…åŒ…å« DDLï¼Œä¸¦ä¸æœƒå¡å…¥ä»»ä½•ä¸€ç­†è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">freshDatabase&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é–‹å•Ÿä¸€å€‹è³‡æ–™åº«é€£ç·šä¸¦æš«å­˜ï¼Œä»¥ä¾¿è®“ suite åº•ä¸‹æ¯å€‹æ¸¬è©¦æ–¹æ³•å…±ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">openDatabaseConnection&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TearDownSuite&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sqlDB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DB&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sqlDB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// suite åº•ä¸‹æ‰€æœ‰æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œé—œé–‰è³‡æ–™åº«é€£ç·š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetupTest&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Begin&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// ä½¿ç”¨æš«å­˜çš„ DB é€£ç·šç‰©ä»¶ï¼Œé–‹å•Ÿä¸€å€‹ transaction
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TearDownTest&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Rollback&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// å›æ»¾ transaction
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestPostgresRepoTestSuite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1">// åŸ·è¡Œ suite åº•ä¸‹æ‰€æœ‰æ¸¬è©¦æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¯¦éš›çš„æ¸¬è©¦æ–¹æ³•ï¼Œå¿…é ˆç‚º suite çš„ receiver
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TestGetUniqidsWithDevicesFilterByUniqId&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä¸»è¦çš„æ¸¬è©¦é‚è¼¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ &lt;code>PostgresRepoTestSuite&lt;/code> ä¸­ï¼Œ &lt;code>db&lt;/code> å’Œ &lt;code>tx&lt;/code> è®Šæ•¸æ˜¯ç”± suite åº•ä¸‹çš„æ¯å€‹æ¸¬è©¦æ–¹æ³•æ‰€å…±ç”¨çš„ã€‚åœ¨å–®ä¸€åŸ·è¡Œç·’ä¸‹åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œé€™ä¸¦ä¸æœƒé€ æˆä»»ä½•å•é¡Œã€‚ä½†å¦‚æœè¦å¹³è¡ŒåŸ·è¡Œæ¸¬è©¦ï¼Œé€™äº›æ–¹æ³•åœ¨åŒä¸€æ™‚é–“å¯èƒ½æœƒç«¶çˆ­åŒä¸€å€‹è®Šæ•¸ï¼Œå°è‡´è³‡æºç«¶çˆ­çš„æƒ…æ³ï¼Œé€²è€Œå½±éŸ¿æ¸¬è©¦çµæœçš„æ­£ç¢ºæ€§ã€‚æ­¤å¤–ï¼Œé€™äº›æ–¹æ³•åŸ·è¡Œæ™‚éƒ½æ˜¯ä½¿ç”¨åŒä¸€å€‹è³‡æ–™åº«é€£ç·šï¼Œå¯èƒ½ä¹Ÿæœƒç”¢ç”Ÿæ„å¤–çš„éŒ¯èª¤ã€‚&lt;/p>
&lt;p>æ–¼æ˜¯æˆ‘å€‘å¯ä»¥æ”¹æˆåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­ï¼Œéƒ½é–‹å•Ÿå°ˆå±¬çš„è³‡æ–™åº«é€£ç·šï¼Œä¸¦å‰µå»ºç¨ç«‹çš„è®Šæ•¸ä¿å­˜é€£ç·šå¯¦é«”ï¼Œé †ä¾¿æ¨¡æ“¬å¹³è¡Œè·‘æ¸¬è©¦æ™‚çš„å ´æ™¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">PostgresRepoTestSuite&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Suite&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetupSuite&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">freshDatabase&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è¦†å¯«äº†åŸæœ¬å…§åµŒçš„ suite.Suite é è¨­ Run æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä»¥ä¾¿ç‚ºæ¯å€‹æ–¹æ³•å‰µå»ºç¨ç«‹çš„è³‡æ–™åº«é€£ç·šç‰©ä»¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åŒæ™‚ä½¿ç”¨æ¨™æº–åº« *testing.T æä¾›çš„ Run æ–¹æ³• wrap èµ·ä¾†ï¼Œå¾…æœƒå°±èƒ½å¤ å¹³è¡Œåœ°åŸ·è¡Œé€™äº›å­æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fn&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">db&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">tx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sqlDB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DB&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">sqlDB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Rollback&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">db&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">openDatabaseConnection&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Begin&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">fn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestPostgresRepoTestSuite&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parallel&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// ä½¿ç”¨ goroutine åŒæ™‚é‹è¡Œæ‰€æœ‰æ¸¬è©¦æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">PostgresRepoTestSuite&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">TestGetUniqidsWithDevicesFilterByUniqId&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å‘¼å«å‰›å‰›è¦†å¯«çš„ Run æ–¹æ³•ï¼Œå°‡åŸæœ¬æ¸¬è©¦é‚è¼¯åŒ…è£æˆ function åšç‚ºåƒæ•¸å‚³å…¥
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">suite&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">T&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;TestGetUniqidsWithDevicesFilterByUniqId&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gorm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ä¸»è¦çš„æ¸¬è©¦é‚è¼¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿æ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½ä½¿ç”¨å„è‡ªçš„è³‡æ–™åº«é€£æ¥ï¼Œå¦‚æœå…©å€‹æ¸¬è©¦æ–¹æ³•éƒ½å˜—è©¦åŒæ™‚å°åŒä¸€æ¢è³‡æ–™é€²è¡Œå­˜å–ï¼Œæˆ–è€…å°æŸå€‹ç¯„åœé€²è¡Œå­˜å–ï¼Œä¹Ÿæœ‰å¯èƒ½å­˜åœ¨è³‡æ–™åº«å±¤é¢çš„äº‹å‹™ç«¶çˆ­ã€‚ä¸éå¦‚æœæ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½åªæ˜¯æ“ä½œè‡ªå·±å‰µå»ºçš„è³‡æ–™ï¼Œè¿¸ç™¼æ¸¬è©¦æ‡‰è©²æ˜¯å®‰å…¨çš„ã€‚&lt;/p>
&lt;h2 id="å°çµ">
&lt;a href="#%e5%b0%8f%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å°çµ
&lt;/h2>
&lt;p>é‡é»æ•´ç†å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¦‚æœè¦æ¸¬è©¦çš„ function éƒ½å’Œè³‡æ–™åº«äº’å‹•ç‚ºä¸»ï¼Œé€šå¸¸æœƒå»ºè­°ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æ¸¬è©¦è€Œéè³‡æ–™åº«æ›¿èº«ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é‡ç½®è³‡æ–™åº«ç‹€æ…‹å¯ä»¥è—‰ç”±åœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå‰/å¾Œåˆ†åˆ¥ run/rollback migrations æˆ–é–‹å•Ÿ/å›æ»¾ä¸€å€‹è³‡æ–™åº«äº¤æ˜“ã€‚ä½¿ç”¨äº¤æ˜“é€šå¸¸æœƒæ›´çœè³‡æºï¼Œä½†å¿…é ˆç¢ºä¿æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­æ‰€ä½¿ç”¨è³‡æ–™çš„ç¨ç«‹æ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯¦ä½œæ¸¬è©¦æ–¹æ³•ï¼š&lt;/p>
&lt;ol>
&lt;li>åœ¨ suite çš„ setup ç•¶ä¸­ï¼Œé‡ç½®æ•´å€‹è³‡æ–™åº«å¾Œå†è·‘ migrationï¼ˆåƒ…åŒ…å« DDLï¼Œæ­¤æ™‚è³‡æ–™åº«æ²’æœ‰ä»»ä½•ä¸€ç­†è³‡æ–™ï¼‰&lt;/li>
&lt;li>åœ¨ suite åº•ä¸‹çš„æ¯å€‹æ¸¬è©¦æ³•æ–¹ç•¶ä¸­&lt;strong>æŒ‰ç…§é †åº&lt;/strong>åŸ·è¡Œï¼š
&lt;ol>
&lt;li>é–‹å•Ÿç¨ç«‹çš„ DB é€£ç·š&lt;/li>
&lt;li>é–‹å§‹äº¤æ˜“&lt;/li>
&lt;li>é‹è¡Œæ¸¬è©¦é‚è¼¯ï¼ˆç•¶ä¸­æ‰å»ºç«‹æ‰€éœ€çš„è³‡æ–™ï¼‰&lt;/li>
&lt;li>å›æ»¾äº¤æ˜“&lt;/li>
&lt;li>é—œé–‰ DB é€£ç·š&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>å¦‚æ­¤ä¸€ä¾†ï¼ŒDB é€£ç·šå’Œè³‡æ–™éƒ½ä¸æœƒäº’ç›¸å¹²æ“¾ï¼Œä¹Ÿå¯ä»¥å¹³è¡Œè·‘æ¸¬è©¦ã€‚&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Golang struct è½‰ JSON é‡åˆ°æ¬„ä½æ²’æœ‰å€¼çš„å•é¡Œ</title><link>/posts/golang-struct-to-json-and-empty-data/</link><pubDate>Mon, 27 Mar 2023 00:00:00 +0000</pubDate><guid>/posts/golang-struct-to-json-and-empty-data/</guid><description>
&lt;p>è¦å°‡ Go çš„ struct è½‰æˆ JSON æ ¼å¼æ™‚ï¼Œé€šå¸¸éƒ½æœƒè—‰ç”±å®˜æ–¹æä¾›çš„æ¨™æº–å‡½å¼åº« &lt;code>encoding/json&lt;/code> å»å¯¦ç¾ï¼Œä¹Ÿæœƒå€ŸåŠ©åœ¨ struct ç•¶ä¸­ç‚ºç‰¹å®šæ¬„ä½å®šç¾© &lt;code>json&lt;/code> tag å»æ¨™ç¤ºè¼¸å‡ºæˆ JSON æ ¼å¼æ™‚çš„å‘½åå’Œè¦å‰‡ã€‚åœ¨æ¬„ä½å€¼å­˜åœ¨çš„æƒ…æ³ä¸‹åŸºæœ¬ä¸Šä¸æœƒæœ‰ä»€éº¼å•é¡Œï¼Œä½†å¦‚æœæ¬„ä½æ²’æœ‰å€¼ï¼Œå°±æœ‰å¯èƒ½æœƒè¼¸å‡ºéé æœŸçµæœï¼ˆç°¡ç¨±ï¼šè¸©å‘ï¼‰ã€‚&lt;/p>
&lt;p>é¦–å…ˆå¿…é ˆå…ˆé‡æ¸…ä¸€ä»¶äº‹ï¼Œæ‰€è¬‚çš„ã€Œæ²’æœ‰å€¼ã€æº–ç¢ºä¾†èªªæ˜¯æŒ‡ä»€éº¼ï¼Ÿnilï¼Ÿç©ºé™£åˆ—ï¼Ÿé‚„æ˜¯ç©ºå­—ä¸²ï¼Ÿæˆ‘å€‘éƒ½çŸ¥é“åœ¨ Golang ç•¶ä¸­ï¼Œä¸åŒé¡å‹çš„è³‡æ–™æœ‰è‘—ä¸åŒçš„ã€Œé›¶å€¼(Zero Value)ã€ï¼Œæ¯”å¦‚ string çš„é›¶å€¼æ˜¯ç©ºå­—ä¸²ã€int çš„é›¶å€¼æ˜¯ 0ã€‚ç„¶è€Œã€Œæ²’æœ‰å€¼ã€æ¯”è¼ƒåå‘ä¸€å€‹ç± çµ±çš„èªªæ³•ï¼Œä¹Ÿä¸ç®¡ç¨‹å¼èªè¨€çš„å®šç¾©ï¼Œåæ­£å°±æ˜¯æ²’æœ‰è³‡æ–™çš„æ„æ€ã€‚&lt;em>åˆæˆ–è€…èªªä»¥ä½¿ç”¨è€…è§’åº¦ä¾†çœ‹ï¼Œå› ç‚ºä¸ç®¡æ¬„ä½è³‡æ–™è£¡é¢æ˜¯ç©ºå­—ä¸²æˆ–æ˜¯ NULLï¼Œå°ä»–å€‘ä¾†èªªå°±éƒ½æ˜¯æ²’è³‡æ–™&lt;/em>ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æœƒä»¥é€™å€‹ struct ç‚ºç¯„ä¾‹ï¼Œåˆ†åˆ¥ä¾†çœ‹é€™å…©ç¨®ä¸åŒé¡å‹(reference v.s. value type)çš„è³‡æ–™æ¬„ä½ï¼Œåœ¨é¢è‡¨æ²’æœ‰è³‡æ–™æ™‚æœƒè¼¸å‡ºä»€éº¼çµæœã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Person&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;hobbies&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="reference-type---slice">
&lt;a href="#reference-type---slice" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Reference Type - Slice
&lt;/h2>
&lt;p>ç•¶æ¬„ä½é¡å‹ç‚º slice çš„æ™‚å€™ï¼Œåœ¨ä¸åŒæƒ…æ³ä¸‹çš„ã€Œæ²’æœ‰å€¼ã€ï¼Œè½‰æ›å‡ºä¾†çš„çµæœä¹Ÿæœƒæœ‰æ‰€ä¸åŒã€‚&lt;/p>
&lt;p>1.ç•¶ &lt;code>Hobbies&lt;/code> æ˜¯ä¸€å€‹å·²åˆå§‹åŒ–éå¾Œçš„ç©º sliceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åˆå§‹åŒ–æ–¹å¼ä¸€ï¼š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">hobbies&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åˆå§‹åŒ–æ–¹å¼äºŒï¼š
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// hobbies := []string{}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// éƒ½æ˜¯åˆå§‹åŒ–ä¸€å€‹é•·åº¦/å®¹é‡çš†ç‚º 0 çš„ slice
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">emmie&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">Person&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;Emmie&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hobbies&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Marshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">emmie&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Emmie&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nt">&amp;#34;hobbies&amp;#34;&lt;/span>&lt;span class="p">:[]}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2.ç•¶ &lt;code>Hobbies&lt;/code> æ˜¯ä¸€å€‹åªæœ‰å®£å‘Šè®Šæ•¸ï¼Œæ²’æœ‰åˆå§‹åŒ–çš„ sliceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">emmie&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">Person&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;Emmie&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hobbies&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Marshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">emmie&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Emmie&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nt">&amp;#34;hobbies&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹‹æ‰€ä»¥æœƒæœ‰é€™ç¨®å·®ç•°æ˜¯å› ç‚ºåœ¨ Golang ä¸­ï¼Œ&lt;strong>ç•¶å®£å‘Šä¸€å€‹è®Šæ•¸ä½†æ˜¯æ²’æœ‰åˆå§‹åŒ–å€¼çš„è©±ï¼Œå…¶é è¨­å€¼æœƒæ˜¯è©²é¡å‹çš„é›¶å€¼&lt;/strong>ï¼Œè€Œå°æ–¼ sliceã€mapã€channel é€™æ¨£çš„é¡å‹(reference type)ä¾†èªªï¼Œé›¶å€¼æ˜¯ nilã€‚&lt;/p>
&lt;p>åœ¨ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­ï¼Œslice è®Šæ•¸æœƒè¢«åˆå§‹åŒ–ç‚ºä¸€å€‹é•·åº¦åŠå®¹é‡çš†ç‚º 0 çš„ç©º sliceï¼Œè€Œä¸æ˜¯ nilã€‚æ‰€ä»¥ &lt;code>hobbies&lt;/code> åœ¨å®£å‘Šæ™‚å·²ç¶“è¢«åˆå§‹åŒ–ç‚ºä¸€å€‹ç©ºçš„ sliceï¼Œå› æ­¤ &lt;code>emmmie&lt;/code> çš„ &lt;code>hobbies&lt;/code> æ¬„ä½æœƒæ˜¯ä¸€å€‹ç©ºçš„ sliceï¼Œå®ƒçš„ JSON è¡¨ç¤ºå°±æ˜¯ &lt;code>[]&lt;/code>ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œåœ¨ç¬¬äºŒå€‹ç¯„ä¾‹ä¸­ï¼Œ&lt;code>hobbies&lt;/code> è®Šæ•¸åƒ…æœ‰è¢«å®£å‘Šï¼Œæ‰€ä»¥é è¨­å€¼ç‚º nilï¼Œè€Œä¸æ˜¯ä¸€å€‹ç©ºçš„ sliceã€‚åœ¨ JSON è½‰æ›æœŸé–“ï¼Œnil slice æœƒè¢«è½‰æ›æˆ JSON çš„ null å€¼ã€‚&lt;/p>
&lt;p>å¦‚æœæƒ³åœ¨ &lt;code>hobbies&lt;/code> æ¬„ä½ç‚º null æˆ–ç©ºé™£åˆ—æ™‚ï¼ˆä¹Ÿå°±æ˜¯ slice ç‚º nil æˆ– ç©º slice çš„ç‹€æ…‹ä¸‹ï¼‰ï¼Œä¸è¦è¼¸å‡ºè©²æ¬„ä½ keyï¼Œåƒé€™æ¨£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;Emmie&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‚£å°±è¦ä¿®æ”¹ struct ç•¶ä¸­çš„å®šç¾©ï¼Œç‚º &lt;code>hobbies&lt;/code> åŠ ä¸Š &lt;code>omitempty&lt;/code> æ¨™ç±¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;hobbies,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çµ±æ•´ä¸€ä¸‹ï¼Œæ‰€ä»¥åœ¨å°‡ struct è½‰æ›æˆ JSON æ™‚ï¼Œå¦‚æœæœ‰æ¬„ä½çš„é¡å‹æ˜¯ slice ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">ç‹€æ³&lt;/th>
&lt;th style="text-align: left">è¼¸å‡º JSON çš„å€¼&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">æœªåˆå§‹åŒ–ï¼ˆnil sliceï¼‰&lt;/td>
&lt;td style="text-align: left">&lt;code>null&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">å·²åˆå§‹åŒ–ï¼ˆç©º sliceï¼‰&lt;/td>
&lt;td style="text-align: left">&lt;code>[]&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">æœªåˆå§‹åŒ–ï¼ˆnil sliceï¼‰ä½†åŠ ä¸Š &lt;code>omitempty&lt;/code> æ¨™ç±¤&lt;/td>
&lt;td style="text-align: left">key ç›´æ¥æ¶ˆå¤±&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">å·²åˆå§‹åŒ–ï¼ˆç©º sliceï¼‰ä½†åŠ ä¸Š &lt;code>omitempty&lt;/code> æ¨™ç±¤&lt;/td>
&lt;td style="text-align: left">key ç›´æ¥æ¶ˆå¤±&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å¯ä»¥ç™¼ç¾ slice é¡å‹ï¼ˆreference typeï¼‰çš„æ¬„ä½åŠ ä¸Š &lt;code>omitempty&lt;/code> ï¼Œä¸ç®¡å…¶å€¼æ˜¯ nilï¼ˆé›¶å€¼ï¼‰ æˆ–æ˜¯ç©º sliceï¼Œkey éƒ½æœƒæ¶ˆå¤±ã€‚&lt;/p>
&lt;h2 id="value-type---string">
&lt;a href="#value-type---string" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Value Type - String
&lt;/h2>
&lt;p>é‚£å¦‚æœç•¶æ¬„ä½é¡å‹æ˜¯ stringã€int ç­‰ value type å‘¢ï¼Ÿ&lt;/p>
&lt;p>ç¹¼çºŒä½¿ç”¨ä¸Šé¢çš„ç¯„ä¾‹ structï¼Œåœ¨é‚„æ²’åŠ ä¸Š &lt;code>omitempty&lt;/code> tag æ™‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Person&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;hobbies,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">emmie&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">Person&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">json&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Marshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">emmie&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">jsonData&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæŠŠ &lt;code>name&lt;/code> ä¹ŸåŠ ä¸Š &lt;code>omitempty&lt;/code> tagï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Person&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;hobbies,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>string æœªåˆå§‹åŒ–æƒ…æ³ä¸‹ï¼Œé è¨­ç‚ºé›¶å€¼ç©ºå­—ä¸²ï¼Œ key ä¹Ÿæ¶ˆå¤±äº†ã€‚&lt;/p>
&lt;p>ä½†å¦‚æœæˆ‘å€‘ä¸æƒ³è®“ key ç›´æ¥æ¶ˆå¤±ï¼Œæƒ³è¦è¼¸å‡º null çš„è©±è©²æ€éº¼è¾¦ï¼Ÿæ–¹æ³•æ˜¯å°‡ struct ç•¶ä¸­çš„ &lt;code>string&lt;/code> æ”¹æˆæŒ‡æ¨™é¡å‹ &lt;code>*string&lt;/code> ï¼ˆå› ç‚ºæŒ‡æ¨™é¡å‹çš„é›¶å€¼ä¹Ÿæ˜¯ nilï¼‰ä¸”ä¸éœ€è¦ &lt;code>omitempty&lt;/code> tagï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Person&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Name&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Hobbies&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;hobbies,omitempty&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å†çµ±æ•´ä¸€ä¸‹ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">é¡å‹&lt;/th>
&lt;th style="text-align: left">ç‹€æ³&lt;/th>
&lt;th style="text-align: left">è¼¸å‡º JSON çš„å€¼&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">&lt;code>string&lt;/code>&lt;/td>
&lt;td style="text-align: left">æœªåˆå§‹åŒ–ï¼ˆç©ºå­—ä¸²ï¼‰&lt;/td>
&lt;td style="text-align: left">&lt;code>&amp;quot;&amp;quot;&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;code>string&lt;/code>&lt;/td>
&lt;td style="text-align: left">æœªåˆå§‹åŒ–ï¼ˆç©ºå­—ä¸²ï¼‰ä½†åŠ ä¸Š &lt;code>omitempty&lt;/code> æ¨™ç±¤&lt;/td>
&lt;td style="text-align: left">key ç›´æ¥æ¶ˆå¤±&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;code>*string&lt;/code>&lt;/td>
&lt;td style="text-align: left">æœªåˆå§‹åŒ– ï¼ˆnilï¼‰&lt;/td>
&lt;td style="text-align: left">&lt;code>null&lt;/code>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="ç¸½çµ">
&lt;a href="#%e7%b8%bd%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ç¸½çµ
&lt;/h2>
&lt;ul>
&lt;li>åœ¨ä¸åŒé¡å‹ä¸­ï¼Œæ ¹æ“šé›¶å€¼ä¸åŒï¼Œè¼¸å‡ºçš„ JSON å€¼ä¹Ÿä¸åŒã€‚&lt;/li>
&lt;li>ç„¶è€Œåœ¨ç›¸åŒé¡å‹ä¸­ï¼Œè¼¸å‡ºçš„ JSON å€¼ä¹Ÿæœ‰ä¸åŒçš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚å‰›å‰›æåˆ°çš„ slice é¡å‹ï¼Œåˆå§‹åŒ–å¾Œçš„ç©º slice æœƒè¼¸å‡ºç©ºé™£åˆ—ï¼Œè€Œæœªåˆå§‹åŒ–ç‚ºé›¶å€¼çš„ nil slice æœƒè¼¸å‡º nullã€‚&lt;/li>
&lt;li>&lt;code>omitempty&lt;/code> tag æœƒå½±éŸ¿ key å€¼çš„å­˜ç•™ã€‚&lt;/li>
&lt;/ul>
&lt;p>åªè¦æ³¨æ„é€™å¹¾é»ï¼Œå°±å¯ä»¥é¿å…åœ¨è¼¸å‡º JSON æ™‚å¾—åˆ°éé æœŸçš„è³‡æ–™é¡å‹/çµæ§‹ã€‚&lt;/p></description></item><item><title>è§£æ±ºä½¿ç”¨ oapi-codegen æ™‚å ±éŒ¯ unexpected reference depth</title><link>/posts/resolve-oapi-codegen-error/</link><pubDate>Fri, 17 Mar 2023 00:00:00 +0000</pubDate><guid>/posts/resolve-oapi-codegen-error/</guid><description>
&lt;p>æœ€è¿‘åœ¨ç ”ç©¶ &lt;a href="https://github.com/deepmap/oapi-codegen">oapi-codegen&lt;/a> é€™å¥—åŸºæ–¼ OpenAPI 3.0 è‡ªå‹•ç”Ÿæˆ Go boilerplate ç¨‹å¼çš„å·¥å…·ï¼Œèƒ½å¹«åŠ©é–‹ç™¼è€…çœä¸‹å¾ˆå¤šæ’°å¯«å¯¦ç¾ HTTP Server ç«¯å£ã€marshalling å’Œ unmarshalling çš„é‡è¤‡ç¨‹å¼ç¢¼çš„æ™‚é–“ã€‚ç•¶é€²è¡Œç³»çµ±é‡æ§‹æˆ–ä½¿ç”¨åƒæ˜¯æ–‡ä»¶å…ˆè¡Œ(Documentation-Driven Development)çš„é–‹ç™¼æ–¹æ³•æ™‚ä¹Ÿå¾ˆé©ç”¨ã€‚
åœ¨æ­¤ç´€éŒ„ä¸€ä¸‹é¤µå…¥ OpenAPI æª”æ¡ˆæ™‚é‡åˆ°çš„å•é¡Œã€‚&lt;/p>
&lt;h2 id="å•é¡Œæ¦‚è¿°">
&lt;a href="#%e5%95%8f%e9%a1%8c%e6%a6%82%e8%bf%b0" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å•é¡Œæ¦‚è¿°
&lt;/h2>
&lt;p>ä½¿ç”¨ä»¥ä¸‹ OpenAPI yaml æª”ï¼ˆæ“·å–ç‰‡æ®µï¼‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">schemas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Response&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ç‹€æ…‹&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">integer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">example&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">200&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">è¨Šæ¯&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">example&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">success&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">detail&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">è©³ç´°è¨Šæ¯&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">example&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>{}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">/iot/stations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">get&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">parameters&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">uniqid&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">in&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">query&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Uniqid&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">required&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">schema&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">string&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">responses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;#39;200&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">OK&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">content&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application/json&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">schema&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">items&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">array&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">$ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;#/components/schemas/Response/message&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">$ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;#/components/schemas/Response/status&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è·‘ç”Ÿæˆä»£ç¢¼çš„æŒ‡ä»¤æ™‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ oapi-codegen -package main openapi.yaml &amp;gt; openapi.gen.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœƒå™´é€™å€‹éŒ¯èª¤&lt;/p>
&lt;pre tabindex="0">&lt;code>error generating code: error creating operation definitions: error generating response definitions: error generating request body definition: error generating Go schema for property &amp;#39;message&amp;#39;: error turning reference (#/components/schemas/Response/message) into a Go type: unexpected reference depth: 5 for ref: #/components/schemas/Response/message local: true
&lt;/code>&lt;/pre>&lt;p>çœ‹äº†ä¸€ä¸‹&lt;a href="https://github.com/deepmap/oapi-codegen/blob/master/pkg/codegen/utils.go#L322-L332">åŸå§‹ç¢¼&lt;/a>ï¼Œç™¼ç¾ä»–åªèƒ½è§£æå››å±¤çš„ $ref pathï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// https://github.com/deepmap/oapi-codegen/blob/master/pkg/codegen/utils.go#L322-L332
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// refPathToGoType returns the Go typename for refPath given its
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">refPathToGoType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">refPath&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">local&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">refPath&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="sc">&amp;#39;#&amp;#39;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">pathParts&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">refPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">depth&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pathParts&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">local&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">depth&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// &amp;lt;---------here!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected reference depth: %d for ref: %s local: %t&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">depth&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">refPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">local&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">depth&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">depth&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unexpected reference depth: %d for ref: %s local: %t&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">depth&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">refPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">local&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯èªªï¼Œåªæœ‰é•·é€™æ¨£çš„ path æ‰èƒ½è¢«é †åˆ©è§£æï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>#/components/responses/Baz
&lt;/code>&lt;/pre>&lt;p>è€Œåœ¨ä¸Šé¢çš„ yaml ç•¶ä¸­çš„ path å·²ç¶“åˆ°ç¬¬äº”å±¤ &lt;code>#/components/schemas/Response/message&lt;/code> ï¼Œå› æ­¤æœƒå ±éŒ¯ã€‚&lt;/p>
&lt;p>å¾Œä¾†ç™¼ç¾ï¼Œé€™ç¨®å¯«æ³•ä¸æ˜¯åˆæ³•çš„ OpenAPI æ ¼å¼çš„å¯«æ³•ï¼ˆä½†ç”¨ &lt;a href="https://redocly.com/docs/redoc/quickstart/">redoc&lt;/a> å¯ä»¥ build å‡ºä¾†ï¼‰ï¼Œå› ç‚ºç•¶è·‘ lint çš„æ™‚å€™æœƒå ±éŒ¯ã€‚&lt;/p>
&lt;p>å¦‚æœè¦æ”¹æˆåˆæ³•çš„æ ¼å¼ï¼Œé¦–å…ˆ schema çš„åœ°æ–¹è¦åœ¨æ¯å€‹ Object åº•ä¸‹å¢åŠ  &lt;code>properties&lt;/code> å±¬æ€§ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">schemas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Response&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># &amp;lt;-------- add this&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ç‹€æ…‹&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">integer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">example&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">200&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾Œ $ref path è¦æ”¹æˆ &lt;code>#/components/schemas/Response/properties/message&lt;/code>
æ‰èƒ½é€šé linter æª¢æŸ¥ã€‚&lt;/p>
&lt;p>ä½†å³ä½¿æ”¹æˆäº†åˆæ³•æ ¼å¼ï¼Œåœ¨ç”¨ oapi-codegen ç”Ÿæˆä»£ç¢¼æ™‚é‚„æ˜¯æœƒå ±éŒ¯ã€‚å› ç‚º path ç¸½å±¤æ•¸è®Šæˆ 6 å±¤ï¼Œä¾ç„¶ç„¡æ³•è¢«è§£æã€‚&lt;/p>
&lt;h2 id="è§£æ±ºæ–¹æ³•">
&lt;a href="#%e8%a7%a3%e6%b1%ba%e6%96%b9%e6%b3%95" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
è§£æ±ºæ–¹æ³•
&lt;/h2>
&lt;h3 id="1-æ”¹æˆåªä½¿ç”¨å››å±¤çš„-ref">
&lt;a href="#1-%e6%94%b9%e6%88%90%e5%8f%aa%e4%bd%bf%e7%94%a8%e5%9b%9b%e5%b1%a4%e7%9a%84-ref" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
1. æ”¹æˆåªä½¿ç”¨å››å±¤çš„ $ref
&lt;/h3>
&lt;p>åƒé€™æ¨£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">schemas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Resource&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">object&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">items&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">array&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">status&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c">#...more&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">responses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">&amp;#39;200&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">description&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">OK&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">content&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">application/json&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">schema&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">$ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;#/components/schemas/Resource&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†é€™æ¨£ä¸€ä¾†å°±è®Šå¾—å¾ˆä¸å½ˆæ€§ï¼Œåœ¨å¹¾ä¹æ²’ä»€éº¼ $ref æœƒå¼•ç”¨åˆ°ç›¸åŒå…§å®¹çš„æƒ…æ³ä¸‹ï¼Œé‚„ä¸å¦‚ç›´æ¥ inlineï¼Œè€Œä¸”è¦æ”¹çš„åœ°æ–¹æœ‰é»å¤ªå¤šäº†(æ‡¶)&lt;/p>
&lt;h3 id="2-å…ˆæŠŠæª”æ¡ˆä¿®æ­£æˆå¯ä»¥é€šé-openapi-çš„-linter-æª¢æŸ¥ç„¶å¾Œå†ç”¨å·¥å…·-å–ä»£æ‰-ref-çš„éƒ¨åˆ†">
&lt;a href="#2-%e5%85%88%e6%8a%8a%e6%aa%94%e6%a1%88%e4%bf%ae%e6%ad%a3%e6%88%90%e5%8f%af%e4%bb%a5%e9%80%9a%e9%81%8e-openapi-%e7%9a%84-linter-%e6%aa%a2%e6%9f%a5%e7%84%b6%e5%be%8c%e5%86%8d%e7%94%a8%e5%b7%a5%e5%85%b7-%e5%8f%96%e4%bb%a3%e6%8e%89-ref-%e7%9a%84%e9%83%a8%e5%88%86" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
2. å…ˆæŠŠæª”æ¡ˆä¿®æ­£æˆå¯ä»¥é€šé OpenAPI çš„ linter æª¢æŸ¥ï¼Œç„¶å¾Œå†ç”¨å·¥å…· å–ä»£æ‰ $ref çš„éƒ¨åˆ†
&lt;/h3>
&lt;p>æƒ³èªªåæ­£åªæ˜¯ç‚ºäº†èƒ½å¤ ä½¿ç”¨ä»£ç¢¼ç”Ÿæˆå·¥å…·ï¼Œä¸æƒ³èŠ±å¤ªå¤šç²¾åŠ›å¤§æ”¹åŸæœ¬çš„ OpenAPI æ–‡ä»¶ï¼Œæ–¼æ˜¯æœ€å¾Œæ¡å–äº†é€™å€‹æ–¹æ³•ã€‚&lt;/p>
&lt;p>å‰›å‰›æœ‰ç¨å¾®æåˆ°åŸæœ¬çš„æ ¼å¼è·‘ lint æ™‚æœƒæœ‰éŒ¯èª¤ï¼Œéœ€è¦é€²è¡Œä¿®æ­£ï¼Œåªè¦èƒ½å¤ æˆåŠŸè·‘é linter çš„æª¢æŸ¥ï¼Œå°±å¯ä»¥å†ç”¨å·¥å…·æŠŠ $ref å¼•ç”¨çš„åœ°æ–¹å…¨éƒ½å–ä»£æˆç›¸å°æ‡‰çš„å®šç¾©å…§å®¹ã€‚&lt;a href="https://stackoverflow.com/questions/65549855/openapi-specification-yml-yaml-all-refs-replace-or-expand-to-its-definition">é€™ç¯‡å•ç­”&lt;/a>æœ‰æä¾›å…©ç¨®å·¥å…·éƒ½èƒ½é”æˆé€™å€‹ç›®çš„ï¼Œåœ¨é€™é‚Šæˆ‘å€‘é¸ç”¨äº† &lt;a href="https://redocly.com/docs/cli/">redockly-cli&lt;/a>ï¼ˆæ²’æœ‰ç‚ºä»€éº¼åªæ˜¯æˆ‘å€‘ä¹Ÿæœ‰ç”¨ redocï¼‰ã€‚&lt;/p>
&lt;h4 id="run-linterhttpsredoclycomdocsclicommandslint">
&lt;a href="#run-linterhttpsredoclycomdocsclicommandslint" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;a href="https://redocly.com/docs/cli/commands/lint/">run linter&lt;/a>
&lt;/h4>
&lt;p>é¦–å…ˆä¿®æ­£ä¸Šé¢å‰›å‰›æåˆ°çš„ properties å’Œ $ref çš„éƒ¨åˆ†å¾Œï¼Œå°±å¯ä»¥æˆåŠŸè·‘é linterï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ redocly lint openapi.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img loading="lazy"
src="/images/oapi-codegen-2.png"
alt="Untitled"
width=886
height="182" />&lt;/p>
&lt;p>warning çš„éƒ¨åˆ†ä¸ç”¨ç†ä»–ã€‚&lt;/p>
&lt;h4 id="bundle-file-and-dereferencedhttpsredoclycomdocsclicommandsbundle">
&lt;a href="#bundle-file-and-dereferencedhttpsredoclycomdocsclicommandsbundle" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;a href="https://redocly.com/docs/cli/commands/bundle/">bundle file and dereferenced&lt;/a>
&lt;/h4>
&lt;p>ç„¶å¾Œå†å°æª”æ¡ˆè·‘ bundle æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ redocly bundle --dereferenced openapi.yaml --output openapi_0317.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img loading="lazy"
src="/images/oapi-codegen-1.png"
alt="Untitled"
width=948
height="76" />&lt;/p>
&lt;p>ç„¶å¾Œå†ä¸€æ¬¡è·‘ oapi-codegen æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> $ oapi-codegen -package ports openapi_0317.yaml &amp;gt; openapi.gen.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¸½ç®—æˆåŠŸ gen å‡ºæª”æ¡ˆå•¦ğŸ‰&lt;/p>
&lt;h4 id="note">
&lt;a href="#note" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Note
&lt;/h4>
&lt;p>åœ¨é è¨­ä¸å¸¶ä»»ä½• &lt;code>-generate&lt;/code> åƒæ•¸çš„æƒ…æ³ä¸‹ï¼Œè©²æŒ‡ä»¤æœƒå¹«æˆ‘å€‘ç”¢ç”Ÿæ‰€æœ‰åŒ…å« server, types, client, spec ç­‰ç­‰ç›¸é—œç¨‹å¼ç¢¼åœ¨æŒ‡å®šè¼¸å‡ºçš„æª”æ¡ˆè£¡ï¼Œä¸”é è¨­ä½¿ç”¨çš„ server æ˜¯ Echoã€‚ï¼ˆè©³ç´°èªªæ˜åƒè€ƒ&lt;a href="https://github.com/deepmap/oapi-codegen#using-oapi-codegen">æ–‡ä»¶&lt;/a>ï¼‰&lt;/p>
&lt;p>å‡è¨­æˆ‘å€‘çš„éœ€æ±‚æ˜¯ä½¿ç”¨ gin ï¼Œä¸¦ä¸”åªéœ€è¦ server å’Œ types éƒ¨åˆ†çš„ç¨‹å¼ç¢¼&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;code>server&lt;/code>&lt;/strong>ï¼šç”Ÿæˆ server æ¥å£ä»¥åŠç›¸é—œçš„ç¨‹å¼ç¢¼ï¼ŒåŒ…æ‹¬å°‡åƒæ•¸ç¶å®šåˆ° structã€åƒæ•¸é¡å‹éŒ¯èª¤ throw Exception çš„è™•ç†ç­‰ç­‰ &lt;br>
&lt;strong>&lt;code>types&lt;/code>&lt;/strong>ï¼šå®šç¾©åœ¨ OpenAPI components ç•¶ä¸­çš„é¡å‹(struct)ï¼ŒåŒ…å« request params/body å’Œ response body&lt;/p>
&lt;/blockquote>
&lt;p>ä¸¦ä¸”åˆ†åˆ¥æ”¾ç½®æ–¼ä¸åŒæª”æ¡ˆä¸­ï¼Œå¯ä»¥é€™æ¨£åšï¼š&lt;/p>
&lt;p>å…ˆç”¢ç”Ÿ gin server çš„æª”æ¡ˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ oapi-codegen -package ports -generate gin openapi_0317.yaml &amp;gt; openapi_api.gen.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å†ç”¢ç”Ÿ types çš„æª”æ¡ˆ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ oapi-codegen -package ports -generate types openapi_0317.yaml &amp;gt; openapi_types.gen.go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>è®“æ¶åœ¨ Netlify ä¸Šçš„ç¶²ç«™ç™¼æ–‡åŒæ™‚å‘ Google è¦æ±‚ç‚ºæ–°é é¢å»ºç«‹ç´¢å¼•! - ä½¿ç”¨ Netlify Functions ä¸²æ¥ Google Indexing API</title><link>/posts/netlify-function-google-indexing-api/</link><pubDate>Mon, 27 Feb 2023 00:00:00 +0000</pubDate><guid>/posts/netlify-function-google-indexing-api/</guid><description>
&lt;h2 id="å‰è¨€">
&lt;a href="#%e5%89%8d%e8%a8%80" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰è¨€
&lt;/h2>
&lt;p>è‡ªå¾å¾ Medium æ›éä¾†è‡ªæ¶éƒ¨è½æ ¼å¾Œï¼ŒSEO çš„äº‹æƒ…ä¹Ÿéƒ½å¾—è‡ªå·±è™•ç†ã€‚ä½†é›–ç„¶èªªæ˜¯ã€Œè™•ç†ã€ï¼Œä¹Ÿåªæ˜¯åšä¸€äº›åŸºæœ¬çš„è¨­å®šè€Œå·²ï¼Œä¾‹å¦‚è£å€‹ Search Consoleã€æäº¤ sitemapï¼ˆä½†å…¶å¯¦ä½¿ç”¨çš„éœæ…‹ç¶²ç«™ç”Ÿç”¢å™¨ Hexo å°±å·²ç¶“æœ‰åšåˆ°è‡ªå‹•ç”Ÿç”¢ã€æ›´æ–° sitemapï¼‰ã€‚å”¯ä¸€çš„æ‰‹å‹•ä½œæ¥­å°±æ˜¯æ¯æ¬¡ç™¼è¡¨æ–°æ–‡ç« å¾Œï¼Œç‚ºäº†åŠ å¿« Google ç´¢å¼•åˆ°æ–°æ–‡ç« é é¢çš„é€Ÿåº¦ï¼Œæˆ‘éƒ½é‚„æ˜¯æœƒé€²åˆ° Search Console å¾Œå°ï¼Œæ‰‹å‹•è¼¸å…¥é é¢ç¶²å€è¦æ±‚å»ºç«‹ç´¢å¼•ï¼ˆç¶²å€å¯©æŸ¥&amp;gt;æ¸¬è©¦ç·šä¸Šç¶²å€&amp;gt;å»ºç«‹ç´¢å¼•)ã€‚&lt;/p>
&lt;p>èº«ç‚ºä¸€å€‹èƒ½å¤ è‡ªå‹•å°±ä¸æ‰‹å‹•çš„æ‡¶äººï¼Œçªç„¶æƒ³åˆ°ä¹‹å‰æ›¾åœ¨å…¬å¸å°ˆæ¡ˆä¸­ä½¿ç”¨é Google Indexing API æäº¤è¦åŠ å…¥ç´¢å¼•çš„ç¶²å€ï¼Œé‚£æˆ‘æ‡‰è©²ä¹Ÿå¯ä»¥ä¾†å¹«æˆ‘çš„éƒ¨è½æ ¼ä¸²çœ‹çœ‹å§ï¼Ÿ&lt;/p>
&lt;p>åœ¨å°‹æ‰¾æ–¹æ³•çš„éç¨‹ä¸­ï¼Œé›–ç„¶åŸæœ¬å°±æ˜¯ä½¿ç”¨ Netlify æ¶ç«™ï¼Œä½†ä¸€å¹´å‰çš„è¨˜æ†¶æœ‰é»æ¨¡ç³Š(&lt;del>å¯èƒ½ä¹Ÿæ˜¯è¤‡è£½è²¼ä¸Šçš„é—œä¿‚&lt;/del>)ï¼Œè£¡é¢å¾ˆå¤šåŠŸèƒ½å…¶å¯¦ä¹Ÿæ²’ç¢°éï¼Œä¸­é€”ä¸å°‘æ¬¡å› ç‚ºé‡åˆ°æŸç¨®é™åˆ¶è€Œåˆæ”¹è®ŠåŸæœ¬çš„åš/è§£æ³•ï¼Œè¦ºå¾—é€™å€‹éç¨‹ä¹Ÿæ˜¯å­¸ç¿’åˆ°äº†ä¸å°‘ï¼Œæˆ–æ˜¯æœ‰æ©Ÿæœƒç‚ºå…¶ä»–äººé¿å‘(?)ï¼Œå› æ­¤æœ‰äº†é€™ç¯‡æ–‡ç« ã€‚&lt;/p>
&lt;h2 id="å¯¦ä½œ">
&lt;a href="#%e5%af%a6%e4%bd%9c" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¯¦ä½œ
&lt;/h2>
&lt;h3 id="åˆæ­¥è¦åŠƒ">
&lt;a href="#%e5%88%9d%e6%ad%a5%e8%a6%8f%e5%8a%83" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åˆæ­¥è¦åŠƒ
&lt;/h3>
&lt;p>é€™å€‹åŠŸèƒ½çš„æµç¨‹å…¶å¯¦éå¸¸ç°¡å–®ï¼Œå°±æ˜¯â€”â€”ç™¼è¡¨æ–‡ç« å¾Œï¼ˆdeploy æˆåŠŸï¼‰é¦¬ä¸Šè§¸ç™¼æ‰“ Google Indexing API çš„ç¨‹å¼ã€‚&lt;/p>
&lt;p>é¦–å…ˆéœ€è¦æ€è€ƒçš„å•é¡Œæ˜¯ï¼Œ&lt;strong>è¦å¦‚ä½•æ¥æ”¶ deploy å®Œæˆçš„è¨Šæ¯ï¼Ÿ&lt;/strong> ä»¥åŠ &lt;strong>ã€Œæ‰“ Google Indexing API çš„ç¨‹å¼ã€è¦åœ¨å“ªè£¡åŸ·è¡Œï¼Ÿ&lt;/strong>&lt;/p>
&lt;p>ç¬¬ä¸€å€‹æƒ³æ³•æ˜¯ï¼šçœ‹çœ‹ Netlify åœ¨ deploy æˆåŠŸå¾Œï¼Œæœ‰æ²’æœ‰ä»€éº¼äº‹ä»¶å¯ä»¥ç›£è½ã€‚&lt;/p>
&lt;p>æ–¼æ˜¯æœå°‹åˆ°äº†å®˜æ–¹æ–‡ä»¶é—œæ–¼ &lt;a href="https://docs.netlify.com/site-deploys/notifications/">Deploy notifications&lt;/a> çš„èªªæ˜ï¼Œæœ‰æ”¯æ´å¤šç¨®æ¥æ”¶é€šçŸ¥çš„æ–¹å¼ï¼ŒSlackã€emailã€webhook ç­‰ç­‰ã€‚çœ‹èµ·ä¾†æ¯”è¼ƒé©åˆçš„æ–¹å¼å¯èƒ½æ˜¯é€é webhookï¼Œå¦å¤–èµ·ä¸€å€‹ http server ä¸¦è¨»å†Šä¸€å€‹ endpointï¼Œserver ä¸€æ¥æ”¶åˆ° request å°±ç«‹åˆ»æ‰“ Google Indexing APIã€‚
ä½†é€™éº¼ä¸€ä¾†ï¼Œå°±é‚„å¾—å¦å¤– run ä¸€å€‹ http serverï¼Œç‚ºäº†å®Œæˆé€™å€‹å°ä»»å‹™é‚„å¾—å†é¡å¤–é–‹ä¸€å€‹æœå‹™ï¼Œç¸½è¦ºå¾—å“ªè£æ€ªæ€ªçš„ã€‚æ‰€ä»¥å¾Œä¾†åˆæ‰¾äº†ä¸€ä¸‹æœ‰æ²’æœ‰å…¶ä»–æ›´é©åˆçš„åšæ³•ï¼Œçµæœå°±çœ‹åˆ°äº† Netlify Functionsã€‚&lt;/p>
&lt;h3 id="ä»€éº¼æ˜¯-netlify-functions">
&lt;a href="#%e4%bb%80%e9%ba%bc%e6%98%af-netlify-functions" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä»€éº¼æ˜¯ Netlify Functions
&lt;/h3>
&lt;p>&lt;a href="https://docs.netlify.com/functions/overview/">Netlify Functions&lt;/a> æ˜¯ Netlify æä¾›çš„ä¸€å€‹é¡ä¼¼ aws lamda çš„åŠŸèƒ½(å¯¦éš›ä¸Šä¹Ÿæ˜¯åŸºæ–¼ aws lamda å»å¯¦ç¾çš„)ï¼Œå¯ä»¥è¼•æ˜“åœ°éƒ¨ç½² serverless çš„æœå‹™ã€‚&lt;/p>
&lt;p>ç„¶è€Œ functions éƒ½æ˜¯åŸºæ–¼å°ˆæ¡ˆ(ä¹Ÿå°±æ˜¯é€é Netlify æ‰€æ§‹å»ºçš„ç¶²ç«™)ï¼Œä¸€å€‹å°ˆæ¡ˆåº•ä¸‹å¯ä»¥æœ‰å¤šå€‹ functionsï¼Œé€™äº› functions éœ€è¦è¢«æ”¾åœ¨ç‰¹å®šè³‡æ–™å¤¾ä¸‹é¢æ‰æœƒä¸€åŒè·Ÿè‘—å°ˆæ¡ˆè¢«éƒ¨ç½²ã€‚ï¼ˆé è¨­çš„è³‡æ–™å¤¾ä½ç½®åœ¨ &lt;code>YOUR_BASE_DIRECTORY/netlify/functions/&lt;/code>ï¼Œå¯ä»¥è‡ªè¡Œé€éè¨­å®šæ›´æ”¹)&lt;/p>
&lt;p>è€Œé€™äº›éƒ¨ç½²åœ¨ç·šä¸Šçš„ functionsï¼Œéƒ½å¯ä»¥è—‰ç”±ç‰¹å®šçš„è·¯ç”±å»è§¸ç™¼åŸ·è¡Œã€‚
ä¾‹å¦‚ï¼Œä¸€å€‹ç”¨ JavaScript å¯«çš„ functions æª”æ¡ˆåç‚º &lt;code>hello.js&lt;/code>ï¼Œè¢«æ”¾åœ¨ &lt;code>netlify/functions/&lt;/code> åº•ä¸‹ï¼Œå®Œæ•´è·¯å¾‘æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>YOUR_BASE_DIRECTORY/netlify/functions/hello.js
&lt;/code>&lt;/pre>&lt;p>å°æ‡‰çš„è·¯ç”±å°±æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>BASE_URL_OF_YOUR_SITE/.netlify/functions/hello
&lt;/code>&lt;/pre>&lt;p>åªè¦æˆ³é€™å€‹ endpointï¼Œéš¨ä¾¿ä¸€ç¨® Http Method éƒ½å¯ä»¥ï¼Œå°±èƒ½è§¸ç™¼é€™å€‹ functionã€‚&lt;/p>
&lt;blockquote>
&lt;p>ğŸ“ Note: ç›®å‰ functions æ”¯æ´çš„ç¨‹å¼èªè¨€åªæœ‰ Typescriptã€JavaScript ä»¥åŠ Golang ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä½†æ¥è‘—åˆæƒ³åˆ°ä¸€ä»¶äº‹ï¼Œæ—¢ç„¶ functions éƒ½æ˜¯åœ¨å°ˆæ¡ˆåº•ä¸‹ï¼Œé‚£ä»–æ˜¯å¦èƒ½é€éæŸç¨®æ–¹å¼ç›£è½åˆ°å°ˆæ¡ˆçš„éƒ¨ç½²æˆåŠŸäº‹ä»¶ï¼Œåªè¦å°ˆæ¡ˆä¸€éƒ¨ç½²æˆåŠŸï¼Œå°±è‡ªå‹• call é€™å€‹ functionï¼Œä¹Ÿä¸éœ€è¦è¨­å®š webhook url äº†ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œ&lt;a href="https://docs.netlify.com/functions/trigger-on-events/">Netlify æä¾›äº†ä¸€ç³»åˆ—çš„ triggers&lt;/a>ï¼Œåªè¦å°‡ functions æŒ‰ç…§äº‹ä»¶åç¨±å‘½åï¼Œå°±æœƒåœ¨è©²äº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œç›´æ¥åŸ·è¡ŒåŒå functionã€‚äº‹ä»¶ç•¶ä¸­ç•¶ç„¶ä¹ŸåŒ…æ‹¬éƒ¨ç½²æˆåŠŸäº‹ä»¶ &lt;code>deploy-succeeded&lt;/code> ï¼Œæ‰€ä»¥åªè¦å°‡ function å‘½åç‚º &lt;code>deploy-succeeded&lt;/code>ï¼Œfunction å°±æœƒåœ¨å°ˆæ¡ˆéƒ¨ç½²å®Œæˆæ™‚è¢«åŸ·è¡Œã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨-netlify-functions">
&lt;a href="#%e4%bd%bf%e7%94%a8-netlify-functions" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä½¿ç”¨ Netlify Functions
&lt;/h3>
&lt;p>ç¸½ç®—é€²å…¥åˆ°å¯¦ä½œçš„ç’°ç¯€å•¦!åœ¨é€™é‚Šæœƒä½¿ç”¨ Golang é€²è¡Œå¯¦ä½œã€‚
é¦–å…ˆï¼Œåœ¨å°ˆæ¡ˆåº•ä¸‹æ–°å»ºæª”æ¡ˆ &lt;code>netlify/functions/deploy-succeeded/deploy-succeeded.go&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>ğŸ“ Note: ç”±æ–¼ä½¿ç”¨ Golangï¼Œä¸€å€‹ function æœƒè¦–ä½œç‚ºä¸€å€‹ Go moduleï¼Œè£¡é¢åŒ…å«ä¸€å€‹æœ‰ main function çš„æª”æ¡ˆï¼Œæ‰€ä»¥éœ€è¦ç”¨è³‡æ–™å¤¾ä¾†åˆ†å±¤ã€‚ä½†å¦‚æœä½¿ç”¨ JS å°±ä¸éœ€è¦è³‡æ–™å¤¾åˆ†å±¤ï¼Œä¸€å€‹æª”æ¡ˆå°±æ˜¯ä¸€å€‹ functionã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥ä¸‹æ˜¯å®˜æ–¹æ–‡ä»¶æä¾›çš„ function ç¯„æœ¬ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Go" data-lang="Go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./netlify/functions/deploy-succeeded/deploy-succeeded.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/aws/aws-lambda-go/events&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/aws/aws-lambda-go/lambda&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€™é‚Šæ˜¯ function çš„é‚è¼¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// é€™å¡Šä¸éœ€è¦å‹•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">lambda&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æƒ³è¦å…ˆæ¸¬è©¦çœ‹çœ‹ï¼Œæ˜¯å¦é€™å€‹ function çœŸçš„æœƒåœ¨æ¯æ¬¡éƒ¨ç½²å®Œæˆå¾Œè¢«è§¸ç™¼åŸ·è¡Œï¼Œä¹Ÿé †ä¾¿çœ‹çœ‹æ”¶åˆ°çš„ request payload æœƒæ˜¯ä»€éº¼ï¼Œæ‰€ä»¥åœ¨ &lt;code>handler&lt;/code> æ–¹æ³•è£¡é¢åŠ ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Go" data-lang="Go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è©¦è‘—æŠŠ request.Body å°å‡ºä¾†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çµæœç™¼ç¾çœŸçš„æœ‰è¢«åŸ·è¡Œï¼Œæˆ‘å€‘å¯ä»¥åˆ° Netlify å¾Œå°å»çœ‹ function çš„ logã€‚é€²å…¥ &lt;a href="https://app.netlify.com/sites/%7Byour_site%7D/functions">https://app.netlify.com/sites/{your_site}/functions&lt;/a>
ï¼Œé»é¸å‰›å‰› deploy çš„ functionï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-02.png"
alt="Untitled"
width=1263
height="735" />&lt;/p>
&lt;p>å°±å¯ä»¥é€²åˆ°è©² function çš„é é¢ç€è¦½ logï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-03.png"
alt="Untitled"
width=1268
height="667" />&lt;/p>
&lt;p>log å°å‡ºä¾†çš„å…§å®¹å¤§æ¦‚é•·é€™æ¨£ï¼Œä½†å› çˆ²è³‡æ–™æœ‰é»å¤ªå¤šï¼Œé€™é‚Šå°±æ²’è²¼å®Œæ•´å…§å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ•æ„Ÿè³‡è¨Šæœ‰ç”¨*è™Ÿé®ç½©
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;payload&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;63f9e14********6916d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;site_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;********-6b6d-4df7-a413-********&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;63f9e144bb8728000846916b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;state&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ready&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;emmielin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://emmie.work&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssl_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://emmie.work&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;admin_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://app.netlify.com/sites/emmielin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;deploy_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;http://main--emmielin.netlify.app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;deploy_ssl_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://main--emmielin.netlify.app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;created_at&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2023-02-25T10:21:56.064Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;updated_at&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2023-02-25T10:22:11.735Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;user_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;************************&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;error_message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;required&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;required_functions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;commit_ref&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;f3fb856c951b6979f22********90&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;review_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;branch&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;commit_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://github.com/linxinemily/hugo-emmie-blog/commit/f3fb856c951b6979f22ffad191843dc831164690&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;skipped&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;locked&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;log_access_attributes&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;firebase&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://netlify-builds9.firebaseio.com/builds/63f9e144bb8728000846916b/log&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;database&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;netlify-builds9&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;endpoint&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://netlify-builds9.firebaseio.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/builds/63f9e144bb8728000846916b/log&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;token&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;************************&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;title&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;commit msg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// more info...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;site&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;********-6b6d-4df7-a413-********&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;site_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;********-6b6d-4df7-a413-********&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;plan&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;nf_team_dev&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssl_plan&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;premium&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;claimed&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;emmielin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;custom_domain&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;emmie.work&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;domain_suffix_branch&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;domain_suffix_deploy_preview&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;domain_aliases&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;password_hash&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;sso_login&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;sso_login_context&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;all&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;notification_email&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://emmie.work&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;admin_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://app.netlify.com/sites/emmielin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;deploy_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;63f9e14********6916d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;deploy_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;http://main--emmielin.netlify.app&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;state&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;current&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;screenshot_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;created_at&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2022-07-18T16:18:18.628Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;updated_at&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2023-02-25T10:22:11.738Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;user_id&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;************************&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;error_message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssl&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssl_url&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;https://emmie.work&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;force_ssl&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;ssl_status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;max_domain_aliases&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// more info...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¦åœ¨ local é–‹ç™¼ function çš„è©±ï¼Œå¯ä»¥&lt;a href="https://docs.netlify.com/cli/get-started/#installation">å®‰è£ Netlify CLI&lt;/a>ï¼Œåœ¨å°ˆæ¡ˆåº•ä¸‹è·‘ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ netlify functions:serve
&lt;/code>&lt;/pre>&lt;p>æˆåŠŸè·‘èµ·ä¾†çš„è©±é è¨­æœƒåœ¨ 9999 portï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-04.png"
alt="Untitled"
width=1422
height="160" />&lt;/p>
&lt;p>ç„¶å¾Œå°±å¯ä»¥ç”¨ Postman æ‰“ function çš„ endpointï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-05.png"
alt="Untitled"
width=2026
height="858" />&lt;/p>
&lt;h3 id="å¦‚ä½•å–å¾—æ–°æ–‡ç« -url">
&lt;a href="#%e5%a6%82%e4%bd%95%e5%8f%96%e5%be%97%e6%96%b0%e6%96%87%e7%ab%a0-url" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¦‚ä½•å–å¾—æ–°æ–‡ç«  URL
&lt;/h3>
&lt;p>ç¢ºå®š Netlify Functions å¯ä»¥é”æˆæˆ‘å€‘çš„éœ€æ±‚å¾Œï¼Œåœ¨ä¸²æ¥ Indexing API å‰ï¼Œç¸½å¾—çŸ¥é“è©²æ€éº¼æŠŠæ–°æ–‡ç« çš„ç¶²å€æ¨é€çµ¦ Indexing API å§ï¼&lt;/p>
&lt;p>åŸæœ¬çš„æƒ³æ³•æ˜¯ï¼Œç”±æ–¼ Hugo æ¯æ¬¡ build çš„æ™‚å€™éƒ½æœƒè‡ªå‹•å¹«æˆ‘å€‘æ›´æ–° sitemap æª”æ¡ˆï¼Œå› æ­¤æˆ–è¨±å¯ä»¥é€éæ–°èˆŠ sitemap çš„æ¯”å°æª¢æŸ¥æ˜¯å¦æœ‰æ–°å¢çš„ page urlï¼Œå¦‚æœæœ‰çš„è©±å°±æŠŠé€™äº› url æ¨é€çµ¦ Google Indexing APIã€‚ä½†å•é¡Œå°±ä¾†äº†ï¼Œè¦æœ‰èˆŠæª”æ¡ˆå¯ä»¥æ‹¿å‡ºä¾†æ¯”è¼ƒï¼Œé‚£å°±å¾—åœ¨æ¯æ¬¡åŸ·è¡Œé€™å€‹ function å®Œå­˜ä¸‹ç•¶å‰çš„ sitemap æª”æ¡ˆï¼Œé€™æ¨£æ‰èƒ½åœ¨ä¸‹ä¸€æ¬¡åŸ·è¡Œ function æ™‚ï¼Œå–å¾—ä¸Šæ¬¡å­˜ä¸‹çš„ sitemap æª”æ¡ˆèˆ‡æ–°çš„åšæ¯”å°ã€‚ç„¶è€Œï¼Œ&lt;strong>åœ¨ functions ç•¶ä¸­ç„¡æ³•å°å°ˆæ¡ˆé€²è¡Œæª”æ¡ˆçš„è®€å¯«&lt;/strong>ï¼Œ(&lt;a href="https://answers.netlify.com/t/is-it-possible-to-use-a-filesystem-like-node-fs-with-netlify-functions-answered/77409">æœ‰äººç™¼å•è¢«å®˜æ–¹å›è¦†åœ¨æ­¤&lt;/a>)ï¼Œé€™éº¼ä¸€ä¾†é‚„å¾—å¦å¤–æ‰¾ä¸€å€‹å¤–éƒ¨ç©ºé–“ä¾‹å¦‚ AWS S3 ä¹‹é¡çš„å»å­˜æ”¾é€™å€‹æª”æ¡ˆï¼Œè¦ºå¾—æœ‰é»å¤ªéº»ç…©äº†ï¼Œè€Œä¸”é€™å€‹åŠŸèƒ½æ‡‰è©²ä¹Ÿä¸éœ€è¦åšåˆ°é€™éº¼è‡ªå‹•åŒ–(ç•¢ç«Ÿæš«æ™‚åªæœ‰æˆ‘è¦ç”¨)ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å¾Œä¾†ç™¼ç¾ payload ç•¶ä¸­æœ‰ä¸€å€‹æ¬„ä½ &lt;code>payload.title&lt;/code> æ˜¯æ¯æ¬¡ commit çš„è¨Šæ¯ï¼Œå› çˆ² Netlify çš„è¨­å®šæ˜¯ä¸€ push commit å°±æœƒè§¸ç™¼ deployï¼Œæ‰€ä»¥æ¯æ¬¡ deploy ä¸€å®šéƒ½æœƒæœ‰ä¸€å€‹ commit msgã€‚æ–¼æ˜¯æƒ³åˆ°å¯ä»¥ç›´æ¥åˆ©ç”¨ commit msg å¸¶å…¥æ–°æ–‡ç« çš„ slugï¼Œåœ¨ payload ä¸­å–å¾— &lt;code>payload.title&lt;/code> è§£æå‡º slug å­—ä¸²å¾Œçµ„å‡ºæ–°æ–‡ç« çš„ç¶²å€ã€‚é›–ç„¶å¥½åƒæœ‰é»åœŸæ³•ç…‰é‹¼ï¼Œä¸éæ„Ÿè¦ºé‚„æŒºå¯è¡Œçš„ã€‚&lt;/p>
&lt;h3 id="ä¸²æ¥-google-indexing-api">
&lt;a href="#%e4%b8%b2%e6%8e%a5-google-indexing-api" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ä¸²æ¥ Google Indexing API
&lt;/h3>
&lt;p>ç¢ºå®šè³‡æ–™çš„å–å¾—éƒ½æ²’å•é¡Œå¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯é€²å…¥ä¸²æ¥ Indexing API çš„éƒ¨åˆ†äº†ã€‚å®Œæˆ&lt;a href="https://developers.google.com/search/apis/indexing-api/v3/prereqs?hl=zh-tw">å®˜æ–¹æ–‡ä»¶äº‹å‰æº–å‚™&lt;/a>çš„æ­¥é©Ÿã€Œç‚ºç”¨æˆ¶ç«¯å»ºç«‹å°ˆæ¡ˆã€ã€ã€Œå»ºç«‹æœå‹™å¸³æˆ¶ã€ã€ã€Œå°‡æœå‹™å¸³æˆ¶æ–°å¢ç‚ºç¶²ç«™æ“æœ‰è€…ã€ä¹‹å¾Œï¼Œå°±å¯ä»¥&lt;a href="https://developers.google.com/search/apis/indexing-api/v3/libraries?hl=zh-tw#go">æ ¹æ“šè¦ä½¿ç”¨çš„ç¨‹å¼èªè¨€å®‰è£ google api sdk ç¨‹å¼&lt;/a>ï¼Œé€™é‚Šé¸æ“‡ä½¿ç”¨ &lt;a href="https://github.com/googleapis/google-api-go-client">Golang çš„ sdk&lt;/a>ã€‚&lt;/p>
&lt;p>å‰›å‰›ç¬¬äºŒå€‹æ­¥é©Ÿã€Œå»ºç«‹æœå‹™å¸³æˆ¶ã€æ™‚ï¼Œä¸‹è¼‰äº†ä¸€å€‹é‡‘é‘°æª”æ¡ˆ(æŒ‰ç…§å»ºè­°æª”æ¡ˆé¡å‹é¸æ“‡JSON)å­˜åœ¨æœ¬åœ°é›»è…¦è£¡ï¼Œä½¿ç”¨é€™å€‹é‡‘é‘°çš„æ–¹å¼å¾ˆç°¡å–®ï¼Œæœ¬åœ°ç«¯é–‹ç™¼çš„è©±ï¼Œåªè¦åœ¨å‘½ä»¤åˆ—å®£å‘Šå€‹ç’°å¢ƒè®Šæ•¸ï¼š&lt;a href="https://cloud.google.com/docs/authentication/provide-credentials-adc#wlif-key">Ref&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>$ export GOOGLE_APPLICATION_CREDENTIALS=&amp;#34;KEY_PATH&amp;#34; //KEY_PATH å–ä»£ç‚ºå‰›å‰›ä¸‹è¼‰çš„é‡‘é‘°æª”æ¡ˆè·¯å¾‘
&lt;/code>&lt;/pre>&lt;p>å…ˆæ¸¬è©¦ä¸€ä¸‹ä¸²æ¥æœ‰æ²’æœ‰æˆåŠŸï¼Œå¸¶å€‹æ¸¬è©¦ç¶²å€ç™¼é€çœ‹çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Go" data-lang="Go">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ./netlify/functions/deploy-succeeded/deploy-succeeded.go
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/aws/aws-lambda-go/events&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;github.com/aws/aws-lambda-go/lambda&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;google.golang.org/api/indexing/v3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">indexingService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">indexing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fullUrl&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;https://emmie.work/posts/test&amp;#34;&lt;/span> &lt;span class="c1">//å…ˆå¯«æ­»ä¸€å€‹æ¸¬è©¦ç¶²å€
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">notification&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">indexing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UrlNotification&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Url&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fullUrl&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;URL_UPDATED&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">indexingService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UrlNotifications&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Publish&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">notification&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Do&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatalln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServerResponse&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyResponse&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">StatusCode&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Body&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Success send request to notify Google of new article, url: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fullUrl&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">lambda&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">handler&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨åŒå€‹å‘½ä»¤åˆ— session ä¸‹å‰›å‰›çš„ &lt;code>netlify functions:serve&lt;/code> æŒ‡ä»¤ï¼Œçœ‹èµ·ä¾†æ˜¯ work çš„ã€‚
&lt;img loading="lazy"
src="/images/netifly-functions-06.png"
alt="Untitled"
width=2028
height="574" />&lt;/p>
&lt;p>OKï¼Œå•é¡Œåˆä¾†äº†ï¼Œç•¶é€™æ®µç¨‹å¼è¦æ”¾åœ¨ Netlify ä¸Šé¢è·‘æ™‚ï¼Œé›£ä¸æˆè¦æŠŠé€™å€‹é‡‘é‘°æª”æ¡ˆä¹Ÿé€£åŒä¸Šå‚³åˆ° github repo å—ï¼Œè½èµ·ä¾†æœ‰é»ä¸å¤ªå®‰å…¨ï¼Œè€Œä¸”é‚„è¨˜å¾—å‰›å‰›æåˆ° function è£¡é¢ç„¡æ³•å­˜å–å°ˆæ¡ˆç•¶ä¸­çš„æª”æ¡ˆï¼Œæ‰€ä»¥é€™æ¢è·¯ä¹Ÿä¸å¯è¡Œã€‚é‚£è©²æ€è¾¦å‘¢ï¼Ÿå¾Œä¾†çœ‹åˆ°æœ‰ç¶²å‹ä¹Ÿæœ‰é¡ä¼¼å•é¡Œï¼ˆä½†æˆ‘çªç„¶æ‰¾ä¸åˆ°åŸç™¼å•é€£çµï¼‰ï¼Œç¸½ä¹‹æœ€å¾Œæ¡ç”¨çš„æ–¹æ³•æ˜¯å°‡ç’°å¢ƒè®Šæ•¸çš„å€¼æ”¹æˆé‡‘é‘° JSON æª”å…§å®¹ï¼Œç„¶å¾Œåœ¨ç¨‹å¼è£¡é¢å–å¾—ç’°å¢ƒè®Šæ•¸çš„å€¼å¾Œï¼Œé€é option è¨­å®šé‡‘é‘°çš„å€¼ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ export GOOGLE_APPLICATION_CREDENTIALS=&amp;#39;{
&amp;#34;type&amp;#34;: &amp;#34;service_account&amp;#34;,
&amp;#34;project_id&amp;#34;: &amp;#34;emmie-hugo-blog&amp;#34;,
&amp;#34;private_key_id&amp;#34;:&amp;#34;xxxxxx&amp;#34;,
//...
}&amp;#39;
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-Go" data-lang="Go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">request&lt;/span> &lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">events&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">APIGatewayProxyResponse&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">credentialJsonStr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;GOOGLE_APPLICATION_CREDENTIALS&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">indexingService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">indexing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">option&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithCredentialsJSON&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">credentialJsonStr&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£ä¸€ä¾†ï¼Œå°±èƒ½å¤ å–®ç´”é€éè¨­å®šç’°å¢ƒè®Šæ•¸çš„å€¼å–ä»£éœ€è¦å­˜å–æª”æ¡ˆçš„æ–¹å¼ã€‚ä½†è¦åœ¨éƒ¨ç½²æ™‚åŠ ä¸Šé€™å€‹è®Šæ•¸ï¼Œæˆ‘å€‘é‚„å¾—å†åšå…©å€‹å‹•ä½œï¼Œä¸€æ˜¯åœ¨ &lt;code>./netlify.toml&lt;/code> æª”æ¡ˆï¼Œè¨­å®šç’°å¢ƒè®Šæ•¸çš„ KEYï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ./netlify.toml&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">production&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">environment&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">HUGO_ENV&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;production&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">GOOGLE_APPLICATION_CREDENTIALS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;$GOOGLE_APPLICATION_CREDENTIALS&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>äºŒæ˜¯åˆ° &lt;a href="https://app.netlify.com/sites/emmielin/settings/env">Netlify å¾Œå°&lt;/a>è¨­å®šç’°å¢ƒè®Šæ•¸çš„å€¼ï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-07.png"
alt="Untitled"
width=945
height="707" />&lt;/p>
&lt;p>ç„¶å¾Œå°±å¤§åŠŸå‘Šæˆäº†ï¼ï¼&lt;/p>
&lt;p>é€™é‚Šç›´æ¥é™„ä¸Šæœ€å¾Œå®Œæˆçš„ codeï¼š &lt;a href="https://github.com/linxinemily/google-indexing-netlify-function/blob/main/deploy-succeeded.go">https://github.com/linxinemily/google-indexing-netlify-function/blob/main/deploy-succeeded.go&lt;/a>&lt;/p>
&lt;p>å†ä¾†æ¸¬è©¦çœ‹çœ‹ç™¼ä¸€å€‹ commit ç„¶å¾Œ push:&lt;/p>
&lt;pre tabindex="0">&lt;code>git commit -m &amp;#34;new article: netlify-function-google-indexing-api&amp;#34; &amp;amp;&amp;amp; git push
&lt;/code>&lt;/pre>&lt;p>é©—è­‰ä¸€ä¸‹æ˜¯å¦æœ‰æˆåŠŸæäº¤ç´¢å¼•ï¼Œåˆ°å¾Œå°çœ‹ function æœ‰æ²’æœ‰ logï¼Œæœ‰é¡¯ç¤ºä»£è¡¨æˆåŠŸï¼š
&lt;img loading="lazy"
src="/images/netifly-functions-08.png"
alt="Untitled"
width=1222
height="253" />&lt;/p>
&lt;h2 id="å¾Œè¨˜">
&lt;a href="#%e5%be%8c%e8%a8%98" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å¾Œè¨˜
&lt;/h2>
&lt;p>ä»¥ä¸Šï¼Œå¤§æ¦‚å°±å®Œæˆäº† 90% çš„äººå·¥ä½œæ¥­ï¼ˆå‰©ä¸‹ 10ï¼… æ˜¯è¦è‡ªå·±æ‰“ commit msg çš„éƒ¨åˆ†ï¼‰ï¼Œä¸éä¹Ÿå·²ç¶“å¿ƒæ»¿æ„è¶³äº†ï¼æ¯”è¼ƒå¤§çš„æ”¶ç©«å°±æ˜¯ç™¼æ˜äº† Netlify Functions é€™å€‹ä¸éŒ¯ç”¨çš„åŠŸèƒ½ï¼Œä»¥åŠé‡æº«ä¸€ä¸‹ä¸² Google API çš„å›æ†¶ã€‚
ç¾åœ¨èƒ½æƒ³åˆ°å”¯ä¸€çš„ç¼ºé™·æ˜¯ï¼Œç•¶ä¸€æ¬¡æ¨å¤šå€‹ commit æ™‚ï¼Œç”±æ–¼ deploy çš„ payload åªæœƒæœ‰æœ€æ–°ä¸€å€‹ commit çš„ç›¸é—œè³‡è¨Šï¼Œæ‰€ä»¥å¦‚æœé€™å¹¾å€‹ commit éƒ½åŒ…å«æœ‰ä¸€ç¯‡æ–°æ–‡ç« ï¼Œé‚£å°±åªæœ‰æœ€å¾Œç™¼çš„é‚£å€‹ commit çš„æ–‡ç« æœƒè¢«æäº¤ç´¢å¼•ï¼Œä¸éæˆ‘å¯«æ–‡é »ç‡æ²’æœ‰é«˜æˆé‚£æ¨£æ‰€ä»¥æ‡‰è©²æ˜¯ä¸å¤ªå¯èƒ½æœƒé‡åˆ°é€™ç¨®æƒ…æ³ï¼Œæ‰€ä»¥å°±å…ˆç•¥éäº†ã€‚å‰©ä¸‹çš„éƒ¨åˆ†å°±çœ‹æœªä¾†æœ‰æ²’æœ‰é‡åˆ°ä»€éº¼ä½¿ç”¨ä¸Šçš„å›°é›£å†ä¾†å„ªåŒ–å§ï¼&lt;/p></description></item><item><title>Golang å¸¸è¦‹éŒ¯èª¤ - åœ¨è¿´åœˆç•¶ä¸­å¼•ç”¨è¿­ä»£è®Šæ•¸(iterator variable)</title><link>/posts/golang-using-reference-to-loop-iterator-variable/</link><pubDate>Tue, 21 Feb 2023 00:00:00 +0000</pubDate><guid>/posts/golang-using-reference-to-loop-iterator-variable/</guid><description>
&lt;p>å‰å¹¾å¤©é–±è®€åˆ°&lt;a href="https://github.com/golang/go/wiki/CommonMistakes">é€™ç¯‡å®˜æ–¹ wiki&lt;/a> ï¼Œå…¶ä¸­çš„ &lt;a href="https://github.com/golang/go/wiki/CommonMistakes#using-reference-to-loop-iterator-variable">Using reference to loop iterator variable&lt;/a>ï¼Œä¹Ÿå°±æ˜¯é—œæ–¼åœ¨è¿´åœˆç•¶ä¸­å¼•ç”¨è¿­ä»£è®Šæ•¸å¸¸çŠ¯çš„éŒ¯èª¤ã€‚ç•¶ä¸­æœ‰å€‹ç¯„ä¾‹ä¸€é–‹å§‹è®“æˆ‘ä¸æ˜¯å¾ˆç†è§£ï¼Œå¾Œä¾†çµ‚æ–¼ææ‡‚ï¼Œæ‰€ä»¥æ‰æƒ³èªªç­†è¨˜ä¸‹ä¾†ï¼Œä¹Ÿé †ä¾¿é‡æ¸…ä¸€ä¸‹æ€è·¯ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œç¬¬ä¸€å€‹ç¯„ä¾‹æ»¿å¥½ç†è§£çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">out&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">out&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Values:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Addresses:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¼¸å‡ºçš„çµæœæœƒæ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>Values: 3 3 3
Addresses: 0x40e020 0x40e020 0x40e020
&lt;/code>&lt;/pre>&lt;p>åŸå› æ˜¯ï¼Œç”±æ–¼ append åˆ° &lt;code>out&lt;/code> é€™å€‹ slice çš„åƒæ•¸æ˜¯ &lt;code>&amp;amp;i&lt;/code> ï¼Œå‚³å…¥çš„æ˜¯ä¸€å€‹ &lt;code>int é¡å‹çš„è®Šæ•¸æŒ‡æ¨™&lt;/code>ï¼ˆ &lt;code>out&lt;/code> çš„å‹åˆ¥ä¹Ÿæ˜¯ä¸€å€‹ &lt;code>å­˜æ”¾å¤šå€‹ int é¡å‹çš„è®Šæ•¸æŒ‡æ¨™ çš„ slice&lt;/code>ï¼‰ï¼Œæ‰€ä»¥æ¯å€‹è¿­ä»£éƒ½æ˜¯æŠŠåŒä¸€å€‹è®Šæ•¸æŒ‡æ¨™ append åˆ° &lt;code>out&lt;/code> è£¡é¢ï¼Œå› æ­¤ç•¶è¿­ä»£åˆ°æœ€å¾Œä¸€æ¬¡æ™‚ï¼Œè©²è®Šæ•¸æŒ‡æ¨™è£¡é¢å­˜æ”¾çš„å€¼å·²ç¶“è®Šæˆ &lt;code>3&lt;/code> ï¼Œæ‰€ä»¥å°å‡ºä¾†å°±æ˜¯éƒ½æ˜¯ &lt;code>3&lt;/code> ã€‚&lt;/p>
&lt;p>è€Œè§£æ±ºçš„è¾¦æ³•å°±æ˜¯æŠŠ &lt;code>i&lt;/code> çš„å€¼è¤‡è£½åˆ°å¦ä¸€å€‹æ–°è®Šæ•¸ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="c1">// Copy i into a new variable.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">out&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ¨£ä¸€ä¾†ï¼Œ å°±èƒ½ä¿è­‰æ¯æ¬¡è¿­ä»£ç•¶ä¸­çš„ &lt;code>&amp;amp;i&lt;/code> å°±æ˜¯ç•¶å‰è¿­ä»£æ‰€å‰µé€ çš„æ–°è®Šæ•¸çš„æŒ‡æ¨™ï¼Œä¸æœƒå°è‡´éé æœŸçš„çµæœï¼Œä¹Ÿè®“åŸæœ¬åªèƒ½å­˜æ´»åœ¨ for scope ç•¶ä¸­çš„è®Šæ•¸ &lt;code>i&lt;/code> èƒ½å¤ åœ¨è¿´åœˆä¹‹å¤–è¢«å¼•ç”¨ï¼Œä¸æœƒåœ¨è¿´åœˆçµæŸå¾Œå°±è¢«å›æ”¶ã€‚&lt;/p>
&lt;p>æ¥ä¸‹ä¾†çš„å¦ä¸€å€‹ç¯„ä¾‹ï¼Œå°±æ˜¯è®“æˆ‘ä¸€é–‹å§‹ä¸æ˜¯å¾ˆèƒ½ç†è§£çš„åœ°æ–¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">out&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="p">[][&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">}}&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">out&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Values:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šç¨‹å¼çš„è¼¸å‡ºæ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>Values: [[3] [3] [3]]
&lt;/code>&lt;/pre>&lt;p>ä½†å¦‚æœç•¶åªæ”¹å‹•ä¸€å€‹åœ°æ–¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">out&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="p">[][]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">},&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">}}&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// æŠŠé•·åº¦ 1 æ‹¿æ‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">out&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">[:])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Values:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šçš„è¼¸å‡ºå°±è®Šæˆé æœŸçš„çµæœï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>Values: [[1] [2] [3]]
&lt;/code>&lt;/pre>&lt;p>..ç­‰ç­‰ï¼Œä¸æ˜¯æ‰å·®ä¸€å€‹å­—å—ï¼Ÿå¯¦éš›ææ‡‚å¾Œï¼Œå·®ä¸€å€‹å­—ä½†å…¶å¯¦å·®å¾ˆå¤šï¼Œå› ç‚ºé€™å…©å€‹ç¯„ä¾‹ç•¶ä¸­çš„è¿­ä»£è®Šæ•¸é¡å‹å®Œå…¨ä¸åŒã€‚&lt;/p>
&lt;p>åŸæœ¬çš„ç¯„ä¾‹ç•¶ä¸­ï¼Œè¢«è¿­ä»£çš„ slice è£é¢æ”¾çš„æ˜¯ &lt;code>é•·åº¦ç‚º 1 ä¸”å…§å®¹ç‰©ç‚º int é¡å‹&lt;/code> çš„é™£åˆ—ï¼š &lt;code>[][1]int{{1}, {2}, {3}}&lt;/code> ï¼Œè€Œå¾Œé¢æ›´å‹•çš„ç‰ˆæœ¬ï¼Œè¢«è¿­ä»£çš„ slice è£¡é¢æ”¾çš„æ˜¯å¦ä¸€å€‹ sliceï¼š &lt;code>[][]int{{1}, {2}, {3}}&lt;/code> ã€‚å› ç‚ºåœ¨ Golang ç•¶ä¸­ï¼Œå®£å‘Šé™£åˆ—å’Œ slice çš„å¯«æ³•å¾ˆåƒï¼Œå·®åˆ¥åœ¨æ–¼é™£åˆ—æ˜¯éœ€è¦æŒ‡å®šé•·åº¦çš„ï¼Œä¸æŒ‡å®šé•·åº¦çš„è©±æœƒè®Šæˆ sliceã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="c1">// å¸¶æŒ‡å®šé•·åº¦æœƒæ˜¯é™£åˆ—
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="c1">// ä¸å¸¶é•·åº¦æœƒæ˜¯ slice
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œä¸”é™£åˆ—å’Œå…¶ä»–ç´”å€¼é¡å‹ä¸€æ¨£æ˜¯å±¬æ–¼ value typeã€‚ä¹Ÿå°±æ˜¯ç•¶æŠŠé™£åˆ—è³¦å€¼çµ¦å¦ä¸€å€‹è®Šæ•¸æ™‚ï¼Œç­‰åŒæ‹·è²ä¸€ä»½ä¸€æ¨£çš„é™£åˆ—é€²å»æ–°çš„è®Šæ•¸ï¼ŒåŸå§‹é™£åˆ—ä¸æœƒå—åˆ°è©²æ–°é™£åˆ—çš„æ›´å‹•å½±éŸ¿ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">arr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">arr2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">arr&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">arr2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">arr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// output: [1]
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å› æ­¤ï¼Œåœ¨å…©å€‹ç¯„ä¾‹ç•¶ä¸­ &lt;code>i[:]&lt;/code> æ‰€ä»£è¡¨çš„æ„ç¾©å°±ä¸åŒã€‚ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­çš„ &lt;code>i&lt;/code> æ˜¯é™£åˆ—ï¼Œ&lt;code>i[:]&lt;/code> ä»£è¡¨ä¸€å€‹å¼•ç”¨ &lt;code>i&lt;/code> é€™å€‹é™£åˆ—çš„ slice ï¼ˆslice åº•å±¤æŒ‡å‘çš„é™£åˆ—æŒ‡æ¨™ = &lt;code>&amp;amp;i&lt;/code>ï¼‰ï¼Œé›–ç„¶æ¯å€‹è¿­ä»£ä¸­éƒ½æœƒå‰µé€ ä¸€å€‹æ–°çš„ sliceï¼Œä½†é€™äº› slice åº•å±¤æ‰€å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€å€‹è®Šæ•¸æŒ‡æ¨™ ã€‚&lt;/p>
&lt;p>åˆ°é€™é‚Šå°±å¯ä»¥çœ‹å‡ºï¼Œå…¶å¯¦é€™å€‹ç‹€æ³è·Ÿæœ€ä¸€é–‹å§‹ &lt;code>i&lt;/code> ç‚º int é¡å‹è®Šæ•¸çš„ç¯„ä¾‹ä¸€æ¨£ï¼Œ ç”±æ–¼æ¯æ¬¡è¿­ä»£æ™‚ï¼Œ &lt;code>i&lt;/code> çš„å€¼éƒ½ä¸€ç›´åœ¨æ›¿æ›ï¼Œç›´åˆ°è¿´åœˆçµæŸï¼Œ &lt;code>i&lt;/code> çš„å€¼åœç•™åœ¨æœ€å¾Œä¸€æ¬¡è¿­ä»£ç•¶ä¸­è¢«è³¦äºˆçš„å€¼ã€‚&lt;/p>
&lt;p>è€Œç¬¬äºŒå€‹ç¯„ä¾‹ä¸­ï¼Œ &lt;code>i[:]&lt;/code> æ˜¯ä»£è¡¨å°‡åŸå…ˆ &lt;code>i&lt;/code> é€™å€‹ slice è¤‡è£½å‡ºä¸€ä»½ sliceï¼Œè€ŒåŸºæ–¼è¤‡è£½ slice çš„åŸç†ï¼Œé€™å…©å€‹ slice åº•å±¤éƒ½æœƒæŒ‡å‘åŒä¸€å€‹é™£åˆ—ï¼ˆè¤‡è£½çš„æ˜¯ slice çš„ headerï¼ŒåŒ…å«é™£åˆ—çš„(ç¬¬ä¸€å€‹å…ƒç´ çš„)æŒ‡æ¨™ã€é•·åº¦çš„å€¼ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>What exactly is this slice variable? Itâ€™s not quite the full story, but for now think of a slice as a little data structure with two elements: a length and a pointer to an element of an array. You can think of it as being built like this behind the scenes:&lt;/p>
&lt;pre tabindex="0">&lt;code>type sliceHeader struct {
Length int
ZerothElement *byte
}
&lt;/code>&lt;/pre>&lt;/blockquote>
&lt;p>ä½† slice æœ¬èº«ä»æ˜¯ä¸€å€‹ value&lt;/p>
&lt;blockquote>
&lt;p>Itâ€™s important to understand that even though a slice contains a pointer, it is itself a value. Under the covers, it is a struct value holding a pointer and a length. It isÂ &lt;em>not&lt;/em>
Â a pointer to a struct.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ç•¶ä¸‹ä¸€æ¬¡è¿­ä»£æ™‚ï¼Œ &lt;code>i&lt;/code> çš„å…§å®¹æ›æˆä¸‹ä¸€å€‹ sliceï¼Œæœƒå†æ¬¡è¤‡è£½ &lt;code>i&lt;/code> çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ header çš„éƒ¨åˆ†çµ¦æ–°çš„ sliceï¼Œæ¯æ¬¡è¿­ä»£ä¸­ç”¢ç”Ÿçš„æ–° slice éƒ½å’Œè¿­ä»£ç•¶ä¸‹çš„ slice æœ‰ç›¸åŒçš„ headerï¼Œæ¯å€‹è¤‡è£½ä¹Ÿéƒ½å¼•ç”¨å’Œè¤‡è£½å°è±¡ç›¸åŒçš„åº•å±¤é™£åˆ—ã€‚æ•´å€‹æµç¨‹å§‹çµ‚æ²’æœ‰å»å¼•ç”¨åˆ° &lt;code>i&lt;/code> çš„æŒ‡æ¨™ï¼Œä¹Ÿå°±ä¸æœƒæœ‰ä¸Šé¢ç¯„ä¾‹çš„å•é¡Œã€‚&lt;/p>
&lt;p>ç¸½çµï¼Œè¿­ä»£è®Šæ•¸åœ¨è¿­ä»£åŒæ™‚ï¼Œå€¼ä¹Ÿæœƒä¸æ–·æ”¹è®Šï¼Œå¦‚æœåœ¨è¿´åœˆä¸­æœ‰å¼•ç”¨åˆ°è¿­ä»£è®Šæ•¸ï¼Œå¯èƒ½æœƒæœ‰éé æœŸçš„è¡Œç‚ºã€‚&lt;/p>
&lt;h2 id="references">
&lt;a href="#references" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
References
&lt;/h2>
&lt;p>&lt;a href="https://github.com/golang/go/wiki/CommonMistakes">CommonMistakes&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://research.swtch.com/godata">research!rsc: Go Data Structures&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://go.dev/blog/slices">Arrays, slices (and strings): The mechanics of &amp;lsquo;append&amp;rsquo; - The Go Programming Language&lt;/a>&lt;/p></description></item><item><title>å°‡è³‡æ–™å¾ MariaDB é·ç§»è‡³ AWS DynamoDB éç¨‹ç´€éŒ„</title><link>/posts/migrate-data-from-mariadb-to-dynamodb/</link><pubDate>Wed, 08 Feb 2023 00:00:00 +0000</pubDate><guid>/posts/migrate-data-from-mariadb-to-dynamodb/</guid><description>
&lt;h2 id="å‰æƒ…æè¦">
&lt;a href="#%e5%89%8d%e6%83%85%e6%8f%90%e8%a6%81" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å‰æƒ…æè¦
&lt;/h2>
&lt;p>å‰é™£å­å°‡å…¬å¸ä¸€å€‹ Laravel å°ˆæ¡ˆç•¶ä¸­é€šçŸ¥çš„åŠŸèƒ½éƒ¨åˆ†åˆ‡å‡ºåˆ°å¦ä¸€å€‹ç”¨ Golang æ§‹å»ºçš„æœå‹™ï¼Œä¸¦ä¸”æŠŠè³‡æ–™å¾ MariaDB é·ç§»åˆ° AWS DynamoDBã€‚æƒ³èªªç¨å¾®ç´€éŒ„ä¸€ä¸‹é€™å€‹éç¨‹ï¼Œç®—æ˜¯ä¸€å€‹æ”¶ç©«æ»¿å¤šçš„ç¶“é©—ã€‚&lt;/p>
&lt;p>ç”±æ–¼åŸæœ¬å­˜åœ¨ MariaDB çš„é€šçŸ¥è³‡æ–™é‡æ—¥ç›Šè‚¥å¤§ï¼Œé›–ç„¶ç•¶å‰ä»ä¸ç®—æ˜¯å·¨é‡è³‡æ–™ï¼Œå¤§ç´„åƒè¬ç´šè³‡æ–™é‡è€Œå·²ï¼Œä½†æ˜¯å…‰æ˜¯é€™å€‹ç­‰ç´šçš„è³‡æ–™é‡ï¼Œåªè¦ä¸å°å¿ƒä¸‹ä¸€å€‹ç¯„åœæ€§çš„ select èªå¥éƒ½æœ‰å¯èƒ½æœƒé€ æˆæ•´å€‹ DB å¡æ­»ç„¶å¾Œæœå‹™æ›æ‰ï¼ˆçœŸå¯¦ç™¼ç”Ÿéåœ¨ production ç’°å¢ƒä¸Šçš„äº‹ä»¶â€¦ï¼‰ã€‚ç„¶è€Œé€šçŸ¥åœ¨æˆ‘å€‘çš„ç³»çµ±ç•¶ä¸­å…¶å¯¦åƒ…æ˜¯ä¸€å€‹è¼”åŠ©çš„åŠŸèƒ½ï¼Œä½†ä¸€æœ‰å•é¡Œå»å¯èƒ½ç›´æ¥å°è‡´æ•´å€‹æœå‹™åœæ“ºï¼Œæ€éº¼æƒ³éƒ½ä¸å¤ªåˆç†ã€‚å› æ­¤ï¼Œã€Œéš”é›¢ã€å°±æ˜¯æˆ‘å€‘é¦–è¦çš„ç›®çš„â€”â€”&lt;em>é€šçŸ¥çš„è³‡æ–™ä¸è©²å’Œä¸»æœå‹™çš„è³‡æ–™æ“ºåœ¨åŒå€‹è³‡æ–™åº«è£¡&lt;/em> ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ğŸ“ Note:
ç•¶è³‡æ–™é‡åˆ°é”ç™¾è¬ç´šä»¥ä¸Šå¾Œï¼Œcount(*) èªæ³•æ˜é¡¯é€Ÿåº¦è®Šå¾ˆæ…¢ï¼Œåƒé€™æ¨£çš„æŸ¥è©¢èªå¥ &lt;code>select count(*) from UserNotification where id &amp;gt; 51306320 and id &amp;lt;= 57615005 order by id&lt;/code> åŸ·è¡Œèµ·ä¾†å°±è¦å…©ç§’å¤šã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ—¢ç„¶è¦æŠŠè³‡æ–™æ¬å‡ºå»ï¼Œè¦æ¬åˆ°å“ªè£¡å°±æ˜¯å°±æ˜¯ç¬¬äºŒå€‹å•é¡Œï¼Œè€Œæˆ‘å€‘å¾Œä¾†æœƒé¸ç”¨ AWS DynamoDB çš„åŸå› åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>é¢å°ä¹˜è¼‰è³‡æ–™é‡çš„è®ŠåŒ–ï¼ŒDB å¯ä»¥è‡ªå‹•éš¨ä¹‹æ“´å±•å’Œç¸®æ¸›&lt;/li>
&lt;li>æŸ¥è©¢æœ‰æ—¢å®šçš„æ¨¡å¼å’Œè¦å‰‡ï¼Œä¸å¤ªæœƒæœ‰è®Šå‹•ï¼ˆå¦‚ï¼šå–å¾—é€šçŸ¥æœªè®€æ•¸é‡ã€å°‡é€šçŸ¥å·²è®€ etc.ï¼‰ï¼Œä¹Ÿä¸éœ€è¦è¤‡é›œçš„ join æˆ– sub queries ç­‰ç­‰&lt;/li>
&lt;li>ä¸éœ€è¦åš´æ ¼çš„çš„è³‡æ–™ä¸€è‡´æ€§ï¼Œåªè¦æœ‰æœ€çµ‚ä¸€è‡´å³å¯ï¼ˆDynamoDB Consistency Model çš„é è¨­å€¼ï¼Œä¹Ÿæ˜¯èƒ½ä¿æŒæœ€ä½³æ•ˆèƒ½çš„æ¨è–¦é¸é …ï¼‰&lt;/li>
&lt;li>åŸæœ¬å°±æœ‰åœ¨ä½¿ç”¨ AWS çš„æœå‹™ï¼Œä¹‹å¾Œè‹¥æœ‰éœ€è¦å’Œ AWS å…¶ä»–æœå‹™æ•´åˆæ™‚ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿&lt;/li>
&lt;/ul>
&lt;p>è€Œä¹‹æ‰€ä»¥æœƒå¦å»ºä¸€å€‹æœå‹™ï¼Œä¸»è¦æ˜¯ç‚ºäº†å°‡éš”é›¢æ€§æé«˜åˆ°æ‡‰ç”¨å±¤çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿ä¹‹å¾Œå°‡å…¶ä»–é€šçŸ¥ç›¸é—œçš„åŠŸèƒ½éƒ½åˆ‡å‡ºå»ï¼ˆex: æ¨æ’­ï¼‰ï¼Œé¸æ“‡ Golang å‰‡æ˜¯å› ç‚ºå…¶ç°¡å–®å¿«é€Ÿçš„ç‰¹æ€§ï¼Œä¹Ÿå¾ˆé©åˆæ‹¿ä¾†æ­å»ºå¾®æœå‹™ï¼ˆ&lt;del>é‚„æœ‰ä¸€éƒ¨åˆ†ç§å¿ƒæ˜¯æƒ³å¯¦éš›å°‡ Golang é‹ç”¨åœ¨å…¬å¸å°ˆæ¡ˆä¸Š&lt;/del>ï¼‰ã€‚
æ­¤å¤–ï¼Œä½¿ç”¨ Golang é‚„æœ‰ä¸€å€‹å¥½è™•å°±æ˜¯èƒ½å¤ ä½¿ç”¨è¿¸ç™¼ç¨‹å¼å° DynamoDB é€²è¡Œæ“ä½œã€‚DynamoDB æœ¬èº«å°±æœ‰èƒ½åŠ›æ¶ˆåŒ–åŒæ™‚æ•¸åƒå€‹ä»¥ä¸Šå¯«å…¥/è®€å–çš„è«‹æ±‚ï¼ˆæ¯ç§’çš„è«‹æ±‚ååé‡ä¸Šé™å–æ±ºæ–¼æ‰€é¸æ“‡çš„è¨ˆåƒ¹æ–¹å¼/ Read/write capacity modeï¼‰ï¼Œéå¸¸é©åˆæ­é…æ”¯æ´ concurrency çš„ç¨‹å¼èªè¨€ä½¿ç”¨ï¼Œåœ¨éœ€è¦çš„æ™‚å€™å¯ä»¥é€éè¿¸ç™¼ç¨‹å¼å¤§å¹…æé«˜è™•ç†å¤§é‡è³‡æ–™çš„æ•ˆç‡ã€‚&lt;/p>
&lt;h2 id="migrate-ä¹‹å‰çš„æº–å‚™">
&lt;a href="#migrate-%e4%b9%8b%e5%89%8d%e7%9a%84%e6%ba%96%e5%82%99" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Migrate ä¹‹å‰çš„æº–å‚™
&lt;/h2>
&lt;p>åœ¨ migrate è³‡æ–™ä¹‹å‰ï¼Œæˆ‘å€‘æ‰€é€²è¡Œçš„æœå‹™æ›¿æ›æ˜¯é€™æ¨£çš„ï¼š&lt;/p>
&lt;p>åŸæœ¬æ‰€æœ‰ notification ç›¸é—œ API éƒ½ä¸å‹•ï¼Œåˆ†åˆ¥æ–°å¢æ¯ä¸€éš» API å°æ‡‰çš„ API åŠ ä¸Š v2 å‰ç¶´ã€‚è€Œ v2 æ‰€åšçš„äº‹æƒ…éƒ½å’Œ v1 ç›¸åŒï¼Œåªæ˜¯åŸæœ¬æ“ä½œè³‡æ–™æ™‚æ˜¯å° MariaDB æ“ä½œï¼Œéƒ½æ”¹æˆå°å¤–éƒ¨é€šçŸ¥æœå‹™æ“ä½œã€‚&lt;/p>
&lt;p>è€Œåœ¨æ–°å¢é€šçŸ¥è³‡æ–™çš„éƒ¨åˆ†ï¼Œç”±æ–¼é€šçŸ¥æ˜¯åœ¨ä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºæ™‚æ‰æœƒè¢«å»ºç«‹ï¼Œæ‰€ä»¥é€™å€‹éƒ¨åˆ†çš„æ”¹å‹•æ˜¯åœ¨æ¯å€‹æ“ä½œè¡Œç‚ºä¹‹å¾ŒåŸæœ¬æœƒè§¸ç™¼æ–°å¢é€šçŸ¥çš„åœ°æ–¹ï¼Œå…¨éƒ¨ä¹Ÿéƒ½åŠ ä¸Šè§¸ç™¼æ–°å¢ v2 çš„é€šçŸ¥ã€‚&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼Œ&lt;strong>æ–°å¢é€šçŸ¥&lt;/strong>èˆ‡&lt;strong>æ¨æ’­é€šçŸ¥&lt;/strong>æ˜¯ç¨ç«‹é‹ä½œçš„ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºï¼Œè§¸ç™¼æ–°å¢é€šçŸ¥äº‹ä»¶ï¼š&lt;/strong> ç•¶ä¸‹ç«‹å³æ–°å¢é€šçŸ¥è³‡æ–™ï¼ŒåŒæ™‚æ´¾ç™¼ä¸€å€‹æ¨æ’­é€šçŸ¥çš„ queue jobï¼ˆæ–°å¢è³‡æ–™çš„ id æœƒå‚³çµ¦ queue jobï¼‰&lt;/li>
&lt;li>&lt;strong>Queue worker æ¶ˆåŒ– job æ¨æ’­é€šçŸ¥ï¼š&lt;/strong> é€éå‚³é€²ä¾†çš„ id æ‰¾åˆ°æ¬²æ¨æ’­çš„è³‡æ–™ï¼Œå†é€²è¡Œæ¨æ’­&lt;/li>
&lt;/ul>
&lt;p>åœ¨é€™å€‹ç‰ˆæœ¬ç•¶ä¸­ï¼Œæ–°èˆŠçš„ Notification API æœƒä¸¦å­˜ï¼ˆAPI ä¸»è¦å°±æ˜¯æä¾›è®€å–é€šçŸ¥åˆ—è¡¨ã€æ›´æ–°é€šçŸ¥å·²è®€ç‹€æ…‹ï¼‰ï¼Œä¸”åŒæ™‚å„²å­˜æ–°èˆŠç‰ˆé€šçŸ¥è³‡æ–™ï¼Œä½†åœ¨æ¨æ’­çš„ job ç•¶ä¸­æ˜¯åˆ°æ–° DB æ‰¾è³‡æ–™ã€‚&lt;/p>
&lt;h2 id="migrate-æ™‚é‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•">
&lt;a href="#migrate-%e6%99%82%e9%81%87%e5%88%b0%e7%9a%84%e5%95%8f%e9%a1%8c%e8%88%87%e8%a7%a3%e6%b3%95" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Migrate æ™‚é‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•
&lt;/h2>
&lt;p>æˆ‘å€‘æ‰“ç®—è¦ migrate æœ€è¿‘ä¸‰å€‹æœˆçš„è³‡æ–™ï¼Œå…ˆå‰å·²ç¶“æœ‰æº–å‚™å¥½ä¸€éš»å°‡ MariaDB è³‡æ–™ migrate åˆ° DynamoDB çš„ç¨‹å¼ã€‚ç…§åŸæœ¬è¨ˆåŠƒåœ¨ä¸Šç‰ˆå‰è¦å…ˆè·‘ migrateï¼Œç¸½å…±æœ‰ 600 å¤šè¬ç­†è³‡æ–™ï¼Œä¼°è¨ˆè‡³å°‘è¦ä¸€å€‹å°æ™‚ä»¥ä¸Šæ‰è·‘å¾—å®Œï¼Œä½†èˆŠè³‡æ–™æœ‰å¯èƒ½æœƒåœ¨é€™æ®µæœŸé–“å…§è¢«æ›´æ–°ï¼ˆå·²è®€ç‹€æ…‹ï¼‰ï¼Œå°è‡´æ–°èˆŠè³‡æ–™ä¸åŒæ­¥çš„å•é¡Œï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/migrate-1.png"
alt="migrate éç¨‹ä¸­ï¼ŒèˆŠè³‡æ–™å¯èƒ½æœƒè¢«æ›´æ–°ï¼Œæ–°è³‡æ–™å»æ²’æœ‰è¢«æ›´æ–°ï¼Œå°è‡´è³‡æ–™ä¸åŒæ­¥ã€‚"
width=1320
height="482" />&lt;/p>
&lt;p>migrate éç¨‹ä¸­ï¼ŒèˆŠè³‡æ–™å¯èƒ½æœƒè¢«æ›´æ–°ï¼Œæ–°è³‡æ–™å»æ²’æœ‰è¢«æ›´æ–°ï¼Œå°è‡´è³‡æ–™ä¸åŒæ­¥ã€‚&lt;/p>
&lt;p>è§£æ±ºé€™å€‹å•é¡Œçš„æ–¹æ³•å…¶å¯¦é¡¯è€Œæ˜“è¦‹ï¼Œå°±æ˜¯ &lt;strong>åœ¨æ›´æ–°èˆŠ DB è³‡æ–™çš„åŒæ™‚ï¼Œä¹Ÿé€£åŒæ›´æ–°åœ¨æ–° DB çš„åŒä¸€ç­†è³‡æ–™ã€‚&lt;/strong> åŒæ¨£åœ°ï¼Œç‚ºäº†ç›¸å®¹æ€§ï¼ˆå‰ç«¯ web/APP ä¹Ÿè¦æ›´æ›æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼Œä½† web æœƒå…ˆæ›´æ–°ã€APP å°šæœªæº–å‚™å¥½ï¼‰ï¼Œ&lt;strong>æ›´æ–°æ–° DB è³‡æ–™æ™‚ä¹Ÿè¦é€£åŒæ›´æ–°åœ¨èˆŠ DB çš„åŒä¸€ç­†è³‡æ–™&lt;/strong>ï¼Œé€™æ¨£å°±ç®—å‰ç«¯æ›æˆæ‰“ v2 å¾Œ APP ä»åœ¨æ‰“ v1ï¼Œå…©é‚Šçš„è³‡æ–™ä¹Ÿéƒ½æœƒæ˜¯åŒæ­¥çš„ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œ migrate ä¹Ÿå°±ä¸éœ€è¦åœ¨ä¸Šç‰ˆå‰åšï¼Œè€Œæ˜¯åœ¨ä¸Šç‰ˆä¹‹å¾Œé‚„èƒ½å¤ å¾ˆæœ‰é¤˜è£•åœ°æ…¢æ…¢è·‘ã€‚&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/migrate-2.png"
alt="Untitled"
width=2941
height="905" />&lt;/p>
&lt;p>æ–¼æ˜¯åŠ ä¸Šä¿®æ”¹ä¹ŸåŒæ­¥ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†çš„æµç¨‹å¤§æ¦‚æ˜¯é€™æ¨£ï¼š&lt;/p>
&lt;ol>
&lt;li>å¾Œç«¯ä¸Šç‰ˆï¼ˆæ–°å¢ä¿®æ”¹çš†åŒæ­¥è³‡æ–™çš„ç‰ˆæœ¬ï¼‰&lt;/li>
&lt;li>è·‘ migrate æŒ‡ä»¤&lt;/li>
&lt;li>migrate å®Œæˆå¾Œï¼Œå‰ç«¯/APP å†ä¸Šç‰ˆ ï¼ˆæ”¹æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼‰&lt;/li>
&lt;/ol>
&lt;p>å…¶å¯¦æ›´ç„¡ç¸«çš„æ–¹æ³•æ˜¯ç›´æ¥æŠŠ v1 API èƒŒå¾Œéƒ½æ”¹æˆä¸²æ¥æ–°æœå‹™ï¼Œä¸¦æä¾›ç›¸åŒçš„å›å‚³è³‡æ–™æ ¼å¼ï¼Œå¦‚æ­¤çš„è©±å‰ç«¯ä¹Ÿç„¡éœ€æ›¿æ›æ¥å£ã€‚ä½†ç”±æ–¼åœ¨ã€Œè®€å–åˆ—è¡¨ã€API çš„åˆ†é åƒæ•¸æœ‰åšæ”¹å‹•ï¼ˆåŸæœ¬ v1 æ˜¯ä½¿ç”¨é æ•¸å»å–ä¸åŒåˆ†é çš„è³‡æ–™ï¼Œä½†åœ¨ DynamoDB å–è³‡æ–™æ™‚ç„¡æ³•ç”¨æŒ‡å®šé æ•¸çš„æ–¹å¼ï¼Œ&lt;em>ä¸æ”¯æŒåƒæ˜¯ SQL çš„ offset èªæ³•çš„ç”¨æ³•æˆ–å¯ä»¥é”åˆ°é¡ä¼¼æ•ˆæœçš„æ–¹æ³•&lt;/em>ï¼Œè€Œæ˜¯è¦æŒ‡å®šå¾å“ªç­†è³‡æ–™é–‹å§‹å¾€ä¸‹å–å¹¾ç­†çš„æ–¹å¼ï¼Œé¡ä¼¼ Cursor çš„æ¦‚å¿µï¼‰ï¼Œå‰ç«¯å¿…å®šå¾—é€²è¡Œç›¸å°æ‡‰çš„ä¿®æ”¹ï¼Œç„¡æ³•ç›´æ¥æŠ½æ›ã€‚&lt;/p>
&lt;p>ä¸éé€éä»¥ä¸Šçš„åšæ³•ï¼Œå·²ç¶“èƒ½å¤ åœ¨ä¸è®“ä½¿ç”¨è€…è¦ºå¯Ÿçš„å‰æä¸‹ï¼Œå°‡è³‡æ–™åº«é€²è¡ŒæŠ½æ›ä¸¦å®Œæˆè³‡æ–™çš„æ¬ç§»ã€‚å¾ŒçºŒå°±åªéœ€è¦æŒçºŒè¿½è¹¤ Logï¼Œå¦‚æœ v1 API éƒ½æ²’æœ‰å†è¢«å‘¼å«çš„è©±ï¼Œå°±å¯ä»¥ç›´æ¥æŠŠ v1 éƒ½æ‹”æ‰ï¼Œä¹Ÿç„¡éœ€å†åŒæ­¥å°‡è³‡æ–™å¯«å…¥èˆŠ DBã€æ›´æ–°èˆŠ DB çš„è³‡æ–™ ã€‚&lt;/p></description></item><item><title>Laravel Prevent Lazy Loading è¸©å‘å¿ƒå¾—åŠåŸç†åˆ†æ</title><link>/posts/laravel-prevent-lazy-loading/</link><pubDate>Thu, 29 Dec 2022 00:00:00 +0000</pubDate><guid>/posts/laravel-prevent-lazy-loading/</guid><description>
&lt;p>åœ¨ Laravel ç•¶ä¸­ï¼Œæˆ‘å€‘å¯ä»¥é€éã€Œ&lt;a href="https://laravel.com/docs/9.x/eloquent-relationships#relationship-methods-vs-dynamic-properties">å‹•æ…‹é—œè¯å±¬æ€§(Dynamic relationship properties)&lt;/a>ã€ç›´æ¥å–å¾— Model çš„é—œè¯è³‡æ–™ï¼Œè€Œè©²è¡Œç‚ºè¢«å®˜æ–¹ç¨±ç‚º ã€ŒLazy Loadingã€ï¼Œç•¶å–å€¼æ™‚å°±æœƒè‡ªå‹•å°‡é—œè¯è³‡æ–™è¼‰å…¥ï¼Œéå¸¸æ–¹ä¾¿ã€‚ä½†ä½¿ç”¨ä¸Šä¸€ä¸å°å¿ƒå°±å¾ˆæœ‰å¯èƒ½æœƒé€ æˆ N+1 å•é¡Œã€‚&lt;/p>
&lt;blockquote>
&lt;p>N+1 å•é¡Œé€šå¸¸æ˜¯æŒ‡ï¼Œåœ¨å¾—åˆ°ä¸€å€‹ Models of Collection/Array å¾Œï¼Œåˆåœ¨éæ­·æ¯å€‹ Model æ™‚ï¼Œé€é Lazy Loading å–å¾—å…¶é—œè¯è³‡æ–™ï¼Œæœƒå°è‡´ æœ‰ N å€‹ Model å°±æœƒåŸ·è¡Œ N+1 æ¬¡ Queryã€‚éå¤šçš„ DB Query æ¬¡æ•¸å¯èƒ½æœƒå°æ•ˆèƒ½é€ æˆåš´é‡å½±éŸ¿ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>Laravel 8 é–‹å§‹å°±æœ‰æä¾›&lt;a href="https://laravel.com/docs/9.x/eloquent-relationships#preventing-lazy-loading">é¿å… Lazy Loading çš„æ–¹æ³•&lt;/a>ï¼Œ
åªè¦åœ¨ &lt;code>App\Providers\AppServiceProvider&lt;/code> ç•¶ä¸­çš„ &lt;code>boot()&lt;/code> æ–¹æ³•è£¡é¢åŠ ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// app/Providers/AppServiceProvider.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">use&lt;/span> &lt;span class="nx">Illuminate\Database\Eloquent\Model&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">boot&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Model&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">preventLazyLoading&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="nx">app&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">isProduction&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="c1">//é è¨­ç‚º true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æ­¤ä¸€ä¾†ï¼Œç•¶ Lazy Loading è¢«è§¸ç™¼æ™‚ï¼Œå°±æœƒç›´æ¥æ‹‹å‡ºä¾‹å¤– (&lt;code>Illuminate\Database\LazyLoadingViolationException&lt;/code>)&lt;/p>
&lt;p>è€Œç•¶åˆè©²æ–°åŠŸèƒ½ç™¼å¸ƒæ™‚ï¼Œlaravel-news ç¶²ç«™&lt;a href="https://laravel-news.com/disable-eloquent-lazy-loading-during-development">æœ‰ä¸€ç¯‡æ–‡ç« &lt;/a>å°±åœ¨ä»‹ç´¹é€™å€‹åŠŸèƒ½ã€‚è©²ç¯‡æ–‡ç« ç•¶ä¸­èˆ‰çš„ä¾‹å­ç‚ºï¼Œæœ‰å…©å€‹ Model - User å’Œ Posts ç‚ºä¸€å°å¤šé—œä¿‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">User&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">first&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$user&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">posts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// é€™é‚Šå°±æœƒè§¸ç™¼ Lazy Loading, å°‡æ‰€æœ‰ user çš„ post éƒ½å¾ DB æ’ˆå‡º
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥å¦‚æœåŠ ä¸Š &lt;code>Model::preventLazyLoading()&lt;/code> ï¼ŒåŸ·è¡Œä¸Šé¢ç¯„ä¾‹æ™‚æ‡‰è©²å°±æœƒæ‹‹å‡º &lt;code>Illuminate\Database\LazyLoadingViolationException&lt;/code> é˜»æ­¢æˆ‘å€‘é€é Lazy Loading å¾—åˆ° postsã€‚&lt;/p>
&lt;p>æ–¼æ˜¯æ‰“é–‹å°ˆæ¡ˆä¾†è©¦è©¦ï¼Œå»ç™¼ç¾ä¸€åˆ‡æ­£å¸¸ï¼Œæ²’æœ‰ä¾‹å¤–æ‹‹å‡º&amp;hellip;&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/laravel-lazy-loading-1.png"
alt="Untitled"
width=2840
height="1644" />&lt;/p>
&lt;p>ä½†å¦‚æœæ›ä¸€å€‹æ–¹æ³•è©¦è©¦ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/laravel-lazy-loading-2.png"
alt="Untitled"
width=2142
height="958" />&lt;/p>
&lt;p>é€™æ™‚å€™æ‰æœƒå¦‚é æœŸæ‹‹å‡ºä¾‹å¤–ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œå¦‚æœç•¶ DB è£¡åªæœ‰ä¸€ç­† user è³‡æ–™ï¼Œå°±ç®—åƒä¸Šé¢é€™æ¨£å– &lt;code>all()&lt;/code>ï¼Œä¹Ÿä¸æœƒæ‹‹å‡ºä¾‹å¤–ã€‚&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/laravel-lazy-loading-3.png"
alt="Untitled"
width=2848
height="1644" />&lt;/p>
&lt;p>ä¸€é–‹å§‹å¾ˆç–‘æƒ‘ç‚ºä»€éº¼ç¯„ä¾‹çš„ code åŸ·è¡Œå¾Œæ²’æœ‰æ‹‹å‡ºä¾‹å¤–ï¼Œæ‰€ä»¥å°±ç ”ç©¶äº†ä¸€ä¸‹åŸå§‹ç¢¼çš„éƒ¨åˆ†ï¼Œé †ä¾¿çœ‹ä¸€ä¸‹é€™å€‹åŠŸèƒ½æ˜¯å¦‚ä½•å¯¦ç¾çš„ã€‚&lt;/p>
&lt;h2 id="åŸå§‹ç¢¼åˆ†æ">
&lt;a href="#%e5%8e%9f%e5%a7%8b%e7%a2%bc%e5%88%86%e6%9e%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åŸå§‹ç¢¼åˆ†æ
&lt;/h2>
&lt;p>é¦–å…ˆï¼Œå¾ &lt;code>Illuminate\Database\Eloquent\Model::preventLazyLoading()&lt;/code> é€™å€‹æ–¹æ³•é–‹å§‹çœ‹èµ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">preventLazyLoading&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">static&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="nv">$modelsShouldPreventLazyLoading&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šæœƒå°‡ &lt;code>Illuminate\Database\Eloquent\Model&lt;/code> ç•¶ä¸­çš„ä¸€å€‹éœæ…‹å±¬æ€§ &lt;code>$modelsShouldPreventLazyLoading&lt;/code> è¨­å€¼æˆå‚³å…¥çš„å¸ƒæ—å€¼ã€‚&lt;/p>
&lt;p>è©²å±¬æ€§é è¨­ç‚º &lt;code>false&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="nv">$modelsShouldPreventLazyLoading&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†å…¶å¯¦ &lt;code>Illuminate\Database\Eloquent\Model&lt;/code> å¦å¤–é‚„æœ‰ä¸€å€‹ééœæ…‹å±¬æ€§ &lt;code>$preventsLazyLoading&lt;/code>ï¼ˆå¾…æœƒæœƒæåˆ°åœ¨å“ªè£¡è¢«ä½¿ç”¨ï¼‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="nv">$preventsLazyLoading&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶åŸ·è¡Œ DB Queryï¼Œå–å¾— &lt;code>App\Models\User&lt;/code> æ™‚(eg: &lt;code>User::first();&lt;/code>)ï¼Œæœƒé€²å…¥ä»¥ä¸‹æ–¹æ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//src/Illuminate/Database/Eloquent/Builder.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">hydrate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">array&lt;/span> &lt;span class="nv">$items&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">newModelInstance&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$instance&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">newCollection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">array_map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$item&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">use&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$items&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$instance&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$model&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$instance&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">newFromBuilder&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$item&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$items&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$model&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">preventsLazyLoading&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Model&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">preventsLazyLoading&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$model&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="nv">$items&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœåŸ·è¡Œ &lt;code>User::first()&lt;/code>ï¼Œæ­¤è™•çš„ &lt;code>$items&lt;/code> å¼•æ•¸æœƒæ˜¯ä¸€å€‹é™£åˆ—ï¼Œå…§å«ä¸€å€‹ stdClass ç‰©ä»¶ (å¾ users table å–å‡ºçš„ç¬¬ä¸€å€‹ row çš„è³‡æ–™)ï¼Œåƒé€™æ¨£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">array&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">0&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#4352
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;id&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;Mrs. Gisselle Sauer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;email&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;dion.kiehn@example.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;email_verified_at&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-12-22 03:53:59&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;password&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;remember_token&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;jq4qLUs2qQ&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;created_at&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-12-22 03:53:59&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span>&lt;span class="s2">&amp;#34;updated_at&amp;#34;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-12-22 03:53:59&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—åœ¨éæ­·é™£åˆ—çš„éç¨‹ä¸­ï¼Œå°‡éæ­·åˆ°çš„ stdClass ç‰©ä»¶è½‰æˆ Eloquent Model æ™‚ï¼Œæœƒå…ˆåˆ¤æ–·å¦‚æœ &lt;code>$items&lt;/code> é™£åˆ—é•·åº¦å¤§æ–¼ 1ï¼Œæ‰æœƒå°‡é€™å€‹ Model(åœ¨æ­¤ç¯„ä¾‹ä¹Ÿå°±æ˜¯ &lt;code>App\Models\User&lt;/code>)çš„ &lt;code>$preventsLazyLoading&lt;/code> å±¬æ€§è¨­ç‚º&lt;code>Model::preventsLazyLoading()&lt;/code> çš„å€¼ï¼Œè€Œé€™å€‹éœæ…‹æ–¹æ³•å…¶å¯¦å›å‚³çš„å°±æ˜¯å…ˆå‰æˆ‘å€‘åœ¨ &lt;code>App\Providers\AppServiceProvider&lt;/code> è¨­å®šçš„éœæ…‹å±¬æ€§ &lt;code>$modelsShouldPreventLazyLoading&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">static&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">preventsLazyLoading&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">static&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="nv">$modelsShouldPreventLazyLoading&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ï¼Œç•¶å‘¼å« &lt;code>$user-&amp;gt;posts&lt;/code> æ™‚ï¼Œæœƒé€²å…¥ &lt;code>Illuminate\Database\Eloquent\Concerns\HasAttributes&lt;/code> ç•¶ä¸­çš„ &lt;code>getRelationValue()&lt;/code> æ–¹æ³•:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// src/Illuminate/Database/Eloquent/Concerns/HasAttributes.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">getRelationValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">preventsLazyLoading&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// here
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">handleLazyLoadingViolation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$key&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getRelationshipFromMethod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$key&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç•¶ &lt;code>$preventsLazyLoading&lt;/code> ç‚º &lt;code>true&lt;/code> æ™‚ï¼Œå°±æœƒæ‹‹å‡ºä¾‹å¤–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// src/Illuminate/Database/Eloquent/Concerns/HasAttributes.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">handleLazyLoadingViolation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">LazyLoadingViolationException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$key&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯èªªï¼Œ&lt;strong>å¾ DB å–å‡ºçš„è³‡æ–™ç­†æ•¸éœ€å¤§æ–¼ 1 ï¼Œå°è©² Model å–é—œè¯æ™‚æ‰æœƒè§¸ç™¼ Prevent Lazy Loading çš„æ•ˆæœ&lt;/strong>ã€‚&lt;/p>
&lt;p>æ‰€ä»¥å¦‚æœæ’ˆå‡ºçš„çµæœéƒ½æ˜¯ä¸€ç­†è³‡æ–™ï¼Œå°±ä¹Ÿä¸æœƒè§¸ç™¼ Prevent Lazy Loading äº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">User&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">first&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// åªæœ‰å¾ DB æ’ˆå‡ºä¸€ç­†è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$user&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">posts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// no exception
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$users&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">User&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">all&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// å‡ä½¿ DB è£å…¶å¯¦ä¹Ÿåªæœ‰ä¸€ç­† user è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$users&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">posts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// no exception
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶å¯¦æŒ‰ç…§å¸¸ç†ï¼Œå¤§æ¦‚èƒ½å¤ ç†è§£çˆ²ä»€éº¼æœƒæœ‰é€™ç¨®æ•ˆæœï¼Œå› ç‚ºåªæœ‰ä¸€å€‹ Model çš„æ™‚å€™ï¼Œå–å¾—å…¶åº•ä¸‹é—œè¯ï¼Œæ‡‰è©²ä¸èƒ½ç®—æ˜¯ N+1 å•é¡Œã€‚ï¼ˆä¸éè©²ç¶²ç«™çš„ä¾‹å­ç‚ºä»€éº¼é€™æ¨£èˆ‰å°±ä¸å¾—è€ŒçŸ¥ï¼Œç®—æ˜¯å°è¸©å‘äº†ä¸‹ï¼‰&lt;/p></description></item><item><title>åœ¨ Laravel ç•¶ä¸­ä½¿ç”¨ Redis åˆ†å¸ƒå¼é– é¿å… race condition é‡è¤‡æ’å…¥ç›¸åŒè³‡æ–™å•é¡Œ</title><link>/posts/%E5%9C%A8-laravel-%E7%95%B6%E4%B8%AD%E4%BD%BF%E7%94%A8-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%8E%96-%E9%81%BF%E5%85%8D-race-condition-%E9%87%8D%E8%A4%87%E6%8F%92%E5%85%A5%E7%9B%B8%E5%90%8C%E8%B3%87%E6%96%99%E5%95%8F%E9%A1%8C/</link><pubDate>Sun, 06 Nov 2022 00:00:00 +0000</pubDate><guid>/posts/%E5%9C%A8-laravel-%E7%95%B6%E4%B8%AD%E4%BD%BF%E7%94%A8-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%8E%96-%E9%81%BF%E5%85%8D-race-condition-%E9%87%8D%E8%A4%87%E6%8F%92%E5%85%A5%E7%9B%B8%E5%90%8C%E8%B3%87%E6%96%99%E5%95%8F%E9%A1%8C/</guid><description>
&lt;p>å‰å¹¾å¤©é‡åˆ°ä¸€å€‹ç‹€æ³ï¼ŒåŸæœ¬ç¨‹å¼è£¡æœ‰ä¸€æ®µé‚è¼¯æ˜¯ &lt;strong>ã€Œå¦‚æœè©²ç­†è³‡æ–™ä¸å­˜åœ¨ï¼Œå°±å¯«å…¥æ–°è³‡æ–™ï¼Œä½†å¦‚æœå·²å­˜åœ¨ï¼Œå°±ç›´æ¥å›å‚³è©²ç­†å·²å­˜åœ¨çš„è³‡æ–™ã€&lt;/strong>ï¼Œç¨‹å¼ç¢¼å¤§æ¦‚é•·é€™æ¨£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$snapshot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">OrderSnapshot&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">where&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;order_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$order&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">first&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="k">empty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$snapshot&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$snapshot&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// do something...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">OrderSnapshot&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;payload&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$order_array&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢ç¨‹å¼ç¢¼å…¶å¯¦ä¹Ÿå¯ä»¥ä½¿ç”¨ Laravel çš„ &lt;code>firstOrCreate&lt;/code> æ–¹æ³•åšç°¡åŒ–:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nx">OrderSnapshot&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">firstOrCreate&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;order_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$order&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;payload&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$order_array&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ®µé‚è¼¯çœ‹èµ·ä¾†å¾ˆç°¡å–®ï¼Œåœ¨å–®ä¸€ process çš„æƒ…æ³ä¸‹ï¼Œé€™æ®µç¨‹å¼ç¢¼ç¢ºå¯¦æ²’æœ‰ä»»ä½•å•é¡Œï¼Œä½†å¦‚æœä»Šå¤©åŒæ™‚æœ‰å…©å€‹ process è¦åŸ·è¡Œé€™æ®µç¨‹å¼çš„è©±ï¼Œå°±å¯èƒ½æœƒæœ‰éé æœŸçš„çµæœå‡ºç¾ã€‚
ç”±æ–¼ä¸è«–æ˜¯ä¸Šé¢çš„ç¨‹å¼ç¢¼ï¼Œæˆ–æ˜¯ç°¡åŒ–å¾Œçš„ç¨‹å¼ç¢¼ï¼Œå¦‚æœæ²’æœ‰æ’ˆå‡ºè³‡æ–™çš„è©±ï¼ˆä¹Ÿå°±æ˜¯è³‡æ–™ä¸å­˜åœ¨ï¼‰ï¼Œéƒ½æ˜¯è¦ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œæ–°å¢è³‡æ–™çš„å‹•ä½œï¼Œè€Œã€Œæ’ˆå‡ºè³‡æ–™ã€å’Œã€Œæ–°å¢è³‡æ–™ã€éƒ½æ˜¯å–®ç¨çš„ Queryï¼Œæ‰€ä»¥å¦‚æœå¹¾ä¹åŒæ™‚åŸ·è¡Œé€™æ®µç¨‹å¼æ™‚ï¼Œå¯èƒ½å°±æœƒç”¢ç”Ÿå…©ç­†ç›¸åŒçš„è³‡æ–™ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/laravel-redis-lock.png"
alt="Untitled"
width=2651
height="1250" />&lt;/p>
&lt;p>è€Œè¦è§£æ±ºé€™å€‹å•é¡Œï¼Œå¤§æ¦‚æœ‰ä»¥ä¸‹å¹¾ç¨®è¾¦æ³•ï¼š&lt;/p>
&lt;h4 id="1-é¿å…å¤šå€‹-process-åŸ·è¡Œ">
&lt;a href="#1-%e9%81%bf%e5%85%8d%e5%a4%9a%e5%80%8b-process-%e5%9f%b7%e8%a1%8c" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
1. é¿å…å¤šå€‹ process åŸ·è¡Œ
&lt;/h4>
&lt;p>å¦‚æœæ˜¯å› ç‚ºæ”¾åœ¨ job è£¡é¢ï¼ŒåŒæ™‚æœ‰å¤šå€‹ queue worker åœ¨æ¶ˆåŒ–é€™äº› jobï¼Œå°±ä¿æŒ queue worker çš„æ•¸é‡ç‚º 1ã€‚
ä½†æˆ‘å€‘é€™æ¬¡é‡åˆ°çš„æƒ…æ³ä¸¦ä¸é©ç”¨ï¼Œå› ç‚ºé‚„å¯ä»¥é€é API Request realtime åŸ·è¡Œé€™æ®µç¨‹å¼ã€‚è€Œä¸”å¦‚æœé‡åˆ°çœŸçš„å¾ˆè€—æ™‚çš„å·¥ä½œï¼Œä¹Ÿä¸å¯èƒ½ç‚ºæ­¤åªé–‹ä¸€å€‹ workerã€‚&lt;/p>
&lt;h4 id="2-ä½¿ç”¨-insert-into--on-duplicate-key-èªæ³•">
&lt;a href="#2-%e4%bd%bf%e7%94%a8-insert-into--on-duplicate-key-%e8%aa%9e%e6%b3%95" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
2. ä½¿ç”¨ &lt;code>INSERT INTO .. ON DUPLICATE KEY&lt;/code> èªæ³•
&lt;/h4>
&lt;p>ä¹Ÿå°±æ˜¯èªªå°‡å…©å€‹ Query åˆä½µæˆä¸€å€‹ Queryï¼Œè®“è³‡æ–™åº«å»åˆ¤æ–·è³‡æ–™å­˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±æ–°å¢ï¼Œå­˜åœ¨å‰‡æ”¹æˆæ›´æ–°ã€‚
ä½†é€™åˆä¸å¤ªç¬¦åˆæˆ‘å€‘çš„æƒ…å¢ƒï¼Œå› ç‚ºå¦‚æœå·²å­˜åœ¨ï¼Œä¸¦ä¸éœ€è¦å°è©²ç­†è³‡æ–™åšæ›´æ–°ï¼Œç›´æ¥å–å‡ºå³å¯ã€‚&lt;/p>
&lt;h4 id="3-åˆ©ç”¨å¤–éƒ¨æœå‹™å¯¦ç¾åˆ†å¸ƒå¼é–æ©Ÿåˆ¶">
&lt;a href="#3-%e5%88%a9%e7%94%a8%e5%a4%96%e9%83%a8%e6%9c%8d%e5%8b%99%e5%af%a6%e7%8f%be%e5%88%86%e5%b8%83%e5%bc%8f%e9%8e%96%e6%a9%9f%e5%88%b6" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
3. åˆ©ç”¨å¤–éƒ¨æœå‹™å¯¦ç¾åˆ†å¸ƒå¼é–æ©Ÿåˆ¶
&lt;/h4>
&lt;p>ç”±æ–¼ PHP å–®åŸ·è¡Œç·’çš„ç‰¹æ€§ï¼Œæœ¬èº«æ²’æœ‰é€™ç¨®æ©Ÿåˆ¶ï¼Œæ‰€ä»¥åªèƒ½è—‰ç”±å¤–éƒ¨çš„æœå‹™ä¾†å¯¦ç¾åˆ†å¸ƒå¼é–çš„åŠŸèƒ½ï¼Œ åƒæ˜¯ Redis å°±æ˜¯ä¸€å€‹å¸¸è¢«æ‹¿ä¾†åšåˆ†å¸ƒå¼é–çš„å·¥å…·ï¼Œè€Œ Laravel æœ¬èº«æœ‰æä¾› Redis Lock ç›¸é—œçš„ APIï¼Œæ‰€ä»¥æœ€å¾Œæ¡ç”¨äº†é€™å€‹è§£æ³•ã€‚&lt;/p>
&lt;p>æˆ‘å€‘è¦é”åˆ°çš„ç›®çš„å…¶å¯¦å¾ˆç°¡å–®ï¼Œä¹Ÿå°±æ˜¯è¦æŠŠã€Œæ’ˆå‡ºè³‡æ–™ã€å’Œã€Œæ–°å¢è³‡æ–™ã€é€™å…©å€‹æ“ä½œè¦–ç‚ºä¸€å€‹åŸå­æ€§çš„æ“ä½œï¼Œå¦‚æœç¬¬ä¸€å€‹ç¨‹åºé‚„æ²’åŸ·è¡Œå®Œï¼Œç¬¬äºŒå€‹ç¨‹åºå¿…é ˆç­‰å¾…ç¬¬ä¸€å€‹åšå®Œå¾Œï¼Œæ‰èƒ½æ¥è‘—åšã€‚åˆ©ç”¨åˆ†å¸ƒå¼é–çš„è©±å°±èƒ½å¤ å¯¦ç¾é€™å€‹è¡Œç‚ºï¼š
ç•¶æŸä¸€å€‹ç¨‹åºé‚„åœ¨åŸ·è¡Œé€™äº›å‹•ä½œçš„æ™‚å€™ï¼ˆé‚„æ‹¿è‘—é€™å€‹é–ï¼‰ï¼Œå…¶ä»–ç¨‹åºéƒ½å¿…é ˆç­‰å¾…å®ƒåŸ·è¡Œå®Œï¼ˆé‡‹æ”¾é–ï¼‰ä¹‹å¾Œæ‰èƒ½æ¥è‘—åŸ·è¡Œï¼ˆç²å¾—é–ï¼‰ã€‚å¦‚æ­¤ä¸€ä¾†å°±ä¸æœƒç™¼ç”Ÿç”¢ç”Ÿç›¸åŒè³‡æ–™çš„å•é¡Œã€‚&lt;/p>
&lt;p>åœ¨ä½¿ç”¨ Laravel Redis Lock ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹åœ¨ Redis ç•¶ä¸­æ˜¯æ€éº¼å¯¦ç¾ Lock æ©Ÿåˆ¶çš„ã€‚&lt;/p>
&lt;h2 id="redis-lock-æ©Ÿåˆ¶">
&lt;a href="#redis-lock-%e6%a9%9f%e5%88%b6" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Redis Lock æ©Ÿåˆ¶
&lt;/h2>
&lt;p>é¦–å…ˆï¼Œåœ¨ redis-cli ä¸‹ä¸€å€‹æŒ‡ä»¤å–å¾—é–&lt;/p>
&lt;pre tabindex="0">&lt;code>SET resource_name my_random_value NX PX 30000
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>
&lt;p>&lt;code>resource_name&lt;/code>ï¼šé–çš„ Key&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>my_random_value&lt;/code>ï¼šé–çš„ Valueï¼Œå¯¦ä½œä¸Šé€šå¸¸æœƒè¨­ç½®ä¸€ä¸² Random Stringï¼Œç•¶ä½œå–å¾—è©²é–çš„ Client è­˜åˆ¥ç¬¦ï¼Œåœ¨é‡‹æ”¾é–æ™‚éœ€æª¢æŸ¥ Key æ‰€å°æ‡‰çš„ Value æ˜¯ä¸æ˜¯å’Œå–å¾—é–æ™‚æ‰€è¨­ç½®çš„ Value ç›¸åŒï¼Œé¿å…é–è¢«å…¶ä»– Client é‡‹æ”¾&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>NX&lt;/code>ï¼šåªæœ‰ç•¶ &lt;code>resource_name&lt;/code> ä¸å­˜åœ¨æ‰å‰µå»ºé€™å€‹ Key&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>PX 30000&lt;/code>ï¼š Key çš„æœ‰æ•ˆæœŸé–“æ˜¯ 30000 æ¯«ç§’ï¼Œè¶…éæœƒè‡ªå‹•å¤±æ•ˆ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å°±é€™æ¨£ï¼è€Œã€Œé‡‹æ”¾é–ã€çš„å¯¦ä½œï¼Œé€šå¸¸æœƒå¯«æˆä¸€å€‹ LUA è…³æœ¬ï¼Œçµ¦ Redis ä¾†åŸ·è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">if&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ARGV&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="n">redis.call&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;DEL&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">KEYS&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">return&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—æˆ‘å€‘å¯ä»¥å›åˆ° Laravel ç•¶ä¸­å»ä½¿ç”¨ Redis Lock äº†ï¼&lt;/p>
&lt;h2 id="laravel-redis-lock">
&lt;a href="#laravel-redis-lock" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Laravel Redis Lock
&lt;/h2>
&lt;h3 id="å»ºç«‹ä¸¦å–å¾—é–">
&lt;a href="#%e5%bb%ba%e7%ab%8b%e4%b8%a6%e5%8f%96%e5%be%97%e9%8e%96" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å»ºç«‹ä¸¦å–å¾—é–
&lt;/h3>
&lt;p>é¦–å…ˆè¦å»ºç«‹ä¸€å€‹é–ï¼Œè¦å…ˆ new ä¸€å€‹ &lt;code>Illuminate\Cache\RedisLock&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>Illuminate\Cache\RedisLock&lt;/code> å¯¦ä½œ &lt;code>Illuminate\Contracts\Cache\Lock&lt;/code> interfaceï¼Œå¯¦ç¾å–å¾—é–ã€é‡‹æ”¾é–ç­‰åŠŸèƒ½ï¼Œä¸¦ç¹¼æ‰¿ &lt;code>Illuminate\Cache\Lock&lt;/code> abstract class å…±äº«åˆ†å¸ƒå¼é–çš„ç›¸åŒåŠŸèƒ½ã€‚&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">use&lt;/span> &lt;span class="nx">Illuminate\Cache\RedisLock&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">use&lt;/span> &lt;span class="nx">Illuminate\Support\Facades\Redis&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">RedisLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Redis&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">connection&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s2">&amp;#34;creating:snapshot:&lt;/span>&lt;span class="si">$order-&amp;gt;id&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¾†çœ‹ä¸€ä¸‹ &lt;code>Illuminate\Cache\RedisLock&lt;/code> çš„å»ºæ§‹å­å¯«äº†ä»€éº¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * Create a new lock instance.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @param \Illuminate\Redis\Connections\Connection $redis
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @param string $name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @param int $seconds
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @param string|null $owner
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @return void
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__construct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$redis&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$seconds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$owner&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">parent&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">__construct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$seconds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$owner&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">redis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$redis&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>&lt;code>$name&lt;/code> ï¼šé–çš„ Keyã€‚åœ¨æˆ‘å€‘çš„ä¾‹å­ç•¶ä¸­ï¼ŒKey å€¼æ‡‰è©²æœƒæ˜¯ OrderSnapshot çš„ order_idï¼Œå› ç‚ºæˆ‘å€‘å°±æ˜¯ç‚ºäº†é¿å…ç›¸åŒ order_id çš„ OrderSnapshot è¢«å»ºç«‹ï¼Œæ‰€ä»¥è¦è™•ç†ç‰¹å®š order_id æ™‚ï¼Œæ‡‰è©²è¦å–å¾—ä¸€å€‹é–ï¼Œé¿å…å…¶ä»–åŸ·è¡Œåºä¹Ÿå°ç›¸åŒ order_id åšè™•ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$seconds&lt;/code>ï¼šKey çš„æœ‰æ•ˆæœŸé–“&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>$owner&lt;/code>ï¼š é–çš„ Valueã€‚å¦‚æœä¸å¸¶è©²åƒæ•¸ï¼ŒLaravel æœƒå¹«æˆ‘å€‘ç”¢ç”Ÿä¸€ä¸²äº‚æ•¸ç•¶æˆ Valueã€‚åœ¨ &lt;code>Illuminate\Cache\Lock&lt;/code> çš„å»ºæ§‹å­ç•¶ä¸­ï¼š&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Cache/Lock.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__construct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$seconds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$owner&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">is_null&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$owner&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$owner&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Str&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">random&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">owner&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$owner&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">seconds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$seconds&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾Œå‘¼å« &lt;code>acquire&lt;/code> æ–¹æ³•æ™‚ï¼Œæ‰æœƒçœŸçš„å‘ Redis ä¸‹æŒ‡ä»¤å»ºç«‹é–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">* Attempt to acquire the lock.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">* @return bool
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">acquire&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">seconds&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">redis&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">owner&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;EX&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">seconds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;NX&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">redis&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">setnx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">owner&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é‡‹æ”¾é–">
&lt;a href="#%e9%87%8b%e6%94%be%e9%8e%96" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
é‡‹æ”¾é–
&lt;/h3>
&lt;p>åŒæ¨£å®šç¾©åœ¨ &lt;code>RedisLock&lt;/code> çš„å¯¦ä½œè£¡ï¼Œä½¿ç”¨äº†å‰›å‰›æåˆ°çš„ Lua è…³æœ¬ï¼Œå‚³çµ¦ Redis å»åŸ·è¡Œï¼Œè…³æœ¬å…§å®¹å°±æ˜¯åŒæ¨£çš„å…§å®¹ï¼Œé€™é‚Šå°±ä¸è²¼äº†&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * Release the lock.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> * @return bool
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">release&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">redis&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LuaScripts&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">releaseLock&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">owner&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å–å¾—é–å’Œé‡‹æ”¾é–çš„æµç¨‹æ‡‰è©²æœƒé¡ä¼¼é€™æ¨£(å½ä»£ç¢¼)ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$lock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">acquire&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è™•ç†æ¥­å‹™é‚è¼¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$lock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">release&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//maybe wait for seconds?
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">sleep&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œ &lt;code>RedisLock&lt;/code> ç•¶ä¸­æœ‰ä¸€å€‹ &lt;code>block&lt;/code> æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼Œå·²ç¶“å¹«æˆ‘å€‘è™•ç†äº†æµç¨‹æ§åˆ¶çš„éƒ¨åˆ†ï¼Œé‚„èƒ½é¡å¤–è¨­ç½®ç­‰å¾…é‡‹æ”¾é–çš„è¶…æ™‚æ™‚é–“ï¼ˆè¶…éæœƒæ‹‹å‡ºç•°å¸¸ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">block&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$seconds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$callback&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$starting&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">currentTime&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">acquire&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// - 7.x ä¹‹å¾Œçš„ laravel æœƒæœ‰ sleepMilliseconds åƒæ•¸ï¼Œé è¨­ç‚º 250 æ¯«ç§’
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// - 7.x ä»¥å‰çš„ç›´æ¥å¯«æ­» 250 æ¯«ç§’
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">usleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">sleepMilliseconds&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">currentTime&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nv">$seconds&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="nv">$starting&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">LockTimeoutException&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å–å¾—é–ä¹‹å¾ŒåŸ·è¡Œ callback ä¸¦é‡‹æ”¾é–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">is_callable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$callback&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$callback&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">release&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€å¾Œä½¿ç”¨ &lt;code>block&lt;/code> æ–¹æ³•ï¼Œæ”¹å¯«æˆ‘å€‘ä¸€é–‹å§‹çš„ç¨‹å¼ç¢¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$lock&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">RedisLock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Redis&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">connection&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s2">&amp;#34;creating:snapshot:&lt;/span>&lt;span class="si">$order-&amp;gt;id&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">return&lt;/span> &lt;span class="nv">$lock&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">block&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="k">use&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$order&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$snapshot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">OrderSnapshot&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">where&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;order_id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$order&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">first&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="k">empty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$snapshot&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$snapshot&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do something...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">OrderSnapshot&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;payload&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$order_array&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Laravel 9 factory recycle method ç”¨æ³•èˆ‡åŸç†åˆ†æ</title><link>/posts/laravel-9-factory-recycle-method-%E7%94%A8%E6%B3%95%E8%88%87%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</link><pubDate>Wed, 05 Oct 2022 00:00:00 +0000</pubDate><guid>/posts/laravel-9-factory-recycle-method-%E7%94%A8%E6%B3%95%E8%88%87%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</guid><description>
&lt;h2 id="recycle-æ–¹æ³•çš„ä½¿ç”¨æƒ…å¢ƒåŠæ¬²è§£æ±ºä¹‹å•é¡Œ">
&lt;a href="#recycle-%e6%96%b9%e6%b3%95%e7%9a%84%e4%bd%bf%e7%94%a8%e6%83%85%e5%a2%83%e5%8f%8a%e6%ac%b2%e8%a7%a3%e6%b1%ba%e4%b9%8b%e5%95%8f%e9%a1%8c" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>recycle&lt;/code> æ–¹æ³•çš„ä½¿ç”¨æƒ…å¢ƒåŠæ¬²è§£æ±ºä¹‹å•é¡Œ
&lt;/h2>
&lt;p>åœ¨ laravel 9 factory çš„&lt;a href="https://laravel.com/docs/9.x/eloquent-factories#recycling-an-existing-model-for-relationships">æ–‡ä»¶ç•¶ä¸­æœ€å¾Œä¸€æ®µ&lt;/a>æ˜¯åœ¨èªªæ˜ &lt;code>recycle&lt;/code> çš„ä½¿ç”¨æƒ…å¢ƒèˆ‡æ–¹æ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>If you have models that share a common relationship with another model, you may use theÂ &lt;strong>&lt;code>recycle&lt;/code>&lt;/strong>Â method to ensure a single instance of the related model is recycled for all of the relationships.&lt;br />
For example, imagine you haveÂ &lt;strong>&lt;code>Airline&lt;/code>&lt;/strong>,Â &lt;strong>&lt;code>Flight&lt;/code>&lt;/strong>, andÂ &lt;strong>&lt;code>Ticket&lt;/code>&lt;/strong>Â models, where the ticket belongs to an airline and a flight, and the flight also belongs to an airline. When creating tickets, you will probably want the same airline for both the ticket and the flight, so you may pass an airline instance to theÂ &lt;strong>&lt;code>recycle&lt;/code>&lt;/strong>Â method:&lt;/p>
&lt;/blockquote>
&lt;p>å¤§è‡´ä¸Šæ˜¯èªªåœ¨é‡åˆ°ä»¥ä¸‹é¡å‹çš„é—œè¯æ™‚&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/factory-recycle-method.png"
alt="Untitled"
width=703
height="351" />&lt;/p>
&lt;p>ä¸€å€‹ ticket å±¬æ–¼ä¸€å€‹ flight èˆ‡ ä¸€å€‹ airlineï¼ˆticket èº«ä¸Šæœ‰ &lt;code>flight_id&lt;/code> èˆ‡ &lt;code>airline_id&lt;/code>)ï¼Œè€Œ ticket æ‰€å±¬æ–¼çš„ flight ï¼ˆflight èº«ä¸Šæœ‰ &lt;code>airline_id&lt;/code>ï¼‰ä¹Ÿæœƒå±¬æ–¼å’Œ ticket ç›¸åŒçš„ airline ï¼ˆticket çš„&lt;code>airline_id&lt;/code> å’Œ flight çš„ &lt;code>airline_id&lt;/code> ç›¸åŒï¼‰&lt;/p>
&lt;p>å¯ä»¥ä½¿ç”¨ &lt;code>recycle&lt;/code> æ–¹æ³•ä¾†å‚³å…¥æœƒå…±ç”¨çš„ airline model å¯¦é«”ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>okï¼Œç„¶å¾Œé€™æ®µè§£èªªå°±çµæŸäº†ã€‚æˆ‘çœ‹äº†å¥½å¤šéé‚„æ˜¯æ»¿é ­ç–‘æƒ‘ã€‚ç›´åˆ°æŸ¥åˆ°äº†é€™å€‹&lt;a href="https://github.com/laravel/framework/pull/44107">åŸå§‹çš„ PR&lt;/a>ï¼Œçœ‹äº†è£¡é¢çš„ç¯„ä¾‹ç¨‹å¼ç¢¼æ‰ç†è§£äº† &lt;code>recycle&lt;/code> çš„ç”¨æ„ã€‚&lt;/p>
&lt;p>PR çš„ä½œè€…å±•ç¤ºäº†åœ¨æ²’æœ‰ &lt;code>recycle&lt;/code> æ–¹æ³•æ™‚ï¼Œå¦‚æœè¦å»ºä¸€å€‹æ»¿è¶³éœ€æ±‚ï¼ˆticket å±¬æ–¼ flight ä¹Ÿå±¬æ–¼ airlineï¼Œä¸” flight çš„ airline å’Œ ticket çš„ airline ç›¸åŒï¼‰çš„ Ticket æœƒéœ€è¦é€™æ¨£å¯«ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$airline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$airline&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Flight&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$airline&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†æœ‰äº† &lt;code>recycle&lt;/code> ä¹‹å¾Œï¼Œå¯ä»¥æ”¹æˆé€™æ¨£å¯«ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$airline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$airline&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­‰æ–¼ &lt;code>recycle&lt;/code> å¹«æˆ‘å€‘æŠŠ ticket æ‰€å±¬æ–¼çš„ airline ï¼Œä»¥åŠ ticket æ‰€å±¬çš„ flight æ‰€å±¬çš„ airline éƒ½æŒ‡å®šæˆç•¶æˆåƒæ•¸å‚³å…¥ &lt;code>recycle&lt;/code> æ–¹æ³•çš„é‚£ä¸€å€‹ airline å¯¦ä¾‹ã€‚
ä¹Ÿå°±æ˜¯èªªåœ¨å»ºç«‹ ticket çš„éç¨‹ä¸­ï¼Œç•¶éœ€è¦å»ºç«‹å…¶é—œè¯ï¼ˆé—œè¯çš„é—œè¯ã€é—œè¯çš„é—œè¯çš„é—œè¯â‹¯â‹¯ï¼‰model æ™‚ï¼Œåªè¦é‡åˆ° &amp;ldquo;BelongsTo airline&amp;rdquo; çš„é—œè¯ï¼Œéƒ½æœƒç›´æ¥ä½¿ç”¨è©² airline å¯¦ä¾‹ã€‚&lt;/p>
&lt;p>æ¸¬è©¦ä¸€ä¸‹æ˜¯ä¸æ˜¯ç¬¦åˆæˆ‘å€‘çš„æƒ³åƒï¼Œé¦–å…ˆå…ˆé–‹å‡ºé€™ä¸‰å€‹ Model èˆ‡ migration å¾Œï¼Œå†åˆ†åˆ¥å®šç¾©ä¸‰è€…çš„ Factoryï¼š&lt;/p>
&lt;h5 id="airline">
&lt;a href="#airline" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Airline
&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Airline&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">Model&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">use&lt;/span> &lt;span class="nx">HasFactory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">tickets&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">hasMany&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">flights&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">hasMany&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Flight&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// airline migration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// default
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">up&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Schema&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;airlines&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Blueprint&lt;/span> &lt;span class="nv">$table&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">timestamps&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// AirlineFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">definition&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">//
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="flights">
&lt;a href="#flights" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Flights
&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Flight&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">Model&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">use&lt;/span> &lt;span class="nx">HasFactory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">tickets&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">hasMany&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">airline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">belongsTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// flight migration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">up&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Schema&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;flights&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Blueprint&lt;/span> &lt;span class="nv">$table&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">timestamps&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">foreignId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;airline_id&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">constrained&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// FlightFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">definition&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;airline_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="tickets">
&lt;a href="#tickets" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Tickets
&lt;/h5>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Ticket&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">Model&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">use&lt;/span> &lt;span class="nx">HasFactory&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">flight&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">belongsTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Flight&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">airline&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">belongsTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// tickets migration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">up&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Schema&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tickets&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Blueprint&lt;/span> &lt;span class="nv">$table&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">id&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">timestamps&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">foreignId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;flight_id&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">constrained&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$table&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">foreignId&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;airline_id&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">constrained&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// TicketFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">definition&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;flight_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Flight&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;airline_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>tinker åŸ·è¡Œçµæœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nv">$ticket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">App\Models\Ticket&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">App\Models\Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">())&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">App\Models\Ticket&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#4619
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">flight_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">airline_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updated_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">created_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nv">$ticket&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">airline&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">App\Models\Airline&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#3647
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">created_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updated_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nv">$ticket&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">flight&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">airline&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">App\Models\Airline&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#3628
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">created_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">updated_at&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;2022-10-05 11:02:54&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¢ºå¯¦ ticket çš„ airline å’Œ ticket çš„ flight çš„ airline éƒ½æ˜¯ id ç‚º 1 çš„ airlineã€‚&lt;/p>
&lt;h2 id="åŸå§‹ç¢¼åˆ†æ">
&lt;a href="#%e5%8e%9f%e5%a7%8b%e7%a2%bc%e5%88%86%e6%9e%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åŸå§‹ç¢¼åˆ†æ
&lt;/h2>
&lt;p>æ¥è‘—ä¾†çœ‹ä¸€ä¸‹é€™å€‹ç¥å¥‡çš„åŠŸèƒ½æ˜¯å¦‚ä½•è¢«å¯¦ç¾çš„ã€‚&lt;/p>
&lt;p>é¦–å…ˆ &lt;code>recyle&lt;/code> æ–¹æ³•æœƒå°‡è¦å…±ç”¨çš„å¯¦ä¾‹æš«å­˜åœ¨ Factory ç•¶ä¸­çš„ &lt;code>recyle&lt;/code> å±¬æ€§ç•¶ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php L627
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">recycle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$model&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Group provided models by the type and merge them into existing recycle collection
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">newInstance&lt;/span>&lt;span class="p">([&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;recycle&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">flatten&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">merge&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Collection&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">wrap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$model&lt;/span> &lt;span class="nx">instanceof&lt;/span> &lt;span class="nx">Model&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="nx">func_get_args&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nv">$model&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">flatten&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">groupBy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fn&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$model&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">get_class&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$model&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>create&lt;/code> æ–¹æ³•è¢«å‘¼å«å¾Œï¼Œé€²åˆ° &lt;code>make&lt;/code> ï¼Œ å†é€²åˆ° &lt;code>$this-&amp;gt;count === null&lt;/code> if æ•˜è¿°è£¡é¢&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">//vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$attributes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[],&lt;/span> &lt;span class="o">?&lt;/span>&lt;span class="nx">Model&lt;/span> &lt;span class="nv">$parent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="k">empty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$attributes&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$attributes&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">make&lt;/span>&lt;span class="p">([],&lt;/span> &lt;span class="nv">$parent&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">count&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">tap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">makeInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parent&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// here
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">callAfterMaking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">collect&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">]));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—é€²åˆ° &lt;code>makeInstance&lt;/code> ï¼Œç•¶ä¸­ &lt;code>newModel&lt;/code> æ™‚å‘¼å«äº† &lt;code>getExpandedAttributes&lt;/code> æ–¹æ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">makeInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="nx">Model&lt;/span> &lt;span class="nv">$parent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">Model&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">unguarded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="k">use&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$parent&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">tap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">newModel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getExpandedAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parent&lt;/span>&lt;span class="p">)),&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">connection&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$instance&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">setConnection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">connection&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°‡ &lt;code>$this-&amp;gt;getRawAttributes($parent)&lt;/code> è¿”å›å€¼ï¼ˆæˆ‘å€‘å‰›å‰›åœ¨æ¯å€‹ Model Factory ç•¶ä¸­çš„ &lt;code>defination&lt;/code> æ–¹æ³•å›å‚³çš„é™£åˆ—ï¼‰ç•¶ä½œåƒæ•¸å¡é€² &lt;code>expandAttributes&lt;/code> ä¸¦å›å‚³çµæœ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">getExpandedAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="nx">Model&lt;/span> &lt;span class="nv">$parent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">expandAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getRawAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parent&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡é»å°±åœ¨é€™è£¡ï¼Œé‚„è¨˜å¾—å‰é¢æ‰€å»ºç«‹çš„ Model Factory ç•¶ä¸­æˆ‘å€‘å°‡ foreign key åˆ†åˆ¥æŒ‡å®šç‚ºå°æ‡‰çš„ Factory&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// TicketFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">definition&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;flight_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Flight&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;airline_id&amp;#39;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Airline&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">factory&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨åŸ·è¡Œåˆ°&lt;/p>
&lt;p>&lt;code>App\Models\Ticket::factory()-&amp;gt;recycle(App\Models\Airline::factory()-&amp;gt;create())-&amp;gt;create()&lt;/code>&lt;/p>
&lt;p>çš„ç¬¬äºŒå€‹ create ï¼ˆ &lt;code>TicketFactory::create&lt;/code>ï¼‰ä¸¦ä¸”é€²åˆ° &lt;code>expandAttributes&lt;/code> æ–¹æ³•è£¡ï¼Œç•¶ä¸­çš„ &lt;code>$definition&lt;/code> å…¶å¯¦å°±ç­‰åŒä¸Šé¢é€™å€‹é™£åˆ—å…§å®¹ï¼ˆè©³æƒ…å¯è¦‹ &lt;code>getRawAttributes&lt;/code> æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥ &lt;code>$attribute&lt;/code> åˆ†åˆ¥æœƒæ˜¯ &lt;code>Flight::factory()&lt;/code> å’Œ &lt;code>Airline::factory()&lt;/code>&lt;/p>
&lt;p>è€ŒåŸ·è¡Œç¬¬ä¸€å€‹è¿­ä»£æ™‚ï¼ˆ &lt;code>$this&lt;/code> = &lt;code>TicketFactory&lt;/code>, &lt;code>$attribute&lt;/code> = &lt;code>Flight::factory()&lt;/code> ï¼‰ç”±æ–¼åœ¨æš«å­˜çš„ recycle å±¬æ€§ä¸­æ‰¾ä¸åˆ°å°æ‡‰çš„ Flight Modelï¼Œæ‰€ä»¥å°‡ &lt;code>Flight::factory()&lt;/code> ä¹Ÿå‚³å…¥ç•¶å‰çš„ &lt;code>recycle&lt;/code> å±¬æ€§å¾Œå† createã€‚å°±æ˜¯åœ¨é€™å€‹åœ°æ–¹å½¢æˆéè¿´ï¼Œä¸æ–·æŠŠ recycle å‚³çµ¦ä¸‹ä¸€å€‹å±¬æ–¼çš„é—œè¯å¾Œå†å»ºç«‹é—œè¯ Modelã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">expandAttributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">array&lt;/span> &lt;span class="nv">$definition&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">collect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$definition&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$evaluateRelations&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$attribute&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$attribute&lt;/span> &lt;span class="nx">instanceof&lt;/span> &lt;span class="nx">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">///***
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nv">$attribute&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getRandomRecycledModel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$attribute&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">modelName&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">??&lt;/span> &lt;span class="nv">$attribute&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">recycle&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">create&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">///***
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">elseif&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$attribute&lt;/span> &lt;span class="nx">instanceof&lt;/span> &lt;span class="nx">Model&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$attribute&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$attribute&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$attribute&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">
&lt;a href="#%e7%b8%bd%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ç¸½çµ
&lt;/h2>
&lt;p>ä¹‹æ‰€ä»¥æœƒæœ‰ &lt;code>recycle&lt;/code> é€™å€‹æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç‚ºäº†å¯ä»¥ä½¿ç”¨åŒä¸€å€‹å¯¦ä¾‹ä½œç‚ºé—œè¯ä¸”ä¸éœ€å·¢ç‹€å‘¼å« &lt;code>for&lt;/code> æ–¹æ³•ã€‚
é‡é»åœ¨æ–¼ &lt;strong>éœ€äº‹å…ˆåœ¨ Model Factory ç•¶ä¸­å°‡ &lt;code>{model}_id&lt;/code>æŒ‡å®šç‚ºå°æ‡‰çš„ Factory (&lt;code>{model}::factory()&lt;/code>)&lt;/strong> ï¼Œè¦é”åˆ°é€™é» &lt;code>recycle&lt;/code> æ‰æœƒæœ‰ä½œç”¨ã€‚&lt;/p>
&lt;p>å€‹äººæ˜¯è¦ºå¾—æ–‡ä»¶æ²’æœ‰å¯«å¾—éå¸¸æ¸…æ¥šï¼ŒèŠ±äº†ä¸€ç•ªåŠ›æ°£æ‰çœŸæ­£ç†è§£å®ƒçš„ç”¨æ³•ï¼Œä½†ä¹Ÿå‰›å¥½å¯ä»¥ç†è§£ä¸€ä¸‹åŸç†å•¦ã€‚&lt;/p></description></item><item><title>Golang Slice Assignment èˆ‡ append æ–¹æ³•</title><link>/posts/golang-slice-assignment-%E8%88%87-append-%E6%96%B9%E6%B3%95/</link><pubDate>Tue, 16 Aug 2022 00:00:00 +0000</pubDate><guid>/posts/golang-slice-assignment-%E8%88%87-append-%E6%96%B9%E6%B3%95/</guid><description>
&lt;h2 id="slice-è³‡æ–™çµæ§‹">
&lt;a href="#slice-%e8%b3%87%e6%96%99%e7%b5%90%e6%a7%8b" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
slice è³‡æ–™çµæ§‹
&lt;/h2>
&lt;p>Golang åº•å±¤ä½¿ç”¨ &lt;a href="https://pkg.go.dev/reflect#SliceHeader">SliceHeader&lt;/a> å»æè¿°é‹è¡Œæ™‚çš„ slice&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SliceHeader&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Data&lt;/span> &lt;span class="kt">uintptr&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Len&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Cap&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°æ‡‰ä¸€å€‹ slice å…·å‚™çš„ä¸‰å€‹å±¬æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>Len - slice çš„é•·åº¦&lt;/li>
&lt;li>Cap - åº•å±¤é™£åˆ—å¤§å°&lt;/li>
&lt;li>Data - åº•å±¤ array &lt;strong>ç¬¬ä¸€å€‹å…ƒç´ &lt;/strong>çš„&lt;strong>æŒ‡æ¨™&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>slice æœ‰é»é¡ä¼¼ java çš„ ArrayListï¼Œlen å°±ç­‰åŒæ–¼ sizeï¼Œè¡¨ç¤º list ç•¶ä¸­çš„å…ƒç´ æ•¸é‡ï¼Œè€Œ cap å‰‡å°æ‡‰ ArrayList çš„ capacityï¼Œä¹Ÿå°±æ˜¯åº•å±¤é™£åˆ—çš„å¤§å°ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ä¹‹æ‰€ä»¥ç‰¹åˆ¥å¼·èª¿ slice æ‰€è¨˜éŒ„çš„åº•å±¤é™£åˆ—æŒ‡æ¨™æ˜¯ã€Œé™£åˆ—ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ã€ï¼Œæ˜¯å› ç‚ºè¦æé†’ä¸è¦å¿˜äº†é™£åˆ—çš„æœ¬è³ªå°±æ˜¯ä¸€ä¸²é€£çºŒçš„è¨˜æ†¶é«”ç©ºé–“ï¼Œå„²å­˜ç¬¬ä¸€å€‹å…ƒç´ æŒ‡æ¨™ï¼ˆä½å€ï¼‰å¾Œå³å¯è—‰ç”±ç´¢å¼•åŠå…ƒç´ å¤§å°ä¾†è¨ˆç®—å‡ºå…¶ä»–ç´¢å¼•ç¢ºåˆ‡çš„è¨˜æ†¶é«”ä½å€ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="slice-assignment">
&lt;a href="#slice-assignment" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Slice Assignment
&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸ·è¡Œ &lt;code>s2 := s1&lt;/code> æ™‚ï¼Œé›–ç„¶æ˜¯è¤‡è£½å‡ºå¦ä¸€å€‹ sliceï¼ˆè¨˜æ†¶é«”ä½ç½®ä¸åŒï¼‰ï¼Œä½†å…©è€…çš„æŒ‡æ¨™ä»æ˜¯åŒä¸€å€‹ï¼Œéƒ½æŒ‡å‘ç›¸åŒçš„é™£åˆ—ï¼ˆèµ·å§‹ä½ç½®ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>é™¤éå…¶ä¸­ä¸€å€‹ slice åœ¨ append æ™‚ï¼Œç™¼ç¾åŸæœ¬é™£åˆ—ç©ºé–“ä¸å¤ ï¼Œå› æ­¤å»ºå¦ä¸€å€‹æ–°çš„é™£åˆ—ï¼Œæ‰æœƒé€ æˆå…©è€…æ‰€æŒ‡å‘çš„åº•å±¤é™£åˆ—ä¸åŒï¼Œæœ‰é—œ append çš„ reallocate æ©Ÿåˆ¶ï¼Œåƒè€ƒï¼š&lt;a href="https://go.dev/blog/slices">https://go.dev/blog/slices&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ç•¶æ–°å¢ä¸€å€‹å¦‚ä¸‹çš„ sliceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">s1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [0, 0, 0, 0, 0]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">cap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s1&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">s1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 5 10 0xc0000ac002
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­‰åŒæ–°å»ºä¸€å€‹å¤§å°ç‚º 10 çš„é™£åˆ—ï¼Œä¸¦åœ¨é™£åˆ—å¡«å…¥ &lt;code>5&lt;/code> å€‹ &lt;code>int&lt;/code> é¡å‹çš„ zero valueï¼Œå†æŠŠ slice çš„ len è¨­ç‚º 5ï¼Œ cap è¨­ç‚º 10ï¼Œä¸¦ä¸”ç´€éŒ„é™£åˆ—ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ã€‚&lt;/p>
&lt;p>ç”¨åœ–ç¤ºè¡¨ç¤ºï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/go-slice-1.png"
alt="Untitled"
width=1478
height="758" />&lt;/p>
&lt;p>æ‰€ä»¥ç•¶æˆ‘å€‘è¦å–è¶…é slice é•·åº¦(len)çš„å…ƒç´ &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœƒç²å¾—ä¸€å€‹ &lt;code>runtime error: index out of range [5] with length 5&lt;/code> çš„ panic&lt;/p>
&lt;h2 id="slice-assignment--append-æ–¹æ³•çš„éé æœŸè¡Œç‚º">
&lt;a href="#slice-assignment--append-%e6%96%b9%e6%b3%95%e7%9a%84%e9%9d%9e%e9%a0%90%e6%9c%9f%e8%a1%8c%e7%82%ba" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Slice Assignment + append æ–¹æ³•çš„éé æœŸè¡Œç‚º
&lt;/h2>
&lt;p>ç•¶è¦å¾€ä¸€å€‹ len ç‚º 0 çš„ slice ç•¶ä¸­æ·»åŠ å…ƒç´ æ™‚ï¼Œæœƒéœ€è¦ä½¿ç”¨ append æ–¹æ³•ï¼Œè©²æ–¹æ³•æœƒå›å‚³ä¸€å€‹æ›´æ–°å¾Œçš„ sliceã€‚é€šå¸¸éƒ½æœƒé€™æ¨£ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// append éå¾Œçš„çµæœç›´æ¥è³¦å€¼çµ¦ nums è®Šæ•¸
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å»¶ä¼¸ä¸Šé¢æåˆ°çš„ slice assignment æ¦‚å¿µï¼Œç•¶å¦å¤–ä¸€å€‹è®Šæ•¸ &lt;code>newNums&lt;/code> ä¹Ÿæ¥æ”¶ append å¾Œå›å‚³çš„æ–° sliceï¼Œå…©å€‹ slice (&lt;code>nums&lt;/code> &amp;amp; &lt;code>newNums&lt;/code>) æ‰€æŒ‡å‘åº•å±¤é™£åˆ—ç›¸åŒæ™‚ï¼Œä»¥ä¸‹ç¨‹å¼ç¢¼æœƒå°å‡ºä»€éº¼ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">newNums&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">newNums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çµæœæœƒæ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="mi">7&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¦ºå¾—æ„å¤–çš„è©±ï¼Œæˆ‘å€‘å°±ä¸€å€‹å€‹ä¾†çœ‹ç©¶ç«Ÿç™¼ç”Ÿä»€éº¼äº‹å§ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œåœ¨å»ºç«‹ &lt;code>newNums&lt;/code> ä¹‹å‰ï¼Œ &lt;code>nums&lt;/code> è·Ÿåº•å±¤é™£åˆ—é•·é€™æ¨£ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/go-slice-2.png"
alt="Untitled"
width=1246
height="754" />&lt;/p>
&lt;p>æ¥è‘—åˆ°äº† &lt;code>newNums := append(nums, 6)&lt;/code> é€™è¡Œï¼Œå»ºç«‹æ–°çš„ slice ä¸¦ä¸”åŠ äº†ä¸€å€‹æ–°çš„å…ƒç´  6 åˆ°é™£åˆ—ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/go-slice-3.png"
alt="Untitled"
width=1246
height="1193" />&lt;/p>
&lt;p>é€™æ™‚å¯èƒ½æœ‰äººæœƒå•ï¼Œæ—¢ç„¶åº•å±¤é™£åˆ—å¤šäº†ä¸€å€‹å…ƒç´ ï¼Œç„¶å¾ŒåŸæœ¬çš„ &lt;code>nums&lt;/code> ä¹ŸæŒ‡å‘é€™å€‹é™£åˆ—ï¼Œé‚£ &lt;code>nums&lt;/code> ä¸å°±ä¹Ÿæœƒå¤šä¸€å€‹å…ƒç´ å—ï¼Ÿ&lt;/p>
&lt;p>&lt;strong>ä½†å…¶å¯¦å‹•åˆ°çš„æ˜¯åº•å±¤é™£åˆ—è€Œä¸æ˜¯ &lt;code>num&lt;/code> é€™å€‹ slice&lt;/strong>ï¼Œå› ç‚º &lt;code>nums&lt;/code> æœ¬èº«çš„ &lt;code>len&lt;/code> ä¸¦æ²’æœ‰æ”¹è®Šï¼ˆæ”¹è®Šçš„æ˜¯ &lt;code>newNums&lt;/code>çš„ &lt;code>len&lt;/code> ï¼‰ï¼Œå‰›å‰›å‰é¢æœ‰æåˆ°ï¼Œç•¶è¦å–è¶…é slice é•·åº¦(len)çš„å…ƒç´ ï¼Œæœƒæ‹‹å‡ºä¾‹å¤–ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œåœ¨ &lt;code>nums&lt;/code> é€™å€‹ slice é›–ç„¶æœ¬èº«åº•å±¤é™£åˆ—å·²ç¶“é­åˆ°æ”¹å‹•äº†ï¼Œä½†&lt;strong>å› çˆ²æˆ‘å€‘éƒ½æ˜¯é€é slice å»å°åº•å±¤é™£åˆ—å–å€¼çš„ ï¼Œè€Œ &lt;code>nums&lt;/code> çš„ &lt;code>len&lt;/code> é‚„æ˜¯ 5ï¼Œæ ¹æœ¬ç„¡æ³• reach åˆ° index ç‚º 5 çš„å…ƒç´ &lt;/strong>ã€‚&lt;/p>
&lt;p>ç¹¼çºŒå¾€ä¸‹åˆ° &lt;code>newNums = append(newNums, 7)&lt;/code> é€™ä¸€è¡Œï¼Œåº•å±¤é™£åˆ—åˆå¤šäº†ä¸€å€‹ 7ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/go-slice-4.png"
alt="Untitled"
width=1257
height="1193" />&lt;/p>
&lt;p>æ¥è‘—åˆ° &lt;code>nums = append(nums, 7)&lt;/code> é€™è¡Œï¼Œç”±æ–¼ &lt;code>nums&lt;/code> slice æœ€å¾Œä¸€å€‹å…ƒç´ çš„ index ç­‰æ–¼ 4ï¼Œæ‰€ä»¥ append æ–¹æ³•æ˜¯æœƒå°‡é™£åˆ— index 4+1=5 çš„ä½ç½®æ”¾å…¥ 7 é€™å€‹å€¼ï¼Œæ‰€ä»¥å°±é€ æˆ index 5 åŸæœ¬çš„å€¼è¢«å–ä»£ï¼š&lt;/p>
&lt;p>&lt;img loading="lazy"
src="/images/go-slice-5.png"
alt="Untitled"
width=1257
height="1193" />&lt;/p>
&lt;p>é©—è­‰ &lt;code>nums&lt;/code> index 5 å’Œ &lt;code>newNums&lt;/code> index 5 çš„æŒ‡æ¨™ï¼ˆè¨˜æ†¶é«”ä½ç½®ï¼‰ç¢ºå¯¦ç›¸åŒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">newNums&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 6 0xc000128068 -&amp;gt;é€™æ™‚å€™é‚„æ˜¯ 6
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">newNums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 7 0xc000128070
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 7 0xc000128068 -&amp;gt;è¢«ä¸Šé¢é‚£è¡Œæ”¹æˆ 7
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">// 7 0xc000128068 -&amp;gt;å’Œ nums ç‚ºåŒä¸€å€‹è¨˜æ†¶é«”ä½ç½®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [1 2 3 4 5 7]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">newNums&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [1 2 3 4 5 7 7] -&amp;gt; index 5 çš„å€¼å·²è¢«è¦†è“‹
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¸½çµï¼Œslice å¯ä»¥è¦–ä½œåœ¨é™£åˆ—ä¹‹ä¸Šçš„ä¸€å±¤â€œç‰‡æ®µè³‡è¨Šâ€ï¼Œè—‰ç”±é€™å€‹ç‰‡æ®µï¼Œæˆ‘å€‘å¯ä»¥å°åº•å±¤é™£åˆ—å–å€¼ã€å¢åˆªæ”¹å…ƒç´ ï¼ŒåŒæ™‚ä¹Ÿå…è¨±å¤šå€‹ç‰‡æ®µå‘åŒå€‹é™£åˆ—æ“ä½œï¼Œä¸åŒç‰‡æ®µå–çš„ç´¢å¼•ç¯„åœå¯èƒ½ä¹Ÿä¸åŒã€‚ä½†ä¹Ÿæ˜¯å› æ­¤å¿…é ˆéå¸¸å°å¿ƒï¼Œå› ç‚ºåªè¦åº•å±¤é™£åˆ—ä¸€è¢«æ”¹å‹•ï¼Œæ‰€æœ‰åƒè€ƒè©²é™£åˆ—çš„ slice éƒ½å¯èƒ½æœƒå—åˆ°å½±éŸ¿ã€‚&lt;/p></description></item><item><title>Mock Dynamodb Client(use aws SDK for golang) with testify/mock</title><link>/posts/mock-dynamodb-clientuse-aws-sdk-for-golang-with-testify-mock/</link><pubDate>Thu, 04 Aug 2022 00:00:00 +0000</pubDate><guid>/posts/mock-dynamodb-clientuse-aws-sdk-for-golang-with-testify-mock/</guid><description>
&lt;p>æ¸¬è©¦æ™‚è‹¥æ¶‰åŠç¬¬ä¸‰æ–¹æœå‹™ï¼Œå¾€å¾€æœƒéœ€è¦é‹ç”¨åˆ° Mock ï¼ˆæ¸¬è©¦æ›¿èº«ï¼‰çš„æ¦‚å¿µï¼Œå°‡å¤–éƒ¨æ¨¡çµ„ä»£æ›æˆä¸€å€‹å‡çš„ç‰©ä»¶ï¼Œä¸¦æ¨¡æ“¬å…¶è¡Œç‚ºèˆ‡å›å‚³å€¼ï¼Œè®“æˆ‘å€‘èƒ½å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯çš„å–®å…ƒæ¸¬è©¦ã€‚&lt;/p>
&lt;p>ç•¶å‰çš„æƒ…å¢ƒç‚ºï¼Œåœ¨ Repository è£¡ä½¿ç”¨ &lt;a href="https://github.com/aws/aws-sdk-go">aws SDK for go&lt;/a> ç•¶ä¸­çš„ dynamodb client ä¾†å»ºç«‹èˆ‡ dynamodb çš„é€£ç·šä»¥åŠå¾ŒçºŒç›¸é—œå°è³‡æ–™åº«çš„æ“ä½œã€‚ä½†åœ¨é€²è¡Œæ¸¬è©¦æ™‚ï¼Œç‚ºäº†é¿å…æ¯æ¬¡è·‘æ¸¬è©¦éƒ½è¦çœŸçš„æˆ³è³‡æ–™åº«ï¼ˆå› åœ¨å–®å…ƒæ¸¬è©¦ä¸­ï¼Œæˆ‘å€‘åªæƒ³è¦ç¢ºå®šèˆ‡ dynamodb client çš„äº’å‹•æœ‰&lt;strong>ç¢ºå¯¦å‘¼å«é æœŸçš„æ–¹æ³•ã€å‚³å…¥ç›¸æ‡‰çš„åƒæ•¸&lt;/strong>ï¼Œè€Œä¸åœ¨ä¹è³‡æ–™åº«åˆ°åº•æœ‰æ²’æœ‰å¯«å…¥è³‡æ–™é€™ç¨®äº‹ï¼‰ï¼Œæœƒéœ€è¦å°‡é€™å€‹ client æ›¿æ›æˆ Mock ç‰©ä»¶ã€‚&lt;/p>
&lt;p>è€Œ &lt;a href="https://github.com/aws/aws-sdk-go">aws SDK for go&lt;/a> å°±æä¾›äº†ä¸€å€‹æ–¹ä¾¿é–‹ç™¼è€…é€²è¡Œ mocking çš„ interfaceï¼š&lt;a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/dynamodbiface/">dynamodb interface&lt;/a>&lt;/p>
&lt;p>æˆ‘å€‘å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/dynamodbiface/">dynamodb interface&lt;/a> ä½œç‚ºä¾è³´çš„é¡å‹ï¼Œä¹Ÿå°±æ˜¯èªªå¦‚æœè¦æ”¾ä¸€å€‹ dynamodb client åœ¨ struct è£¡é¢ï¼ŒåŸæœ¬å¯èƒ½æœƒç›´æ¥ä½¿ç”¨ &lt;code>*dynamodb.DynamoDB&lt;/code> é¡å‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">dynamodbUserNotificationRepository&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¯¦ä¾‹åŒ–æ™‚æ³¨å…¥ dynamodb client ä¾è³´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewDynamondbUserNotificationRepository&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Client&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserNotificationRepository&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dynamodbUserNotificationRepository&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†ç‚ºäº†ä¹‹å¾Œæ–¹ä¾¿åœ¨æ¸¬è©¦æ™‚èƒ½è¼•é¬†æ³¨å…¥ Mock ç‰©ä»¶ï¼Œå¯ä»¥æ›¿æ›æˆ &lt;code>dynamodbiface.DynamoDBAPI&lt;/code> ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">dynamodbUserNotificationRepository&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Client&lt;/span> &lt;span class="nx">dynamodbiface&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDBAPI&lt;/span> &lt;span class="c1">// instead of *dynamodb.DynamoDB
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewDynamondbUserNotificationRepository&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Client&lt;/span> &lt;span class="nx">dynamodbiface&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDBAPI&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserNotificationRepository&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dynamodbUserNotificationRepository&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Client&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¹¼çºŒå®Œæ•´é€™å€‹ç¯„ä¾‹ï¼Œå‡è¨­ &lt;code>dynamodbUserNotificationRepository&lt;/code> æœ‰ä¸€å€‹ &lt;code>Store&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodbUserNotificationRepository&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Store&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">user_notification_input&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserNotificationRequestInputStore&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">batch&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">user_notification&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">domain&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UserNotification&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è£¡é¢æœƒå‘¼å«åˆ° d.Client.PutItem æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¦æ¸¬è©¦ä¸Šé¢é€™å€‹ &lt;code>Store&lt;/code> æ–¹æ³•ï¼Œéœ€è¦å°‡ &lt;code>dynamodbUserNotificationRepository&lt;/code> è£¡é¢çš„ &lt;code>Client&lt;/code> å–ä»£æˆ Mock ç‰©ä»¶ï¼Œæ‰€ä»¥æˆ‘å€‘å…ˆæŒ‰ç…§å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹å®šç¾©ä¸€å€‹ Mock client structï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MockDynamoDBClient&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dynamodbiface&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDBAPI&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—è¤‡å¯« &lt;code>PutItem&lt;/code> æ–¹æ³•ï¼Œå›å‚³ dummy è³‡æ–™ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">mockDynamoDBClient&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">PutItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemInput&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemOutput&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemOutput&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾Œå°±å¯ä»¥åœ¨æ¸¬è©¦ä¸­ new ä¸€å€‹ &lt;code>mockDynamoDBClient&lt;/code> å‚³å…¥ &lt;code>NewDynamondbUserNotificationRepository&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mockSvc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">mockDynamoDBClient&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">repo&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">repository&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDynamondbUserNotificationRepository&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mockSvc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// do something...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ„Ÿè¦ºå°±å¾ˆé–‹å¿ƒåœ°å¯«å®Œæ¸¬è©¦äº†ã€‚ä½†å¦‚æœåŒæ™‚æœ‰å¦å¤–ä¸€å€‹æ–¹æ³•ä¹Ÿæœƒå‘¼å« &lt;code>PutItem&lt;/code> ï¼Œè€Œåœ¨ç‚ºé€™å€‹æ–¹æ³•å¯«æ¸¬è©¦æ™‚ï¼Œ&lt;code>PutItem&lt;/code> çš„å›å‚³å€¼å¿…é ˆä¸åŒï¼Œè©²æ€éº¼è¾¦ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯å†å¦å¤–å¯«å€‹ Mock client 2ï¼Œä½†æœ‰ n å€‹é›£é“è¦å¯« n æ¬¡å—ï¼Ÿ&lt;/p>
&lt;p>é€™å°±æ˜¯ testify/mock å‡ºå ´çš„æ™‚å€™äº†ï¼Œä½¿ç”¨å®ƒèƒ½è®“æˆ‘å€‘åœ¨å€‹åˆ¥æ¸¬è©¦è£¡å®šç¾© Mock ç‰©ä»¶æœƒè¢«å‘¼å«çš„æ–¹æ³•ååŠå…¶å›å‚³å€¼ã€‚&lt;/p>
&lt;p>å°‡ &lt;code>MockDynamoDBClient&lt;/code> ä¿®æ”¹ç‚ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MockDynamoDBClient&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">dynamodbiface&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DynamoDBAPI&lt;/span> &lt;span class="c1">// 1.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">mock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mock&lt;/span> &lt;span class="c1">// (å¤šåŠ ä¸Šçš„éƒ¨åˆ†) 2.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡åŒæ™‚ä½¿ç”¨åˆ°å…©å€‹ package æä¾›çš„ interface ä»¥åŠ struct&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/aws/aws-sdk-go/blob/v1.44.69/service/dynamodb/dynamodbiface/interface.go#L62-L286">aws/aws-sdk-go dynamodbiface.DynamoDBAPI&lt;/a>:
ä¾ç…§&lt;a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/dynamodbiface/">å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹&lt;/a>ï¼Œå°‡ &lt;code>dynamodbiface.DynamoDBAPI&lt;/code> interface ç”¨åŒ¿åçš„æ–¹å¼åµŒé€² Mock client struct è£¡é¢ï¼Œä½¿å¾—è©² struct ç­‰åŒâ€ç¹¼æ‰¿â€äº†é€™äº› interface ç•¶ä¸­çš„æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥è¢«è¦–ç‚ºä¸€å€‹æœ‰å¯¦ç¾è©² interface çš„ structã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/stretchr/testify/blob/master/mock/mock.go#L266-L283">stretchr/testify mock.Mock&lt;/a>:
ä¾ç…§å®˜æ–¹ç¯„ä¾‹ï¼Œåœ¨å®šç¾© Mock client struct ç•¶ä¸­åµŒå…¥ &lt;code>mock.Mock&lt;/code>ï¼ˆåŒæ¨£æœƒæœ‰â€ç¹¼æ‰¿â€œ &lt;code>mock.Mock&lt;/code> è£çš„æ–¹æ³•çš„æ•ˆæœï¼‰ã€‚&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>å…©è€…éƒ½åˆ©ç”¨åˆ°äº† golang struct embed çš„ç‰¹æ€§ï¼Œé—œæ–¼ golang çš„ struct with embedded anonymous interface æœ‰ç©ºæœƒå†å¯«å¦ä¸€ç¯‡ç­†è¨˜ä¾†è§£é‡‹ã€‚
Refï¼š&lt;a href="https://stackoverflow.com/a/24546029/10943670">https://stackoverflow.com/a/24546029/10943670&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>æ¥è‘—å®šç¾© mock client å¾…æœƒåœ¨æ¸¬è©¦ä¸­æœƒè¢«å‘¼å«åˆ°çš„æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MockDynamoDBClient&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">PutItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemInput&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemOutput&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">arg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Called&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">input&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 1.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">arg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemOutput&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">arg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 2.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>&lt;strong>å–å¾—åƒæ•¸&lt;/strong>:
é€™è£çš„ &lt;code>Called&lt;/code> æ–¹æ³•æœƒå–å¾— &lt;code>PutItem&lt;/code> æ–¹æ³•è¢«å‘¼å«ä¹‹å¾Œæ‡‰è©²è¦å›å‚³çš„åƒæ•¸ï¼Œå¾…æœƒæœƒåœ¨å¯«æ¸¬è©¦æ™‚å¯¦éš›å®šç¾©ï¼Œç¸½ä¹‹é€™é‚Šå°±æ˜¯é æœŸæœƒå¾—åˆ°ä¸€çµ„åœ¨æ¸¬è©¦æ™‚å®šç¾©çš„å›å‚³åƒæ•¸ã€‚&lt;/li>
&lt;li>&lt;strong>é¡å‹æª¢æŸ¥&lt;/strong>:
æª¢æŸ¥å¾—åˆ°çš„åƒæ•¸æ˜¯å¦ç¬¦åˆé¡å‹ï¼Œæ˜¯çš„è©±æ‰æœƒçœŸçš„å°‡å…¶ç•¶æˆ &lt;code>PutItem&lt;/code> æ–¹æ³•çš„å›å‚³å€¼å‚³å‡ºå»ã€‚ &lt;code>arg.Get(0).(*dynamodb.PutItemOutput)&lt;/code> è¡¨ç¤ºå¾—åˆ°çš„ç¬¬ä¸€å€‹åƒæ•¸å¿…é ˆæ˜¯ &lt;code>*dynamodb.PutItemOutput&lt;/code> é¡å‹ï¼Œ&lt;code>arg.Error(1)&lt;/code> è¡¨ç¤ºå¾—åˆ°çš„ç¬¬äºŒå€‹åƒæ•¸å¿…é ˆæ˜¯ &lt;code>Error&lt;/code> é¡å‹ï¼Œè‹¥ä¸ç¬¦åˆé¡å‹æœƒå¼•ç™¼ panicã€‚&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>å®˜æ–¹æ–‡ä»¶ï¼š&lt;a href="https://github.com/stretchr/testify/blob/master/mock/doc.go">https://github.com/stretchr/testify/blob/master/mock/doc.go&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>æœ€å¾Œä¾†è·‘ä¸€æ¬¡åŠ å…¥äº† &lt;code>mock.Mock&lt;/code> ä¹‹å¾Œçš„æ•´å€‹æ¸¬è©¦æµç¨‹å§ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestStore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mockSvc&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">mockDynamoDBClient&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">// 1.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">mockSvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">On&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;PutItem&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">mock&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Anything&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Return&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dynamodb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PutItemOutput&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Once&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// 2.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">repo&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">repository&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDynamondbUserNotificationRepository&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mockSvc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 3.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// other arrangements...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// action
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">ret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">repo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Store&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TODO&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">mockedInput&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">batch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 4.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// assertions...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol>
&lt;li>é¦–å…ˆå¯¦ä¾‹åŒ–ä¸€å€‹ Mock client&lt;/li>
&lt;li>é‡é»åœ¨æ–¼é€™å€‹éƒ¨åˆ†ï¼Œä½¿ç”¨äº† &lt;code>mock.Mock&lt;/code> ç•¶ä¸­çš„æ–¹æ³•ï¼Œåˆ†åˆ¥è§£é‡‹å„å€‹æ–¹æ³•ä½œç”¨ï¼š
&lt;ul>
&lt;li>&lt;code>On(&amp;quot;PutItem&amp;quot;, mock.Anything)&lt;/code> ï¼šæ–·è¨€å‘¼å«è©²ç‰©ä»¶çš„ &lt;code>PutItem&lt;/code> æ–¹æ³•æ™‚æœƒæ”¶åˆ°ä¸€å€‹ä»»æ„åƒæ•¸ &lt;code>mock.Anything&lt;/code>&lt;/li>
&lt;li>&lt;code>Return(&amp;amp;dynamodb.PutItemOutput{}, nil)&lt;/code> ï¼šä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„ &lt;code>Called&lt;/code> æ–¹æ³•è¢«å‘¼å«å¾Œçš„å›å‚³å€¼&lt;/li>
&lt;li>&lt;code>Once()&lt;/code> ï¼šæ–·è¨€è©²æ–¹æ³•æ‡‰è©²è¦è¢«å‘¼å«ä¸€æ¬¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å†ä¾†å°‡ Mock client ç‰©ä»¶æ³¨å…¥ &lt;code>NewDynamondbUserNotificationRepository&lt;/code>&lt;/li>
&lt;li>å‘¼å« &lt;code>repo.Store(context.TODO(), mockedInput, batch)&lt;/code> æ™‚ï¼Œè£¡é¢å°‡æœƒå‘¼å« Mock client çš„ &lt;code>PutItem&lt;/code> æ–¹æ³•&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šå°±æ˜¯çµåˆ &lt;a href="https://github.com/aws/aws-sdk-go">aws SDK for go&lt;/a> æ‰€æä¾›çš„ &lt;a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/dynamodbiface/">dynamodb interface&lt;/a> æ­é… testify/mock é€²è¡Œå–®å…ƒæ¸¬è©¦çš„æ–¹æ³•ï½&lt;/p></description></item><item><title>Laravel IoC Container å¦‚ä½•è§£æ Controller method ç•¶ä¸­çš„ä¾è³´(DI)</title><link>/posts/laravel-ioc-container-%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90-controller-method-%E7%95%B6%E4%B8%AD%E7%9A%84%E4%BE%9D%E8%B3%B4/</link><pubDate>Mon, 18 Jul 2022 00:00:00 +0000</pubDate><guid>/posts/laravel-ioc-container-%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90-controller-method-%E7%95%B6%E4%B8%AD%E7%9A%84%E4%BE%9D%E8%B3%B4/</guid><description>
&lt;blockquote>
&lt;p>ç”±æ–¼ä»¥ä¸‹æ‰€åˆ†æçš„åŸå§‹ç¢¼æ˜¯èˆŠç‰ˆ(5.5)çš„ laravelï¼Œä½†å› ç‚ºæœ¬æ–‡ä¸»è¦æ¢è¨ IoC åœ¨ç‰¹å®š method çš„ä¾è³´è§£æï¼Œæ ¸å¿ƒæ¦‚å¿µæ˜¯ä¸è®Šçš„ï¼Œä½†å¯èƒ½ä¸åŒç‰ˆæœ¬åœ¨éƒ¨åˆ†ç¨‹å¼ç¢¼ä¸Šé¢æœƒæœ‰äº›è¨±å·®ç•°ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç†Ÿæ‚‰ Laravel çš„äººæ‡‰è©²éƒ½æ›‰å¾— IoC Container çš„å¼·å¤§ä¹‹è™•ï¼Œåœ¨ laravel ç•¶ä¸­ï¼Œå¯ä»¥ç°¡å–®åœ°é€éä¸€è¡Œ &lt;code>app(MyClass::class)&lt;/code> å–å¾—å·²ç¶“è¢«æ³¨å…¥ä¾è³´å¾Œ Class çš„å¯¦ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Dependence1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Dependence2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">foo2&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;foo2&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">final&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$dep1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$dep2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__construct&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Dependence1&lt;/span> &lt;span class="nv">$dependence1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Dependence2&lt;/span> &lt;span class="nv">$dependence2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">dep1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$dependence1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">dep2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$dependence2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">MyClass&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// maybe $this-&amp;gt;app-&amp;gt;make(MyClass::class) in ServiceProvider
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™æ˜¯ä¸€å€‹ laravel å¯¦ç¾æ§åˆ¶åè½‰(IoC)çš„ç°¡å–®ä¾‹å­ ï¼ŒMyClass çš„å»ºæ§‹å­ç•¶ä¸­çš„å…©å€‹å¼•æ•¸(ä¾è³´çš„Class) è¢« container è®€å–åˆ°å¾Œï¼Œå…ˆåˆ†åˆ¥è¢«å¯¦ä¾‹åŒ–ä¸¦ä½œç‚ºåƒæ•¸å‚³é€² MyClass çš„å»ºæ§‹å­ï¼Œæœ€å¾Œè¿”å›å¯¦ä¾‹åŒ–å®Œæˆçš„ MyClass ç‰©ä»¶ã€‚(æ¯æ¬¡æ‹œè®€åˆ°é€™é‚ŠçœŸçš„æ˜¯æƒ³è·ª laravel ä½œè€…ï¼‰&lt;/p>
&lt;blockquote>
&lt;p>IoC çš„æ ¸å¿ƒç†å¿µå°±æ˜¯å°‡åŸæœ¬åœ¨ä¸‹å±¤ï¼ˆå…·é«”ï¼‰çš„ç¨‹å¼ç¢¼ä¸­ã€Œæ³¨å…¥ä¾è³´ã€é€™å€‹è¡Œç‚ºï¼Œæå‡è‡³ä¸Šå±¤ï¼ˆæŠ½è±¡ï¼‰å»æ§åˆ¶æ±ºå®šè¦çµ¦è©² Class æ³¨å…¥ä»€éº¼ä¾è³´ï¼Œä¹Ÿå°±æ˜¯èªªä¸‹å±¤çš„ Class éœ€è¦ä¾è³´æ™‚ï¼Œéƒ½æœƒå‘ä¸Šå±¤å»è¦ä»–æ‰€éœ€è¦çš„ä¾è³´å¯¦ä¾‹ï¼ˆç‰¹å®š Class æˆ–æ˜¯ implement ç‰¹å®š Interface çš„å¯¦ä¾‹ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>laravel ç•¶ä¸­è¨±å¤šåŸºç¤æ ¸å¿ƒçš„ Class åœ¨åº•å±¤ä¹Ÿæ˜¯é€™éº¼é‹ä½œçš„ï¼Œä¾‹å¦‚ Controller ä¹Ÿæ˜¯ç¶“ç”± IoC Container å¯¦ä¾‹åŒ–ï¼Œæ‰€ä»¥æˆ‘å€‘æ‰èƒ½å¤ åœ¨ Controller å»ºæ§‹å­çš„å¼•æ•¸å¯«ä¸€å †ä¾è³´ç„¶å¾Œé–‹å¿ƒåœ°ä½¿ç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyController&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">Controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">protected&lt;/span> &lt;span class="nv">$logger&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__construct&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Logger&lt;/span> &lt;span class="nv">$logger&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">logger&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$logger&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">index&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">logger&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Something happened&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶è€Œï¼Œlaravel ä¸åªæœƒè‡ªå‹•è§£æåœ¨å»ºæ§‹å­å¼•æ•¸ç•¶ä¸­çš„ Dependenciesï¼Œåœ¨æŸäº›ç‰¹å®š Class ç•¶ä¸­ï¼Œlaravel ä¹Ÿæœƒè‡ªå‹•è§£æ method å¼•æ•¸ä¸­çš„ä¾è³´ï¼Œæœ€å¸¸è¦‹çš„çš„å°±æ˜¯æˆ‘å€‘çš„ Controllerï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyController&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">Controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">show&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Logger&lt;/span> &lt;span class="nv">$logger&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$logger&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Something happened&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ°åº•å…¶èƒŒå¾Œæ˜¯æ€éº¼å¯¦ç¾é€™å€‹åŠŸèƒ½çš„å‘¢ï¼Ÿä»¥ä¸‹å°±é–‹å§‹ trace code ä¾†çœ‹çœ‹å§ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä¸€å€‹ Request çš„æ—…ç¨‹å°±æ˜¯å¾ &lt;code>Illuminate\Contracts\Http\Kernel&lt;/code> é–‹å§‹ï¼Œ åœ¨ index.php ç•¶ä¸­ï¼Œå¯¦ä¾‹åŒ– Kernel Class ä¹‹å¾Œï¼Œ å‘¼å«äº† handle é€™å€‹ methodï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// public/index.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$kernel&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$app&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Illuminate\Contracts\Http\Kernel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$kernel&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">handle&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">Illuminate\Http\Request&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">capture&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥åœ¨ bootstrap/app.php ç•¶ä¸­æ‰¾åˆ°è©²æŠ½è±¡å°æ‡‰çš„ç¶å®šï¼Œä¹Ÿå°±æ˜¯ &lt;code>App\Http\Kernel&lt;/code> ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// bootstrap/app.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$app&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">singleton&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Illuminate\Contracts\Http\Kernel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">App\Http\Kernel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">class&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—ï¼Œ &lt;code>App\Http\Kernel&lt;/code> åˆ extend äº† &lt;code>Illuminate\Foundation\Http\Kernel&lt;/code> ï¼Œhandle æ–¹æ³•å°±åœ¨é€™å€‹ Class ç•¶ä¸­å®šç¾©ï¼Œé‡é»æ˜¯ sendRequestThroughRouter é€™å€‹ methodï¼Œæº–å‚™è¦å°‡ Request åˆ†é…çµ¦ Router (ä¸Šé¢éƒ½é‚„åœ¨ application å±¤ï¼Œå¾é€™é‚Šé–‹å§‹é€²åˆ° framework è£¡é¢)ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$request&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">enableHttpMethodParameterOverride&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">sendRequestThroughRouter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">sendRequestThroughRouter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">Pipeline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">app&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">through&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">app&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">shouldSkipMiddleware&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="p">[]&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">middleware&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">dispatchToRouter&lt;/span>&lt;span class="p">());&lt;/span> &lt;span class="c1">// å°‡ Request åˆ†é…çµ¦ Router
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">dispatchToRouter&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">app&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;request&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$request&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">router&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">dispatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹ä¾†è¦é€²å…¥åˆ° Router çš„éšæ®µï¼Œæœ‰äº›ä¸æ˜¯å¾ˆç›¸é—œçš„éƒ¨åˆ†å°±ç›´æ¥è·³éä¸è²¼ç¨‹å¼ç¢¼äº†ï¼Œé€²åˆ° Router å¾Œçš„ method å‘¼å«é †åºæ˜¯ dispatch â†’ dispatchToRoute â†’ runRoute -&amp;gt; runRouteWithinStack&lt;/p>
&lt;p>ä¾†çœ‹ä¸€ä¸‹ åœ¨ runRouteWithinStack ç•¶ä¸­å€’æ•¸ç¬¬ä¸‰è¡Œ &lt;code>$route-&amp;gt;run()&lt;/code> ï¼Œé€™è£¡å³å°‡è¦æº–å‚™è§£æåœ¨ routes/xxx.php ç•¶ä¸­æ‰€å®šç¾©çš„ Route æ‰€æŒ‡å®šçš„å°æ‡‰ Controller ä»¥åŠ Controller methodï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/Router.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">runRouteWithinStack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Route&lt;/span> &lt;span class="nv">$route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Request&lt;/span> &lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">Pipeline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">container&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">through&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$middleware&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">use&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$route&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">prepareResponse&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$route&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šé€²å…¥äº† Routeï¼Œä¸»è¦åœ¨æº–å‚™åŸ·è¡Œ Route æŒ‡å®šå°æ‡‰çš„ Controller ä»¥åŠ Controller methodï¼Œé€²åˆ° &lt;code>$this-&amp;gt;runController()&lt;/code> çš„éƒ¨åˆ†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/Route.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">container&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">container&lt;/span> &lt;span class="o">?:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Container&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">isControllerAction&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">runController&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// !!!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">runCallable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">HttpResponseException&lt;/span> &lt;span class="nv">$e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$e&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getResponse&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™è£¡æœƒå‘¼å«åˆ° ControllerDispatcher çš„ dispatch æ–¹æ³•æ¥æ‰‹è™•ç†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/Route.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">runController&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">controllerDispatcher&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">dispatch&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getController&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getControllerMethod&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ–äº†é€™éº¼æ·±ï¼Œçµ‚æ–¼è¦åˆ°é‡é ­æˆ²äº†ï¼Œä¹Ÿå°±æ˜¯å‘¼å«äº† &lt;code>$this-&amp;gt;resolveClassMethodDependencies&lt;/code> é€™å€‹ methodï¼Œä¸¦å°‡è·¯ç”±ä¸Šé¢æ‰€å¸¶çš„åƒæ•¸ã€å·²å¯¦ä¾‹åŒ–å¾Œçš„ Controller ä»¥åŠ method åç¨±åšç‚ºåƒæ•¸å‚³å…¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">dispatch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Route&lt;/span> &lt;span class="nv">$route&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$controller&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$method&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$parameters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">resolveClassMethodDependencies&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$route&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">parametersWithoutNulls&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nv">$controller&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$method&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$controller&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nv">$method&lt;/span>&lt;span class="p">}(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">array_values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parameters&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>resolveClassMethodDependencies å‘¼å«äº† resolveMethodDependenciesï¼Œä¸¦å°‡å‰›å‰›çš„è·¯ç”±åƒæ•¸ä»¥åŠä¸€å€‹æ–°çš„ ReflectionMethod å¯¦ä¾‹åšç‚ºåƒæ•¸å‚³å…¥ï¼ŒåŸä¾†å¯¦ç¾ Method Dependency injection çš„é‡è¦åŠŸè‡£å°±æ˜¯ ReflectionMethod é€™å€‹æ±è¥¿ï¼Œè—‰ç”± ReflectionMethodï¼Œæˆ‘å€‘å¯ä»¥ç²å¾—æŸå€‹ instance è£¡é¢é—œæ–¼æŸå€‹ method çš„è³‡è¨Šï¼ŒåŒ…æ‹¬&lt;strong>å¯ä»¥çŸ¥é“ä»–æœ‰å“ªäº›å¼•æ•¸&lt;/strong>ï¼Œè€Œé€™ä¹Ÿå°±æ˜¯å¦‚ä½•å¾—ä»¥åµæ¸¬åˆ°é€™äº› method éœ€è¦çš„ä¾è³´ï¼Œä¸¦ä¸”é å…ˆè§£æå¥½ç‰©ä»¶ç•¶çœŸæ­£è¦å‘¼å«é€™å€‹ method æ™‚å†å°‡å·²è§£æå¥½çš„ç‰©ä»¶å¸¶å…¥çš„é—œéµã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">resolveClassMethodDependencies&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">array&lt;/span> &lt;span class="nv">$parameters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$method&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="nx">method_exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$method&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$parameters&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">resolveMethodDependencies&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$parameters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ReflectionMethod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$method&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘å€‘ä¾†çœ‹çœ‹ resolveMethodDependencies è£¡é¢åšäº†ä»€éº¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">resolveMethodDependencies&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">array&lt;/span> &lt;span class="nv">$parameters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ReflectionFunctionAbstract&lt;/span> &lt;span class="nv">$reflector&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$instanceCount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">array_values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parameters&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$reflector&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getParameters&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nv">$key&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$parameter&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">transformDependency&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$parameter&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$parameters&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="nx">is_null&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$instance&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$instanceCount&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">spliceIntoParameters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parameters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$instance&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">elseif&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$values&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$key&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nv">$instanceCount&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$parameter&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">isDefaultValueAvailable&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">spliceIntoParameters&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parameters&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$parameter&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">getDefaultValue&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$parameters&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€™é‚Šå¦å¤–æ³¨æ„ï¼Œå‚³å…¥çš„ parameters ç•¶ä¸­å¯èƒ½åŒ…å« primitive å€¼ï¼Œå› ç‚ºåœ¨ Route ç•¶ä¸­å¯èƒ½æœƒé€™æ¨£å®šç¾©ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// in routes
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Route&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;countries.{country}&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;CountryController@show&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;countries.show&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// in Controllers
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">show&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$country&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Request&lt;/span> &lt;span class="nv">$request&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‹¥ endpoint ç‚º &lt;code>/api/countries/1&lt;/code> ï¼Œæˆ‘å€‘å°‡ &lt;code>$parameters&lt;/code> ã€ &lt;code>$reflector-&amp;gt;getParameters()&lt;/code> dd å‡ºä¾†çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// $parameters
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">array&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// $reflector-&amp;gt;getParameters()
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">array&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">0&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">ReflectionParameter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#1228
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;country&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">position&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="mi">1&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">ReflectionParameter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="c1">#1229
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;request&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">position&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">typeHint&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;Illuminate\Http&lt;/span>&lt;span class="se">\R&lt;/span>&lt;span class="s2">equest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥åœ¨éæ­·æ¯å€‹å¾ ReflectionMethod å¾—åˆ°çš„ method å¼•æ•¸æ™‚ (&lt;code>$reflector-&amp;gt;getParameters()&lt;/code>)ï¼Œé¦–å…ˆæœƒå˜—è©¦æ ¹æ“š TypeHint å°‡å…¶å¯¦ä¾‹åŒ–ï¼ˆå¦‚æœè©²å¼•æ•¸æœ‰ typeHint ï¼‰ï¼Œè‹¥èƒ½æˆåŠŸè§£æå‡ºå¯¦ä¾‹ï¼Œå†æŒ‰ç…§æ­£ç¢ºä½ç½®å¡å…¥ $parameters ç•¶ä¸­ï¼Œæœ€å¾Œå›å‚³è©² $parameters é™£åˆ—çµ¦vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher@dispatch&lt;/p>
&lt;p>å°‡é€™äº›è§£æå®Œç•¢çš„ä¾è³´åƒæ•¸å‚³å…¥ç›¸å°æ‡‰çš„ Controller method åŸ·è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$controller&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nv">$method&lt;/span>&lt;span class="p">}(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">array_values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$parameters&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‡³æ­¤å·²ç¶“å¤§è‡´å°‡ laravel å¯¦ç¾ Controller method è‡ªå‹•æ³¨å…¥ä¾è³´çš„æ ¸å¿ƒéƒ¨åˆ†éƒ½çœ‹å®Œäº†ï¼Œç†è§£äº†æ ¸å¿ƒæ¦‚å¿µå†ä¾†çœ‹é€™äº›å¯¦ä½œçš„ç¨‹å¼ç¢¼å¾Œï¼Œæ„Ÿè¦ºä¸€åˆ‡ä¸å†é‚£éº¼ magic äº†ï½&lt;/p>
&lt;h2 id="åƒè€ƒè³‡æ–™">
&lt;a href="#%e5%8f%83%e8%80%83%e8%b3%87%e6%96%99" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åƒè€ƒè³‡æ–™
&lt;/h2>
&lt;ul>
&lt;li>Laravel: Up &amp;amp; Running (Book) CHAPTER 11. The The Container&lt;/li>
&lt;li>&lt;a href="https://www.php.net/manual/en/class.reflectionmethod.php">https://www.php.net/manual/en/class.reflectionmethod.php&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Promise.all() èˆ‡ async/await</title><link>/posts/promise-all%E8%88%87async-await%E5%92%8Caxios/</link><pubDate>Sun, 30 Jun 2019 14:48:12 +0000</pubDate><guid>/posts/promise-all%E8%88%87async-await%E5%92%8Caxios/</guid><description>
&lt;p>æœ¬ä¾†ä¸€ç›´éƒ½ç”¨è¿´åœˆå»è™•ç†åŒæ™‚ç™¼å¤šå€‹ requestï¼ˆå¾ˆå¥½æ‡‚ä½†æœ‰é»é›£è™•ç† Errorï¼‰ï¼Œé€™æ¬¡è¦ªè‡ªä¾†è©¦è©¦ Promise.all() ç¸½ç®—é«”é©—åˆ°å¹³è¡Œè™•ç†éåŒæ­¥çš„å¨åŠ›ï¼ˆï¼Ÿï¼‰æ–¼æ˜¯ç´€éŒ„ä¸€ä¸‹å¿ƒå¾—ä»¥åŠå’Œ await + axios é€£ç”¨æ™‚çš„ä¸€äº›çœ‰è§’ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="promiseall-ç”¨æ³•">
&lt;a href="#promiseall-%e7%94%a8%e6%b3%95" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Promise.all() ç”¨æ³•
&lt;/h2>
&lt;p>Promise.all (&lt;code>iterable&lt;/code>) æ¥å—ä¸€å€‹ iterable ç‰©ä»¶ï¼ˆé€šå¸¸æ˜¯é™£åˆ—ï¼‰ä½œç‚ºåƒæ•¸ï¼Œç•¶è£¡é¢æ¯å€‹å…ƒç´ éƒ½æ˜¯ Promise ç‰©ä»¶æ™‚(ä¹Ÿå¯ä»¥ä¸æ˜¯ï¼Œå¾…æœƒæœƒæåˆ°ï¼‰ï¼Œå®ƒå°±æœƒå¹³è¡Œå»è™•ç†é€™äº› Promiseã€‚ç”±æ–¼&lt;strong>å…¶æœ¬èº«æœƒå›å‚³ä¸€å€‹ Promise ç‰©ä»¶&lt;/strong>ï¼Œæ‰€ä»¥æˆ‘å€‘åŒæ¨£å¯ä»¥ç”¨ then æˆ– await å»æ¥ä»–çš„ resolve/rejectã€‚
ç•¶æ‰€æœ‰çš„ Promise éƒ½è¢« resolve å¾Œæ‰æœƒå›å‚³ resolveï¼Œå…¶å€¼æœƒæ˜¯å…¨éƒ¨çš„ Promise è™•ç†å®Œå¾Œæ‰€å›å‚³çš„ resolve å€¼æ‰€çµ„æˆçš„é™£åˆ—ã€‚ä½†è‹¥å…¶ä¸­æœ‰ä¸€å€‹ Promise è¢« reject å°±æœƒç›´æ¥æ‹‹å‡ºè©² Promise æ‰€å›å‚³çš„éŒ¯èª¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">array1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">promiseArr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">array1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">promiseArr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//Â [Promise, Promise, Promise, Promise]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç”¨ then æ¥çµæœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">promiseArr&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">then&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vals&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vals&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [1, 4, 9, 16]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç”¨ await æ¥çµæœ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">vals&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">promiseArr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vals&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [1, 4, 9, 16]
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>æé†’ï¼š &lt;code>await&lt;/code> å¾Œé¢æ¥çš„ä¸€å®šæœƒæ˜¯ä¸€å€‹ Promise ï¼ˆæˆ– async functionï¼‰ï¼Œä»–æœƒå¹«æˆ‘å€‘æŠŠ Promise è™•ç†å®Œå¾Œç›´æ¥åçµ¦æˆ‘å€‘ resovle æˆ– reject çš„å€¼ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>è€Œç•¶é™£åˆ—è£¡é¢æœ‰é Promise ç‰©ä»¶çš„å…ƒç´ å­˜åœ¨æ™‚ï¼ŒPromise.all() ä»æœƒè¼¸å‡ºè©²å…ƒç´ çš„å€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">resolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">all&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// [1, 2]
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="promiseall--axios">
&lt;a href="#promiseall--axios" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
Promise.all() + axios
&lt;/h2>
&lt;p>æˆ‘å€‘å¯ä»¥å…ˆé€é &lt;code>map()&lt;/code> è™•ç†åŸå§‹é™£åˆ—ï¼ˆ&lt;code>map()&lt;/code>æœƒå›å‚³æ–°çš„é™£åˆ—ï¼‰ï¼ŒæŠŠåŸå§‹é™£åˆ—æ”¹æˆä¸€çµ„ Promise é™£åˆ—ã€‚ä»¥ä¸‹é¢ç¨‹å¼ç¢¼ç‚ºä¾‹ï¼Œ products ç‚ºä¸€çµ„å•†å“ç‰©ä»¶çš„é™£åˆ—ï¼Œåœ¨æ­¤å³åˆ©ç”¨ &lt;code>map ()&lt;/code> éæ­·æ¯å€‹å•†å“ç‰©ä»¶ï¼Œåœ¨ &lt;code>map()&lt;/code> çš„ callback function è£¡ç›´æ¥å‘¼å« axios å°‡å•†å“è³‡è¨Šå¸¶å…¥ request body ç™¼é€è«‹æ±‚ï¼Œç”±æ–¼ axios æœ¬èº«å°±æœƒå›å‚³ Promiseï¼Œæ‰€ä»¥æˆ‘å€‘å°±èƒ½æˆåŠŸæ‹¿åˆ°ä¸€çµ„ Promise é™£åˆ—ä¸¦ç›´æ¥å¡é€² Promise.all è£¡é¢å›‰ï¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nb">Promise&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">all&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">products&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nx">product&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">$axios&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://localhost:8000/api/products&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">product&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">price&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">product&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">price&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">order_id&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">myOrder_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥æˆ‘å€‘æœƒå¾—åˆ°ä¸€å€‹é™£åˆ—é•·é€™æ¨£ï¼š&lt;/p>
&lt;p>é€™æ™‚ç™¼ç¾å®ƒé•·å¾—å¥½åƒä¸æ˜¯æˆ‘å€‘è¦çš„ response dataï¼Œé‚£æ˜¯å› ç‚º axios çš„ response ï¼ˆresolve valueï¼‰ä¸¦éç›´æ¥å› server çµ¦æˆ‘å€‘çš„è³‡æ–™ ï¼Œè€Œè£¡é¢é‚£å±¤ data æ‰æ˜¯æˆ‘å€‘è¦çš„è³‡æ–™ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{},&lt;/span> &lt;span class="c1">//é€™æ‰æ˜¯ server å›çµ¦æˆ‘å€‘çš„è³‡æ–™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">status&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">statusText&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;OK&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">headers&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">config&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">request&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Vue $attrs/$listeners çˆºå­«çµ„ä»¶è³‡æ–™å‚³é</title><link>/posts/vue%E7%88%BA%E5%AD%AB%E7%B5%84%E4%BB%B6%E8%B3%87%E6%96%99%E5%82%B3%E9%81%9E/</link><pubDate>Sun, 23 Jun 2019 22:38:02 +0000</pubDate><guid>/posts/vue%E7%88%BA%E5%AD%AB%E7%B5%84%E4%BB%B6%E8%B3%87%E6%96%99%E5%82%B3%E9%81%9E/</guid><description>
&lt;p>å¹³å¸¸åœ¨å¯¦ä½œ Vue çµ„ä»¶ä¹‹é–“çš„è³‡æ–™å‚³éå¤§éƒ¨åˆ†éƒ½æ˜¯é€é &lt;code>props&lt;/code> åŠ &lt;code>$emit&lt;/code>ï¼Œæˆ–æ˜¯ç›´æ¥ç¶“ç”± Vuex é€²è¡Œç‹€æ…‹ç®¡ç†ï¼Œè€Œé™¤äº†é€™å…©ç¨®æ–¹æ³•ï¼Œé‚„æœ‰å¦å¤–ä¸€ç¨®åšæ³•æ˜¯é€é &lt;code>$attrs&lt;/code> åŠ &lt;code>$listenter&lt;/code>ã€‚&lt;/p>
&lt;!-- more -->
&lt;p>æœ¬èº«ä¹Ÿæ˜¯å› ç‚ºä¹‹å‰å¶ç„¶åœ¨æŸ¥è³‡æ–™çš„æ™‚å€™çœ‹åˆ°é€™å…©å€‹ APIï¼Œä½†ç•¶æ™‚çœ‹éåˆ¥äººå¯«çš„æ–‡ç« å¾Œå»åªæ˜¯ä¼¼æ‡‚éæ‡‚ï¼Œé ‚å¤šçŸ¥é“æœ‰é€™å€‹æ±è¥¿ä½†ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨æˆ–è©²ç”¨åœ¨ä»€éº¼å ´åˆï¼Œä¸€ç›´åˆ°å¯¦ä½œæ™‚æ‰çœŸæ­£ç†è§£å®ƒçš„ç”¨æ³•ï¼Œä½†å¤šçœ‹å¤šè®€ç¸½æ˜¯å¥½çš„ï¼Œæœ‰ä¸€å¤©æˆ–è¨±æ´¾å¾—ä¸Šç”¨å ´ã€‚&lt;/p>
&lt;h2 id="attrs">
&lt;a href="#attrs" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
&lt;code>$attrs&lt;/code>
&lt;/h2>
&lt;p>å…¶å¯¦ç°¡å–®èªªå°±æ˜¯å­çµ„ä»¶å¯ä»¥é€é&lt;code>$attrs&lt;/code>å–å¾—çˆ¶çµ„ä»¶ç•¶ä¸­&lt;em>é™¤äº† Props ä»¥å¤–&lt;/em>çš„æ‰€æœ‰è³‡æ–™ã€‚&lt;/p>
&lt;p>ä¹çœ‹ä¹‹ä¸‹å¥½åƒæ²’ä»€éº¼ï¼Œé‚£ä¸å°±ç›´æ¥ç”¨ Props å°±å¥½äº†å—ï¼Ÿ
ä½†ç•¶åœ¨å¤šé‡çµ„ä»¶åµŒå¥—çš„æƒ…æ³ä¹‹ä¸‹ï¼Œå°±æœƒé¡¯å¾—å¾ˆæœ‰ç”¨ã€‚æˆ‘å€‘å…ˆå®šç¾©å‡ºä¸‰å€‹çµ„ä»¶ï¼Œä»–å€‘åˆ†åˆ¥æ˜¯ï¼š a-componentï¼ˆçˆºçµ„ä»¶/æ¨¡æ¿ï¼‰ã€b-componentï¼ˆçˆ¶çµ„ä»¶ï¼‰ã€c-componentï¼ˆå­«çµ„ä»¶ï¼‰&lt;/p>
&lt;p>æˆ‘å€‘å¯ä»¥åœ¨ a ä½¿ç”¨ bï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// a-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">b-component&lt;/span> &lt;span class="na">:msg&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;hello&amp;#34;&lt;/span>&lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—åœ¨ b ä¸­æˆ‘å€‘å¯ä»¥ä½¿ç”¨ &lt;code>$attrs&lt;/code> è€Œä¸ç”¨é€é Props æ‹¿åˆ° &lt;code>apiUrl&lt;/code>ï¼Œä¸¦ä¸”å°‡ &lt;code>$attrs&lt;/code> é€é &lt;code>v-bind&lt;/code> ç¶å®šåœ¨ c ä¸Šå‚³çµ¦ c ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// b-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">h1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>{{ $attrs.data }}&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">h1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">c-component&lt;/span> &lt;span class="na">v-bind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;$attrs&amp;#34;&lt;/span>&lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å¾ŒåŒæ¨£åœ¨ c ç•¶ä¸­æˆ‘å€‘å°±èƒ½å¤ é€é&lt;code>$attrs&lt;/code>å–å¾— a çš„è³‡æ–™ ã€‚é€™æ¨£ä¸€ä¾†çš„å¥½è™•å°±æ˜¯ç•¶æˆ‘å€‘æœ‰å¤šå€‹è³‡æ–™è¦å¾ a å‚³çµ¦ b è·Ÿ c å…±ç”¨æ™‚ï¼Œä¸ç”¨æ¯ä¸€å±¤éƒ½è¦è²æ˜ Propsï¼Œç„¶å¾Œé‚„è¦å°‡æ¯å€‹ Props å¯«åœ¨ component çš„æ¨™ç±¤è£¡é¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// c-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">h1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>{{ $attrs.data }}&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">h1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>å’Œ &lt;code>$attrs&lt;/code> ç›¸é—œçš„ API é‚„æœ‰ &lt;code>inheritAttrs&lt;/code>ï¼Œå…¶å€¼ç‚ºå¸ƒæ—å€¼ï¼Œé è¨­ç‚º &lt;code>true&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæˆ‘å€‘æ²’æœ‰ç‰¹åˆ¥å°‡å…¶è¨­å®šæˆ &lt;code>false&lt;/code>ï¼Œå­çµ„ä»¶é»˜èªå¯ä»¥é€é &lt;code>$attrs&lt;/code> å–å¾—åœ¨çˆ¶çµ„ä»¶ç•¶ä¸­éé€é Props ç¹¼æ‰¿çš„è³‡æ–™ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="listeners">
&lt;a href="#listeners" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
$listeners
&lt;/h2>
&lt;p>æ‡‰è©²ä¸é›£çŒœæƒ³ï¼Œ &lt;code>$attrs&lt;/code> å°æ‡‰ Props ï¼Œ&lt;code>$listeners&lt;/code> å‰‡å°æ‡‰ &lt;code>$emit&lt;/code>ã€‚
ç°¡å–®ä¾†èªªå°±æ˜¯çˆ¶çµ„ä»¶å¯ä»¥é€é &lt;code>$listeners&lt;/code> å–å¾—æ‰€æœ‰å­çµ„ä»¶ &lt;code>$emit&lt;/code> æ‰“å‡ºä¾†çš„äº‹ä»¶ã€‚åŒæ¨£ä»¥ä¸Šé¢ä¸‰å€‹çµ„ä»¶ç‚ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// c-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">button&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="na">click&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;$emit(&amp;#39;sayHi&amp;#39;)&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> click me!&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">button&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ b ç•¶ä¸­åŒæ¨£å¯ä»¥é€é &lt;code>v-on=&amp;quot;$listeners&amp;quot;&lt;/code>å°‡ c äº‹ä»¶å§”ä»»çµ¦ aï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// b-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">c-component&lt;/span> &lt;span class="na">v-on&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;$listeners&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>a å°±å¯ä»¥ç›´æ¥è™•ç† c æ‰“å‡ºçš„&lt;code>$emit&lt;/code>äº‹ä»¶ï¼Œè€Œä¸ç”¨é€é b å† emit ä¸€æ¬¡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">// a-component
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">b-component&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="na">sayHi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;anEventHandler&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç¸½çµ">
&lt;a href="#%e7%b8%bd%e7%b5%90" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
ç¸½çµ
&lt;/h2>
&lt;p>æ‰€ä»¥ç•¶å¤šé‡çµ„ä»¶ä¹‹é–“éœ€è¦æºé€šå‚³éï¼Œä½†ä¸æƒ³ç”¨ Vuex æ™‚ï¼Œå¯ä»¥å˜—è©¦æ¡ç”¨é€™å…©ç¨®æ–¹æ³•ï¼š
* &lt;code>$attrs&lt;/code>ï¼šå­«çµ„ä»¶å–å¾—çˆºçµ„ä»¶çš„è³‡æ–™
* &lt;code>$listeners&lt;/code>ï¼šçˆºçµ„ä»¶ç›´æ¥è§¸ç™¼å­«çµ„ä»¶çš„äº‹ä»¶&lt;/p></description></item><item><title>ä½¿ç”¨ vue-echarts è¸©çš„å‘</title><link>/posts/%E4%BD%BF%E7%94%A8vue-echarts%E8%B8%A9%E7%9A%84%E5%9D%91/</link><pubDate>Tue, 11 Jun 2019 00:00:00 +0000</pubDate><guid>/posts/%E4%BD%BF%E7%94%A8vue-echarts%E8%B8%A9%E7%9A%84%E5%9D%91/</guid><description>
&lt;p>ç¬¬ä¸€æ¬¡ä½¿ç”¨ Echarts é€™å¥—åœ–å½¢ libraryï¼Œåœ¨ vue ä¸­ä½¿ç”¨ Echarts å¯ä»¥ç›´æ¥è£ vue-echartï¼Œå®˜æ–¹æ–‡ä»¶æ¨è–¦å…©å€‹éƒ½è£ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ npm install echarts vue-echarts
&lt;/code>&lt;/pre>&lt;p>é æ–™ä¹‹ä¸­çš„è¸©äº†ä¸å°‘å‘ï¼Œåœ¨æ­¤ç´€éŒ„ä¸€äº›é‡é»ã€‚&lt;/p>
&lt;!-- more -->
&lt;h2 id="å®‰è£å®Œå¾Œå¼•å…¥ä¸¦è¨»å†Šåœ–è¡¨-component">
&lt;a href="#%e5%ae%89%e8%a3%9d%e5%ae%8c%e5%be%8c%e5%bc%95%e5%85%a5%e4%b8%a6%e8%a8%bb%e5%86%8a%e5%9c%96%e8%a1%a8-component" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
å®‰è£å®Œå¾Œå¼•å…¥ä¸¦è¨»å†Šåœ–è¡¨ component
&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">Vue&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s1">&amp;#39;vue&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="nx">ECharts&lt;/span> &lt;span class="nx">from&lt;/span> &lt;span class="s1">&amp;#39;vue-echarts&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="s1">&amp;#39;echarts/lib/chart/bar&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="s1">&amp;#39;echarts/lib/component/tooltip&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="s1">&amp;#39;echarts-gl&amp;#39;&lt;/span> &lt;span class="c1">//ç­‰ç­‰æœƒä½¿ç”¨ grapic è¨­å®šåœ–å½¢æ–‡å­—ï¼Œæ•…éœ€è¼‰å…¥æ­¤ module
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">Vue&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">component&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;v-chart&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ECharts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// è¨»å†Šç‚º global component
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åŸºç¤ä½¿ç”¨">
&lt;a href="#%e5%9f%ba%e7%a4%8e%e4%bd%bf%e7%94%a8" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åŸºç¤ä½¿ç”¨
&lt;/h2>
&lt;p>åœ¨ template ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨åœ–è¡¨ componentï¼Œå…¶æ¥æ”¶ &lt;code>options&lt;/code> ç‚º propsï¼Œè£¡é¢çš„&lt;code>series&lt;/code>å±¬æ€§ç‚ºè¨­ç½®ç‰¹å®šé¡å‹åœ–è¡¨çš„å±¬æ€§ï¼Œåœ¨æ­¤ä½¿ç”¨å°ˆæ¡ˆä¸­çš„åœ“é¤…åœ–ç•¶ç¯„ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">v-chart&lt;/span> &lt;span class="na">:options&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;options&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">data&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">options&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">series&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;pie&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// å¿…é ˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;test&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// å¿…é ˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">radius&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;50%&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;70%&amp;#39;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">label&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">normal&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">show&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">emphasis&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">show&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">formatter&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;{b} {@percentage}%&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;éŸ“åœ‹&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">70&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;æ—¥æœ¬&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;å°ç£&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;è¶Šå—&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">6&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;ä¸­åœ‹&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;å…¶ä»–&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åœ“é¤…åœ–ä¸­é–“åŠ å…¥æ–‡å­—">
&lt;a href="#%e5%9c%93%e9%a4%85%e5%9c%96%e4%b8%ad%e9%96%93%e5%8a%a0%e5%85%a5%e6%96%87%e5%ad%97" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åœ“é¤…åœ–ä¸­é–“åŠ å…¥æ–‡å­—
&lt;/h2>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼š&lt;strong>ä¸€å®šè¦è£ &lt;code>echarts-gl&lt;/code> æ¨¡çµ„&lt;/strong>ï¼Œå¦å‰‡æœƒç„¡æ³•é¡¯ç¤ºã€‚
å¯ä»¥ç›´æ¥åˆ©ç”¨å®˜æ–¹æä¾›çš„å±¬æ€§&lt;code>grapic&lt;/code>ç‚ºåœ–è¡¨è‡ªè¡Œæ·»åŠ åœ–å½¢å…ƒç´ ï¼Œä¸¦æ–°å¢ç‰¹å®šæ–‡å­—ï¼ˆå¯ä»¥æ–°å¢çš„åœ–å½¢å…ƒç´ é¡å‹é‚„æœ‰åœ–ç‰‡ã€åœ–å½¢ç­‰ï¼Œå¯ä»¥åƒè€ƒ&lt;a href="https://echarts.baidu.com/option.html#graphic">æ–‡ä»¶&lt;/a>ï¼‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">graphic&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;text&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">left&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;center&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">top&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;center&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">style&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">text&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;å­¸ç”Ÿåœ‹ç±æ¯”ä¾‹&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">textAlign&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;center&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fill&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;#666&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">font&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;20px &amp;#34;STHeiti&amp;#34;, sans-serif&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åœ–ä¾‹èªªæ˜legendéœ€è¦æ·»åŠ -value-è³‡æ–™">
&lt;a href="#%e5%9c%96%e4%be%8b%e8%aa%aa%e6%98%8elegend%e9%9c%80%e8%a6%81%e6%b7%bb%e5%8a%a0-value-%e8%b3%87%e6%96%99" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åœ–ä¾‹èªªæ˜ï¼ˆlegendï¼‰éœ€è¦æ·»åŠ  value è³‡æ–™
&lt;/h2>
&lt;p>echarts æä¾›çš„ formater callback function åªæœ‰çµ¦æˆ‘å€‘ &lt;code>name&lt;/code> é€™å€‹åƒæ•¸ï¼Œæ‰€ä»¥è¦åŒæ™‚æ‹¿åˆ° &lt;code>value&lt;/code> çš„è©±ï¼Œæœƒéœ€è¦è‡ªå·±å¾åœ–è¡¨å¯¦ä¾‹è£¡é¢æ‰¾ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼š&lt;strong>å¿…é ˆä½¿ç”¨ç®­é ­å‡½å¼&lt;/strong>æ‰èƒ½æ‹¿åˆ°é€™å€‹ component çš„å¯¦ä¾‹ï¼Œé€²è€Œå–å¾— &lt;code>options.series[0].data&lt;/code> å¾—åˆ°æˆ‘å€‘è¦çš„ &lt;code>value&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">legend&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">orient&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;verticle&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">left&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;left&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">bottom&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;middle&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">textStyle&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fontSize&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">formatter&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">name&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">series&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">targetValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">map&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">item&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">targetValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">item&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">name&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">targetValue&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s1">&amp;#39;%&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åœ–è¡¨çš„éŸ¿æ‡‰">
&lt;a href="#%e5%9c%96%e8%a1%a8%e7%9a%84%e9%9f%bf%e6%87%89" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
åœ–è¡¨çš„éŸ¿æ‡‰
&lt;/h2>
&lt;p>ç”±æ–¼ä¸€é–‹å§‹è¨­å®šåœ–ä¾‹çš„æ’åˆ—æ–¹å¼ç‚ºå‚ç›´æ’åˆ—ã€é å·¦ä¸¦ç½®ä¸­ï¼Œä½†åœ¨è¡Œå‹•è£ç½®ä¸Šé€™æ¨£æœƒç ´ç‰ˆï¼Œæ‰€ä»¥é¦–å…ˆç¬¬ä¸€æ­¥å…ˆè¨­å®šè®“æ•´å€‹ Canvas å¯ä»¥è‡ªé©æ‡‰å®¹å™¨å¤§å°ç¸®æ”¾ï¼Œå¯¦ç¾æ–¹æ³•å…¶å¯¦åªè¦ä¿®æ”¹ CSS å³å¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-css" data-lang="css">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span>&lt;span class="nc">echarts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">width&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="kt">%&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">height&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="kt">px&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥è‘—å°±æœƒé¢è‡¨åˆ°åœ–ä¾‹è·Ÿåœ–è¡¨æœ¬é«”é‡ç–Šçš„å•é¡Œï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åµæ¸¬è¦–çª—å¯¬åº¦å¤§å°ï¼Œéš¨è‘—è£ç½®å¯¬åº¦ä¸åŒæ”¹è®Šåœ–ä¾‹æ’åˆ—çš„æ–¹å¼ã€‚&lt;/p>
&lt;h4 id="1-é¦–å…ˆå…ˆåœ¨-component-ä¸Šç¶å®š-ref">
&lt;a href="#1-%e9%a6%96%e5%85%88%e5%85%88%e5%9c%a8-component-%e4%b8%8a%e7%b6%81%e5%ae%9a-ref" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
1. é¦–å…ˆå…ˆåœ¨ component ä¸Šç¶å®š &lt;code>ref&lt;/code>
&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">v-chart&lt;/span> &lt;span class="na">ref&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;myChart&amp;#34;&lt;/span> &lt;span class="na">:options&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;options&amp;#34;&lt;/span> &lt;span class="p">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2-åœ¨-mounted-ç•¶ä¸­ç›£è½-window-çš„-load-eventç•¶é é¢è¼‰å…¥æ™‚è¨ˆç®—ç•¶å‰è¢å¹•å¯¬åº¦å¤§å°å†é€é-ref-å±¬æ€§è¨ªå•è©²åœ–è¡¨å¯¦ä¾‹ä¸¦ä¿®æ”¹å…¶-optionslegend-å±¬æ€§å’Œåœ–ä¾‹å®šä½ç›¸é—œçš„å±¬æ€§">
&lt;a href="#2-%e5%9c%a8-mounted-%e7%95%b6%e4%b8%ad%e7%9b%a3%e8%81%bd-window-%e7%9a%84-load-event%e7%95%b6%e9%a0%81%e9%9d%a2%e8%bc%89%e5%85%a5%e6%99%82%e8%a8%88%e7%ae%97%e7%95%b6%e5%89%8d%e8%9e%a2%e5%b9%95%e5%af%ac%e5%ba%a6%e5%a4%a7%e5%b0%8f%e5%86%8d%e9%80%8f%e9%81%8e-ref-%e5%b1%ac%e6%80%a7%e8%a8%aa%e5%95%8f%e8%a9%b2%e5%9c%96%e8%a1%a8%e5%af%a6%e4%be%8b%e4%b8%a6%e4%bf%ae%e6%94%b9%e5%85%b6-optionslegend-%e5%b1%ac%e6%80%a7%e5%92%8c%e5%9c%96%e4%be%8b%e5%ae%9a%e4%bd%8d%e7%9b%b8%e9%97%9c%e7%9a%84%e5%b1%ac%e6%80%a7" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
2. åœ¨ mounted ç•¶ä¸­ç›£è½ window çš„ load eventï¼Œç•¶é é¢è¼‰å…¥æ™‚è¨ˆç®—ç•¶å‰è¢å¹•å¯¬åº¦å¤§å°ï¼Œå†é€é &lt;code>ref&lt;/code> å±¬æ€§è¨ªå•è©²åœ–è¡¨å¯¦ä¾‹ä¸¦ä¿®æ”¹å…¶ &lt;code>options.legend&lt;/code> å±¬æ€§ï¼ˆå’Œåœ–ä¾‹å®šä½ç›¸é—œçš„å±¬æ€§ï¼‰
&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addEventListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;load&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">windowWidth&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">window&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">screen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">width&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">let&lt;/span> &lt;span class="nx">orient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">left&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">bottom&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">windowWidth&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">480&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">orient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;horizontal&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;center&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">bottom&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;bottom&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">orient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;vertical&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;left&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">bottom&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;middle&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">$refs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">myChart&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">$refs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">myChart&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">orient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">orient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">$refs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">myChart&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">left&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">left&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">$refs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">myChart&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">legend&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bottom&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">bottom&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>æ³¨æ„ï¼šæ­¤ç¶å®šæ–¹æ³•åªæœ‰åœ¨é é¢ç¬¬ä¸€æ¬¡æ¸²æŸ“æ™‚æ‰æœƒæœ‰æ•ˆï¼Œå¦‚æœè¦å¯¦ç¾ RWD è¦å†å¦å¤–ç›£è½ resize äº‹ä»¶ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="çµèª">
&lt;a href="#%e7%b5%90%e8%aa%9e" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
çµèª
&lt;/h2>
&lt;h4 id="1-å¦‚æœè¦ç”¨åˆ°è¼ƒå¤šå®¢è£½åŒ–åŠŸèƒ½è¦ç”¨-echartså¦å‰‡æ‰ç”¨-v-charts">
&lt;a href="#1-%e5%a6%82%e6%9e%9c%e8%a6%81%e7%94%a8%e5%88%b0%e8%bc%83%e5%a4%9a%e5%ae%a2%e8%a3%bd%e5%8c%96%e5%8a%9f%e8%83%bd%e8%a6%81%e7%94%a8-echarts%e5%90%a6%e5%89%87%e6%89%8d%e7%94%a8-v-charts" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
1. å¦‚æœè¦ç”¨åˆ°è¼ƒå¤šå®¢è£½åŒ–åŠŸèƒ½è¦ç”¨ Echartsï¼Œå¦å‰‡æ‰ç”¨ v-charts
&lt;/h4>
&lt;p>åœ¨åŠ å…¥åœ“é¤…ä¸­é–“æ–‡å­—é‚£è£¡å¡æ»¿ä¹…ï¼ŒåŸå› æ˜¯ä¸€é–‹å§‹è£çš„æ˜¯ v-chartsï¼ˆç®—æ˜¯è¼•é‡ç°¡åŒ–ç‰ˆçš„ Echartsï¼‰ï¼Œæ¨æ¸¬ç›®å‰é‚„æ²’æœ‰æ”¯æ´åˆ°å¯ä»¥ä½¿ç”¨åœ–å½¢æ–‡å­—ï¼ˆå„ç¨®æ–¹å¼åŠ å…¥ &lt;code>graphic&lt;/code> å±¬æ€§éƒ½æœªèµ·ä½œç”¨ï¼‰ï¼Œé›–ç„¶ä¹Ÿå¯èƒ½åªæ˜¯å°šæœªæ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆï¼ˆç¿»æ–‡ä»¶å¿«ç¿»åˆ°ç™¼ç˜‹ï¼‰ã€‚&lt;/p>
&lt;h4 id="2-åœ¨-vue-ç•¶ä¸­å–å¾—åœ–è¡¨å¯¦ä¾‹çš„æ–¹æ³•">
&lt;a href="#2-%e5%9c%a8-vue-%e7%95%b6%e4%b8%ad%e5%8f%96%e5%be%97%e5%9c%96%e8%a1%a8%e5%af%a6%e4%be%8b%e7%9a%84%e6%96%b9%e6%b3%95" class="anchor">
&lt;svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
&lt;path fill-rule="evenodd"
d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
&lt;/path>
&lt;/svg>
&lt;/a>
2. åœ¨ Vue ç•¶ä¸­å–å¾—åœ–è¡¨å¯¦ä¾‹çš„æ–¹æ³•
&lt;/h4>
&lt;p>åœ¨ &lt;code>options&lt;/code> å…§éƒ¨è‹¥ç”¨åˆ°å…¶æä¾›çš„å›èª¿å‡½å¼ï¼Œå¿…é ˆä½¿ç”¨ç®­é ­å‡½å¼ï¼Œæ‹¿åˆ°çš„ &lt;code>this&lt;/code>æ‰æœƒæ˜¯æˆ‘å€‘è¦çš„åœ–è¡¨å¯¦ä¾‹ç‰©ä»¶ï¼ˆå¦å‰‡æœƒæ˜¯ undefinedï¼‰ã€‚ä½†åœ¨å…¶ä»–åœ°æ–¹ï¼ˆVue çš„ç’°å¢ƒä¸­ï¼‰å‰‡è¦é€éè¨ªå• DOM å…ƒç´ æ‰èƒ½å¾—åˆ°åœ–è¡¨å¯¦ä¾‹ç‰©ä»¶ã€‚
ç›®å‰çš„æ–¹æ³•æ˜¯é€™æ¨£ï¼Œä½†å…¶å¯¦å®˜æ–¹å¥½åƒæœ‰æä¾›å…¶ä»–å¯ä»¥è¨ªå• &lt;code>options&lt;/code>çš„ APIï¼ˆå¦‚ &lt;code>computedOptions&lt;/code>ï¼Œå¯åƒè€ƒ&lt;a href="https://github.com/ecomfe/vue-echarts#computed">æ–‡ä»¶&lt;/a>ï¼‰ ï¼Œä½†æˆ‘ç›®å‰æ˜¯éƒ½æ²’æœ‰æˆåŠŸé QwQï¼Œå¯èƒ½é‚„éœ€å¦å¤–ç ”ç©¶ã€‚&lt;/p></description></item></channel></rss>