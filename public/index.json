[{"categories":null,"contents":" å‰æ Facebook ios sdk åœ¨ 17.0.0 ç‰ˆæœ¬å¾Œï¼Œè¦æ±‚å¿…é ˆå¯¦ä½œ Limited Loginï¼Œä¸¦ä½¿ç”¨ JWT token é€²è¡Œé©—è­‰ï¼Œå¦å‰‡åœ¨æŸäº›æƒ…æ³ä¸‹æœƒæœ‰éé æœŸéŒ¯èª¤(ref)ã€‚\næµç¨‹ç‚ºï¼š\nclient ç«¯ï¼ˆios Appï¼‰ æœƒå°‡ä»¥ä¸‹è³‡è¨Šï¼š\nç™»å…¥å˜—è©¦è¦æ±‚çš„æ¬Šé™ è¿½è¹¤åå¥½è¨­å®š nonceï¼ˆéš¨æ©Ÿç”Ÿç”¢çš„äº‚æ•¸ï¼Œæ¯æ¬¡è«‹æ±‚éƒ½é ˆä¸åŒï¼Œç”¨ä¾†åšå¾ŒçºŒçš„é©—è­‰ï¼‰ å¸¶å…¥è«‹æ±‚ï¼Œå‘ FB å–å¾—ç”¨æˆ¶è³‡æ–™èˆ‡ä¸€çµ„ JWT tokenã€‚ï¼ˆå¯¦ä½œç¯„ä¾‹å¯åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼‰\næ¥è‘— client æœƒå°‡ token å‚³çµ¦æˆ‘å€‘çš„å¾Œç«¯ serverï¼Œå¾Œç«¯éœ€è¦é©—è­‰ token æ˜¯å¦åˆæ³•ã€‚\né‡é»å°±åœ¨æ–¼å¾Œç«¯é©—è­‰ token é€™æ®µï¼Œå®˜æ–¹æ–‡ä»¶éå¸¸ç°¡æ˜æ¦‚è¦ï¼Œä¸¦æ²’æœ‰é™„ä¸Šå¯¦ä½œç¯„ä¾‹ã€‚æ‰€ä»¥ç‰¹æ­¤ç´€éŒ„ä¸€ä¸‹è¸©å‘éç¨‹ã€‚\nå¦‚ä½•é©—è­‰ JWT Token é¦–å…ˆï¼Œæ–‡ä»¶è¦æˆ‘å€‘ç¢ºèªä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š\n1. That the JWT is well formed token é ˆç‚ºåˆæ³•çš„ JWT tokenã€‚ä¹Ÿå°±æ˜¯åŒ…å«ä¸€çµ„ç”¨ Base64Url-encoded çš„ header, payload, signatureï¼Œæ¯å€‹éƒ¨åˆ†è§£ç¢¼å¾Œéƒ½å¿…é ˆç‚ºåˆæ³•çš„ json æ ¼å¼ã€‚\n2. The signature è§£ç¢¼å¾Œçš„ signature éƒ¨åˆ†éœ€è¦å’Œä»¥ä¸‹æ­¥é©Ÿç”¢ç”Ÿçš„çµæœç›¸åŒï¼š\nè—‰ç”±å‘¼å« JWKS endpoint å–å¾—ä¸€çµ„ public key\næ‰“ JWKS endpoint æœƒå¾—åˆ°ä¸€å€‹ json ç‰©ä»¶ï¼Œå›å‚³å¤šçµ„ pub keyï¼š\n1 2 3 4 5 6 7 8 9 10 \u0026#34;keys\u0026#34;: [ { \u0026#34;kid\u0026#34;: \u0026#34;d458ab5237807dc6718901e522cebcd8e8157791\u0026#34;, \u0026#34;kty\u0026#34;: \u0026#34;RSA\u0026#34;, \u0026#34;alg\u0026#34;: \u0026#34;RS256\u0026#34;, \u0026#34;use\u0026#34;: \u0026#34;sig\u0026#34;, \u0026#34;n\u0026#34;: \u0026#34;uPyWMhNfNsO9EtiraYI0tr78vnkiJmzsmAAUd8hLHF5vPXDn683aQKZQ2Ny5lObigNmbHI5tt5y0o5m0RuZjJTj081uWm7Z901boO-p4VLwEONzjh4vTp2ZQ7aMjo17kMBzInHqz9iruWeB94dEu_LKYdQnDI6rweD_-chWWTR4mc7xbeaNozLHYzjEisSrIM3xIry2lZv5Mh334ZoahcTXGouFtU2XV_HvStXthwhoAtizQK7s2yJlBz8qlQK2lFNojRzd95f2bkynRnIvcpoF-qHZbOBTCIf-6TLp23qShs-XvbCkwHMhzvCPxcuZx3GNfCQkyTxeM5IGIMlWZ8w\u0026#34;, \u0026#34;e\u0026#34;: \u0026#34;AQAB\u0026#34; }, ... è€Œè¦ä½¿ç”¨å“ªä¸€çµ„ keyï¼Œéœ€è¦ç”¨è§£ç¢¼çš„ header ç•¶ä¸­æ‰€å¸¶çš„ä¸€å€‹å±¬æ€§ kid å»æ¯”å°ï¼Œæ‰¾å‡ºç›¸åŒ kid çš„é‚£æŠŠ keyã€‚\nä½¿ç”¨è§£ç¢¼å¾Œçš„ header ç•¶ä¸­æŒ‡å®šçš„æ¼”ç®—æ³•(æ¬„ä½ï¼š alg)ä»¥åŠä¸Šè¿°çš„ public key å° Base64Url-encoded çš„ header è·Ÿ payload é€£æ¥çš„å€¼(Base64url-encoded header + \u0026quot;.\u0026quot; + Base64url-encoded payload) åŠ å¯†è™•ç†å¾Œçš„çµæœé€²è¡Œ Base64url-encodeã€‚\n3. The standard claims æª¢æŸ¥è§£ç¢¼å¾Œçš„ payload å¹¾å€‹å±¬æ€§å€¼æ˜¯å¦ç¬¦åˆé æœŸï¼š\næª¢æŸ¥ token æœ‰ç„¡éæœŸï¼ˆæ¬„ä½ï¼š expï¼‰\nToken issuer æ˜¯å¦æ­£ç¢ºï¼ˆæ¬„ä½ï¼š iss ï¼‰\næ–‡ä»¶ä¸Šæ²’æœ‰èªªæ˜ issuer çš„å€¼ç‚ºä½•ï¼ˆç…§ç†ä¾†èªªæœƒæ˜¯ Facebook çš„æŸå€‹ç¶²åŸŸæˆ–ç«¯é»ï¼‰ï¼Œå¾Œä¾†æ˜¯åœ¨æŸç¯‡è¨è«–ä¸²ç•¶ä¸­æ‰¾åˆ°ï¼Œåœ¨é™åˆ¶ç™»å…¥çš„ OIDC æ¬Šæ–çš„ OIDC ç«¯é» \u0026gt; æ¢ç´¢ç«¯é» è£¡é¢ï¼š\n1 2 3 4 { \u0026#34;issuer\u0026#34;: \u0026#34;https://www.facebook.com\u0026#34;, //... } Audience æ˜¯å¦èˆ‡ FB App ID ç›¸åŒ ï¼ˆæ¬„ä½ï¼š aud ï¼‰\nApp ID å¯ä»¥åˆ° Facebook developer å¾Œå°æŸ¥çœ‹\nNonce æ˜¯å¦æ­£ç¢ºï¼ˆæ¬„ä½ï¼š nonce ï¼‰\nå°±æ˜¯ä¸Šé¢å‰ç«¯å‚³çµ¦ FB ç”¢ token æ™‚å¸¶çš„äº‚æ•¸ï¼Œå‰ç«¯åœ¨ç™¼ request çµ¦å¾Œç«¯æ™‚éœ€ä¸€ä½µæ”œå¸¶éä¾†ã€‚ï¼ˆå¾Œç«¯æ‰èƒ½é©—è­‰ payload ç•¶ä¸­çš„ nonce æ˜¯å¦èˆ‡ä¹‹ç›¸åŒï¼‰\nå¯¦ä½œ ä»¥ä¸Šè§£æ JWT token èˆ‡é©—è­‰ signature çš„éƒ¨åˆ†éƒ½æœ‰ç¾æˆçš„ JWT å¥—ä»¶å¯ä»¥æ›¿æˆ‘å€‘å®Œæˆï¼Œåœ¨é€™é‚Šä½¿ç”¨ golang æ­é…ä»¥ä¸‹å…©å€‹å¥—ä»¶ä¾†å¯¦ä½œï¼š\ngolang-jwt/jwt/v5ï¼šè§£æ JWT token èˆ‡é©—è­‰ signature lestrrat-go/jwx/jwkï¼šè§£æ JWKS public key é¦–å…ˆå®šç¾© structs æ¥æ”¶éœ€è¦çš„è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 type ( Auth struct { JWTToken string Nonce string APIHost string AppID string JWKSEndpoint string Client *http.Client } // æª¢æŸ¥ token æœ‰ç„¡éæœŸã€é©—è­‰ issuer èˆ‡ audience éƒ½æ˜¯å±¬æ–¼ JWT è¦ç¯„ä¸­å®šç¾©çš„ä¸€äº›å¸¸è¦‹è²æ˜ // å¯ä»¥ä½¿ç”¨ jwt.RegisteredClaims å³å¯ // ä½†å› ç‚ºæˆ‘å€‘æœ‰æ”œå¸¶ `Nonce`ï¼Œç‚º FB è‡ªå®šç¾©çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¨‚ Claim ClientClaims struct { jwt.RegisteredClaims Nonce string `json:\u0026#34;nonce\u0026#34;` } ) func NewFBAuth(jwtToken, nonce string) *Auth { return \u0026amp;Auth{ JWTToken: jwtToken, Nonce: nonce, //å±¬æ–¼æ•æ„Ÿè³‡è¨Šï¼Œä»¥ env config å½¢å¼å–å¾— APIHost: config.Config.FacebookAuth.APIHost, // é æœŸçš„ issuer å€¼ AppID: config.Config.FacebookAuth.AppID, // é æœŸçš„ audience å€¼ JWKSEndpoint: config.Config.FacebookAuth.JWKSEndpoint, Client: \u0026amp;http.Client{Timeout: 30 * time.Second}, } } æ¥è‘—å¯¦ä½œé©—è­‰æ–¹æ³•çš„éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 func (a *Auth) ValidateJWTToken() error { set, err := a.fetchPublicKeySet() // å–å¾— JWKS Public key if err != nil { return err } token, err := jwt.NewParser( // ä½¿ç”¨å¥—ä»¶å…§å»ºçš„ validator é©—è­‰æ¨™æº–è²æ˜çš„æ¬„ä½ jwt.WithExpirationRequired(), // æª¢æŸ¥ token æœ‰ç„¡éæœŸ jwt.WithIssuer(a.APIHost), // Token issuer æ˜¯å¦æ­£ç¢ºï¼ˆç­‰æ–¼ a.APIHostï¼‰ jwt.WithAudience(a.AppID), // Audience æ˜¯å¦æ­£ç¢ºï¼ˆç­‰æ–¼ a.AppIDï¼‰ ).ParseWithClaims(a.JWTToken, \u0026amp;ClientClaims{}, func(token *jwt.Token) (interface{}, error) { // å–å¾— header çš„ kid å€¼ï¼Œç”¨ä¾†å°‹æ‰¾ JWKS ç«¯é»å›å‚³ json ç•¶ä¸­åŒ¹é…çš„ pub key keyID, ok := token.Header[\u0026#34;kid\u0026#34;].(string) if !ok { return nil, errors.Str(\u0026#34;expecting JWT header to have string kid\u0026#34;) } keys := set.LookupKeyID(keyID) if len(keys) == 0 { return nil, errors.Str(\u0026#34;can not find kid\u0026#34;) } var key interface{} if err := keys[0].Raw(\u0026amp;key); err != nil { return nil, err } return key, nil }) if err != nil { return err } else if claims, ok := token.Claims.(*ClientClaims); ok { // ç”±æ–¼ Nonce ç‚ºè‡ªå®šç¾©çš„è²æ˜å±¬æ€§ï¼Œéœ€è¦é¡å¤–æ‰‹å‹•é©—è­‰ if claims.Nonce != a.Nonce { return errors.Errorf(\u0026#34;nonce mismatch: %s != %s\u0026#34;, claims.Nonce, a.Nonce) } } else { return errors.Errorf(\u0026#34;expecting *ClientClaims, got %T\u0026#34;, token.Claims) } return nil } func (a *Auth) fetchPublicKeySet() (*jwk.Set, error) { resp, err := a.Client.Get(a.JWKSEndpoint) if err != nil { return nil, err } respBody, err := io.ReadAll(resp.Body) if err != nil { return nil, err } defer resp.Body.Close() return jwk.ParseBytes(respBody) } é©—è­‰æˆåŠŸå³å¯å‘å‰ç«¯å›å‚³ä½¿ç”¨è€…ç™»å…¥æˆåŠŸã€‚\nç¢ç¢å¿µ çŒœæ¸¬æ˜¯å› ç‚ºå¾Œç«¯èªè¨€å¤ªå¤šï¼Œå„èªè¨€ä¹Ÿéƒ½æœ‰è‡ªå·±çš„ jwt å¥—ä»¶ï¼Œæ‰€ä»¥å®˜æ–¹æ‰æ²’æœ‰æ”¾é©—è­‰ Token çš„å¯¦ä½œç¯„ä¾‹ï¼Œä½†åƒä¸Šé¢æåˆ°çš„ kidã€issuer æ‡‰è©²å¯ä»¥èªªæ˜æ›´æ¸…æ¥šä¸€é»ã€‚ä¸éä¹Ÿç®—æ˜¯è—‰æ©Ÿå­¸ç¿’äº†ï¼Œæ„Ÿè¬ Facebookã€‚ï¼ˆï¼Ÿï¼‰\n","date":"May 19","permalink":"//localhost:1313/posts/validate-facebook-limited-login-jwt-token/","tags":["Golang","Third-Party Integration"],"title":"Validate Facebook Limited Login JWT Token in Golang"},{"categories":null,"contents":" å‰è¨€ å¾å»å¹´å…«æœˆå·¦å³é–‹å§‹åƒåŠ ä¸€å ‚æ°´çƒè»Ÿé«”å­¸é™¢æ‰€é–‹è¨­çš„ã€Œç²¾é€šè»Ÿé«”è¨­è¨ˆæ¨¡å¼ä¹‹æ—…ã€ç·šä¸Šèª²ç¨‹ï¼Œè‡³ä»Šä¹Ÿç®—æ˜¯å®Œæˆäº†ä¸€å€‹é‡Œç¨‹ç¢‘ï¼Œæƒ³èªªæ˜¯æ™‚å€™å¯ä»¥ä¾†åˆ†äº«ä¸€ä¸‹å¾åƒåŠ æ—…ç¨‹è‡³ä»Šçš„é»é»æ»´æ»´ï¼Œå¾åƒåŠ å‹•æ©Ÿã€èª²ç¨‹é«”é©—åˆ°å­¸ç¿’å¿ƒå¾—ï¼Œç®—æ˜¯ç‚ºè‡ªå·±é€™æ®µå­¸ç¿’åšä¸€å€‹å›é¡§æ€§çš„ç´€éŒ„ã€‚\nåƒåŠ å‹•æ©Ÿèˆ‡èª²ç¨‹é«”é©— å¤§æ¦‚åœ¨ä¸€å¹´å¤šå‰å¾ç¶²è·¯ç¤¾ç¾¤ä¸Šé¢å¾—çŸ¥æœ‰é€™æ¨£ä¸€å€‹èª²ç¨‹æº–å‚™å±•é–‹ï¼Œä½†é‚£æ™‚å€™é‚„åªæœ‰æ¨å‡ºã€Œå…è²»è©¦åƒã€èª²ç¨‹ï¼Œå¡«å¯«è¡¨å–®å°±å¯ä»¥æ’éšŠæŠ½ç±¤ï¼ŒæŠ½ä¸­çš„æ‰æœ‰åƒåŠ è©¦åƒèª²ç¨‹çš„è³‡æ ¼ã€‚çµæœä¸€ç›´æ²’è¢«æŠ½ä¸­ï¼Œå¾Œä¾†çµ‚æ–¼ç­‰åˆ°äº†ç¬¬ä¸€æ¢¯æ¬¡æ­£å¼æ”¶è²»çš„èª²ç¨‹é–‹è·‘å°±ç›´æ¥å ±åäº†ã€‚æ‰€ä»¥ç•¶åˆåˆ°åº•æ˜¯ä»€éº¼å¸å¼•äº†æˆ‘ï¼Œè®“æˆ‘é€™éº¼æƒ³å ±åé€™å€‹èª²ç¨‹å‘¢ï¼Ÿ\nè¡è‘—è€å¸«å’ŒæŒ‘æˆ°é¡Œè€Œä¾† å…¶å¯¦åœ¨æ¥è§¸èª²ç¨‹ä¹‹å‰ï¼Œå°±æ›¾ç¶“åœ¨èª²ç¨‹è€å¸«æ°´çƒæ½˜çš„ YouTube é »é“çœ‹éä»–è¬›è§£çš„è¨­è¨ˆæ¨¡å¼ä¹‹è·¯ç³»åˆ—å½±ç‰‡ï¼Œ ç•¶æ™‚ç¬¬ä¸€æ¬¡è¦ºå¾—å±…ç„¶æœ‰äººæœ‰è¾¦æ³•æŠŠè¨­è¨ˆæ¨¡å¼çš„æ¦‚å¿µè¬›è§£å¾—é€™éº¼æœ‰è¶£ï¼Œè®“äººæœƒæƒ³è¦åƒçœ‹åŠ‡ä¸€æ¨£ç¹¼çºŒè¿½ä¸‹å»ã€‚ä¸éå› ç‚ºè©²ç³»åˆ—å½±ç‰‡ä¼¼ä¹å› ç‚ºæ°´çƒæœ¬äººçš„èª²æ¥­å› ç´ æ‰€ä»¥å¾Œä¾†åœæ›´äº†ï¼Œè¦ºå¾—å¯æƒœä¹‹å¤–ï¼Œä¹Ÿåªèƒ½æœŸå¾…å“ªå¤©ä»–æœƒçªç„¶é–‹å§‹æ›´æ–°ã€‚çµæœå¾Œä¾†åœ¨ç¤¾ç¾¤çœ‹åˆ°ä»–æœ¬äººç™¼æ–‡æ¨å‡ºæ–°èª²ç¨‹æ™‚ï¼ŒçœŸçš„æ˜¯å°±åƒæ˜¯è¿½è¨±ä¹…çš„ YT æ²ˆå¯‚ä¸€é™£å­å¾Œçªç„¶å¾©å‡ºä¸€æ¨£çš„é©šå–œï¼\næ­¤å¤–ï¼Œèª²ç¨‹ä¸­é™¤äº†æ•™å­¸å½±ç‰‡ï¼Œé‚„åŒ…å«è¨±å¤šå¯¦æˆ°é¡Œä½œæ¥­ã€‚å°æˆ‘ä¾†èªªï¼Œé€™ä¸€é»çœŸçš„æ˜¯ä¸€å€‹å¾ˆå¤§çš„å¸å¼•åŠ›ã€‚åœ¨è‡ªå·²éå»çš„è»Ÿé«”é–‹ç™¼ç¶“æ­·ä¸­ï¼Œå¾ˆå¤šæ™‚å€™å¹¾ä¹æ˜¯é€éå‹•æ‰‹å¯¦ä½œæ‰çœŸæ­£ç†è§£ä¸€å€‹æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘èªç‚ºå¯¦ä½œåœ¨å­¸ç¿’è»Ÿé«”é–‹ç™¼ç›¸é—œæŠ€èƒ½æ™‚æ˜¯å¾ˆé‡è¦çš„ä¸€ç’°ã€‚ åŒæ™‚ï¼Œç”±æ–¼ä»¥å¾€å°è¨­è¨ˆæ¨¡å¼çš„ç†è§£å¯ä»¥èªªåƒ…æ­¢æ–¼çŸ¥é“å¹¾å€‹åè©ï¼Œé›–ç„¶æ›¾çœ‹éç›¸é—œæ›¸ç±ï¼Œä½†å› ç‚ºå¹³å¸¸ä¹Ÿæ²’æœ‰ä»€éº¼æ‡‰ç”¨å ´æ™¯æˆ–å¯¦ä½œçš„æ©Ÿæœƒï¼Œè¦ºå¾—æ˜¯æ™‚å€™è©²æŠŠé€™å¡Šè£œèµ·ä¾†ã€‚\næ—…ç¨‹ä¸­ä¸éŒ¯çš„æœå‹™ å¦å¤–é‚„æœ‰ä¸€äº›æ—…ç¨‹æ‰€æä¾›çš„æœå‹™ï¼Œæ˜¯æˆ‘åœ¨æ—…ç¨‹ç•¶ä¸­é€æ¼¸é«”æœƒåˆ°ä¹Ÿå¾ˆé‡è¦çš„éƒ¨åˆ†ï¼š\nå”åŠ©æª¢é©—å­¸ç¿’æˆæœ è¼¸å‡ºçš„çµæœï¼Œå¾€å¾€ä¹Ÿéœ€è¦ç¶“éæª¢é©—ï¼Œæ‰èƒ½ç¢ºä¿æœ‰å¸æ”¶åˆ°æ­£ç¢ºçš„çŸ¥è­˜ã€‚èª²ç¨‹ç•¶ä¸­æœƒå®‰æ’æ¯é€±å›ºå®šæ™‚é–“çš„ã€ŒTA Hourã€ä¾†é‡å°ä½œæ¥­é€²è¡Œ Code Reviewï¼Œé™¤äº†æª¢è¨ä½œæ¥­ä¹‹å¤–ï¼Œè‹¥éç¨‹ä¸­æœ‰é‡åˆ°ä»€éº¼å•é¡Œæˆ–å›°é›£ï¼Œéƒ½èƒ½å¤ åœ¨ TA Hour ä¸­æå‡ºï¼Œä¸¦å¾—åˆ°ç«‹å³çš„åé¥‹ã€‚\næ´»èºçš„å­¸ç¿’ç¤¾ç¾¤ ä»¥å¾€åƒåŠ éæŸäº›ç·šä¸Šèª²ç¨‹ï¼Œæœ‰çš„ä¹Ÿæ˜¯æœƒä¸»æ‰“å¡‘é€ å­¸ç¿’ç¤¾ç¾¤ï¼Œä½†å¯èƒ½å‰›å¥½æˆ‘åƒåŠ éçš„èª²ç¨‹åœ¨é€™éƒ¨åˆ†éƒ½è·Ÿæƒ³åƒä¸­æœ‰å·®è·ï¼Œå­¸å“¡ä¹‹é–“å¯¦éš›ä¸Šä¸¦ä¸æœƒæœ‰å¤ªå¤šäº’å‹•ï¼Œå› æ­¤ä¸€é–‹å§‹å°æ–¼é€™éƒ¨åˆ†æ²’æœ‰æŠ±å¤ªå¤§æœŸå¾…ã€‚åˆæœŸä¹ŸçœŸçš„å¹¾ä¹æ˜¯å–®æ‰“ç¨é¬¥ï¼Œé ‚å¤šæœ‰æ™‚å€™æœ‰å•é¡Œåœ¨ç¾¤çµ„ç™¼å•ï¼Œæœ‰æ»¿å¤šç†±å¿ƒå¤§å¤§æœƒå›æ‡‰ï¼Œä½†æ­¤æ™‚çš„äº’å‹•æ€§ä¹Ÿä¸é«˜ï¼ˆå°æ–¼ä¸€å€‹å®³ç¾å…§å‘çš„äººï¼ˆæœƒè¢«æ‰“ã„‡ï¼Œæ‡‰è©²ä¸æœƒå§é€™æ˜¯æˆ‘çš„éƒ¨è½æ ¼æ¬¸ï¼‰ä¾†èªªï¼Œä¸ç®—æ˜¯å€‹èƒ½å¾ˆè‡ªåœ¨çš„ç™¼è¨€çš„å ´æ‰€ï¼‰ã€‚ä½†å¾Œä¾†æ¨å‡ºäº†æ‰€è¬‚çš„ã€Œå…¬æœƒç³»çµ±ã€ï¼Œè®“å­¸å“¡ï¼ˆåœ¨æ—…ç¨‹ä¸­éƒ½ç¨±ç‚ºå†’éšªè€…ï¼‰èƒ½å¤ è‡ªç”±çµ„æˆå­¸ç¿’å°çµ„ï¼Œèƒ½å¤ å½¼æ­¤è¨è«–ä½œæ¥­æˆ–åˆ†äº«é€²åº¦ç­‰ç­‰ï¼Œæ–¼æ˜¯æˆ‘å°±é †å‹¢åŠ å…¥äº†å…¶ä¸­ä¸€å€‹å…¬æœƒï¼Œèªè­˜äº†å¥½å¹¾å€‹å²å®³çš„å¤¥ä¼´ï¼Œé€™æ‰çœŸçš„é«”æœƒåˆ°äº’ç›¸äº¤æµæˆé•·çš„æ„Ÿè¦ºï¼Œæœ‰äººä¸€èµ·å¯«ä½œæ¥­çœŸçš„æœƒæ¯”è¼ƒæœ‰å‹•åŠ›ï¼\nä»¥ä¸Šé€™å…©é»æˆ‘å¾Œä¾†æƒ³æƒ³çœŸçš„ç®—æ˜¯æ»¿é‡è¦è®“æˆ‘å¯ä»¥æŒçºŒèª²ç¨‹çš„éƒ¨åˆ†ï¼Œå› ç‚ºä»¥å‰å…©é»ï¼ˆ1.è€å¸«æ•™å­¸å“è³ªé«˜ 2.è±å¯Œçš„å¯¦ä½œç·´ç¿’ï¼‰ä¾†èªªï¼Œæˆ‘å°±æ›¾ç¶“ä¸Šé Berkeley ä¸€å€‹å¾ˆæœ‰åçš„ç·šä¸Šå…¬é–‹èª²ç¨‹ CS 61Bï¼Œå…§å®¹æ˜¯çœŸçš„éå¸¸å„ªè³ªï¼Œä¹Ÿæœ‰é…åˆå¤§é‡çš„ç·´ç¿’é¡Œï¼Œä½†æˆ‘æœ€å¾Œé‚„æ˜¯æ²’èƒ½å®Œèª²ï¼ˆå¤§æ¦‚ä¸Šåˆ°ä¸€åŠè€Œå·²ğŸ¥²ï¼‰ã€‚\nç•¶åˆæ²’æœ‰ç¹¼çºŒçš„ä¸»å› ç•¶ç„¶æ˜¯æˆ‘å°±æ‡¶å˜›ï¼Œä½†åˆ°äº†è»Ÿé«”è¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…ï¼Œå¤šäº†æœ‰äººå”åŠ© Code Review æª¢é©—å­¸ç¿’æˆæœï¼‹æœ‰åŒå„•èƒ½äº’ç›¸äº¤æµè¨è«–ï¼Œå±…ç„¶å¯ä»¥è®“æˆ‘é€™ç¨®æœƒåŠé€”æ”¾æ£„çš„äººç¹¼çºŒä¸Šèª²å¯«ä½œæ¥­ï¼Œå¯è¦‹é€™å…©é»çœŸçš„æ˜¯éå¸¸æœ‰å¹«åŠ©çš„ï¼\nå­¸ç¿’å¿ƒå¾— é‡æ–°èªè­˜ç‰©ä»¶å°å‘ï¼Œå¾ OOA é–‹å§‹ é€™é–€èª²é›–ç„¶ç¨±ä¹‹ç‚ºã€Œè¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…ã€ï¼Œä½†ä¸¦æ²’æœ‰åƒä¸€èˆ¬å¤§éƒ¨åˆ†æ›¸ç±æˆ–æ•™å­¸åŠˆé ­å°±æŠŠ GoF çš„ 23 å€‹è¨­è¨ˆæ¨¡å¼å…¨éƒ¨ä¸Ÿçµ¦æˆ‘å€‘ï¼Œåå€’æ˜¯å¾é‡æ–°èªè­˜ç‰©ä»¶å°å‘é–‹å§‹ï¼Œä»¥åŠé‡æ–°é‡æ¸…ã€Œç‰©ä»¶ã€å’Œã€Œé¡åˆ¥ã€çš„æ¦‚å¿µï¼Œé‚„æœ‰ã€Œé¡åˆ¥ã€ä¹‹é–“çš„é—œä¿‚ã€‚è€Œé€™ä¸€åˆ‡ï¼Œéƒ½æ˜¯ç‚ºäº†è¦å…ˆæ‰“å¥½åŸºæœ¬åŠŸï¼Œä¹Ÿå°±æ˜¯åœ¨åšè¨­è¨ˆä¹‹å‰çš„ç¬¬ä¸€æ­¥ï¼Œå…ˆå»ºç«‹å‡ºã€Œé ˜åŸŸæ¨¡å‹ã€ï¼Œå°‡ UML é¡åˆ¥åœ–ç•«å‡ºä¾†ï¼Œæ•æ‰å„å€‹ç‰©ä»¶/é¡åˆ¥çš„å±¬æ€§å’Œè¡Œç‚ºï¼Œä¸¦ä¸”æ¨™ç¤ºä»–å€‘ä¹‹é–“çš„é—œè¯ï¼Œè€Œé€™éšæ®µä¹Ÿç¨±ä¹‹ç‚º OOA(Object-Oriented Analysis)/ç‰©ä»¶å°å‘åˆ†æã€‚\nâ¬†ï¸é€²è¡Œ OOA ç¹ªè£½ UML é¡åˆ¥åœ–ï¼Œå°‡å„å€‹ç‰©ä»¶/é¡åˆ¥çš„å±¬æ€§å’Œè¡Œç‚ºå®šç¾©å‡ºä¾†ï¼Œä¸¦ä¸”æ¨™ç¤ºä»–å€‘ä¹‹é–“çš„é—œè¯\nOOA æ˜¯æ•´é–€èª²ç•¶ä¸­æœ€åŸºç¤ä¹Ÿæœ€é‡è¦çš„ä¸€æ­¥ï¼Œå› ç‚ºç•¶æœ‰äº† OOA æˆ‘å€‘æ‰èƒ½é€²è¡Œæ¥ä¸‹ä¾†çš„è¨­è¨ˆï¼Œä¹Ÿå°±æ˜¯ OOD(Object-Oriented Design)/ç‰©ä»¶å°å‘è¨­è¨ˆï¼Œè€Œé€™æ™‚æ‰æ˜¯è¨­è¨ˆæ¨¡å¼ã€Œå¯èƒ½ã€æœƒå‡ºå ´çš„æ™‚å€™ã€‚ç‚ºä»€éº¼é€™é‚Šæœƒèªªã€Œå¯èƒ½ã€ï¼Ÿå› ç‚ºè¨­è¨ˆæ¨¡å¼ä¸¦ä¸æ˜¯ç”Ÿä¾†å°±è®“ä½ æƒ³å¥—å°±å¥—çš„ï¼Œç•¶ç„¶é€™æ¨£ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œåªæ˜¯é€šå¸¸é€™ç¨®æ¯«ç„¡ç†ç”±å¥—ç”¨è¨­è¨ˆæ¨¡å¼çš„è¡Œç‚ºï¼Œé€šå¸¸æœƒè¢«èªç‚ºæ˜¯ã€Œéåº¦è¨­è¨ˆ/Over Designã€çš„ï¼Œä¹Ÿæ˜¯èª²ç¨‹ä¸­å¾ˆå¸¸å‘¼ç±²å¤§å®¶ä¸è¦ä¸€ä¸å°å¿ƒæˆç‚ºäº†è»Ÿé«”é…’é§•éåº¦è¨­è¨ˆå¸«ã€‚\nOOD è¨­è¨ˆè¦é»ï¼šè¦ºå¯Ÿ Forcesï¼Œå¾—å‡º Problemï¼Œæ‰¾åˆ° Pattern(Solution) å…ˆå›åˆ°ä¸€é–‹å§‹çš„å®šç¾©ï¼Œæ‰€è¬‚çš„æ¨¡å¼ï¼Œå°±æ˜¯ä¸€å¥—å¯ä»¥è§£æ±ºç‰¹å®šæƒ…å¢ƒåº•ä¸‹çš„å•é¡Œçš„æ–¹æ³•ï¼Œä¸”é€™å¥—æ–¹æ³•ç¶“éå‰äººåè¦†é©—è­‰ä¸¦è¢«å‚³æ‰¿ä¸‹ä¾†ï¼Œç™½è©±æ–‡å°±æ˜¯è§£æ±ºç‰¹å®šå•é¡Œçš„ä¸€å¥— SOPã€‚æ¯å€‹è¨­è¨ˆæ¨¡å¼èƒŒå¾Œéƒ½æ˜¯ç‚ºäº†è§£æ±ºæŸå€‹ ç‰¹å®šæƒ…å¢ƒ(Context)åº•ä¸‹çš„å•é¡Œ(Problem) è€Œç”Ÿï¼Œæ‰€ä»¥èªªå‡ä½¿å•é¡Œä¸å­˜åœ¨ï¼Œé‚£éº¼ä¹Ÿå°±æ²’æœ‰å¥—ç”¨è¨­è¨ˆçš„å¿…è¦ã€‚å¦‚æœå†å°‡é€™äº›æ‰€è¬‚çš„å•é¡Œä¸€ä¸€æ”¤é–‹ä¾†çœ‹ï¼Œæœƒç™¼ç¾å…¶å¯¦æ­£æ˜¯å› ç‚ºä¸€é“é“ Forces å½¼æ­¤ç›¸äº’è¡çªï¼Œé€²è€Œè®“å•é¡Œå‘¼ä¹‹æ¬²å‡ºï¼Œæ­¤æ™‚æ‰æœƒéœ€è¦é€éç‰¹å®šæ¨¡å¼(Pattern)çš„ Form ä¾†è§£æ±ºå•é¡Œâ€”â€”æ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆ(Solution)ï¼Œæœ€å¾Œå¾—åˆ°å¥—ç”¨æ¨¡å¼ä¹‹å¾Œçš„çµæœ(Resulting Context)æˆåŠŸåŒ–è§£è¡çªçš„ Forcesã€‚\né€™è£¡æ‰€æŒ‡çš„ Forcesï¼Œèˆ‰ä¾‹ä¾†èªªåƒæ˜¯ã€Œæœªä¾†å¯èƒ½æœƒç¹¼çºŒæ“´å……æ–°çš„è¡Œç‚ºã€ã€ã€Œå°ç¨‹å¼ç¢¼ç¶­è­·æ€§çš„è¦æ±‚ã€ã€ã€Œé ˆæ»¿è¶³ç‰¹å®šçš„å•†æ¥­é‚è¼¯ã€ï¼Œæ¯ä¸€é …éƒ½æ˜¯ä¸€é“ Forceï¼Œè€Œå¤šé“ Forces è‹¥åŒæ™‚å­˜åœ¨åˆå½¼æ­¤äº’ç›¸è¡çªï¼Œå°±æœƒä»¤å·¥ç¨‹å¸«æ„Ÿå—åˆ°æ»¿æ»¿çš„å£“æŠ‘æ„Ÿã€‚\nâ¬†ï¸OODï¼šä»¥ç‚º OOA åŸºç¤ï¼Œå¯Ÿè¦ºå½¼æ­¤è¡çªçš„ Forces ä¹‹å¾Œå®šç¾©å‡º Problemï¼Œä¸¦æ‰¾åˆ° Problem å°æ‡‰çš„ Solutionï¼Œå¥—ç”¨ Pattern å¾Œçš„ Resultinng Context\nã€å¦‚æœæ²’æœ‰å¯Ÿè¦ºåˆ° Forcesï¼Œå°±èªªæ˜æ²’æœ‰è¨­è¨ˆé›£é¡Œ Problemï¼Œä¹Ÿå°±ä¸å¿…è¦è¨è«– Solutionï¼Œæ›´æ²’å¿…è¦æ€è€ƒ Patternã€‚ã€\nå”¯æœ‰ç²¾æº–çš„å¯Ÿè¦ºåˆ°æ¯ä¸€é“å½¼æ­¤è¡çªçš„ Forces å¾Œï¼Œæ‰èƒ½çœ‹å‡ºå•é¡Œæ‰€åœ¨ï¼Œå†å¾è…¦è¢‹ä¸­ç´¢å¼•è©²å•é¡Œé©åˆçš„è§£æ±ºæ–¹æ¡ˆï¼Œæœ€å¾Œä¸€æ­¥æ‰æ˜¯å¥—ç”¨è¨­è¨ˆæ¨¡å¼ã€‚æˆ‘èªç‚ºçœŸæ­£å›°é›£çš„é»éƒ½æ˜¯åœ¨å¯Ÿè¦º Forcesï¼Œå°¤å…¶åœ¨åšé­”ç‹é¡Œæ™‚ï¼Œå¶çˆ¾æœƒæœ‰æ„Ÿå—ä¸åˆ° Forces çš„ç‹€æ³ï¼Œé€™ç¨®æ™‚å€™é€šå¸¸éƒ½æ˜¯ç”±æ–¼æ²’æœ‰æŠŠéœ€æ±‚çœ‹ä»”ç´°ï¼Œä¹Ÿå°±æ˜¯åœ¨åš OOA æ™‚ï¼Œå¯èƒ½æ¼æ•æ‰äº†æŸäº›é‡è¦çš„å…ƒç´ æˆ–è¡Œç‚ºã€‚ä½†é€£ä½œæ¥­éƒ½æœƒæœ‰é€™ç¨®æƒ…æ³ç™¼ç”Ÿäº†ï¼Œæ›´ä½•æ³æ˜¯ç¾å¯¦çš„å•†æ¥­é–‹ç™¼ç’°å¢ƒï¼Œä½œæ¥­å› ç‚ºæ˜¯åˆ»æ„è¦è¨“ç·´æˆ‘å€‘ï¼Œä¸€å®šæœƒæš—è— Forcesï¼Œä¸”éœ€æ±‚èªªæ˜é€™éº½å®Œæ•´ï¼Œæˆ‘ç¡¬æ‰¾å‡ºä¾†å³å¯ï¼›ä½†ç¾å¯¦ç•¶ä¸­ï¼Œæˆ‘æ€éº¼å¯èƒ½çŸ¥é“å“ªäº›æ˜¯æš—è—çš„ï¼Ÿå¸¸å¸¸é€£éœ€æ±‚éƒ½ä¸æ¸…ä¸æ¥šäº†ã€‚ä¸éé€™ä¹Ÿä»£è¡¨å¯Ÿè¦º Forces çš„èƒ½åŠ›é‚„éœ€è¦æ›´é€²ä¸€æ­¥çš„æå‡ï¼Œåœ¨æœªä¾†é¢å°å¯¦éš›éœ€æ±‚æ™‚ï¼Œæ‰æ›´æœ‰å¯èƒ½æ´¾å¾—ä¸Šç”¨å ´ã€‚\nOOP å°±æ˜¯æŒ‰ç…§ OOAD è—åœ–æ–½å·¥ æœ€å¾Œï¼Œçµ‚æ–¼å¾—åˆ°äº†å®Œæˆ OOD çš„ UML é¡åˆ¥åœ–ç‰ˆæœ¬ï¼Œé€™æ™‚å€™æ‰çœŸçš„è¦é–‹å§‹å‹•æ‰‹å¯«ç¨‹å¼ï¼Œé€²å…¥ OOP(Object-oriented programming)/ç‰©ä»¶å°å‘ç¨‹å¼é–‹ç™¼çš„éšæ®µã€‚é€™æ™‚å€™åŸºæœ¬ä¸Šä¸ç®¡ä½¿ç”¨ä»€éº¼èªè¨€ï¼Œéƒ½å¯ä»¥ç…§è‘— OOD é€™å¼µè—åœ–ï¼Œå¿«é€Ÿåœ°å»å®Œæˆç¨‹å¼å¯¦ä½œçš„éƒ¨åˆ†ã€‚\næŒ‰ç…§é€™å€‹ SOP (OOA â†’ OOD â†’ OOP) é€²è¡Œå¹¾æ¬¡ä½œæ¥­ä¹‹å¾Œï¼Œæ˜é¡¯æ„Ÿå—åˆ°å¤§å¤šæ•¸æ€è€ƒç¨‹å¼æ¶æ§‹çš„éƒ¨åˆ†éƒ½æ˜¯åœ¨ OOA èˆ‡ OOD éšæ®µï¼Œè€Œé€²å…¥ OOP å¾Œï¼Œé€šå¸¸éƒ½æ˜¯é–‹å§‹é€²å…¥ç¢¼è¾²æ¨¡å¼ï¼ˆé™¤äº†ä¸€äº›æ¯”è¼ƒè¤‡é›œçš„é¡Œç›®ï¼Œè¦å¯¦ç¾ç‰¹å®šæ¼”ç®—æ³•æˆ–æ˜¯è™•ç†éåŒæ­¥æ©Ÿåˆ¶éœ€è¦æ¯”è¼ƒå¤šæ€è€ƒï¼‰ï¼Œå°±åƒå·¥äººä¾ç…§å»ºç¯‰è—åœ–å»æ–½å·¥ä¸€æ¨£ã€‚\næŒæ¡è»Ÿé«”è¨­è¨ˆç²¾é«“ï¼Œé¿å…éåº¦è¨­è¨ˆ æˆ‘æƒ³ OOAD çš„éƒ¨åˆ†ï¼Œæ­£æ˜¯è»Ÿé«”è¨­è¨ˆçš„ç²¾é«“æ‰€åœ¨ï¼Œé€™ä¹Ÿæ˜¯æˆ‘åœ¨éå¾€é–‹ç™¼ç¶“æ­·ä¸­å¹¾ä¹æ²’æœ‰åŸ¹é¤Šéçš„èƒ½åŠ›ï¼Œç•¢ç«Ÿè‡ªå·±å¹³å¸¸å·¥ä½œä¸Šå¤§å¤šæ˜¯ CRUDï¼Œæ‰‹é‚Šå¤§æ¦‚ 80% ä»¥ä¸Šçš„å·¥ä½œéƒ½æ˜¯é‹ç”¨æ¡†æ¶æˆ–å·¥å…·å³å¯è™•ç†çš„æ¥­å‹™éœ€æ±‚ï¼Œå¦‚æœç•¶åˆè¦å«æˆ‘å¯«ä¸€å€‹ Domain Logic éå¸¸è±å¯Œçš„å¡ç‰ŒéŠæˆ²ï¼Œæˆ‘å¯èƒ½æ ¹æœ¬å¯«ä¸å‡ºä¾†ã€‚è€Œæ—…ç¨‹ç•¶ä¸­å·²ç¶“å¯«éäº†æ¯”å¤§å°ã€å¤§è€äºŒå’Œ RPG éŠæˆ²ï¼Œæœªä¾†é‚„æœƒç¹¼çºŒæŒ‘æˆ°åˆ° IoC å®¹å™¨æ¡†æ¶ã€Web Framework ç­‰ç­‰é›£åº¦æ›´é€²éšçš„é¡Œç›®ï¼Œé›–ç„¶ä¸ç¢ºå®šè‡ªå·±èƒ½å¦èµ°åˆ°æœ€å¾Œä¸€é—œï¼ˆä½†é¡˜ï¼‰ï¼Œä¸éå¾ç¾å›é ­çœ‹ï¼Œè‡ªå·±çš„è»Ÿé«”è¨­è¨ˆæŠ€èƒ½å·²ç¶“æˆé•·äº†ä¸å°‘ã€‚\nä¸€é–‹å§‹çš„æˆ‘ç´”ç²¹åªæ˜¯æƒ³å­¸ç¿’å¦‚ä½•ä½¿ç”¨è¨­è¨ˆæ¨¡å¼ï¼Œå»å®Œå…¨å¿½ç•¥äº†ã€Œçˆ²ä»€éº¼è¦å­¸ç¿’/ä½¿ç”¨è¨­è¨ˆæ¨¡å¼ã€ï¼Œç›´æ¥åœ¨æ—…ç¨‹çš„ä¸€é–‹å§‹å°±è¢«é»å‡ºäº†è‡ªå·±å¾æœªæ€è€ƒéï¼Œå»éå¸¸æ ¸å¿ƒçš„å•é¡Œã€‚è¦æ˜¯æ²’æœ‰åƒåŠ æ—…ç¨‹ï¼Œæˆ‘å¯èƒ½å°±æœƒç¹¼çºŒç”¨ä»¥å¾€çš„æ€ç¶­ï¼Œåªæ˜¯å› ç‚ºç†Ÿæ‚‰æŸäº›è¨­è¨ˆæ¨¡å¼æˆ–å–®ç´”ç‚ºäº†ç‚«æŠ€è€Œå¥—æ¨¡å¼ã€‚è€Œå°±ä»¥ä¸€å€‹å¹³å¸¸å¤§å¤šæ•¸ä½¿ç”¨æ¡†æ¶å’Œå·¥å…·å°±èƒ½å®Œæˆæ—¥å¸¸ 80% å·¥ä½œçš„äººä¾†èªªï¼Œè¨­è¨ˆæ¨¡å¼ç¢ºå¯¦å¾ˆå°‘æ©Ÿæœƒæ´¾å¾—ä¸Šç”¨ä¸Šï¼ˆå¤§å¤šæ•¸æœƒä½¿ç”¨æ¨¡å¼çš„éƒ¨åˆ†ï¼Œæ¡†æ¶æˆ–å·¥å…·éƒ½å¹«æˆ‘å€‘åšæ‰äº†ï¼‰ï¼Œä½†æˆ‘èªç‚ºé€™è¶Ÿæ—…ç¨‹æ‰€å¸¶ä¾†æœ€å¤§çš„æ”¶ç©«å°±æ˜¯å°æ–¼ OOAD çš„æŒæ¡èƒ½åŠ›ï¼ŒåŒæ™‚åŸ¹é¤Šäº†è»Ÿé«”æ¶æ§‹æ€ç¶­ï¼Œæ‡‚å¾—å¦‚ä½•é¿å…éåº¦è¨­è¨ˆï¼Œå…‰é€™ä¸€é»å°±è®“æˆ‘è¦ºå¾—éå¸¸å€¼å¾—äº†ã€‚\n","date":"Aug 16","permalink":"//localhost:1313/posts/design-pattern-by-waterballsa-learning-experience/","tags":["Software Development"],"title":"åŸ¹é¤Šè»Ÿé«”æ¶æ§‹æ€ç¶­ï¼Œæ‹’çµ•éåº¦è¨­è¨ˆâ€”â€”è»Ÿé«”è¨­è¨ˆæ¨¡å¼ç²¾é€šä¹‹æ—…å¿ƒå¾—"},{"categories":null,"contents":" é¡Œç›®æ¦‚è¿° çµ¦å®šå…©å€‹å–®å‘ Linked List çš„ç¬¬ä¸€å€‹ç¯€é» (head)ï¼Œå…©å€‹ List å¯èƒ½æœƒåœ¨æŸå€‹ç¯€é»æœƒåˆæˆç‚ºä¸€å€‹ Listï¼Œè¦æ±‚æ‰¾å‡ºæœƒåˆç¯€é»ä¸¦å›å‚³ã€‚è‹¥å…©å€‹ List ä¸¦ç„¡æœƒåˆï¼Œå‰‡å›å‚³ nullã€‚\nå…¶ä¸­ï¼Œæœƒåˆç¯€é»å¿…é ˆæ˜¯æŒ‡å‘åŒä¸€å€‹å¯¦ä¾‹ï¼ˆæŒ‡æ¨™ï¼‰ï¼Œä¹Ÿå°±æ˜¯å³ä½¿å…©å€‹ç¯€é»çš„å€¼ç›¸åŒï¼Œä½†ç‚ºä¸åŒå¯¦ä¾‹ï¼Œä¸èƒ½ç®—æ˜¯æœƒåˆç¯€é»ã€‚\né¡Œç›®é€£çµ\nè§£æ³•ä¸€ï¼šHashMap ä¹Ÿæ˜¯ç¬¬ä¸€æ™‚é–“æƒ³åˆ°çš„æ–¹æ³•ï¼Œå…ˆéæ­·å…¶ä¸­ä¸€å€‹ Listï¼Œä½¿ç”¨ä¸€å€‹ Hashmap ç´€éŒ„ key ç‚ºå¯¦ä¾‹æŒ‡æ¨™ï¼Œå€¼ç‚ºç¯€é»çš„å€¼ï¼ˆå…¶å¯¦å€¼ç‚ºä½•ä¸¦ä¸é‡è¦ï¼‰ï¼Œæ¥è‘—å†éæ­·ç¬¬äºŒå€‹ Listï¼Œåˆ¤æ–·ç•¶å‰ç¯€é»æ˜¯å¦å­˜åœ¨æ–¼ map ç•¶ä¸­ï¼Œæœ‰çš„è©±å‰‡ç«‹å³è¿”å›ï¼Œéƒ½éæ­·å®Œçš„è©±ä»£è¡¨å…©å€‹ List ä¸¦ç„¡ç›¸åŒå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ä¸å­˜åœ¨æœƒåˆç¯€é»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func getIntersectionNode(headA, headB *ListNode) *ListNode { m1 := make(map[*ListNode]int) curA := headA for curA != nil { m1[curA] = curA.Val curA = curA.Next } curB := headB for curB != nil { if _, ok := m1[curB]; ok { return curB } curB = curB.Next } return nil } ä½†é€™å€‹æ–¹æ³•å…¶å¯¦æœƒéœ€è¦ O(n) çš„ç©ºé–“è¤‡é›œåº¦ï¼Œé›–ç„¶å¯ä»¥è¢« Acceptedï¼Œä½†ä¸¦éæœ€ä½³è§£ã€‚\nç„¡æ³•æ»¿è¶³ follow up è¦æ±‚ï¼šç©ºé–“è¤‡é›œåº¦ O(1)ï¼Œæ™‚é–“è¤‡é›œåº¦ O(m+n)\nè§£æ³•äºŒï¼šé›™æŒ‡é‡ é€å‡ºå¾Œæ»‘äº†ä¸€ä¸‹ Solutions ç•¶ä¸­å…¶ä»–å¼·è€…çš„è§£æ³•ï¼Œæ‰çœ‹åˆ°é€™å€‹è°æ˜çš„æ–¹æ³•ã€‚\né…ç½®å…©å€‹æŒ‡é‡ï¼Œéƒ½å„è‡ªå¾ List A å’Œ List B çš„ head é–‹å§‹ï¼ŒæŒ‡é‡1 å°‡ List A èµ°åˆ°åº•å¾Œæ¥è‘—èµ° List Bï¼ŒåŒæ™‚ï¼ŒæŒ‡é‡2 å°‡ List B èµ°åˆ°åº•å¾Œæ¥è‘—èµ° List Aã€‚çŸ­çš„ List æœƒè¢«å…ˆèµ°å®Œå°±æœƒæ›åˆ°é•·çš„ List å»ï¼Œè€Œé•·çš„ List èµ°å®Œä¹Ÿæœƒæ›åˆ°çŸ­ List å»èµ°ï¼Œæœ€çµ‚å…©å€‹æŒ‡é‡å°±æœƒèµ°åˆ°äº¤æœƒçš„ç¯€é»ä¸Šã€‚\nåšäº†å€‹ç°¡å–®çš„å‹•ç•«ï¼Œç›´æ¥çœ‹æ¯”è¼ƒæ¸…æ¥šï¼š\nä¸ç®¡æ˜¯å…ˆèµ°å®Œ A å†èµ° Bï¼Œé‚„æ˜¯å…ˆèµ°å®Œ B å†èµ° Aï¼Œç•¶èµ°åˆ°äº’æ› List é‚£é‚Šå»ä¹‹å¾Œï¼Œæœƒåœ¨é¢è‡¨äº¤æœƒé»ä¹‹å‰åŒæ­¥ï¼š\na1 â†’ a2 â†’ c1 â†’ c2 â†’ c3 â†’ null(aèµ°å®Œæ›b) â†’ b1 â†’ b2 â†’ b3 â†’ c1\nb1 â†’ b2 â†’ b3 â†’ c1 â†’ c2 â†’ c3 â†’ null(bèµ°å®Œæ›a) â†’ a1 â†’ a2 â†’ c1\nb3 çš„ next ç‚º c1 ï¼Œ a2 çš„ next ä¹Ÿç‚º c1 ï¼Œå¾—å‡ºäº¤æœƒé»ç‚º c1 ã€‚\né‚£å¦‚æœç•¶æ²’æœ‰äº¤æœƒé»çš„æ™‚å€™æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿç”¨åŒæ¨£çš„æ€è€ƒæ–¹å¼ä¾†çœ‹ï¼š\na1 â†’ a2 â†’ a3 â†’ a4 â†’ null(aèµ°å®Œæ›b) â†’ b1 â†’ b2 â†’ b3 â†’ null\nb1 â†’ b2 â†’ b3 â†’ null(bèµ°å®Œæ›a) â†’ a1 â†’ a2 â†’ a3 â†’ a4 â†’ null\nç”±æ–¼ b3 å’Œ a4 çš„ next éƒ½æ˜¯ nullï¼Œå¾—å‡ºäº¤æœƒé»ç‚º nullã€‚\nå¦‚æœList A å’Œ List B çš„é•·åº¦ç›¸åŒï¼Œå‰‡æ­¤è§£æ±ºæ–¹æ¡ˆå°‡åœ¨ä¸è¶…é1æ¬¡éæ­·çš„æƒ…æ³ä¸‹çµ‚æ­¢ï¼›å¦‚æœå…©å€‹ List çš„é•·åº¦ä¸åŒï¼Œå‰‡æ­¤è§£æ±ºæ–¹æ¡ˆå°‡åœ¨ä¸è¶…é2æ¬¡éæ­·çš„æƒ…æ³ä¸‹çµ‚æ­¢ \u0026ndash; åœ¨ç¬¬äºŒæ¬¡éæ­·ä¸­ï¼Œäº¤æ› A å’Œ B æœƒä½¿ A å’Œ B åœ¨ç¬¬äºŒæ¬¡éæ­·çµæŸå‰åŒæ­¥ã€‚åœ¨ç¬¬äºŒæ¬¡éæ­·ä¸­ï¼Œå®ƒå€‘éƒ½å…·æœ‰ç›¸åŒçš„å‰©é¤˜æ­¥é©Ÿï¼Œä»¥ç¢ºä¿å®ƒå€‘åŒæ™‚ï¼ˆå¾æŠ€è¡“ä¸Šä¾†èªªï¼Œæ˜¯åœ¨åŒä¸€æ¬¡è¿­ä»£ä¸­ï¼‰åˆ°é”ç¬¬ä¸€å€‹äº¤æœƒç¯€é»ï¼Œæˆ–è€…åŒæ™‚åˆ°é” nullã€‚ by Java solution without knowing the difference in len!\næœ€å¾Œçš„ codeï¼š\n1 2 3 4 5 6 7 8 class Solution: def getIntersectionNode(self, headA: ListNode, headB: ListNode) -\u0026gt; Optional[ListNode]: p1 = headA p2 = headB while(p1 != p2): p1 = headB if p1 is None else p1.next p2 = headA if p2 is None else p2.next return p1 Reference Java solution without knowing the difference in len!ï¼š é€™ç¯‡ Solution åº•ä¸‹æœ‰ä¸€å€‹ BryanBoCao å¤§å¤§çš„ï¼ˆæ‡‰è©²æ˜¯ç¬¬ä¸€å€‹ï¼‰ç•™è¨€ï¼Œç•¶ä¸­æœ‰è©³ç´°çš„åœ–è§£èªªæ˜ï¼Œéå¸¸æœ‰åŠ©æ–¼ç†è§£ã€‚ ","date":"Jul 31","permalink":"//localhost:1313/posts/leetcode-160-intersection-of-two-linked-lists/","tags":["Algorithm"],"title":"[leetcode ç­†è¨˜] 160.Â Intersection of Two Linked Lists"},{"categories":null,"contents":"æ¥çºŒä¸Šä¸€ç¯‡æ–‡ç« ï¼šGraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸Šï¼‰ã€‚\nåœ¨é€²å…¥åŸå§‹ç¢¼ä¹‹å‰ï¼Œå…ˆè¤‡ç¿’ä¸€ä¸‹ use caseã€‚é¦–å…ˆå¾ resolver é–‹å§‹çœ‹èµ·ï¼š\n1 2 3 4 5 // IconURL is the resolver for the icon_url field. func (r *roomFeatureResolver) IconURL(ctx context.Context, obj *model.RoomFeature) (*string, error) { f, _ := storage.GetFeature(ctx, *obj.ID) return f.IconUrl, nil } ç•¶ä¸­å‘¼å«äº†æˆ‘å€‘çš„è‡ªå®šç¾©æ–¹æ³• storage.GetFeatureï¼š\n1 2 3 4 5 6 7 func GetFeature(ctx context.Context, featureID int) (*model.RoomFeatureWithData, error) { //... thunk := loaders.FeatureLoader.Load(ctx, DataLoader.StringKey(fmt.Sprintf(\u0026#34;%d\u0026#34;, featureID))) result, err := thunk() //... return result.(*model.RoomFeatureWithData), nil } é‡é»å°±æ˜¯é€™è£¡ä½¿ç”¨åˆ°çš„ loaders.FeatureLoader.Load æ–¹æ³•ã€‚\nFeatureLoader é›–ç‚ºè‡ªå®šç¾©å±¬æ€§ï¼Œä½†æ˜¯é€é DataLoader å¥—ä»¶æä¾›çš„ *DataLoader.Loader å»ºæ§‹å­ DataLoader.NewBatchedLoader æ‰€å‰µå»ºå‡ºï¼Œæ‰€ä»¥æœ¬èº«å°±å…·å‚™äº† Load æ–¹æ³•ã€‚\nåœ¨æ·±å…¥æ¢ç©¶ Load æ–¹æ³•ä¹‹å‰ï¼Œå…ˆé‡æ¸…ä¸€ä¸‹é€™å€‹ GetFeature æ–¹æ³•ä»€éº¼æ™‚å€™æœƒè¢«åŸ·è¡Œåˆ°ã€‚å›åˆ°ä¸€é–‹å§‹çš„æ¡ˆä¾‹ï¼Œ ç•¶ Client é€²è¡Œå¦‚ä¸‹ Query æ™‚ï¼š\n1 2 3 4 5 6 7 8 9 10 query { content(hotel_id: 1) { rooms { features { id icon_url } } } } å¦‚æœæœ‰ n å€‹ roomsï¼Œæ¯å€‹ room æœ‰ m å€‹ featuresï¼Œç¸½å…±æœƒåŸ·è¡Œ n * m æ¬¡ IconURL ä¾†å–å¾—æ¯å€‹ feature çš„ icon URLï¼Œä¹Ÿå°±æ˜¯åŸ·è¡Œ m * n æ¬¡ GetFeatureã€‚è€Œåœ¨æ¯å€‹ GetFeature æ–¹æ³•ç•¶ä¸­åˆå‘¼å«äº† loaders.FeatureLoader.Load æ–¹æ³•ï¼Œé€éå›å‚³çš„å‡½æ•¸å–å¾— feature è³‡æ–™ã€‚\nå–®ç´”ä»¥ä½¿ç”¨ä¸Šçš„è§’åº¦ï¼Œå¯ä»¥æŠŠ Load æ–¹æ³•ç•¶æˆæ˜¯ä¸€å€‹é»‘ç›’å­ï¼Œç•¶æˆ‘å€‘å‘ä»–ç´¢å–éœ€è¦çš„è³‡æ–™æ™‚ï¼Œä»–å°±æœƒå›å‚³çµ¦æˆ‘å€‘ã€‚\næƒ³åƒå¦‚æœé€™äº›æ–¹æ³•éƒ½æ˜¯åŒæ­¥è¢«åŸ·è¡Œçš„ï¼Œå‡è¨­ç¬¬ä¸€æ¬¡å‚³å…¥ GetFeature çš„ feature id ç‚º 1ï¼Œæ­¤æ™‚è¦å‘ DataLoader å– id ç‚º 1 çš„ feature è³‡æ–™ï¼Œç…§ç†ä¾†èªªæ‡‰è©²é‚„æ²’æœ‰è¾¦æ³•å–å¾—ï¼Œå› ç‚ºé€™æ™‚å€™ DataLoader å°šæœªè’é›†åˆ°æ‰€æœ‰ rooms çš„ featuresï¼Œï¼ˆè¦æœé›†å®Œæ‰€æœ‰ id æ‰æœƒå‘è³‡æ–™åº«æŸ¥è©¢ï¼‰ï¼Œæ‰€ä»¥æ‡‰è©²æœƒæš«æ™‚ block ä½ï¼Œç­‰å¾…æ‰€æœ‰ id è’é›†å®Œå¾Œæ‰å–å¾—æ‰€æœ‰è³‡æ–™ï¼Œæ‰èƒ½å–å¾— id 1 çš„è³‡æ–™ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œé€™å€‹åŠŸèƒ½èƒŒå¾Œä¸€å®šæ˜¯æœ‰éåŒæ­¥çš„æ”¯æŒæ‰æœ‰å¯èƒ½è¾¦åˆ°ã€‚\næ‰€ä»¥åˆ°åº• DataLoader æ˜¯åœ¨ä»€éº¼æ™‚å€™è’é›†åˆ°æ‰€æœ‰ rooms çš„ features æ¯å€‹ id çš„ï¼Ÿåˆæ˜¯åœ¨ä»€éº¼æ™‚å€™å‘¼å«å‘è³‡æ–™åº«æŸ¥è©¢çš„æ–¹æ³•ï¼Ÿå°±ä¾†çœ‹çœ‹é€™å€‹ Load æ–¹æ³•åˆ°åº•åšäº†ä»€éº¼å§ï¼\nç„¶å¾Œå› ç‚ºé€™å€‹æ–¹æ³•æœ‰é»é•·ï¼Œæ‰€ä»¥æˆ‘æœƒæŒ‰ç…§é †åºåˆ†æ®µè²¼ä¸Šä¾†ï¼Œä½†ä¸æœƒå…¨éƒ¨è²¼ï¼Œæ¯”è¼ƒéæ ¸å¿ƒåŠŸèƒ½çš„éƒ¨åˆ†ä¹Ÿæœƒæš«æ™‚çœç•¥ã€‚æœ‰èˆˆè¶£çš„è®€è€…å¯ä»¥è‡ªè¡Œå»çœ‹åŸå§‹ç¢¼ã€‚\né¦–å…ˆå‰µå»ºä¸€å€‹æ¥æ”¶çµæœçš„ channelï¼Œä»¥åŠä¸€å€‹ result è®Šæ•¸ï¼Œæ¥è‘—è©¦åœ–åˆ° Loader çš„ cache ç•¶ä¸­å°‹æ‰¾ key å°æ‡‰çš„å€¼å­˜ä¸å­˜åœ¨ï¼Œæœ‰çš„è©±å°±ç›´æ¥è¿”å›å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 //github.com/graph-gophers/DataLoader@v5.0.0+incompatible/DataLoader.go func (l *Loader) Load(originalContext context.Context, key Key) Thunk { ctx, finish := l.tracer.TraceLoad(originalContext, key) c := make(chan *Result, 1) var result struct { mu sync.RWMutex value *Result } l.cacheLock.Lock() if v, ok := l.cache.Get(ctx, key); ok { defer finish(v) defer l.cacheLock.Unlock() return v } //...ä¸‹é¢çºŒ } è¿”å›å€¼æ˜¯ Thunk é¡å‹ï¼Œå…¶å¯¦å°±æ˜¯ä¸€å€‹é€™æ¨£å½¢ç‹€çš„ functionï¼š\n1 type Thunk func() (interface{}, error) æ¥è‘—ï¼Œç•¶åœ¨ cache ç•¶ä¸­æ‰¾ä¸åˆ°å°æ‡‰å€¼æ™‚ï¼Œå°±æ–°å»ºä¸€å€‹ thunk å‡½æ•¸ï¼Œç•¶ä¸­æœƒä½¿ç”¨ä¸Šé¢å»ºç«‹çš„ result è®Šæ•¸ï¼Œå¦‚æœ result è£¡çš„å€¼ç‚ºç©ºï¼Œå°±ä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰è³‡æ–™å‚³é€² channelï¼Œ ç„¶å¾Œå°‡ result çš„å€¼æ›´æ–°ç‚ºå‚³å…¥çš„ valueã€‚æœ€å¾Œå¯«å…¥ cacheã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (l *Loader) Load(originalContext context.Context, key Key) Thunk { // ...æ¥çºŒä¸Šé¢ thunk := func() (interface{}, error) { result.mu.RLock() //ä¸Šè®€é–ï¼Œé¿å…åœ¨è®€å–è³‡æ–™æ™‚ï¼ŒåŒæ™‚æœ‰å…¶ä»–ç·šç¨‹æƒ³æ›´æ–°è©²è³‡æ–™ resultNotSet := result.value == nil result.mu.RUnlock() // é‡‹æ”¾è®€é– if resultNotSet { result.mu.Lock() //ä¸Šç¨å é–ï¼Œé¿å…åœ¨æ›´æ–°è³‡æ–™æ™‚ï¼ŒåŒæ™‚æœ‰å…¶ä»–ç·šç¨‹æƒ³æ›´æ–°è©²è³‡æ–™ if v, ok := \u0026lt;-c; ok { // block ä½ç›´åˆ° c æœ‰ result å‚³å…¥ result.value = v } result.mu.Unlock() //é‡‹æ”¾ç¨ä½”é– } result.mu.RLock() defer result.mu.RUnlock() return result.value.Data, result.value.Error } defer finish(thunk) l.cache.Set(ctx, key, thunk) l.cacheLock.Unlock() //...ä¸‹é¢çºŒ } å†ä¾†ï¼Œæ–°å¢ä¸€å€‹ batchRequestï¼Œä¸¦æª¢æŸ¥ loader ç•¶ä¸­çš„ curBatcher å­˜åœ¨èˆ‡å¦ï¼Œä¸å­˜åœ¨å°±å‰µå»ºæ–°çš„ã€‚é€™å€‹ curBatcher å…§éƒ¨æœƒæœ‰åŸ·è¡Œè‡ªå®šç¾©æ–¹æ³•â€”â€”ä¹Ÿå°±æ˜¯åœ¨ NewBatchedLoader æ™‚å‚³å…¥çš„ featureReader.GetFeature æ–¹æ³•â€”â€”çš„é‚è¼¯ã€‚\næ¥è‘—å¦é–‹ä¸€å€‹ goroutine åŸ·è¡Œ curBatcher çš„ batch æ–¹æ³•ä¹‹å¾Œï¼Œåˆé–‹äº†ä¸€å€‹ goroutine åŸ·è¡Œ loader çš„ sleeper æ–¹æ³•ã€‚\nç„¶å¾ŒæŠŠ batchRequest å‚³å…¥åˆ°äº† curBatcher çš„ input channelï¼Œæœ€å¾Œå›å‚³ thunk å‡½æ•¸ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 type batchRequest struct { key Key channel chan *Result } type batcher struct { input chan *batchRequest batchFn BatchFunc //... } func (l *Loader) Load(originalContext context.Context, key Key) Thunk { //...æ¥çºŒä¸Šé¢ // req åŒ…å«äº†è¦æŸ¥è©¢çš„ key å’Œ ç­‰å¾…æ¥æ”¶çµæœçš„ channel req := \u0026amp;batchRequest{key, c} l.batchLock.Lock() if l.curBatcher == nil { l.curBatcher = l.newBatcher(l.silent, l.tracer) go l.curBatcher.batch(originalContext) l.endSleeper = make(chan bool) go l.sleeper(l.curBatcher, l.endSleeper) } l.curBatcher.input \u0026lt;- req // å¦‚æœæœ‰é¡å¤–è¨­å®š batchCapï¼Œå¯ä»¥é™åˆ¶ä¸€æ¬¡æœ€å¤šå¯ä»¥æ¥å—çš„ req æ•¸é‡ if l.batchCap \u0026gt; 0 { // ä½†æˆ‘å€‘ä¸¦æ²’æœ‰è¨­å®šï¼Œæ‰€ä»¥ batchCap ç‚º 0ï¼Œä¸æœƒé€²å…¥é€™é‚Š //... } l.batchLock.Unlock() return thunk } é€™æ™‚ï¼Œç™¼ç¾é‚è¼¯é€²åˆ°äº† curBatcher.batch æ–¹æ³•ç•¶ä¸­ï¼Œæ‰€ä»¥ç·Šæ¥è‘—ä¾†çœ‹é€™æ®µæ–¹æ³•ï¼š\né€ä¸€æ¥æ”¶ input çš„è³‡æ–™ä¹‹å¾Œï¼Œçµ‚æ–¼çœ‹åˆ°äº†åŸ·è¡Œ b.batchFn(ctx, keys) ä¹Ÿå°±æ˜¯æˆ‘å€‘è‡ªå®šç¾©çš„è³‡æ–™åº«æŸ¥è©¢æ–¹æ³•ï¼ ç„¶å¾Œå°±æ˜¯æŠŠæŸ¥è©¢åˆ°çš„è³‡æ–™ï¼Œä¾åºæ”¾å…¥æ¯å€‹ request çš„ channelï¼Œå†é—œé–‰ channelï¼Œå¦‚æ­¤ä¸€ä¾† thunk å‡½æ•¸ç•¶ä¸­ç­‰å¾…è©² channel å‚³å› result é‚£ä¸€è¡Œå°±æœƒå–å¾—å€¼è€Œç¹¼çºŒå¾€ä¸‹åŸ·è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (b *batcher) batch(originalContext context.Context) { var ( keys = make(Keys, 0) reqs = make([]*batchRequest, 0) items = make([]*Result, 0) panicErr interface{} ) // keys çš„é †åº ç­‰åŒ reqs çš„é †åº for item := range b.input { keys = append(keys, item.key) reqs = append(reqs, item) } ctx, finish := b.tracer.TraceBatch(originalContext, keys) defer finish(items) func() { // ... items = b.batchFn(ctx, keys) // åŸ·è¡Œè‡ªå®šç¾©çš„è³‡æ–™åº«æŸ¥è©¢æ–¹æ³• }() // ... // å› ç‚ºè‡ªå®šç¾©æ–¹æ³•ç•¶ä¸­ä¹Ÿæœ‰ä¾ç…§ keys çš„é †åºå›å‚³ resultï¼Œä¸” keys çš„é †åº ç­‰åŒ reqs çš„é †åº // æ‰€ä»¥é€™æ¨£æ”¾å…¥é †åºä¸æœƒäº‚ for i, req := range reqs { req.channel \u0026lt;- items[i] close(req.channel) } } ä½†æ˜¯åˆ¥å¿˜äº†ï¼Œb.input ä¹Ÿæ˜¯ä¸€å€‹ channelï¼Œé€™é‚Šåˆä½¿ç”¨äº† for..range èªæ³•ä¾†éæ­· channelï¼Œç…§ç†ä¾†èªªï¼Œé™¤éåˆ¥çš„ goroutine ç•¶ä¸­æœ‰æŠŠé€™å€‹ channel çµ¦é—œäº†ï¼Œå¦å‰‡æ‡‰è©²æœƒé€ æˆ deadlock æ‰å°ã€‚è€Œåœ¨å“ªè£¡æœƒå°‡ input é€™å€‹ channel é—œé–‰å‘¢ï¼Ÿ\nç¸½å…±æœ‰å…©å€‹åœ°æ–¹éƒ½åœ¨ Load æ–¹æ³•ç•¶ä¸­ï¼Œä¸€å€‹æ˜¯ç•¶ l.batchCap \u0026gt; 0 æ™‚ï¼Œå¦‚æœç¬¦åˆæŒ‡å®šæ¢ä»¶(åŸ·è¡Œçš„ req æ•¸é‡ç­‰æ–¼ batchCap æ•¸é‡æ™‚)ï¼Œæœƒå‘¼å« l.curBatcher.end() é—œé–‰ input chanã€‚\n1 2 3 4 5 6 7 8 if l.batchCap \u0026gt; 0 { //... if l.count == l.batchCap { l.curBatcher.end() // ç›´æ¥çµ‚æ­¢æ¥æ”¶ reqï¼Œä¸å†ç¹¼çºŒç­‰å¾… close(l.endSleeper) // é—œé–‰ç­‰å¾…ç‰¹å®šä¸€æ®µæ™‚é–“çš„ channel l.reset() } } å¦ä¸€å€‹æ˜¯ä½æ–¼ go l.sleeper(l.curBatcher, l.endSleeper) é€™ä¸€è¡Œï¼Œæ‰€ä»¥é‚„å¾—å†çœ‹ä¸€ä¸‹é€™å€‹æ–¹æ³•åšäº†ä»€éº¼æ‰è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (l *Loader) sleeper(b *batcher, close chan bool) { select { // åªæœ‰åœ¨ Load æ–¹æ³•ä¸­é€²å…¥ `l.batchCap \u0026gt; 0` çš„ if å€å¡Šæ™‚ï¼Œæœƒå° close channel å‚³é€è¨Šè™Ÿ // é€™é‚Šæ”¶åˆ°è¨Šè™Ÿè¡¨ç¤ºå·²ç¶“æå‰é—œé–‰äº† input channelï¼Œä¹Ÿä¸éœ€ç¹¼çºŒç­‰å¾…ä¸‹å» case \u0026lt;-close: return case \u0026lt;-time.After(l.wait): } l.batchLock.Lock() b.end() // \u0026lt;-----here //... } func (b *batcher) end() { if !b.finished { close(b.input) b.finished = true } } å¯ä»¥çœ‹åˆ°ï¼Œç•¶ç­‰å¾…æ™‚é–“ä¸€åˆ°(time.After(l.wait)æ”¶åˆ°è¨Šè™Ÿå¾Œ)ï¼Œå°±æœƒå¾€ä¸‹åŸ·è¡Œåˆ° b.end()ï¼Œä¹Ÿå°±æ˜¯é—œé–‰ input channel çš„æ–¹æ³•ï¼Œè€Œç­‰å¾…çš„æ™‚é–“ l.wait é è¨­å€¼æ˜¯ 16msï¼š\n1 2 3 4 5 6 7 8 func NewBatchedLoader(batchFn BatchFunc, opts ...Option) *Loader { loader := \u0026amp;Loader{ batchFn: batchFn, inputCap: 1000, wait: 16 * time.Millisecond, // \u0026lt;-----here } //... } ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœ loader çš„ input channel åœ¨ 16ms ä¹‹å¾Œéƒ½æ²’æœ‰å†æ”¶åˆ° request çš„è©±ï¼Œå°±æœƒè‡ªå‹•é—œé–‰äº†ã€‚\nç¸½çµ çœ‹å®Œä»¥ä¸Šçš„åŸå§‹ç¢¼ä¹‹å¾Œï¼Œç®—æ˜¯æ­é–‹äº† DataLoader çš„é»‘ç›’å­ï¼Œç†è§£äº†å®ƒçš„é‹ä½œåŸç†ã€‚æœ€å¾Œå†é‡é»æ•´ç†ä¸€ä¸‹ Dataloader é‹ä½œçš„æµç¨‹ï¼š\nç•¶ç¬¬ä¸€æ¬¡èª¿ç”¨ loader çš„ Load æ–¹æ³•æ™‚ï¼Œloader å…§éƒ¨æœƒé–‹å•Ÿä¸€å€‹ input channel ä¾†æ¥æ”¶æŸ¥è©¢è³‡æ–™çš„ requestï¼Œä¸¦é–‹å§‹ç­‰å¾… request å‚³å…¥ã€‚ æ¯æ¬¡èª¿ç”¨ Load æ–¹æ³•æ™‚ï¼Œéƒ½æœƒå»ºç«‹ä¸€å€‹ requestï¼ˆè£é¢åŒ…å« key å’Œä¸€å€‹æ¥æ”¶æŸ¥è©¢çµæœçš„ channelï¼‰ä¸¦å°‡å…¶å‚³å…¥ input channelã€‚ Load æ–¹æ³•è¿”å›ä¸€å€‹åŒ¿åå‡½æ•¸ï¼Œå‡½æ•¸å…§éƒ¨å¦‚æœæ²’æœ‰å¯ä»¥ç«‹å³è¿”å›çš„çµæœï¼Œæœƒè©¦åœ–å¾ request channel ä¸­å–å€¼ï¼Œå› æ­¤åœ¨å°šæœªæœ‰å€¼é€å…¥ channel ä¹‹å‰æœƒæš«æ™‚é˜»å¡ã€‚ loader çš„ input channel æœƒç­‰å¾…ä¸€æ®µæ™‚é–“ï¼ˆé è¨­ç‚º 16msï¼‰ï¼Œæ™‚é–“ä¸€åˆ°å°±é—œé–‰æ¥æ”¶ requestã€‚ï¼ˆå¦‚æœæœ‰è¨­å®šæ¥æ”¶ request çš„æœ€å¤§æ•¸é‡ï¼Œä¹Ÿæœ‰å¯èƒ½æå‰é—œé–‰ï¼‰ input channel é—œé–‰å¾Œï¼Œå°±æœƒå°‡æ‰€æœ‰æœé›†åˆ°çš„ request keys å‚³çµ¦è‡ªè¨‚æ‰¹æ¬¡è™•ç†æ–¹æ³•ï¼Œå–å¾—æ‰€æœ‰è³‡æ–™ï¼ˆç‚º key - value å½¢å¼ï¼‰ã€‚ è³‡æ–™è¼‰å…¥å®Œæˆå¾Œï¼Œå°‡é€™äº›è³‡æ–™ä¾ç…§ key æ¨é€²å°æ‡‰çš„ request channelï¼Œæ¥æ”¶åˆ°è©² channel å›å‚³å€¼çš„åŒ¿åå‡½æ•¸å°±æœƒåœæ­¢é˜»å¡ï¼Œå°‡çµæœç·©å­˜å¾Œï¼Œå›å‚³çµ¦ clientã€‚ ","date":"Jun 04","permalink":"//localhost:1313/posts/golang-graphql-dataloader-2/","tags":["GraphQL","Golang"],"title":"GraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸‹ï¼‰"},{"categories":null,"contents":" The Problem ä½¿ç”¨ GraphQL æ™‚ï¼Œé‡åˆ°ä»¥ä¸‹çš„æŸ¥è©¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 query { content(hotel_id: 1) { rooms { features { id icon_url text { zh_tw } } } } } åœ¨è³‡æ–™çš„é—œè¯ä¸Šï¼Œcontent åº•ä¸‹æœ‰è¨±å¤š roomsï¼Œæ¯å€‹ room åº•ä¸‹éƒ½æœ‰å¤šå€‹ featuresã€‚ä½†åœ¨è³‡æ–™è¡¨çµæ§‹ä¸Šï¼Œroom æœ‰ä¸€å€‹ content_id æ¬„ä½ï¼Œä»¥åŠä¸€å€‹ features æ¬„ä½ï¼Œè£é¢å„²å­˜äº†æ‰€æœ‰ features çš„ idã€‚\nè€Œç¾åœ¨ Client å¸Œæœ›ï¼Œç•¶ query features æ™‚å¦‚æœå¤¾å¸¶äº† icon_url æˆ– text æ¬„ä½ï¼Œserver å¿…é ˆå¤šå›å‚³ feature çš„é€™å…©å€‹æ¬„ä½ã€‚ä¹Ÿå°±æ˜¯åœ¨ room.feature çš„ resolver çš„é€™å…©å€‹æ–¹æ³•ç•¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 func (r *roomFeatureResolver) IconURL(ctx context.Context, obj *model.RoomFeature) (*string, error) { // maybe query feature data from DB by obj.id ...? return f.IconUrl, nil } func (r *roomFeatureResolver) Text(ctx context.Context, obj *model.RoomFeature) (*model.I18nString, error) { // maybe query feature data from DB by obj.id ...? return f.Text, nil } éƒ½éœ€è¦å‘ DB å–å¾— feature è³‡æ–™ã€‚\nä½†é€™éº¼ä¸€ä¾†ï¼Œåªè¦æœ‰ n å€‹ roomsï¼Œm å€‹ featureï¼Œå°±å¾— query n * m * 2(å–å¾— icon_url å’Œ text 2 å€‹æ¬„ä½) æ¬¡ï¼Œå—¯..éå¸¸ç†Ÿæ‚‰çš„ N+1 å•é¡Œã€‚ è¦è§£æ±ºé€™å€‹å•é¡Œï¼ŒGraphQL å®˜æ–¹æœ‰æä¾›ä¸€å€‹æ–¹æ³•ï¼Œé‚£å°±æ˜¯ä½¿ç”¨ DataLoaderã€‚\nä»€éº¼æ˜¯ Dataloaderï¼Ÿ DataLoader æ˜¯ GraphQL å®˜æ–¹æä¾›çš„ä¸€å€‹å¥—ä»¶ï¼Œä¸»è¦ç”¨æ–¼è§£æ±ºè³‡æ–™è¼‰å…¥æ™‚çš„æ•ˆèƒ½å•é¡Œã€‚é€éå°‡å¤šå€‹è«‹æ±‚æ”¶é›†åˆ°æ‰¹æ¬¡ä¸­ï¼Œç„¶å¾Œä¸€æ¬¡æ€§ç²å–çµæœï¼Œå¾è€Œæ¸›å°‘é‡è¤‡çš„æŸ¥è©¢æˆ–è¨ˆç®—ã€‚ å…·é«”è€Œè¨€ï¼ŒDataLoader æœ‰ä»¥ä¸‹ç‰¹é»ï¼š\nä»¥ä¸‹æ‰€æåˆ°çš„ã€Œè«‹æ±‚ã€éƒ½æ˜¯æŒ‡åœ¨åŒä¸€å€‹ API Request ç”Ÿå‘½é€±æœŸç•¶ä¸­ï¼Œå°åŒä¸€è³‡æ–™çš„è®€å–è«‹æ±‚ã€‚\næ‰¹æ¬¡è™•ç†ï¼šDataLoader æœƒå°‡ä¸€æ®µæ™‚é–“å…§æˆ–ä¸€å®šæ•¸é‡çš„è«‹æ±‚é€²è¡Œæ‰¹æ¬¡è™•ç†è¼‰å…¥æ•¸æ“šï¼Œä»¥æ¸›å°‘è³‡æ–™åº«çš„æŸ¥è©¢æ¬¡æ•¸å’Œè¨ˆç®—æˆæœ¬ã€‚\nç·©å­˜ï¼šDataLoader å…§éƒ¨ä½¿ç”¨ç·©å­˜æ©Ÿåˆ¶ï¼Œå°‡å·²ç¶“è¼‰å…¥çš„è³‡æ–™æš«å­˜åœ¨è¨˜æ†¶é«”ä¸­ã€‚ç•¶ä¸‹æ¬¡è«‹æ±‚éœ€è¦ç›¸åŒçš„è³‡æ–™æ™‚ï¼Œå¯ä»¥ç›´æ¥å¾ç·©å­˜ä¸­è¿”å›ï¼Œé¿å…å†æ¬¡æŸ¥è©¢è³‡æ–™åº«ã€‚(ä½†é€™äº›ç·©å­˜æ•¸æ“šåªæœƒå­˜åœ¨æ–¼åŒä¸€å€‹ API Request çš„ç”Ÿå‘½é€±æœŸç•¶ä¸­ï¼Œç•¶ Request çµæŸå¾Œå°±æœƒè¢«æ¸…é™¤)\né¿å…é‡è¤‡è¼‰å…¥ï¼šDataLoader æœƒç¢ºä¿åŒä¸€å€‹è³‡æ–™åªè¢«è¼‰å…¥ä¸€æ¬¡ï¼Œå³ä½¿åŒä¸€æ™‚é–“æœ‰å¤šå€‹è«‹æ±‚è¦æ±‚è¼‰å…¥ç›¸åŒçš„è³‡æ–™ï¼Œä¹ŸåªæœƒåŸ·è¡Œä¸€æ¬¡è¼‰å…¥æ“ä½œã€‚\nä½†å› ç‚ºå®˜æ–¹å¥—ä»¶åªæœ‰ nodejs ç‰ˆæœ¬ï¼Œå…¶ä»–èªè¨€çš„è©±å®˜æ–¹æ˜¯è¡¨ç¤ºç•™çµ¦é–‹ç™¼è€…å€‘è‡ªå·±å»å¯¦ç¾\u0026hellip;\n\u0026ldquo;DataLoader is provided so that it may be useful not just to build GraphQL services for Node.js but also as a publicly available reference implementation of this concept in the hopes that it can be ported to other languages.â€œ\nç•¶ç„¶ä½¿ç”¨ Golang çš„æˆ‘å€‘å¾ˆå¹¸é‹åœ°é‚„æ˜¯å¯ä»¥ç¹¼çºŒç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œåœ¨ gqlgenï¼ˆä¸€å€‹æä¾›å¿«é€Ÿæ­å»º GraphQL Server çš„å¥—ä»¶ï¼‰çš„æ–‡ä»¶ç•¶ä¸­ï¼Œå°±ç›´æ¥ç«¯å‡ºäº†é€™å€‹ Golang ç‰ˆæœ¬çš„å¥—ä»¶ï¼šgraph-gophers/DataLoaderã€‚æ‰€ä»¥ä¸‹æ‰€è¨è«–çš„ä½¿ç”¨æ–¹æ³•ä»¥åŠåŸå§‹ç¢¼ï¼Œéƒ½æ˜¯æœƒä»¥é€™å€‹å¥—ä»¶çš„å…§å®¹ç‚ºä¸»ã€‚\nä½¿ç”¨ Dataloader é‚£éº½å°±ä¾†é€é DataLoader å¯¦ç¾æˆ‘å€‘çš„éœ€æ±‚å§ï¼\né æœŸé”åˆ°çš„æ•ˆæœæ˜¯ï¼šå°‡ Query ç•¶ä¸­æ‰€æœ‰ rooms.features çš„ id éƒ½æœé›†èµ·ä¾†ï¼Œä¸€æ¬¡å‘è³‡æ–™åº«ç™¼é€æŸ¥è©¢ï¼Œå–å¾—æ‰€æœ‰ feature è³‡æ–™å¾Œï¼Œå°‡å…¶æš«å­˜åœ¨è¨˜æ†¶é«”ï¼Œç•¶éœ€è¦ç‰¹å®š id çš„ feature è³‡æ–™æ™‚ä¾¿å¾ä¸­å–å‡ºå›å‚³ã€‚\né›–ç„¶ä½¿ç”¨æ–¹å¼åœ¨å‰›å‰›æåˆ°çš„ gqlgen å®˜æ–¹æ–‡ä»¶æ‰€æä¾›çš„ç¯„ä¾‹ç•¶ä¸­éƒ½å·²ç¶“å¯«å¾—å¾ˆæ¸…æ¥šï¼Œä½†ä¸‹é¢é‚„æ˜¯æœƒå®Œæ•´å‘ˆç¾ï¼Œè£œå……ç•¶ä¸­å¹¾å€‹æ–¹æ³•è·Ÿåƒæ•¸çš„é—œä¿‚ï¼Œä»¥ä¾¿åœ¨å¾ŒçºŒçš„åŸå§‹ç¢¼é–±è®€ä¸­å¯ä»¥æ›´å®¹æ˜“ç†è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 // my_repo/graph/storage/storage.go package storage type ctxKey string const ( loadersKey = ctxKey(\u0026#34;dataloaders\u0026#34;) ) type FeatureReader struct { featureRepo model.FeatureRepository // å°‡å‘DBæŸ¥è©¢çš„éƒ¨åˆ†å°è£åˆ° Repository ç•¶ä¸­ } // å¯¦éš›ä¸Šæœƒè¢« dataloader æ‰€å‘¼å«ï¼Œç”¨ä¾†ä¸€æ¬¡å–å¾—æ‰€æœ‰ features çš„æ–¹æ³• // é€™é‚Šçš„åƒæ•¸ keys çš„ä¾†æºæ˜¯ä¸‹æ–¹å¦ä¸€å€‹åŒåçš„è‡ªå®šç¾©æ–¹æ³•ç•¶ä¸­ï¼Œå‘¼å«äº† dataloader çš„ Load æ–¹æ³• // è€Œ Load æ–¹æ³•éƒ½æœƒæ¥æ”¶ä¸€å€‹ key åƒæ•¸ // ç•¶æœé›†å®Œæˆæ‰€æœ‰çš„ keys å¾Œå°±æœƒè¢«å‚³é€²é€™é‚Šä¾† func (u *FeatureReader) GetFeature(ctx context.Context, keys dataloader.Keys) []*dataloader.Result { featuresIDs := make([]int, len(keys)) for ix, key := range keys { featureID, _ := strconv.Atoi(key.String()) featuresIDs[ix] = featureID } featuresById, err := u.featureRepo.GetFeaturesByIDs(ctx, featuresIDs) // å¯¦éš›å‘DBå–è³‡æ–™çš„æ–¹æ³• if err != nil { return nil } // å¿…é ˆå°‡è³‡æ–™çš„é †åºæŒ‰ç…§ keys çš„é †åºæ’åˆ— output := make([]*dataloader.Result, len(keys)) for index, featureKey := range keys { feature, ok := featuresById[featureKey.String()] if ok { output[index] = \u0026amp;dataloader.Result{Data: feature, Error: nil} } else { err := fmt.Errorf(\u0026#34;feature not found %s\u0026#34;, featureKey.String()) output[index] = \u0026amp;dataloader.Result{Data: nil, Error: err} } } return output } type Loaders struct { FeatureLoader *dataloader.Loader } // å¾…æœƒæœƒåœ¨ä¸»ç¨‹å¼è£é¢å‘¼å«ï¼Œå¯¦ä¾‹åŒ–æ‰€æœ‰ loaders ä»¥ä¾¿å‚³å…¥ middleware ç•¶ä¸­ func NewLoaders(MySqlFeatureRepository model.FeatureRepository) *Loaders { featureReader := \u0026amp;FeatureReader{ featureRepo: MySqlFeatureRepository, } loaders := \u0026amp;Loaders{ //æ–°å¢ä¸€å€‹ Loader ä¸¦å‚³å…¥è‡ªå®šç¾©çš„æ‰¹æ¬¡è™•ç†æ–¹æ³• FeatureLoader: dataloader.NewBatchedLoader(featureReader.GetFeature), } return loaders } // é€é middleware å°‡ loaders æ³¨å…¥åˆ° context è£é¢ // ä»¥åˆ©å…¶ä»–åœ°æ–¹å¯ä»¥é€éåŒä¸€å€‹ ctx ç‰©ä»¶å–å¾— loaderï¼ˆä¸€å€‹ API Request ç•¶ä¸­æœƒæœ‰ä¸€å€‹ ctx ç‰©ä»¶ï¼‰ func Middleware(loaders *Loaders, next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { nextCtx := context.WithValue(r.Context(), loadersKey, loaders) r = r.WithContext(nextCtx) next.ServeHTTP(w, r) }) } // å°‡ loaders å¾ context ç•¶ä¸­å–å‡ºçš„ helper method func For(ctx context.Context) *Loaders { return ctx.Value(loadersKey).(*Loaders) } // æœƒåœ¨ resolver ç•¶ä¸­è¢«å‘¼å«ï¼Œåªè¦å‚³å…¥ feature id å°±æœƒå›å‚³åœ¨ dataloader ç•¶ä¸­æº–å‚™å¥½çš„å°æ‡‰è³‡æ–™ func GetFeature(ctx context.Context, featureID int) (*model.RoomFeatureWithData, error) { loaders := For(ctx) // é€™é‚Šæ‰€å‚³å…¥ Load çš„ç¬¬äºŒå€‹åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è‡ªå®šç¾©æ–¹æ³• FeatureReader.GetFeature è¨»è§£ç•¶ä¸­æ‰€æåˆ° // æ¯å€‹å‚³é€² Load çš„ç¬¬äºŒå€‹åƒæ•¸ï¼Œä¹Ÿå°±æ˜¯ key // éƒ½æœƒè¢«æœé›†ä¸‹ä¾†ï¼Œç›´åˆ°æ‰€æœ‰ keys æœé›†å®Œç•¢å¾Œï¼Œå°±æœƒè§¸ç™¼ FeatureReader.GetFeature æ–¹æ³• // ä¸¦å°‡æ‰€æœ‰æœé›†çš„ keys å‚³å…¥è©²æ–¹æ³• thunk := loaders.FeatureLoader.Load(ctx, dataloader.StringKey(fmt.Sprintf(\u0026#34;%d\u0026#34;, featureID))) // ç•™æ„ key å¿…é ˆç‚ºå­—ä¸²é¡å‹ result, err := thunk() if err != nil { return nil, err } return result.(*model.RoomFeatureWithData), nil } æ¥è‘—ï¼Œåˆ° resolver ç•¶ä¸­ï¼Œå°‡å–å¾—è³‡æ–™çš„é‚è¼¯æ”¹æˆå‘¼å« stroage.GetFeature æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 func (r *roomFeatureResolver) IconURL(ctx context.Context, obj *model.RoomFeature) (*string, error) { f, _ := storage.GetFeature(ctx, *obj.ID) return f.IconUrl, nil } func (r *roomFeatureResolver) Text(ctx context.Context, obj *model.RoomFeature) (*model.I18nString, error) { f, _ := storage.GetFeature(ctx, *obj.ID) return f.Text, nil } ç„¶å¾Œåœ¨ä¸»ç¨‹å¼ç•¶ä¸­ï¼ˆæˆ–æ˜¯å®šç¾©è·¯ç”±çš„æª”æ¡ˆï¼‰ï¼ŒåŠ ä¸Š middlerwareï¼š\n1 2 3 4 router.Use(func(next http.Handler) http.Handler { // æ¯æ¬¡ request éƒ½æœ‰è‡ªå·±çš„ dataloader return storage.Middleware(storage.NewLoaders(featureRepo), next) }) è‡³æ­¤ï¼Œä¸ç®¡å¾€å¾Œç¸½å…±æœ‰å¹¾å€‹ featuresï¼Œéƒ½åªæœƒåŸ·è¡Œä¸€æ¬¡çš„è³‡æ–™åº«æŸ¥è©¢ï¼Œè§£æ±ºäº† N+1 å•é¡Œã€‚ ç¤™æ–¼ç¯‡å¹…æœ‰é»å¤ªé•·ï¼Œæƒ³èªªæ‹†æˆä¸Šä¸‹å…©ç¯‡æ¯”è¼ƒå¥½é–±è®€ï¼Œæ‰€ä»¥åˆ†æ Dataloader åŸå§‹ç¢¼çš„éƒ¨åˆ†ï¼Œå°±ç•™åˆ°ä¸‹ä¸€ç¯‡äº†ï½\n","date":"Jun 04","permalink":"//localhost:1313/posts/golang-graphql-dataloader-1/","tags":["GraphQL","Golang"],"title":"GraphQL Dataloader åœ¨ Golang ç•¶ä¸­çš„æ‰“é–‹æ–¹æ³•èˆ‡åŸç†è§£æï¼ˆä¸Šï¼‰"},{"categories":null,"contents":" å‰è¨€ ä¸Šä¸€ç¯‡æ–‡ç«  Golang è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦ ç•¶ä¸­æåˆ°äº†åœ¨ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«ä½œç‚ºæ¸¬è©¦è³‡æ–™åº«æ™‚ï¼Œé‚„å¯ä»¥ä½¿ç”¨ testcontainers è®“æˆ‘å€‘èƒ½å¤ åœ¨æ¸¬è©¦ç•¶ä¸­ç›´æ¥æ“ä½œ Docker Containerï¼Œå»å»ºç«‹æ¸¬è©¦æ™‚éœ€è¦çš„è³‡æ–™åº«ç’°å¢ƒã€‚é€™æ¨£ä¸€ä¾†ï¼Œä¹Ÿä¸ç”¨åƒä¸€é–‹å§‹é‚£æ¨£ï¼Œå¾—å¦å¤–æ‰‹å‹•é…ç½®ä¸€å€‹å°ˆé–€æ‹¿ä¾†è·‘æ¸¬è©¦ç”¨çš„è³‡æ–™åº«ï¼Œå°‡æ¸¬è©¦æ•´åˆåˆ° CI/CD æµç¨‹ä¸Šæ™‚ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ã€‚\nç„¶å¾Œæ‡‰è©²æ˜¯ä¸æœƒæœ‰ Part 3 å•¦ã€‚ Testcontainers ç°¡ä»‹ Testcontainers ç‚ºå¤šç¨®èªè¨€æä¾›å¥—ä»¶ï¼ˆGolangã€Javaã€Python ç­‰ç­‰ï¼‰ï¼Œé–‹ç™¼äººå“¡å¯ä»¥é€éè©²å¥—ä»¶æ‰€æä¾›çš„ APIï¼Œåœ¨ç¨‹å¼ç•¶ä¸­å»ºç«‹å’Œæ¸…é™¤åŸºæ–¼å®¹å™¨çš„ä¾è³´é …ï¼Œä»¥é€²è¡Œè‡ªå‹•åŒ–æ•´åˆæ¸¬è©¦ã€‚\næ‰€ä»¥å°±å»¶çºŒä½¿ç”¨ä¸Šç¯‡æ–‡ç« ç•¶ä¸­çš„ç¯„ä¾‹ï¼ŒæŠŠå®ƒæ”¹æˆä½¿ç”¨ Testcontainers çš„ç‰ˆæœ¬å§ï¼\nä½¿ç”¨ Testcontainers Requirement é¦–å…ˆå¿…é ˆå…ˆç¢ºä¿ç’°å¢ƒç•¶ä¸­æœ‰å®‰è£ Dockerï¼Œç‹€æ…‹ç‚º runningï¼Œä¸”ä½¿ç”¨è€…è¦æœ‰æ¬Šé™å¯ä»¥åŸ·è¡Œ docker æŒ‡ä»¤ã€‚ ä¸åŒçš„ä½œæ¥­ç³»çµ±æœƒæœ‰ä¸åŒçš„å»ºè­°ç‰ˆæœ¬å’Œæ³¨æ„äº‹é …ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ã€‚\nnote: åŸæœ¬åœ¨ local è·‘ï¼Œé›»è…¦æ˜¯ Mac åˆæ˜¯ M1 æ™¶ç‰‡ï¼Œé‡åˆ°ä¸€å †ç’°å¢ƒå•é¡Œå¿«è¢«æç˜‹ï¼Œå¾Œä¾†ç´¢æ€§æ”¾æ£„ï¼Œæ”¹æˆåœ¨ linux ä¸»æ©Ÿä¸Šé¢è·‘å°±éƒ½ä¸€åˆ‡æ­£å¸¸QQ\nå®‰è£ Testcontainers for Go åŒ… go get github.com/testcontainers/testcontainers-go å®‰è£ MySql Module åŒ… ç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„ MariaDB ç‚º MySql æ—ç³»è¡€è¦ªï¼Œæ‰€ä»¥å¯ä»¥å®‰è£å®˜æ–¹æä¾›çš„ MySql Module åŒ…ï¼Œç›´æ¥ç”¨åŒ…æä¾›çš„ API å¯ä»¥å†å¤šçœä¸‹ä¸€äº›ç¨‹å¼ç¢¼ï¼š\ngo get github.com/testcontainers/testcontainers-go/modules/mysql èª¿æ•´ç¨‹å¼ç¢¼ ä¸Šå›æˆ‘å€‘å°‡é‡ç½®è³‡æ–™åº«çš„æ­¥é©Ÿæ”¾åœ¨ suite çš„ setup ç•¶ä¸­ï¼Œé‚£æˆ‘å€‘å‹¢å¿…å¾—åœ¨é€™å€‹å‹•ä½œä¹‹å‰å…ˆæº–å‚™å¥½è³‡æ–™åº«ï¼Œä¹Ÿå°±æ˜¯è¦å…ˆæŠŠ MariaDB container èµ·èµ·ä¾†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 import ( \u0026#34;github.com/testcontainers/testcontainers-go\u0026#34; \u0026#34;github.com/testcontainers/testcontainers-go/wait\u0026#34; testcontainermysql \u0026#34;github.com/testcontainers/testcontainers-go/modules/mysql\u0026#34; ) // æ·»åŠ äº†å¹¾å€‹å±¬æ€§åˆ° struct è£¡é¢ type MysqlRepoTestSuite struct { suite.Suite dbUser string dbPassword string dbName string dbHost string dbPort string mariadbC *testcontainermysql.MySQLContainer ctx context.Context } func (suite *MysqlRepoTestSuite) SetupSuite() { // ------é–‹å§‹å•Ÿå‹• container çš„ä½œæ¥­------ suite.ctx = context.Background() mariadbC, err := testcontainermysql.RunContainer( suite.ctx, testcontainers.WithImage(\u0026#34;mariadb:10.5\u0026#34;), testcontainermysql.WithPassword(suite.dbPassword), testcontainermysql.WithDatabase(suite.dbName), testcontainers.WithWaitStrategy( wait.ForLog(\u0026#34;mysqld: ready for connections.\u0026#34;). WithOccurrence(2). WithStartupTimeout(2*time.Minute), ), ) if err != nil { log.Fatal(\u0026#34;Failed to start MariaDB container: \u0026#34;, err) } suite.host, err = mariadbC.Host(suite.ctx) // å–å¾— container çš„ host if err != nil { log.Fatal(\u0026#34;Failed to get MariaDB container host: \u0026#34;, err) } // å°‡ container 3306 port æ˜ å°„åˆ°ä¸»æ©Ÿä¸Šï¼Œä¸¦å–å¾—æ˜ å°„åˆ°ä¸»æ©Ÿä¸Šçš„ port // (ç­‰åŒä¸‹ docker run æŒ‡ä»¤æ™‚çš„ -P {ä¸»æ©Ÿport}:{container port} æ“ä½œ) mappedPort, _ := mariadbC.MappedPort(suite.ctx, \u0026#34;3306/tcp\u0026#34;) suite.container = mariadbC suite.port = strconv.Itoa(mappedPort.Int()) if err != nil { log.Fatal(\u0026#34;Failed to get MariaDB container port: \u0026#34;, err) } _, err = suite.freshDatabase() if err != nil { panic(err) } } å‚³å…¥ testcontainermysql.RunContainer() çš„åƒæ•¸é™¤äº† ctx ä¹‹å¤–éƒ½æ˜¯é¸å¡«ï¼Œåˆ†åˆ¥è§£é‡‹ä¸Šé¢å‚³å…¥å„å€‹åƒæ•¸çš„æ„ç¾©ï¼š\ntestcontainers.WithImage(\u0026quot;mariadb:10.5\u0026quot;) æŒ‡å®šä½¿ç”¨ mariadb 10.5 ç‰ˆæœ¬çš„ docker imageï¼ˆä¸å‚³å…¥è©²åƒæ•¸çš„è©±ï¼Œé è¨­æœƒæŠ“å– mysql:8 çš„ docker imageï¼‰\ntestcontainermysql.WithPassword(suite.dbPassword) æŒ‡å®šå•Ÿå‹• container æ™‚å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸ MYSQL_PASSWORDï¼ˆä¸å‚³å…¥çš„é è¨­å€¼æ˜¯ testï¼‰\ntestcontainermysql.WithDatabase(suite.dbName) æŒ‡å®šå•Ÿå‹• container æ™‚å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸ MYSQL_DATABASEï¼Œå»ºç«‹ä¸€å€‹åç‚º suite.dbName(è®Šæ•¸) çš„ databaseï¼ˆä¸å‚³å…¥çš„é è¨­å€¼æ˜¯ testï¼‰\ntestcontainers.WithWaitStrategy(wait.ForLog(\u0026quot;mysqld: ready for connections.\u0026quot;).WithOccurrence(2).WithStartupTimeout(2*time.Minute)) ç”±æ–¼ä¸‹å»ºç«‹ container çš„æŒ‡ä»¤ä¹‹å¾Œï¼Œéœ€ç­‰å¾… container å®Œå…¨å•Ÿå‹•ï¼Œæ‰èƒ½ä¿è­‰å¾ŒçºŒçš„ä½¿ç”¨å¯ä»¥æ­£å¸¸åœ°é€£æ¥ä¸Š containerï¼Œå› æ­¤é€™å€‹åƒæ•¸æ˜¯è®“æˆ‘å€‘å¯ä»¥è¨­å®šç­‰å¾…çš„ç­–ç•¥ã€‚åˆ†åˆ¥è§£é‡‹éˆçš„å„å€‹æ–¹æ³•æ„ç¾©ï¼š\nwait.ForLog()ï¼šç¨‹å¼æœƒè¢« blocking ä½ï¼Œç›´åˆ° container ç•¶ä¸­ç‰¹å®šçš„ log å‡ºç¾å¾Œï¼Œæ‰ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œ WithOccurrence()ï¼šæŒ‡å®š log å¿…é ˆå‡ºç¾çš„æ¬¡æ•¸ WithStartupTimeout()ï¼šæŒ‡å®šç­‰å¾…çš„è¶…æ™‚æ™‚é–“ ç”¨äººè©±ä¾†ç¸½çµé€™ä¸€è¡Œçš„æ“ä½œï¼š ç­‰å¾… log ç•¶ä¸­å‡ºç¾ mysqld: ready for connections.é€™æ®µæ–‡å­— 2 æ¬¡ä¹‹å¾Œæ‰ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Œå¦‚æœ 2 åˆ†é˜ä¹‹å…§æ²’ç­‰åˆ°çš„è©±å°±è·³ timeout éŒ¯èª¤ã€‚\næ¥è‘—ï¼Œå°±æ˜¯è¦è¨˜å¾—åœ¨ suite çš„ teardown ç•¶ä¸­ï¼Œé—œé–‰ container é‡‹æ”¾è³‡æºï¼š\n1 2 3 4 5 6 func (suite *MysqlRepoTestSuite) TearDownSuite() { err := suite.mariadbC.Terminate(suite.ctx) if err != nil { panic(err) } } æœ€å¾Œå°±å¯ä»¥ä¾†è·‘çœ‹çœ‹æ¸¬è©¦äº†ï¼š\ngo test æˆåŠŸå›‰ğŸ‰\nå°çµ å…¶å¯¦ä½¿ç”¨çš„æ–¹å¼æ»¿ç°¡æ˜“çš„ï¼Œæ¦‚å¿µä¸Šä¹Ÿä¸é›£ï¼Œå°±æ˜¯åœ¨ setup ç•¶ä¸­æœ€ä¸€é–‹å§‹å¤šä¸€å€‹ã€Œå•Ÿå‹•è³‡æ–™åº« Server çš„ Docker Containerã€ä»¥åŠæœ€å¾Œ teardown æ™‚ã€Œé—œé–‰ containerã€çš„æ­¥é©Ÿè€Œå·²ï¼Œå¾Œé¢å°±å¯ä»¥ç¹¼çºŒåŸæœ¬çš„æµç¨‹(é‡ç½®è³‡æ–™åº«ã€é–‹å•Ÿé€£ç·š\u0026hellip;ç­‰ç­‰)ï¼Œä½†æ¯”è¼ƒæœƒé‡åˆ°å•é¡Œçš„éƒ¨åˆ†å¯èƒ½æœƒæ˜¯åœ¨ç’°å¢ƒé…ç½®ä»¥åŠ API çš„ä½¿ç”¨ï¼Œå› ç‚ºå®˜æ–¹æ–‡ä»¶çš„ç¯„ä¾‹éƒ½æ²’æœ‰åˆ°å¾ˆå®Œæ•´ï¼Œä½¿ç”¨æ™‚æœƒéœ€è¦æ‘¸ç´¢ä¸€é™£å­ï¼Œå› æ­¤æ‰ç‰¹åˆ¥å¯«ä¸€ç¯‡ç­†è¨˜è¨˜éŒ„ã€‚\næœ€å¾Œé™„ä¸Šå®Œæ•´çš„ç¨‹å¼ç¢¼ç¯„ä¾‹ï¼š https://gist.github.com/linxinemily/276905e0145218538cb0be3a79a36153\n","date":"May 17","permalink":"//localhost:1313/posts/golang-database-testing-with-testcontainer/","tags":["Golang","Testing"],"title":"Golang çš„è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦ Part 2 - ä½¿ç”¨ Testcontainers"},{"categories":null,"contents":"\nTL;DR æœ¬æ–‡è¨˜éŒ„äº†æ¢ç´¢åœ¨ Golang ç•¶ä¸­æ’°å¯«è³‡æ–™åº«æ•´åˆæ¸¬è©¦çš„éç¨‹åŠæ–¹æ³•ã€‚åŒ…å«å¹¾å€‹é‡é»çš„è¨è«–ï¼š\né€²è¡Œè³‡æ–™åº«æ¸¬è©¦æ™‚ï¼Œè©²ä½¿ç”¨çœŸå¯¦çš„æ¸¬è©¦è³‡æ–™åº«æˆ–æ˜¯æ¸¬è©¦æ›¿èº«(Test Double)ï¼Ÿ ä½¿ç”¨æ¸¬è©¦è³‡æ–™åº«çš„è©±ï¼Œè©²å¦‚ä½•é‡ç½®è³‡æ–™åº«ç‹€æ…‹ï¼Œæ‰èƒ½é¿å…ä¸åŒæ¸¬è©¦æ–¹æ³•ä¹‹é–“çš„è³‡æ–™ç›¸äº’å½±éŸ¿ï¼Ÿ æœ€å¾Œæä¾›è®“ä¸åŒæ¸¬è©¦æ–¹æ³•ä¹‹é–“è³‡æ–™ä¸äº’ç›¸å½±éŸ¿ï¼Œä¸¦èƒ½å¹³è¡Œè·‘æ¸¬è©¦çš„å¯¦ä½œæ–¹æ³• å‰è¨€ æœ‰ç¶“é©—çš„å·¥ç¨‹å¸«éƒ½çŸ¥é“å¯«æ¸¬è©¦å°æ–¼è»Ÿé«”é–‹ç™¼çš„é‡è¦æ€§ï¼Œè€Œç•¶ä¸­æœ€åŸºæœ¬çš„å°±æ˜¯å–®å…ƒæ¸¬è©¦ã€‚ç‹¹ç¾©æˆ–è€…èªªæ¯”è¼ƒåš´æ ¼å®šç¾©çš„å–®å…ƒæ¸¬è©¦ï¼Œå¦‚æœä»¥ Clean Architechture çš„è§€é»ä¾†çœ‹ï¼Œé€šå¸¸æ˜¯é‡å° Domain Layer ä»¥åŠ Application(Use Case) Layer ï¼Œä¹Ÿå°±æ˜¯ä¸æ¶‰åŠå¤–éƒ¨æœå‹™æˆ–å¥—ä»¶/æ¶ç­‰ç­‰çš„æ¸¬è©¦ã€‚ä½†å°æ–¼ä¸€äº›å°å‹å°ˆæ¡ˆä¾†èªªï¼ŒDomain é‚è¼¯é€šå¸¸ä¸å¤šï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å°è³‡æ–™åº«çš„ CRUD æ“ä½œï¼Œåˆæˆ–è€…ä½¿ç”¨çš„æ¡†æ¶åŸæœ¬å°±æŠŠ ORM è·Ÿ Model ç¶æ­»åœ¨ä¸€èµ·ï¼Œæ¡†æ¶æä¾›çš„æ¸¬è©¦é›†æˆ API ä¹Ÿæ˜¯ç›´æ¥é è¨­å¥½å°çœŸå¯¦è³‡æ–™åº«çš„é€£æ¥ï¼Œæ•´å€‹å°ˆæ¡ˆå¯èƒ½å¹¾ä¹æ²’æœ‰å¹¾å€‹ç‹¹ç¾©çš„å–®å…ƒæ¸¬è©¦äº†ã€‚\nä¸éç¡¬æ˜¯è¦ç•«åˆ†å‡ºå–®å…ƒæ¸¬è©¦æˆ–è€…æ•´åˆæ¸¬è©¦å…¶å¯¦æ²’ä»€éº¼æ„ç¾©ï¼Œé€™é‚Šåªæ˜¯æƒ³è¦ç¨å¾®é»å‡ºä¸€é“ç¾å¯¦ï¼Œåœ¨å’Œè³‡æ–™åº«é«˜åº¦æ›é‰¤æˆ–è€…æ‰€è¬‚è³‡æ–™å¯†é›†å‹çš„æœå‹™åº•ä¸‹ï¼Œè³‡æ–™åº«æ¸¬è©¦å‹¢å¿…æ˜¯æ¥µé‡è¦çš„ä¸€ç’°ã€‚\nç„¶è€Œåœ¨ Golang ç•¶ä¸­ï¼Œä¸¦æ²’æœ‰åƒæ˜¯ Spring Boot or Laravel é€™ç¨®åŒ…å±±åŒ…æµ·çš„æ¡†æ¶ï¼ˆä¼¼ä¹ä¹Ÿä¸å¤ªå¯èƒ½å‡ºç¾ï¼Œç•¢ç«Ÿé•åäº† Golang çš„è¨­è¨ˆå“²å­¸ï¼‰ï¼Œæ¸¬è©¦çš„éƒ¨åˆ†ï¼Œé›–ç„¶æ¨™æº–åº«æœ‰æä¾›ä¸€å€‹æ¸¬è©¦å¥—ä»¶ï¼Œä½†åƒ…æ˜¯å°æ–¼å–®å…ƒæ¸¬è©¦ä»¥åŠæ€§èƒ½æ¸¬è©¦çš„è¼”åŠ©ï¼Œè‡³æ–¼è³‡æ–™åº«æ¸¬è©¦ï¼Ÿå¾—è‡ªå·±æƒ³è¾¦æ³•ã€‚\né‚„æ˜¯å¯ä»¥æ‰¾å¾—åˆ°å°æ–¼è³‡æ–™åº«æ¸¬è©¦çš„è¼”åŠ©å¥—ä»¶ï¼Œä½†å› çˆ²æ³›ç”¨æ€§æ²’æœ‰åˆ°éå¸¸å»£ï¼Œä¸”å¯¦ç¾è³‡æ–™åº«æ¸¬è©¦çš„æ–¹æ³•å…¶å¯¦ä¹Ÿä¸¦ä¸é›£ï¼Œæ‰€ä»¥å°±æ²’æœ‰ç‰¹åˆ¥å»ä½¿ç”¨ï¼Œé€™é‚Šä¹Ÿä¸å¤šåŠ ä»‹ç´¹ã€‚\næƒ…å¢ƒæ¦‚è¿° åƒè€ƒ Clean Architecture çš„æ¶æ§‹ï¼Œå°ˆæ¡ˆç•¶ä¸­æœ‰åŠƒåˆ† Domainã€Applicationã€Adapter ä»¥åŠ Port Layerã€‚è€Œåœ¨ Domain Layer ç•¶ä¸­æˆ‘å€‘å®šç¾©äº† UniqidRepository ä»‹é¢ï¼š\n1 2 3 4 //domain layer type UniqidRepository interface { GetUniqidsWithDevicesFilterByUniqId(ctx context.Context, uniqid string) ([]*Uniqid, error) } é€™å€‹ä»‹é¢æœƒç”± Adapter Layer ç•¶ä¸­ä¸åŒçš„ Repository å»å¯¦ä½œï¼Œåœ¨é€™é‚Šæˆ‘å€‘å®šç¾©ä¸€å€‹ PostgresUniqidRepository ï¼Œå¯¦ç¾ UniqidRepository ä»‹é¢ï¼Œä¸¦ä¸”å…§åµŒä¸€å€‹è³‡æ–™åº«é€£ç·šç‰©ä»¶(ä½¿ç”¨ äº† gorm æä¾›çš„ struct)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 type PostgresUniqidRepository struct { db *gorm.DB } func (u *PostgresUniqidRepository) GetUniqidsWithDevicesFilterByUniqId(ctx context.Context, uniqid string) ([]*domain.Uniqid, error) { ctx, cancel := context.WithTimeout(ctx, 30*time.Second) defer cancel() // to retrieve data from DB by GORM... return uniqids, nil } è³‡æ–™åº«æ¸¬è©¦çš„é¸æ“‡ï¼šæ¸¬è©¦æ›¿èº« VS çœŸå¯¦è³‡æ–™åº« ç‚ºäº†è¦æ’°å¯« PostgresUniqidRepository çš„æ¸¬è©¦ï¼Œæˆ‘å€‘æœƒéœ€è¦ä¾è³´ä¸€å€‹ db ç‰©ä»¶ï¼Œé‚£é€™æ™‚å€™æ‡‰è©²é€£æ¥ä¸€å€‹çœŸå¯¦çš„æ¸¬è©¦è³‡æ–™åº«ï¼Œé‚„æ˜¯ä½¿ç”¨æ¸¬è©¦æ›¿èº«(Test Double)å‘¢ï¼Ÿå…ˆä¾†çœ‹çœ‹é€™å…©è€…å„è‡ªçš„å„ªç¼ºé»ï¼š\nä½¿ç”¨æ¸¬è©¦æ›¿èº« æ¸¬è©¦æ›¿èº«æ˜¯ä¸€å€‹æ¨¡æ“¬è³‡æ–™åº«è¡Œç‚ºçš„ç‰©ä»¶æˆ–ç¨‹å¼ï¼Œç”¨ä¾†æ›¿ä»£çœŸå¯¦çš„è³‡æ–™åº«é€£æ¥ã€‚æ–¹æ³•å°±æ˜¯å°‡åŸæœ¬å¯¦ä½œé€£æ¥çœŸå¯¦è³‡æ–™åº«çš„ç‰©ä»¶è—‰ç”±ä¾è³´æ³¨å…¥æŠ½æ›æˆæ¸¬è©¦æ›¿èº«ï¼ˆä¹‹æ‰€ä»¥å¯ä»¥æŠ½æ›ï¼Œé€šå¸¸æ˜¯å› ç‚ºæœ‰å®šç¾©äº†ä¸€å€‹ä»‹é¢ï¼Œä¸è«–æ˜¯é€£æ¥çœŸå¯¦è³‡æ–™åº«çš„ç‰©ä»¶æˆ–æ˜¯æ¸¬è©¦æ›¿èº«ï¼Œéƒ½æœƒå»å¯¦ç¾é€™å€‹ä»‹é¢ï¼‰é€éæ¸¬è©¦æ›¿èº«å»æ¨¡æ“¬è³‡æ–™åº«çš„è¡Œç‚ºå’Œå›å‚³å€¼ã€‚\nåœ¨ Golang ç•¶ä¸­ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ SQL é¡å‹çš„è³‡æ–™åº«ï¼Œå®˜æ–¹æ¨™æº–åº«å°±æœ‰å®šç¾©äº† sql.DB ä»‹é¢ï¼Œä¹Ÿæœ‰ç›¸é—œçš„ library åƒæ˜¯ go-sqlmock ç•¶ä¸­å°±æä¾›äº†å¯¦ç¾è©²ä»‹é¢æ–¹æ³•çš„æ¸¬è©¦æ›¿èº«ï¼Œè®“é–‹ç™¼è€…èƒ½åœ¨æ¸¬è©¦æ™‚èƒ½å¤ æª¢æŸ¥æ‰€åŸ·è¡Œçš„ SQL èªå¥æ˜¯å¦å¦‚é æœŸï¼Œä¸¦æ¨¡æ“¬è³‡æ–™åº«çš„å›å‚³å€¼ã€‚å¦‚æœæ˜¯ä½¿ç”¨å…¶ä»–é¡å‹çš„è³‡æ–™åº«ï¼Œä¾‹å¦‚ AWS çš„ DynamoDBï¼Œå…¶æä¾›çš„ client sdk ç•¶ä¸­ä¹Ÿæœ‰åŒ…æ‹¬ dynamodb ä»‹é¢ï¼Œä¹Ÿæ˜¯ç›¸åŒçš„æ¦‚å¿µã€‚\nå„ªé»ï¼š æä¾›äº†è¼ƒé«˜çš„æ¸¬è©¦æ§åˆ¶ï¼Œå®¹æ˜“æ¨¡æ“¬éŒ¯èª¤æƒ…å¢ƒ(ex: æ¨¡æ“¬è³‡æ–™åº«é€£æ¥å¤±æ•—)ã€‚ ç”±æ–¼ä¸éœ€è¦çœŸå¯¦çš„è³‡æ–™åº«é€£æ¥ï¼Œæ¸¬è©¦é€Ÿåº¦å¯èƒ½æœƒæ›´å¿«ã€‚ ç¼ºé»ï¼š å¯èƒ½ç„¡æ³•å®Œå…¨æ¨¡æ“¬çœŸå¯¦è³‡æ–™åº«çš„è¡Œç‚ºï¼Œå› æ­¤æ¸¬è©¦çµæœå¯èƒ½èˆ‡å¯¦éš›é‹è¡Œæ™‚çš„è¡Œç‚ºä¸ä¸€è‡´ã€‚ éœ€è¦é¡å¤–çš„é–‹ç™¼å’Œç¶­è­·å·¥ä½œï¼ŒåŒ…æ‹¬æ¨¡æ“¬è³‡æ–™åº«çš„è¡Œç‚ºå’Œç¶­è­·æ¸¬è©¦æ›¿èº«çš„ç‹€æ…‹ï¼Œå¯èƒ½å¢åŠ é–‹ç™¼å’Œç¶­è­·æˆæœ¬ã€‚ å‰›å‰›æœ‰æåˆ°èªªåŒ…å±±åŒ…æµ·çš„æ¡†æ¶ä¸­ï¼Œä¾‹å¦‚ Laravelï¼Œå®˜æ–¹æ˜¯æ²’æœ‰ç›´æ¥æä¾›ä½¿ç”¨æ¸¬è©¦æ›¿èº«è³‡æ–™åº«çš„é¸é …ï¼Œä¸éæœ‰ Memory è³‡æ–™åº«(sqlite)ï¼Œé€™åˆæ˜¯å¦ä¸€ç¨®è³‡æ–™åº«æ¸¬è©¦çš„é¸æ“‡ï¼Œä½†é€™é‚Šä¸ç‰¹åˆ¥ä»‹ç´¹ï¼Œæš«ä¸”æŠŠä»–æ­¸é¡åœ¨ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«çš„ç¯„ç–‡ï¼Œå› ç‚ºä¾ç„¶æ˜¯ä¾è³´å¤–éƒ¨æœå‹™ã€‚\nä½¿ç”¨çœŸå¯¦è³‡æ–™åº« ä¸€å€‹å¯¦éš›é‹è¡Œåœ¨ä¸»æ©Ÿæˆ–å®¹å™¨ä¸Šçš„è³‡æ–™åº«ï¼Œé€šå¸¸å°ˆé–€ for æ¸¬è©¦ç”¨ã€‚\næœ‰ç¶²å‹è£œå……ï¼Œé‚„å¯ä»¥ä½¿ç”¨åƒæ˜¯ testcontainers-go é€™ç¨®å·¥å…·ï¼Œè®“é–‹ç™¼è€…å¯ä»¥é€éå‘¼å«å…¶ API ä¾†ç®¡ç†å’Œä½¿ç”¨ Docker å®¹å™¨ï¼Œé€²è¡Œæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦ã€‚èƒ½å¤ åœ¨æ¸¬è©¦ç•¶ä¸­æ›´æ–¹ä¾¿åœ°ç®¡ç†è³‡æ–™åº«ä¾è³´ã€‚ä»‹ç´¹èˆ‡ç”¨æ³•å¯åƒè€ƒä¸‹ä¸€ç¯‡ç­†è¨˜ã€‚\nå„ªé»ï¼š æä¾›æ›´æ¥è¿‘å¯¦éš›é‹è¡Œç’°å¢ƒçš„æ¸¬è©¦ï¼Œæ¸¬è©¦çµæœæ›´åŠ çœŸå¯¦å¯é ã€‚ å¯ä»¥æ¸¬è©¦åˆ°çœŸå¯¦è³‡æ–™åº«çš„ç‰¹å®šè¡Œç‚ºã€æ•ˆèƒ½ç­‰æ–¹é¢çš„å•é¡Œï¼Œæ›´å…¨é¢åœ°é©—è­‰ç³»çµ±çš„å“è³ªã€‚ ç¼ºé»ï¼š æ¸¬è©¦çµæœå¯èƒ½å—åˆ°çœŸå¯¦è³‡æ–™åº«ç‹€æ…‹å’Œç’°å¢ƒçš„å½±éŸ¿ï¼Œè¼ƒé›£ä»¥æ§åˆ¶æ¸¬è©¦æƒ…å¢ƒã€‚ å¯èƒ½æœƒå› ç‚ºè³‡æ–™åº«ä¸­çš„è®Šå‹•è€Œå°è‡´æ¸¬è©¦çµæœä¸ç©©å®šï¼Œåƒæ˜¯ä¸åŒæ¸¬è©¦æ¡ˆä¾‹ä¹‹é–“çš„è³‡æ–™ç›¸äº’å½±éŸ¿ï¼Œéœ€å¦å¤–é€éé©ç•¶åœ°èª¿æ•´æ¸¬è©¦é †åºã€ç·¨å¯«æ¸…ç†è…³æœ¬æˆ–ç¢ºä¿ä¸åŒæ¸¬è©¦æ¡ˆä¾‹ä½¿ç”¨è³‡æ–™çš„ç¨ç«‹æ€§ç­‰æ–¹æ³•ä¾†é¿å…ã€‚ æ‰€ä»¥åˆ°åº•è¦ç”¨ä½¿ç”¨æ¸¬è©¦æ›¿èº«é‚„æ˜¯çœŸå¯¦è³‡æ–™åº«å‘¢ï¼Ÿ\nå›åˆ°ä¸€é–‹å§‹ç¯„ä¾‹çš„æƒ…å¢ƒï¼Œæœ‰ä¸€å€‹ Repository å°ˆé–€ç”¨ä¾†é€£æ¥ Postgres è³‡æ–™åº«ï¼ŒåŒæ™‚åˆç”¨äº† gorm é€™å€‹ ORM å¥—ä»¶åŒ…è£çœŸå¯¦çš„ SQL èªæ³•ã€‚å¦‚æœè¦ä½¿ç”¨æ¸¬è©¦æ›¿èº«çš„è©±ï¼Œå¯ä»¥å€ŸåŠ© go-sqlmock é€™å€‹å¥—ä»¶ã€‚ä½†ä»”ç´°æƒ³æƒ³ï¼Œä»¥ GetUniqidsWithDevicesFilterByUniqId é€™å€‹æ–¹æ³•ä¾†çœ‹ï¼Œåƒ…æœ‰çš„é‚è¼¯å°±æ˜¯å–å¾—æ‰€æœ‰/è¢«éæ¿¾çš„ Uniqid è³‡æ–™è€Œå·²ï¼Œå¦‚æœåˆç”¨äº†æ¸¬è©¦æ›¿èº«ï¼Œé‚£éº½é€™å€‹æ¸¬è©¦å°±è®Šæˆåªå‰©ä¸‹æª¢æŸ¥ SQL èªæ³•æœ‰æ²’æœ‰çµ„å°ã€‚é€™æ¨£ç®—æ˜¯ä¸€å€‹æœ‰ç”¨çš„æ¸¬è©¦å—ï¼Ÿ\nä»¥é€™å€‹é‡å° Repository æ¸¬è©¦çš„æƒ…å¢ƒè€Œè¨€ï¼Œæ˜¯å¦æœ‰ç¢ºå¯¦å¾è³‡æ–™åº«ä¸­å–å‡ºæ­£ç¢ºçš„è³‡æ–™ï¼Œæ‰æ˜¯æˆ‘å€‘çœŸæ­£æƒ³è¦é©—è­‰çš„äº‹æƒ…ã€‚å› æ­¤ï¼Œæˆ‘èªç‚ºä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æœƒæ˜¯æ¯”è¼ƒé©åˆçš„åšæ³•ã€‚\næŸ¥è©¢è³‡æ–™çš„éç¨‹ä¸­ï¼Œæœ‰çœ‹åˆ°ä¸€ç¯‡ç”± Github å·¥ç¨‹å¸«æ‰€æ’°å¯«çš„éƒ¨è½æ ¼æ–‡ç« ï¼Œç•¶ä¸­ä¹Ÿæœ‰æåˆ°ï¼Œâ€You need to actually test your SQL code.â€\nè³‡æ–™åº«æ•´åˆæ¸¬è©¦ï¼šé‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼ å¦‚æœè¦é€²è¡Œé€£æ¥å¯¦éš›è³‡æ–™åº«çš„æ•´åˆæ¸¬è©¦ï¼Œç‚ºäº†é¿å…æ¯å€‹æ¸¬è©¦å½¼æ­¤ä¹‹é–“çš„è³‡æ–™äº’ç›¸å½±éŸ¿ï¼Œé€šå¸¸æœƒåœ¨æ¯æ¬¡è·‘æ¸¬è©¦ä¹‹å‰å…ˆé‡ç½®è³‡æ–™åº«ç‹€æ…‹ã€‚é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œåƒè€ƒäº†æ‰‹é‚Šæœ€å¸¸ä½¿ç”¨çš„ Laravel æ¡†æ¶ï¼Œç•¶ä¸­æœ‰æä¾›è¨±å¤šå”åŠ©åœ¨æ¸¬è©¦æ™‚é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„ Traitï¼Œéƒ½æ˜¯å¹³å¸¸é–‹ç®±å³ä½¿ç”¨çš„æ–¹æ³•ï¼š\nDatabaseMigrationï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œå…ˆåˆªé™¤è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™è¡¨ï¼Œä¸¦é‡æ–° migrateï¼Œç­‰è©²æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œå† rollback æ‰€æœ‰ migrationsã€‚ DatabaseTransactionsï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œé–‹å§‹ä¸€å€‹ transactionï¼Œç­‰è©²æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œå†å°‡ transaction rollbackï¼Œå›å¾©åˆ°è³‡æ–™åº«åŸæœ¬çš„ç‹€æ…‹ã€‚ RefreshDatabaseï¼šåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œä¹‹å‰ï¼Œ(éä½¿ç”¨å…§å­˜è³‡æ–™åº«çš„ç‹€æ³ä¸‹)æœƒå…ˆåˆ¤æ–·è³‡æ–™åº«çš„ç‹€æ…‹æ˜¯å¦å·²ç¶“ migrate éï¼Œå¦‚æœé‚„æ²’å°±åˆªé™¤è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™è¡¨ã€é‡æ–° migrateï¼Œä¸¦å°‡ migrate ç‹€æ…‹æ¨™ç¤ºç‚ºå·²ç¶“ migrate é ï¼Œæ¥è‘—ç¹¼çºŒåŸ·è¡Œå’Œ DatabaseTransaction ç›¸åŒçš„è¡Œç‚ºã€‚ å¾é€™äº› Laravel æ‰€æä¾›çš„ Trait ç•¶ä¸­ï¼Œå¤§æ¦‚å¯ä»¥æ•´ç†å‡ºå…©å€‹æ–¹æ¡ˆï¼š\nåœ¨æ¯æ¬¡è·‘æ¸¬è©¦æ–¹æ³•ä¹‹å‰ï¼Œå…ˆè·‘ migrationï¼Œç­‰æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå®Œç•¢å¾Œï¼Œå† rollback migrationã€‚ å¥½è™•å°±æ˜¯ç°¡å–®æ–¹ä¾¿ï¼Œä½†ç”±æ–¼éœ€è¦åœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­éƒ½è·‘ä¸€é migration å† rollbackï¼Œé€£æ¥çœŸå¯¦è³‡æ–™åº«çš„æƒ…æ³ä¸‹ï¼Œé€Ÿåº¦æœƒæ¯”è¼ƒæ…¢ã€‚ï¼ˆæ‰€ä»¥å¤§å¤šæ˜¯ä½¿ç”¨å…§å­˜è³‡æ–™åº«å¦‚ sqlite æ™‚æ‰æœƒä½¿ç”¨é€™å€‹æ–¹æ³•ï¼‰ åœ¨æ¯æ¬¡è·‘æ¸¬è©¦æ–¹æ³•ä¹‹å‰å…ˆé–‹å•Ÿä¸€å€‹è³‡æ–™åº«äº¤æ˜“(begin transaction)ï¼Œç­‰æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå®Œç•¢å¾Œï¼Œå†å›æ»¾äº¤æ˜“(rollback transaction)ã€‚ ä¸éœ€è¦è·‘æ¯å€‹æ¸¬è©¦æ–¹æ³•æ™‚éƒ½çœŸçš„æŠŠæ•´å€‹è³‡æ–™åº«é‡ç½®ï¼Œè€Œæ˜¯åˆ©ç”¨äº¤æ˜“çš„ç‰¹æ€§ï¼Œå°‡æ¯å€‹æ¸¬è©¦ç•¶ä¸­å°è³‡æ–™åº«é€²è¡Œçš„æ“ä½œéƒ½è¦–ç‚ºåŸå­æ€§çš„æ“ä½œï¼ŒåŸ·è¡Œé€Ÿåº¦è¼ƒå¿«ã€‚ä½†éœ€å¦å¤–æ³¨æ„çš„æ˜¯ï¼Œä¸åŒæ¸¬è©¦æ–¹æ³•å¦‚æœéƒ½å°åŒä¸€ç­†æˆ–åŒä¸€å€é–“çš„è³‡æ–™åšæ“ä½œï¼Œå¯èƒ½æœƒç”¢ç”Ÿéé æœŸçš„è³‡æ–™ï¼Œé€²è€Œå½±éŸ¿åˆ°æ¸¬è©¦çš„çµæœã€‚æ‰€ä»¥ä½¿ç”¨é€™å€‹æ–¹æ³•æ™‚ï¼Œé€šå¸¸æœƒåœ¨æ¯å€‹æ¸¬è©¦ç•¶ä¸­å‰µå»ºè©²æ¸¬è©¦éœ€è¦ç”¨åˆ°çš„è³‡æ–™ï¼Œè€Œéå’Œå…¶ä»–æ¸¬è©¦å…±äº«è³‡æ–™ï¼Œå¦‚æ­¤ä¸€ä¾†ï¼Œå¯ä»¥é™ä½æ¸¬è©¦ä¹‹é–“ç›¸äº’å½±éŸ¿çš„é¢¨éšªï¼Œç¢ºä¿æ¯å€‹æ¸¬è©¦çš„ç¨ç«‹æ€§ã€‚ ä½†ç”±æ–¼è¦ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«ä¾†æ¸¬è©¦ï¼Œä»¥æˆ‘å€‘çš„æƒ…å¢ƒä¾†çœ‹ï¼Œä½¿ç”¨ç¬¬äºŒç¨®æ–¹å¼æœƒæ˜¯æ¯”è¼ƒé©ç•¶çš„é¸æ“‡ã€‚\nå…¶å¯¦é‡ç½®è³‡æ–™åº«ç‹€æ…‹çš„æ–¹å¼ä¸åªé€™å¹¾ç¨®ï¼Œä½† Laravel Trait æ‰€æä¾›çš„æ–¹å¼å·²ç¶“èƒ½æ»¿è¶³æˆ‘å€‘åŸºæœ¬çš„éœ€æ±‚ï¼Œå°±ä¸å†é¡å¤–æ¢è¨ã€‚\nå¯¦ä½œè³‡æ–™åº«æ•´åˆæ¸¬è©¦ ç¸½ç®—é€²å…¥åˆ°å¯¦ä½œæ¸¬è©¦çš„éƒ¨åˆ†äº†ï¼\nåœ¨é€™é‚Šæœƒä½¿ç”¨åˆ°å¹¾å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ä¾†è¼”åŠ©æ¸¬è©¦ä»¥åŠè³‡æ–™åº«çš„é€£æ¥ï¼š\ntestify/suiteï¼štestify æ¸¬è©¦æ¡†æ¶ç•¶ä¸­çš„ suite package æ–¹ä¾¿ç”¨ä¾†å°æ•´é«”/åˆ†çµ„/å–®ç¨çš„æ¸¬è©¦æ–¹æ³•å‰µå»º setup ä»¥åŠ teardown æ–¹æ³•ã€‚åªè¦å…§åµŒsuite.Suite structï¼Œå°±å¯ä»¥è—‰ç”±è¤‡å¯«ä»¥ä¸‹æ–¹æ³•ï¼Œä¾†å¯¦ç¾ç‚ºä¸åŒçš„æ¸¬è©¦è¡Œç‚ºåŠ å…¥å‰/å¾Œç½®è™•ç†ï¼š SetupSuite() ï¼šåŸ·è¡Œ suite ç•¶ä¸­æ‰€æœ‰æ¸¬è©¦æ–¹æ³•ä¹‹å‰çš„å‰ç½®è™•ç† TearDownSuite() ï¼šåŸ·è¡Œ suite ç•¶ä¸­æ‰€æœ‰æ¸¬è©¦æ–¹æ³•ä¹‹å¾Œçš„å¾Œç½®è™•ç† SetupTest()ï¼šåŸ·è¡Œ suite ç•¶ä¸­æ¯å€‹æ¸¬è©¦æ–¹æ³•ä¹‹å‰çš„å‰ç½®è™•ç† TearDownTest() ï¼šåŸ·è¡Œ suite ç•¶ä¸­æ¯å€‹æ¸¬è©¦æ–¹æ³•ä¹‹å¾Œçš„å¾Œç½®è™•ç† go-migrateï¼šä½¿ç”¨ CLI æˆ–æ˜¯åœ¨ç¨‹å¼ç•¶ä¸­å‘¼å«ç‰¹å®šæ–¹æ³•åŸ·è¡Œå®šç¾©å¥½çš„ migration æª”æ¡ˆã€‚ gormï¼šGolang ç•¶ä¸­è‘—åçš„ ORM æ¡†æ¶ã€‚ç”±æ–¼ Repository ç•¶ä¸­ä½¿ç”¨äº†è©²å¥—ä»¶å­˜å–è³‡æ–™åº«ï¼Œæ‰€ä»¥åŸ·è¡Œ Repository æ–¹æ³•æ™‚éœ€è¦ä½¿ç”¨åˆ°ã€‚ æˆ‘å€‘å¯ä»¥åœ¨ suite çš„ setup ç•¶ä¸­ï¼Œå…ˆé‡ç½®è³‡æ–™åº«ä¸¦é–‹å•Ÿä¸€å€‹é€£ç·šã€‚ç„¶å¾Œå°‡æ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½ç”¨ä¸€å€‹ transaction åŒ…ä½ï¼ˆåœ¨é–‹å§‹å‰å…ˆ begin TXã€çµæŸå¾Œ rollback TXï¼‰ï¼Œæœ€å¾Œåœ¨ suite teardown æ™‚é—œé–‰è³‡æ–™åº«é€£ç·šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 type PostgresRepoTestSuite struct { suite.Suite db *gorm.DB tx *gorm.DB } func (suite *PostgresRepoTestSuite) SetupSuite() { // é‡ç½®è³‡æ–™åº«ï¼Œå…ˆæŠŠè³‡æ–™åº« rollback æˆ–æ•´å€‹ reset å¾Œå†è·‘ migrations // é€™é‚Šçš„ migrations æ‡‰åƒ…åŒ…å« DDLï¼Œä¸¦ä¸æœƒå¡å…¥ä»»ä½•ä¸€ç­†è³‡æ–™ _, err := freshDatabase() if err != nil { panic(err) } // é–‹å•Ÿä¸€å€‹è³‡æ–™åº«é€£ç·šä¸¦æš«å­˜ï¼Œä»¥ä¾¿è®“ suite åº•ä¸‹æ¯å€‹æ¸¬è©¦æ–¹æ³•å…±ç”¨ suite.db = openDatabaseConnection() } func (suite *PostgresRepoTestSuite) TearDownSuite() { sqlDB, _ := suite.db.DB() sqlDB.Close() // suite åº•ä¸‹æ‰€æœ‰æ¸¬è©¦æ–¹æ³•è·‘å®Œå¾Œï¼Œé—œé–‰è³‡æ–™åº«é€£ç·š } func (suite *PostgresRepoTestSuite) SetupTest() { suite.tx = suite.db.Begin() // ä½¿ç”¨æš«å­˜çš„ DB é€£ç·šç‰©ä»¶ï¼Œé–‹å•Ÿä¸€å€‹ transaction } func (suite *PostgresRepoTestSuite) TearDownTest() { suite.tx.Rollback() // å›æ»¾ transaction } func TestPostgresRepoTestSuite(t *testing.T) { suite.Run(t, new(PostgresRepoTestSuite)) // åŸ·è¡Œ suite åº•ä¸‹æ‰€æœ‰æ¸¬è©¦æ–¹æ³• } // å¯¦éš›çš„æ¸¬è©¦æ–¹æ³•ï¼Œå¿…é ˆç‚º suite çš„ receiver func (suite *PostgresRepoTestSuite) TestGetUniqidsWithDevicesFilterByUniqId() { // ä¸»è¦çš„æ¸¬è©¦é‚è¼¯ // ... } åœ¨ PostgresRepoTestSuite ä¸­ï¼Œ db å’Œ tx è®Šæ•¸æ˜¯ç”± suite åº•ä¸‹çš„æ¯å€‹æ¸¬è©¦æ–¹æ³•æ‰€å…±ç”¨çš„ã€‚åœ¨å–®ä¸€åŸ·è¡Œç·’ä¸‹åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œé€™ä¸¦ä¸æœƒé€ æˆä»»ä½•å•é¡Œã€‚ä½†å¦‚æœè¦å¹³è¡ŒåŸ·è¡Œæ¸¬è©¦ï¼Œé€™äº›æ–¹æ³•åœ¨åŒä¸€æ™‚é–“å¯èƒ½æœƒç«¶çˆ­åŒä¸€å€‹è®Šæ•¸ï¼Œå°è‡´è³‡æºç«¶çˆ­çš„æƒ…æ³ï¼Œé€²è€Œå½±éŸ¿æ¸¬è©¦çµæœçš„æ­£ç¢ºæ€§ã€‚æ­¤å¤–ï¼Œé€™äº›æ–¹æ³•åŸ·è¡Œæ™‚éƒ½æ˜¯ä½¿ç”¨åŒä¸€å€‹è³‡æ–™åº«é€£ç·šï¼Œå¯èƒ½ä¹Ÿæœƒç”¢ç”Ÿæ„å¤–çš„éŒ¯èª¤ã€‚\næ–¼æ˜¯æˆ‘å€‘å¯ä»¥æ”¹æˆåœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­ï¼Œéƒ½é–‹å•Ÿå°ˆå±¬çš„è³‡æ–™åº«é€£ç·šï¼Œä¸¦å‰µå»ºç¨ç«‹çš„è®Šæ•¸ä¿å­˜é€£ç·šå¯¦é«”ï¼Œé †ä¾¿æ¨¡æ“¬å¹³è¡Œè·‘æ¸¬è©¦æ™‚çš„å ´æ™¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 type PostgresRepoTestSuite struct { suite.Suite } func (suite *PostgresRepoTestSuite) SetupSuite() { _, err := freshDatabase() if err != nil { panic(err) } } // è¦†å¯«äº†åŸæœ¬å…§åµŒçš„ suite.Suite é è¨­ Run æ–¹æ³• // ä»¥ä¾¿ç‚ºæ¯å€‹æ–¹æ³•å‰µå»ºç¨ç«‹çš„è³‡æ–™åº«é€£ç·šç‰©ä»¶ // åŒæ™‚ä½¿ç”¨æ¨™æº–åº« *testing.T æä¾›çš„ Run æ–¹æ³• wrap èµ·ä¾†ï¼Œå¾…æœƒå°±èƒ½å¤ å¹³è¡Œåœ°åŸ·è¡Œé€™äº›å­æ–¹æ³• func (suite *PostgresRepoTestSuite) Run(t *testing.T, method string, fn func(t *testing.T, tx *gorm.DB)) { t.Run(method, func(t *testing.T) { var db *gorm.DB var tx *gorm.DB defer func() { sqlDB, _ := db.DB() sqlDB.Close() }() defer func() { tx.Rollback() }() db = openDatabaseConnection() tx = db.Begin() fn(t, tx) }) } func TestPostgresRepoTestSuite(t *testing.T) { t.Parallel() // ä½¿ç”¨ goroutine åŒæ™‚é‹è¡Œæ‰€æœ‰æ¸¬è©¦æ–¹æ³• suite.Run(t, new(PostgresRepoTestSuite)) } func (suite *PostgresRepoTestSuite) TestGetUniqidsWithDevicesFilterByUniqId() { // å‘¼å«å‰›å‰›è¦†å¯«çš„ Run æ–¹æ³•ï¼Œå°‡åŸæœ¬æ¸¬è©¦é‚è¼¯åŒ…è£æˆ function åšç‚ºåƒæ•¸å‚³å…¥ suite.Run(suite.T(), \u0026#34;TestGetUniqidsWithDevicesFilterByUniqId\u0026#34;, func(t *testing.T, tx *gorm.DB) { // ä¸»è¦çš„æ¸¬è©¦é‚è¼¯ // ... }) } ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿æ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½ä½¿ç”¨å„è‡ªçš„è³‡æ–™åº«é€£æ¥ï¼Œå¦‚æœå…©å€‹æ¸¬è©¦æ–¹æ³•éƒ½å˜—è©¦åŒæ™‚å°åŒä¸€æ¢è³‡æ–™é€²è¡Œå­˜å–ï¼Œæˆ–è€…å°æŸå€‹ç¯„åœé€²è¡Œå­˜å–ï¼Œä¹Ÿæœ‰å¯èƒ½å­˜åœ¨è³‡æ–™åº«å±¤é¢çš„äº‹å‹™ç«¶çˆ­ã€‚ä¸éå¦‚æœæ¯å€‹æ¸¬è©¦æ–¹æ³•éƒ½åªæ˜¯æ“ä½œè‡ªå·±å‰µå»ºçš„è³‡æ–™ï¼Œè¿¸ç™¼æ¸¬è©¦æ‡‰è©²æ˜¯å®‰å…¨çš„ã€‚\nå°çµ é‡é»æ•´ç†å¦‚ä¸‹ï¼š\nå¦‚æœè¦æ¸¬è©¦çš„ function éƒ½å’Œè³‡æ–™åº«äº’å‹•ç‚ºä¸»ï¼Œé€šå¸¸æœƒå»ºè­°ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æ¸¬è©¦è€Œéè³‡æ–™åº«æ›¿èº«ã€‚\né‡ç½®è³‡æ–™åº«ç‹€æ…‹å¯ä»¥è—‰ç”±åœ¨æ¯å€‹æ¸¬è©¦æ–¹æ³•åŸ·è¡Œå‰/å¾Œåˆ†åˆ¥ run/rollback migrations æˆ–é–‹å•Ÿ/å›æ»¾ä¸€å€‹è³‡æ–™åº«äº¤æ˜“ã€‚ä½¿ç”¨äº¤æ˜“é€šå¸¸æœƒæ›´çœè³‡æºï¼Œä½†å¿…é ˆç¢ºä¿æ¯å€‹æ¸¬è©¦æ–¹æ³•ç•¶ä¸­æ‰€ä½¿ç”¨è³‡æ–™çš„ç¨ç«‹æ€§ã€‚\nå¯¦ä½œæ¸¬è©¦æ–¹æ³•ï¼š\nåœ¨ suite çš„ setup ç•¶ä¸­ï¼Œé‡ç½®æ•´å€‹è³‡æ–™åº«å¾Œå†è·‘ migrationï¼ˆåƒ…åŒ…å« DDLï¼Œæ­¤æ™‚è³‡æ–™åº«æ²’æœ‰ä»»ä½•ä¸€ç­†è³‡æ–™ï¼‰ åœ¨ suite åº•ä¸‹çš„æ¯å€‹æ¸¬è©¦æ³•æ–¹ç•¶ä¸­æŒ‰ç…§é †åºåŸ·è¡Œï¼š é–‹å•Ÿç¨ç«‹çš„ DB é€£ç·š é–‹å§‹äº¤æ˜“ é‹è¡Œæ¸¬è©¦é‚è¼¯ï¼ˆç•¶ä¸­æ‰å»ºç«‹æ‰€éœ€çš„è³‡æ–™ï¼‰ å›æ»¾äº¤æ˜“ é—œé–‰ DB é€£ç·š å¦‚æ­¤ä¸€ä¾†ï¼ŒDB é€£ç·šå’Œè³‡æ–™éƒ½ä¸æœƒäº’ç›¸å¹²æ“¾ï¼Œä¹Ÿå¯ä»¥å¹³è¡Œè·‘æ¸¬è©¦ã€‚\n","date":"Apr 23","permalink":"//localhost:1313/posts/golang-database-testing/","tags":["Golang","Testing"],"title":"Golang çš„è³‡æ–™åº«(æ•´åˆ)æ¸¬è©¦"},{"categories":null,"contents":"è¦å°‡ Go çš„ struct è½‰æˆ JSON æ ¼å¼æ™‚ï¼Œé€šå¸¸éƒ½æœƒè—‰ç”±å®˜æ–¹æä¾›çš„æ¨™æº–å‡½å¼åº« encoding/json å»å¯¦ç¾ï¼Œä¹Ÿæœƒå€ŸåŠ©åœ¨ struct ç•¶ä¸­ç‚ºç‰¹å®šæ¬„ä½å®šç¾© json tag å»æ¨™ç¤ºè¼¸å‡ºæˆ JSON æ ¼å¼æ™‚çš„å‘½åå’Œè¦å‰‡ã€‚åœ¨æ¬„ä½å€¼å­˜åœ¨çš„æƒ…æ³ä¸‹åŸºæœ¬ä¸Šä¸æœƒæœ‰ä»€éº¼å•é¡Œï¼Œä½†å¦‚æœæ¬„ä½æ²’æœ‰å€¼ï¼Œå°±æœ‰å¯èƒ½æœƒè¼¸å‡ºéé æœŸçµæœï¼ˆç°¡ç¨±ï¼šè¸©å‘ï¼‰ã€‚\né¦–å…ˆå¿…é ˆå…ˆé‡æ¸…ä¸€ä»¶äº‹ï¼Œæ‰€è¬‚çš„ã€Œæ²’æœ‰å€¼ã€æº–ç¢ºä¾†èªªæ˜¯æŒ‡ä»€éº¼ï¼Ÿnilï¼Ÿç©ºé™£åˆ—ï¼Ÿé‚„æ˜¯ç©ºå­—ä¸²ï¼Ÿæˆ‘å€‘éƒ½çŸ¥é“åœ¨ Golang ç•¶ä¸­ï¼Œä¸åŒé¡å‹çš„è³‡æ–™æœ‰è‘—ä¸åŒçš„ã€Œé›¶å€¼(Zero Value)ã€ï¼Œæ¯”å¦‚ string çš„é›¶å€¼æ˜¯ç©ºå­—ä¸²ã€int çš„é›¶å€¼æ˜¯ 0ã€‚ç„¶è€Œã€Œæ²’æœ‰å€¼ã€æ¯”è¼ƒåå‘ä¸€å€‹ç± çµ±çš„èªªæ³•ï¼Œä¹Ÿä¸ç®¡ç¨‹å¼èªè¨€çš„å®šç¾©ï¼Œåæ­£å°±æ˜¯æ²’æœ‰è³‡æ–™çš„æ„æ€ã€‚åˆæˆ–è€…èªªä»¥ä½¿ç”¨è€…è§’åº¦ä¾†çœ‹ï¼Œå› ç‚ºä¸ç®¡æ¬„ä½è³‡æ–™è£¡é¢æ˜¯ç©ºå­—ä¸²æˆ–æ˜¯ NULLï¼Œå°ä»–å€‘ä¾†èªªå°±éƒ½æ˜¯æ²’è³‡æ–™ã€‚\nä»¥ä¸‹æœƒä»¥é€™å€‹ struct ç‚ºç¯„ä¾‹ï¼Œåˆ†åˆ¥ä¾†çœ‹é€™å…©ç¨®ä¸åŒé¡å‹(reference v.s. value type)çš„è³‡æ–™æ¬„ä½ï¼Œåœ¨é¢è‡¨æ²’æœ‰è³‡æ–™æ™‚æœƒè¼¸å‡ºä»€éº¼çµæœã€‚\n1 2 3 4 type Person struct { Name string `json:\u0026#34;name\u0026#34;` Hobbies []string `json:\u0026#34;hobbies\u0026#34;` } Reference Type - Slice ç•¶æ¬„ä½é¡å‹ç‚º slice çš„æ™‚å€™ï¼Œåœ¨ä¸åŒæƒ…æ³ä¸‹çš„ã€Œæ²’æœ‰å€¼ã€ï¼Œè½‰æ›å‡ºä¾†çš„çµæœä¹Ÿæœƒæœ‰æ‰€ä¸åŒã€‚\n1.ç•¶ Hobbies æ˜¯ä¸€å€‹å·²åˆå§‹åŒ–éå¾Œçš„ç©º sliceï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // åˆå§‹åŒ–æ–¹å¼ä¸€ï¼š hobbies := make([]string, 0) // åˆå§‹åŒ–æ–¹å¼äºŒï¼š // hobbies := []string{} // éƒ½æ˜¯åˆå§‹åŒ–ä¸€å€‹é•·åº¦/å®¹é‡çš†ç‚º 0 çš„ slice emmie := Person{ \u0026#34;Emmie\u0026#34;, hobbies, } jsonData, _ := json.Marshal(emmie) fmt.Println(string(jsonData)) è¼¸å‡ºï¼š\n1 {\u0026#34;name\u0026#34;:\u0026#34;Emmie\u0026#34;,\u0026#34;hobbies\u0026#34;:[]} 2.ç•¶ Hobbies æ˜¯ä¸€å€‹åªæœ‰å®£å‘Šè®Šæ•¸ï¼Œæ²’æœ‰åˆå§‹åŒ–çš„ sliceï¼š\n1 2 3 4 5 6 7 8 var hobbies []string emmie := Person{ \u0026#34;Emmie\u0026#34;, hobbies, } jsonData, _ := json.Marshal(emmie) fmt.Println(string(jsonData)) è¼¸å‡ºï¼š\n1 {\u0026#34;name\u0026#34;:\u0026#34;Emmie\u0026#34;,\u0026#34;hobbies\u0026#34;:null} ä¹‹æ‰€ä»¥æœƒæœ‰é€™ç¨®å·®ç•°æ˜¯å› ç‚ºåœ¨ Golang ä¸­ï¼Œç•¶å®£å‘Šä¸€å€‹è®Šæ•¸ä½†æ˜¯æ²’æœ‰åˆå§‹åŒ–å€¼çš„è©±ï¼Œå…¶é è¨­å€¼æœƒæ˜¯è©²é¡å‹çš„é›¶å€¼ï¼Œè€Œå°æ–¼ sliceã€mapã€channel é€™æ¨£çš„é¡å‹(reference type)ä¾†èªªï¼Œé›¶å€¼æ˜¯ nilã€‚\nåœ¨ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­ï¼Œslice è®Šæ•¸æœƒè¢«åˆå§‹åŒ–ç‚ºä¸€å€‹é•·åº¦åŠå®¹é‡çš†ç‚º 0 çš„ç©º sliceï¼Œè€Œä¸æ˜¯ nilã€‚æ‰€ä»¥ hobbies åœ¨å®£å‘Šæ™‚å·²ç¶“è¢«åˆå§‹åŒ–ç‚ºä¸€å€‹ç©ºçš„ sliceï¼Œå› æ­¤ emmmie çš„ hobbies æ¬„ä½æœƒæ˜¯ä¸€å€‹ç©ºçš„ sliceï¼Œå®ƒçš„ JSON è¡¨ç¤ºå°±æ˜¯ []ã€‚\nç„¶è€Œï¼Œåœ¨ç¬¬äºŒå€‹ç¯„ä¾‹ä¸­ï¼Œhobbies è®Šæ•¸åƒ…æœ‰è¢«å®£å‘Šï¼Œæ‰€ä»¥é è¨­å€¼ç‚º nilï¼Œè€Œä¸æ˜¯ä¸€å€‹ç©ºçš„ sliceã€‚åœ¨ JSON è½‰æ›æœŸé–“ï¼Œnil slice æœƒè¢«è½‰æ›æˆ JSON çš„ null å€¼ã€‚\nå¦‚æœæƒ³åœ¨ hobbies æ¬„ä½ç‚º null æˆ–ç©ºé™£åˆ—æ™‚ï¼ˆä¹Ÿå°±æ˜¯ slice ç‚º nil æˆ– ç©º slice çš„ç‹€æ…‹ä¸‹ï¼‰ï¼Œä¸è¦è¼¸å‡ºè©²æ¬„ä½ keyï¼Œåƒé€™æ¨£ï¼š\n1 {\u0026#34;name\u0026#34;:\u0026#34;Emmie\u0026#34;} é‚£å°±è¦ä¿®æ”¹ struct ç•¶ä¸­çš„å®šç¾©ï¼Œç‚º hobbies åŠ ä¸Š omitempty æ¨™ç±¤ï¼š\n1 Hobbies []string `json:\u0026#34;hobbies,omitempty\u0026#34;` çµ±æ•´ä¸€ä¸‹ï¼Œæ‰€ä»¥åœ¨å°‡ struct è½‰æ›æˆ JSON æ™‚ï¼Œå¦‚æœæœ‰æ¬„ä½çš„é¡å‹æ˜¯ slice ï¼š\nç‹€æ³ è¼¸å‡º JSON çš„å€¼ æœªåˆå§‹åŒ–ï¼ˆnil sliceï¼‰ null å·²åˆå§‹åŒ–ï¼ˆç©º sliceï¼‰ [] æœªåˆå§‹åŒ–ï¼ˆnil sliceï¼‰ä½†åŠ ä¸Š omitempty æ¨™ç±¤ key ç›´æ¥æ¶ˆå¤± å·²åˆå§‹åŒ–ï¼ˆç©º sliceï¼‰ä½†åŠ ä¸Š omitempty æ¨™ç±¤ key ç›´æ¥æ¶ˆå¤± å¯ä»¥ç™¼ç¾ slice é¡å‹ï¼ˆreference typeï¼‰çš„æ¬„ä½åŠ ä¸Š omitempty ï¼Œä¸ç®¡å…¶å€¼æ˜¯ nilï¼ˆé›¶å€¼ï¼‰ æˆ–æ˜¯ç©º sliceï¼Œkey éƒ½æœƒæ¶ˆå¤±ã€‚\nValue Type - String é‚£å¦‚æœç•¶æ¬„ä½é¡å‹æ˜¯ stringã€int ç­‰ value type å‘¢ï¼Ÿ\nç¹¼çºŒä½¿ç”¨ä¸Šé¢çš„ç¯„ä¾‹ structï¼Œåœ¨é‚„æ²’åŠ ä¸Š omitempty tag æ™‚ï¼š\n1 2 3 4 type Person struct { Name string `json:\u0026#34;name\u0026#34;` Hobbies []string `json:\u0026#34;hobbies,omitempty\u0026#34;` } 1 2 3 4 emmie := Person{} jsonData, _ := json.Marshal(emmie) fmt.Println(string(jsonData)) è¼¸å‡ºï¼š\n1 {\u0026#34;name\u0026#34;:\u0026#34;\u0026#34;} å¦‚æœæŠŠ name ä¹ŸåŠ ä¸Š omitempty tagï¼š\n1 2 3 4 type Person struct { Name string `json:\u0026#34;name,omitempty\u0026#34;` Hobbies []string `json:\u0026#34;hobbies,omitempty\u0026#34;` } è¼¸å‡ºï¼š\n1 {} string æœªåˆå§‹åŒ–æƒ…æ³ä¸‹ï¼Œé è¨­ç‚ºé›¶å€¼ç©ºå­—ä¸²ï¼Œ key ä¹Ÿæ¶ˆå¤±äº†ã€‚\nä½†å¦‚æœæˆ‘å€‘ä¸æƒ³è®“ key ç›´æ¥æ¶ˆå¤±ï¼Œæƒ³è¦è¼¸å‡º null çš„è©±è©²æ€éº¼è¾¦ï¼Ÿæ–¹æ³•æ˜¯å°‡ struct ç•¶ä¸­çš„ string æ”¹æˆæŒ‡æ¨™é¡å‹ *string ï¼ˆå› ç‚ºæŒ‡æ¨™é¡å‹çš„é›¶å€¼ä¹Ÿæ˜¯ nilï¼‰ä¸”ä¸éœ€è¦ omitempty tagï¼š\n1 2 3 4 type Person struct { Name *string `json:\u0026#34;name\u0026#34;` Hobbies []string `json:\u0026#34;hobbies,omitempty\u0026#34;` } è¼¸å‡ºï¼š\n1 {\u0026#34;name\u0026#34;:null} å†çµ±æ•´ä¸€ä¸‹ï¼š\né¡å‹ ç‹€æ³ è¼¸å‡º JSON çš„å€¼ string æœªåˆå§‹åŒ–ï¼ˆç©ºå­—ä¸²ï¼‰ \u0026quot;\u0026quot; string æœªåˆå§‹åŒ–ï¼ˆç©ºå­—ä¸²ï¼‰ä½†åŠ ä¸Š omitempty æ¨™ç±¤ key ç›´æ¥æ¶ˆå¤± *string æœªåˆå§‹åŒ– ï¼ˆnilï¼‰ null ç¸½çµ åœ¨ä¸åŒé¡å‹ä¸­ï¼Œæ ¹æ“šé›¶å€¼ä¸åŒï¼Œè¼¸å‡ºçš„ JSON å€¼ä¹Ÿä¸åŒã€‚ ç„¶è€Œåœ¨ç›¸åŒé¡å‹ä¸­ï¼Œè¼¸å‡ºçš„ JSON å€¼ä¹Ÿæœ‰ä¸åŒçš„å¯èƒ½æ€§ã€‚ä¾‹å¦‚å‰›å‰›æåˆ°çš„ slice é¡å‹ï¼Œåˆå§‹åŒ–å¾Œçš„ç©º slice æœƒè¼¸å‡ºç©ºé™£åˆ—ï¼Œè€Œæœªåˆå§‹åŒ–ç‚ºé›¶å€¼çš„ nil slice æœƒè¼¸å‡º nullã€‚ omitempty tag æœƒå½±éŸ¿ key å€¼çš„å­˜ç•™ã€‚ åªè¦æ³¨æ„é€™å¹¾é»ï¼Œå°±å¯ä»¥é¿å…åœ¨è¼¸å‡º JSON æ™‚å¾—åˆ°éé æœŸçš„è³‡æ–™é¡å‹/çµæ§‹ã€‚\n","date":"Mar 27","permalink":"//localhost:1313/posts/golang-struct-to-json-and-empty-data/","tags":["Golang"],"title":"Golang struct è½‰ JSON é‡åˆ°æ¬„ä½æ²’æœ‰å€¼çš„å•é¡Œ"},{"categories":null,"contents":"æœ€è¿‘åœ¨ç ”ç©¶ oapi-codegen é€™å¥—åŸºæ–¼ OpenAPI 3.0 è‡ªå‹•ç”Ÿæˆ Go boilerplate ç¨‹å¼çš„å·¥å…·ï¼Œèƒ½å¹«åŠ©é–‹ç™¼è€…çœä¸‹å¾ˆå¤šæ’°å¯«å¯¦ç¾ HTTP Server ç«¯å£ã€marshalling å’Œ unmarshalling çš„é‡è¤‡ç¨‹å¼ç¢¼çš„æ™‚é–“ã€‚ç•¶é€²è¡Œç³»çµ±é‡æ§‹æˆ–ä½¿ç”¨åƒæ˜¯æ–‡ä»¶å…ˆè¡Œ(Documentation-Driven Development)çš„é–‹ç™¼æ–¹æ³•æ™‚ä¹Ÿå¾ˆé©ç”¨ã€‚ åœ¨æ­¤ç´€éŒ„ä¸€ä¸‹é¤µå…¥ OpenAPI æª”æ¡ˆæ™‚é‡åˆ°çš„å•é¡Œã€‚\nå•é¡Œæ¦‚è¿° ä½¿ç”¨ä»¥ä¸‹ OpenAPI yaml æª”ï¼ˆæ“·å–ç‰‡æ®µï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 schemas: Response: status: description: ç‹€æ…‹ type: integer example: 200 message: description: è¨Šæ¯ type: string example: success detail: description: è©³ç´°è¨Šæ¯ type: object example: {} #...more paths: /iot/stations: get: parameters: - name: uniqid in: query description: Uniqid required: false schema: type: string responses: \u0026#39;200\u0026#39;: description: OK content: application/json: schema: type: object properties: data: type: object properties: items: type: array #...more message: $ref: \u0026#39;#/components/schemas/Response/message\u0026#39; status: $ref: \u0026#39;#/components/schemas/Response/status\u0026#39; è·‘ç”Ÿæˆä»£ç¢¼çš„æŒ‡ä»¤æ™‚\n1 $ oapi-codegen -package main openapi.yaml \u0026gt; openapi.gen.go æœƒå™´é€™å€‹éŒ¯èª¤\nerror generating code: error creating operation definitions: error generating response definitions: error generating request body definition: error generating Go schema for property \u0026#39;message\u0026#39;: error turning reference (#/components/schemas/Response/message) into a Go type: unexpected reference depth: 5 for ref: #/components/schemas/Response/message local: true çœ‹äº†ä¸€ä¸‹åŸå§‹ç¢¼ï¼Œç™¼ç¾ä»–åªèƒ½è§£æå››å±¤çš„ $ref pathï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // https://github.com/deepmap/oapi-codegen/blob/master/pkg/codegen/utils.go#L322-L332 // refPathToGoType returns the Go typename for refPath given its func refPathToGoType(refPath string, local bool) (string, error) { if refPath[0] == \u0026#39;#\u0026#39; { pathParts := strings.Split(refPath, \u0026#34;/\u0026#34;) depth := len(pathParts) if local { if depth != 4 { // \u0026lt;---------here! return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;unexpected reference depth: %d for ref: %s local: %t\u0026#34;, depth, refPath, local) } } else if depth != 4 \u0026amp;\u0026amp; depth != 2 { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;unexpected reference depth: %d for ref: %s local: %t\u0026#34;, depth, refPath, local) } ä¹Ÿå°±æ˜¯èªªï¼Œåªæœ‰é•·é€™æ¨£çš„ path æ‰èƒ½è¢«é †åˆ©è§£æï¼š\n#/components/responses/Baz è€Œåœ¨ä¸Šé¢çš„ yaml ç•¶ä¸­çš„ path å·²ç¶“åˆ°ç¬¬äº”å±¤ #/components/schemas/Response/message ï¼Œå› æ­¤æœƒå ±éŒ¯ã€‚\nå¾Œä¾†ç™¼ç¾ï¼Œé€™ç¨®å¯«æ³•ä¸æ˜¯åˆæ³•çš„ OpenAPI æ ¼å¼çš„å¯«æ³•ï¼ˆä½†ç”¨ redoc å¯ä»¥ build å‡ºä¾†ï¼‰ï¼Œå› ç‚ºç•¶è·‘ lint çš„æ™‚å€™æœƒå ±éŒ¯ã€‚\nå¦‚æœè¦æ”¹æˆåˆæ³•çš„æ ¼å¼ï¼Œé¦–å…ˆ schema çš„åœ°æ–¹è¦åœ¨æ¯å€‹ Object åº•ä¸‹å¢åŠ  properties å±¬æ€§ï¼š\n1 2 3 4 5 6 7 schemas: Response: properties: # \u0026lt;-------- add this status: description: ç‹€æ…‹ type: integer example: 200 ç„¶å¾Œ $ref path è¦æ”¹æˆ #/components/schemas/Response/properties/message æ‰èƒ½é€šé linter æª¢æŸ¥ã€‚\nä½†å³ä½¿æ”¹æˆäº†åˆæ³•æ ¼å¼ï¼Œåœ¨ç”¨ oapi-codegen ç”Ÿæˆä»£ç¢¼æ™‚é‚„æ˜¯æœƒå ±éŒ¯ã€‚å› ç‚º path ç¸½å±¤æ•¸è®Šæˆ 6 å±¤ï¼Œä¾ç„¶ç„¡æ³•è¢«è§£æã€‚\nè§£æ±ºæ–¹æ³• 1. æ”¹æˆåªä½¿ç”¨å››å±¤çš„ $ref åƒé€™æ¨£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 schemas: Resource: type: object properties: data: type: object properties: items: type: array #...more message: #...more status: #...more paths: #...more responses: \u0026#39;200\u0026#39;: description: OK content: application/json: schema: $ref: \u0026#39;#/components/schemas/Resource\u0026#39; ä½†é€™æ¨£ä¸€ä¾†å°±è®Šå¾—å¾ˆä¸å½ˆæ€§ï¼Œåœ¨å¹¾ä¹æ²’ä»€éº¼ $ref æœƒå¼•ç”¨åˆ°ç›¸åŒå…§å®¹çš„æƒ…æ³ä¸‹ï¼Œé‚„ä¸å¦‚ç›´æ¥ inlineï¼Œè€Œä¸”è¦æ”¹çš„åœ°æ–¹æœ‰é»å¤ªå¤šäº†(æ‡¶)\n2. å…ˆæŠŠæª”æ¡ˆä¿®æ­£æˆå¯ä»¥é€šé OpenAPI çš„ linter æª¢æŸ¥ï¼Œç„¶å¾Œå†ç”¨å·¥å…· å–ä»£æ‰ $ref çš„éƒ¨åˆ† æƒ³èªªåæ­£åªæ˜¯ç‚ºäº†èƒ½å¤ ä½¿ç”¨ä»£ç¢¼ç”Ÿæˆå·¥å…·ï¼Œä¸æƒ³èŠ±å¤ªå¤šç²¾åŠ›å¤§æ”¹åŸæœ¬çš„ OpenAPI æ–‡ä»¶ï¼Œæ–¼æ˜¯æœ€å¾Œæ¡å–äº†é€™å€‹æ–¹æ³•ã€‚\nå‰›å‰›æœ‰ç¨å¾®æåˆ°åŸæœ¬çš„æ ¼å¼è·‘ lint æ™‚æœƒæœ‰éŒ¯èª¤ï¼Œéœ€è¦é€²è¡Œä¿®æ­£ï¼Œåªè¦èƒ½å¤ æˆåŠŸè·‘é linter çš„æª¢æŸ¥ï¼Œå°±å¯ä»¥å†ç”¨å·¥å…·æŠŠ $ref å¼•ç”¨çš„åœ°æ–¹å…¨éƒ½å–ä»£æˆç›¸å°æ‡‰çš„å®šç¾©å…§å®¹ã€‚é€™ç¯‡å•ç­”æœ‰æä¾›å…©ç¨®å·¥å…·éƒ½èƒ½é”æˆé€™å€‹ç›®çš„ï¼Œåœ¨é€™é‚Šæˆ‘å€‘é¸ç”¨äº† redockly-cliï¼ˆæ²’æœ‰ç‚ºä»€éº¼åªæ˜¯æˆ‘å€‘ä¹Ÿæœ‰ç”¨ redocï¼‰ã€‚\nrun linter é¦–å…ˆä¿®æ­£ä¸Šé¢å‰›å‰›æåˆ°çš„ properties å’Œ $ref çš„éƒ¨åˆ†å¾Œï¼Œå°±å¯ä»¥æˆåŠŸè·‘é linterï¼š\n1 $ redocly lint openapi.yaml warning çš„éƒ¨åˆ†ä¸ç”¨ç†ä»–ã€‚\nbundle file and dereferenced ç„¶å¾Œå†å°æª”æ¡ˆè·‘ bundle æŒ‡ä»¤ï¼š\n1 $ redocly bundle --dereferenced openapi.yaml --output openapi_0317.yaml ç„¶å¾Œå†ä¸€æ¬¡è·‘ oapi-codegen æŒ‡ä»¤ï¼š\n1 $ oapi-codegen -package ports openapi_0317.yaml \u0026gt; openapi.gen.go ç¸½ç®—æˆåŠŸ gen å‡ºæª”æ¡ˆå•¦ğŸ‰\nNote åœ¨é è¨­ä¸å¸¶ä»»ä½• -generate åƒæ•¸çš„æƒ…æ³ä¸‹ï¼Œè©²æŒ‡ä»¤æœƒå¹«æˆ‘å€‘ç”¢ç”Ÿæ‰€æœ‰åŒ…å« server, types, client, spec ç­‰ç­‰ç›¸é—œç¨‹å¼ç¢¼åœ¨æŒ‡å®šè¼¸å‡ºçš„æª”æ¡ˆè£¡ï¼Œä¸”é è¨­ä½¿ç”¨çš„ server æ˜¯ Echoã€‚ï¼ˆè©³ç´°èªªæ˜åƒè€ƒæ–‡ä»¶ï¼‰\nå‡è¨­æˆ‘å€‘çš„éœ€æ±‚æ˜¯ä½¿ç”¨ gin ï¼Œä¸¦ä¸”åªéœ€è¦ server å’Œ types éƒ¨åˆ†çš„ç¨‹å¼ç¢¼\nserverï¼šç”Ÿæˆ server æ¥å£ä»¥åŠç›¸é—œçš„ç¨‹å¼ç¢¼ï¼ŒåŒ…æ‹¬å°‡åƒæ•¸ç¶å®šåˆ° structã€åƒæ•¸é¡å‹éŒ¯èª¤ throw Exception çš„è™•ç†ç­‰ç­‰ typesï¼šå®šç¾©åœ¨ OpenAPI components ç•¶ä¸­çš„é¡å‹(struct)ï¼ŒåŒ…å« request params/body å’Œ response body\nä¸¦ä¸”åˆ†åˆ¥æ”¾ç½®æ–¼ä¸åŒæª”æ¡ˆä¸­ï¼Œå¯ä»¥é€™æ¨£åšï¼š\nå…ˆç”¢ç”Ÿ gin server çš„æª”æ¡ˆ\n1 $ oapi-codegen -package ports -generate gin openapi_0317.yaml \u0026gt; openapi_api.gen.go å†ç”¢ç”Ÿ types çš„æª”æ¡ˆ\n1 $ oapi-codegen -package ports -generate types openapi_0317.yaml \u0026gt; openapi_types.gen.go ","date":"Mar 17","permalink":"//localhost:1313/posts/resolve-oapi-codegen-error/","tags":["Golang","OpenAPI"],"title":"è§£æ±ºä½¿ç”¨ oapi-codegen æ™‚å ±éŒ¯ unexpected reference depth"},{"categories":null,"contents":" å‰è¨€ è‡ªå¾å¾ Medium æ›éä¾†è‡ªæ¶éƒ¨è½æ ¼å¾Œï¼ŒSEO çš„äº‹æƒ…ä¹Ÿéƒ½å¾—è‡ªå·±è™•ç†ã€‚ä½†é›–ç„¶èªªæ˜¯ã€Œè™•ç†ã€ï¼Œä¹Ÿåªæ˜¯åšä¸€äº›åŸºæœ¬çš„è¨­å®šè€Œå·²ï¼Œä¾‹å¦‚è£å€‹ Search Consoleã€æäº¤ sitemapï¼ˆä½†å…¶å¯¦ä½¿ç”¨çš„éœæ…‹ç¶²ç«™ç”Ÿç”¢å™¨ Hexo å°±å·²ç¶“æœ‰åšåˆ°è‡ªå‹•ç”Ÿç”¢ã€æ›´æ–° sitemapï¼‰ã€‚å”¯ä¸€çš„æ‰‹å‹•ä½œæ¥­å°±æ˜¯æ¯æ¬¡ç™¼è¡¨æ–°æ–‡ç« å¾Œï¼Œç‚ºäº†åŠ å¿« Google ç´¢å¼•åˆ°æ–°æ–‡ç« é é¢çš„é€Ÿåº¦ï¼Œæˆ‘éƒ½é‚„æ˜¯æœƒé€²åˆ° Search Console å¾Œå°ï¼Œæ‰‹å‹•è¼¸å…¥é é¢ç¶²å€è¦æ±‚å»ºç«‹ç´¢å¼•ï¼ˆç¶²å€å¯©æŸ¥\u0026gt;æ¸¬è©¦ç·šä¸Šç¶²å€\u0026gt;å»ºç«‹ç´¢å¼•)ã€‚\nèº«ç‚ºä¸€å€‹èƒ½å¤ è‡ªå‹•å°±ä¸æ‰‹å‹•çš„æ‡¶äººï¼Œçªç„¶æƒ³åˆ°ä¹‹å‰æ›¾åœ¨å…¬å¸å°ˆæ¡ˆä¸­ä½¿ç”¨é Google Indexing API æäº¤è¦åŠ å…¥ç´¢å¼•çš„ç¶²å€ï¼Œé‚£æˆ‘æ‡‰è©²ä¹Ÿå¯ä»¥ä¾†å¹«æˆ‘çš„éƒ¨è½æ ¼ä¸²çœ‹çœ‹å§ï¼Ÿ\nåœ¨å°‹æ‰¾æ–¹æ³•çš„éç¨‹ä¸­ï¼Œé›–ç„¶åŸæœ¬å°±æ˜¯ä½¿ç”¨ Netlify æ¶ç«™ï¼Œä½†ä¸€å¹´å‰çš„è¨˜æ†¶æœ‰é»æ¨¡ç³Š(å¯èƒ½ä¹Ÿæ˜¯è¤‡è£½è²¼ä¸Šçš„é—œä¿‚)ï¼Œè£¡é¢å¾ˆå¤šåŠŸèƒ½å…¶å¯¦ä¹Ÿæ²’ç¢°éï¼Œä¸­é€”ä¸å°‘æ¬¡å› ç‚ºé‡åˆ°æŸç¨®é™åˆ¶è€Œåˆæ”¹è®ŠåŸæœ¬çš„åš/è§£æ³•ï¼Œè¦ºå¾—é€™å€‹éç¨‹ä¹Ÿæ˜¯å­¸ç¿’åˆ°äº†ä¸å°‘ï¼Œæˆ–æ˜¯æœ‰æ©Ÿæœƒç‚ºå…¶ä»–äººé¿å‘(?)ï¼Œå› æ­¤æœ‰äº†é€™ç¯‡æ–‡ç« ã€‚\nå¯¦ä½œ åˆæ­¥è¦åŠƒ é€™å€‹åŠŸèƒ½çš„æµç¨‹å…¶å¯¦éå¸¸ç°¡å–®ï¼Œå°±æ˜¯â€”â€”ç™¼è¡¨æ–‡ç« å¾Œï¼ˆdeploy æˆåŠŸï¼‰é¦¬ä¸Šè§¸ç™¼æ‰“ Google Indexing API çš„ç¨‹å¼ã€‚\né¦–å…ˆéœ€è¦æ€è€ƒçš„å•é¡Œæ˜¯ï¼Œè¦å¦‚ä½•æ¥æ”¶ deploy å®Œæˆçš„è¨Šæ¯ï¼Ÿ ä»¥åŠ ã€Œæ‰“ Google Indexing API çš„ç¨‹å¼ã€è¦åœ¨å“ªè£¡åŸ·è¡Œï¼Ÿ\nç¬¬ä¸€å€‹æƒ³æ³•æ˜¯ï¼šçœ‹çœ‹ Netlify åœ¨ deploy æˆåŠŸå¾Œï¼Œæœ‰æ²’æœ‰ä»€éº¼äº‹ä»¶å¯ä»¥ç›£è½ã€‚\næ–¼æ˜¯æœå°‹åˆ°äº†å®˜æ–¹æ–‡ä»¶é—œæ–¼ Deploy notifications çš„èªªæ˜ï¼Œæœ‰æ”¯æ´å¤šç¨®æ¥æ”¶é€šçŸ¥çš„æ–¹å¼ï¼ŒSlackã€emailã€webhook ç­‰ç­‰ã€‚çœ‹èµ·ä¾†æ¯”è¼ƒé©åˆçš„æ–¹å¼å¯èƒ½æ˜¯é€é webhookï¼Œå¦å¤–èµ·ä¸€å€‹ http server ä¸¦è¨»å†Šä¸€å€‹ endpointï¼Œserver ä¸€æ¥æ”¶åˆ° request å°±ç«‹åˆ»æ‰“ Google Indexing APIã€‚ ä½†é€™éº¼ä¸€ä¾†ï¼Œå°±é‚„å¾—å¦å¤– run ä¸€å€‹ http serverï¼Œç‚ºäº†å®Œæˆé€™å€‹å°ä»»å‹™é‚„å¾—å†é¡å¤–é–‹ä¸€å€‹æœå‹™ï¼Œç¸½è¦ºå¾—å“ªè£æ€ªæ€ªçš„ã€‚æ‰€ä»¥å¾Œä¾†åˆæ‰¾äº†ä¸€ä¸‹æœ‰æ²’æœ‰å…¶ä»–æ›´é©åˆçš„åšæ³•ï¼Œçµæœå°±çœ‹åˆ°äº† Netlify Functionsã€‚\nä»€éº¼æ˜¯ Netlify Functions Netlify Functions æ˜¯ Netlify æä¾›çš„ä¸€å€‹é¡ä¼¼ aws lamda çš„åŠŸèƒ½(å¯¦éš›ä¸Šä¹Ÿæ˜¯åŸºæ–¼ aws lamda å»å¯¦ç¾çš„)ï¼Œå¯ä»¥è¼•æ˜“åœ°éƒ¨ç½² serverless çš„æœå‹™ã€‚\nç„¶è€Œ functions éƒ½æ˜¯åŸºæ–¼å°ˆæ¡ˆ(ä¹Ÿå°±æ˜¯é€é Netlify æ‰€æ§‹å»ºçš„ç¶²ç«™)ï¼Œä¸€å€‹å°ˆæ¡ˆåº•ä¸‹å¯ä»¥æœ‰å¤šå€‹ functionsï¼Œé€™äº› functions éœ€è¦è¢«æ”¾åœ¨ç‰¹å®šè³‡æ–™å¤¾ä¸‹é¢æ‰æœƒä¸€åŒè·Ÿè‘—å°ˆæ¡ˆè¢«éƒ¨ç½²ã€‚ï¼ˆé è¨­çš„è³‡æ–™å¤¾ä½ç½®åœ¨ YOUR_BASE_DIRECTORY/netlify/functions/ï¼Œå¯ä»¥è‡ªè¡Œé€éè¨­å®šæ›´æ”¹)\nè€Œé€™äº›éƒ¨ç½²åœ¨ç·šä¸Šçš„ functionsï¼Œéƒ½å¯ä»¥è—‰ç”±ç‰¹å®šçš„è·¯ç”±å»è§¸ç™¼åŸ·è¡Œã€‚ ä¾‹å¦‚ï¼Œä¸€å€‹ç”¨ JavaScript å¯«çš„ functions æª”æ¡ˆåç‚º hello.jsï¼Œè¢«æ”¾åœ¨ netlify/functions/ åº•ä¸‹ï¼Œå®Œæ•´è·¯å¾‘æ˜¯ï¼š\nYOUR_BASE_DIRECTORY/netlify/functions/hello.js å°æ‡‰çš„è·¯ç”±å°±æ˜¯ï¼š\nBASE_URL_OF_YOUR_SITE/.netlify/functions/hello åªè¦æˆ³é€™å€‹ endpointï¼Œéš¨ä¾¿ä¸€ç¨® Http Method éƒ½å¯ä»¥ï¼Œå°±èƒ½è§¸ç™¼é€™å€‹ functionã€‚\nğŸ“ Note: ç›®å‰ functions æ”¯æ´çš„ç¨‹å¼èªè¨€åªæœ‰ Typescriptã€JavaScript ä»¥åŠ Golang ã€‚\nä½†æ¥è‘—åˆæƒ³åˆ°ä¸€ä»¶äº‹ï¼Œæ—¢ç„¶ functions éƒ½æ˜¯åœ¨å°ˆæ¡ˆåº•ä¸‹ï¼Œé‚£ä»–æ˜¯å¦èƒ½é€éæŸç¨®æ–¹å¼ç›£è½åˆ°å°ˆæ¡ˆçš„éƒ¨ç½²æˆåŠŸäº‹ä»¶ï¼Œåªè¦å°ˆæ¡ˆä¸€éƒ¨ç½²æˆåŠŸï¼Œå°±è‡ªå‹• call é€™å€‹ functionï¼Œä¹Ÿä¸éœ€è¦è¨­å®š webhook url äº†ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼ŒNetlify æä¾›äº†ä¸€ç³»åˆ—çš„ triggersï¼Œåªè¦å°‡ functions æŒ‰ç…§äº‹ä»¶åç¨±å‘½åï¼Œå°±æœƒåœ¨è©²äº‹ä»¶ç™¼ç”Ÿæ™‚ï¼Œç›´æ¥åŸ·è¡ŒåŒå functionã€‚äº‹ä»¶ç•¶ä¸­ç•¶ç„¶ä¹ŸåŒ…æ‹¬éƒ¨ç½²æˆåŠŸäº‹ä»¶ deploy-succeeded ï¼Œæ‰€ä»¥åªè¦å°‡ function å‘½åç‚º deploy-succeededï¼Œfunction å°±æœƒåœ¨å°ˆæ¡ˆéƒ¨ç½²å®Œæˆæ™‚è¢«åŸ·è¡Œã€‚\nä½¿ç”¨ Netlify Functions ç¸½ç®—é€²å…¥åˆ°å¯¦ä½œçš„ç’°ç¯€å•¦!åœ¨é€™é‚Šæœƒä½¿ç”¨ Golang é€²è¡Œå¯¦ä½œã€‚ é¦–å…ˆï¼Œåœ¨å°ˆæ¡ˆåº•ä¸‹æ–°å»ºæª”æ¡ˆ netlify/functions/deploy-succeeded/deploy-succeeded.go\nğŸ“ Note: ç”±æ–¼ä½¿ç”¨ Golangï¼Œä¸€å€‹ function æœƒè¦–ä½œç‚ºä¸€å€‹ Go moduleï¼Œè£¡é¢åŒ…å«ä¸€å€‹æœ‰ main function çš„æª”æ¡ˆï¼Œæ‰€ä»¥éœ€è¦ç”¨è³‡æ–™å¤¾ä¾†åˆ†å±¤ã€‚ä½†å¦‚æœä½¿ç”¨ JS å°±ä¸éœ€è¦è³‡æ–™å¤¾åˆ†å±¤ï¼Œä¸€å€‹æª”æ¡ˆå°±æ˜¯ä¸€å€‹ functionã€‚\nä»¥ä¸‹æ˜¯å®˜æ–¹æ–‡ä»¶æä¾›çš„ function ç¯„æœ¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // ./netlify/functions/deploy-succeeded/deploy-succeeded.go package main import ( \u0026#34;github.com/aws/aws-lambda-go/events\u0026#34; \u0026#34;github.com/aws/aws-lambda-go/lambda\u0026#34; ) func handler(request events.APIGatewayProxyRequest) (*events.APIGatewayProxyResponse, error) { // é€™é‚Šæ˜¯ function çš„é‚è¼¯ } func main() { // é€™å¡Šä¸éœ€è¦å‹• lambda.Start(handler) } æƒ³è¦å…ˆæ¸¬è©¦çœ‹çœ‹ï¼Œæ˜¯å¦é€™å€‹ function çœŸçš„æœƒåœ¨æ¯æ¬¡éƒ¨ç½²å®Œæˆå¾Œè¢«è§¸ç™¼åŸ·è¡Œï¼Œä¹Ÿé †ä¾¿çœ‹çœ‹æ”¶åˆ°çš„ request payload æœƒæ˜¯ä»€éº¼ï¼Œæ‰€ä»¥åœ¨ handler æ–¹æ³•è£¡é¢åŠ ä¸Šï¼š\n1 2 3 4 func handler(request events.APIGatewayProxyRequest) (*events.APIGatewayProxyResponse, error) { // è©¦è‘—æŠŠ request.Body å°å‡ºä¾† fmt.Println(request.Body) } çµæœç™¼ç¾çœŸçš„æœ‰è¢«åŸ·è¡Œï¼Œæˆ‘å€‘å¯ä»¥åˆ° Netlify å¾Œå°å»çœ‹ function çš„ logã€‚é€²å…¥ https://app.netlify.com/sites/{your_site}/functions ï¼Œé»é¸å‰›å‰› deploy çš„ functionï¼š å°±å¯ä»¥é€²åˆ°è©² function çš„é é¢ç€è¦½ logï¼š log å°å‡ºä¾†çš„å…§å®¹å¤§æ¦‚é•·é€™æ¨£ï¼Œä½†å› çˆ²è³‡æ–™æœ‰é»å¤ªå¤šï¼Œé€™é‚Šå°±æ²’è²¼å®Œæ•´å…§å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 // æ•æ„Ÿè³‡è¨Šæœ‰ç”¨*è™Ÿé®ç½© { \u0026#34;payload\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;63f9e14********6916d\u0026#34;, \u0026#34;site_id\u0026#34;: \u0026#34;********-6b6d-4df7-a413-********\u0026#34;, \u0026#34;build_id\u0026#34;: \u0026#34;63f9e144bb8728000846916b\u0026#34;, \u0026#34;state\u0026#34;: \u0026#34;ready\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;emmielin\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://emmie.work\u0026#34;, \u0026#34;ssl_url\u0026#34;: \u0026#34;https://emmie.work\u0026#34;, \u0026#34;admin_url\u0026#34;: \u0026#34;https://app.netlify.com/sites/emmielin\u0026#34;, \u0026#34;deploy_url\u0026#34;: \u0026#34;http://main--emmielin.netlify.app\u0026#34;, \u0026#34;deploy_ssl_url\u0026#34;: \u0026#34;https://main--emmielin.netlify.app\u0026#34;, \u0026#34;created_at\u0026#34;: \u0026#34;2023-02-25T10:21:56.064Z\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2023-02-25T10:22:11.735Z\u0026#34;, \u0026#34;user_id\u0026#34;: \u0026#34;************************\u0026#34;, \u0026#34;error_message\u0026#34;: null, \u0026#34;required\u0026#34;: [], \u0026#34;required_functions\u0026#34;: [], \u0026#34;commit_ref\u0026#34;: \u0026#34;f3fb856c951b6979f22********90\u0026#34;, \u0026#34;review_id\u0026#34;: null, \u0026#34;branch\u0026#34;: \u0026#34;main\u0026#34;, \u0026#34;commit_url\u0026#34;: \u0026#34;https://github.com/linxinemily/hugo-emmie-blog/commit/f3fb856c951b6979f22ffad191843dc831164690\u0026#34;, \u0026#34;skipped\u0026#34;: null, \u0026#34;locked\u0026#34;: null, \u0026#34;log_access_attributes\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;firebase\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;https://netlify-builds9.firebaseio.com/builds/63f9e144bb8728000846916b/log\u0026#34;, \u0026#34;database\u0026#34;: \u0026#34;netlify-builds9\u0026#34;, \u0026#34;endpoint\u0026#34;: \u0026#34;https://netlify-builds9.firebaseio.com\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/builds/63f9e144bb8728000846916b/log\u0026#34;, \u0026#34;token\u0026#34;: \u0026#34;************************\u0026#34;, }, \u0026#34;title\u0026#34;: \u0026#34;commit msg\u0026#34;, // more info... }, \u0026#34;site\u0026#34;: { \u0026#34;id\u0026#34;: \u0026#34;********-6b6d-4df7-a413-********\u0026#34;, \u0026#34;site_id\u0026#34;: \u0026#34;********-6b6d-4df7-a413-********\u0026#34;, \u0026#34;plan\u0026#34;: \u0026#34;nf_team_dev\u0026#34;, \u0026#34;ssl_plan\u0026#34;: null, \u0026#34;premium\u0026#34;: false, \u0026#34;claimed\u0026#34;: true, \u0026#34;name\u0026#34;: \u0026#34;emmielin\u0026#34;, \u0026#34;custom_domain\u0026#34;: \u0026#34;emmie.work\u0026#34;, \u0026#34;domain_suffix_branch\u0026#34;: null, \u0026#34;domain_suffix_deploy_preview\u0026#34;: null, \u0026#34;domain_aliases\u0026#34;: [], \u0026#34;password\u0026#34;: null, \u0026#34;password_hash\u0026#34;: null, \u0026#34;sso_login\u0026#34;: false, \u0026#34;sso_login_context\u0026#34;: \u0026#34;all\u0026#34;, \u0026#34;notification_email\u0026#34;: null, \u0026#34;url\u0026#34;: \u0026#34;https://emmie.work\u0026#34;, \u0026#34;admin_url\u0026#34;: \u0026#34;https://app.netlify.com/sites/emmielin\u0026#34;, \u0026#34;deploy_id\u0026#34;: \u0026#34;63f9e14********6916d\u0026#34;, \u0026#34;build_id\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;deploy_url\u0026#34;: \u0026#34;http://main--emmielin.netlify.app\u0026#34;, \u0026#34;state\u0026#34;: \u0026#34;current\u0026#34;, \u0026#34;screenshot_url\u0026#34;: null, \u0026#34;created_at\u0026#34;: \u0026#34;2022-07-18T16:18:18.628Z\u0026#34;, \u0026#34;updated_at\u0026#34;: \u0026#34;2023-02-25T10:22:11.738Z\u0026#34;, \u0026#34;user_id\u0026#34;: \u0026#34;************************\u0026#34;, \u0026#34;error_message\u0026#34;: null, \u0026#34;ssl\u0026#34;: true, \u0026#34;ssl_url\u0026#34;: \u0026#34;https://emmie.work\u0026#34;, \u0026#34;force_ssl\u0026#34;: true, \u0026#34;ssl_status\u0026#34;: null, \u0026#34;max_domain_aliases\u0026#34;: 100, // more info... } } å¦‚æœè¦åœ¨ local é–‹ç™¼ function çš„è©±ï¼Œå¯ä»¥å®‰è£ Netlify CLIï¼Œåœ¨å°ˆæ¡ˆåº•ä¸‹è·‘ï¼š\n$ netlify functions:serve æˆåŠŸè·‘èµ·ä¾†çš„è©±é è¨­æœƒåœ¨ 9999 portï¼š ç„¶å¾Œå°±å¯ä»¥ç”¨ Postman æ‰“ function çš„ endpointï¼š å¦‚ä½•å–å¾—æ–°æ–‡ç«  URL ç¢ºå®š Netlify Functions å¯ä»¥é”æˆæˆ‘å€‘çš„éœ€æ±‚å¾Œï¼Œåœ¨ä¸²æ¥ Indexing API å‰ï¼Œç¸½å¾—çŸ¥é“è©²æ€éº¼æŠŠæ–°æ–‡ç« çš„ç¶²å€æ¨é€çµ¦ Indexing API å§ï¼\nåŸæœ¬çš„æƒ³æ³•æ˜¯ï¼Œç”±æ–¼ Hugo æ¯æ¬¡ build çš„æ™‚å€™éƒ½æœƒè‡ªå‹•å¹«æˆ‘å€‘æ›´æ–° sitemap æª”æ¡ˆï¼Œå› æ­¤æˆ–è¨±å¯ä»¥é€éæ–°èˆŠ sitemap çš„æ¯”å°æª¢æŸ¥æ˜¯å¦æœ‰æ–°å¢çš„ page urlï¼Œå¦‚æœæœ‰çš„è©±å°±æŠŠé€™äº› url æ¨é€çµ¦ Google Indexing APIã€‚ä½†å•é¡Œå°±ä¾†äº†ï¼Œè¦æœ‰èˆŠæª”æ¡ˆå¯ä»¥æ‹¿å‡ºä¾†æ¯”è¼ƒï¼Œé‚£å°±å¾—åœ¨æ¯æ¬¡åŸ·è¡Œé€™å€‹ function å®Œå­˜ä¸‹ç•¶å‰çš„ sitemap æª”æ¡ˆï¼Œé€™æ¨£æ‰èƒ½åœ¨ä¸‹ä¸€æ¬¡åŸ·è¡Œ function æ™‚ï¼Œå–å¾—ä¸Šæ¬¡å­˜ä¸‹çš„ sitemap æª”æ¡ˆèˆ‡æ–°çš„åšæ¯”å°ã€‚ç„¶è€Œï¼Œåœ¨ functions ç•¶ä¸­ç„¡æ³•å°å°ˆæ¡ˆé€²è¡Œæª”æ¡ˆçš„è®€å¯«ï¼Œ(æœ‰äººç™¼å•è¢«å®˜æ–¹å›è¦†åœ¨æ­¤)ï¼Œé€™éº¼ä¸€ä¾†é‚„å¾—å¦å¤–æ‰¾ä¸€å€‹å¤–éƒ¨ç©ºé–“ä¾‹å¦‚ AWS S3 ä¹‹é¡çš„å»å­˜æ”¾é€™å€‹æª”æ¡ˆï¼Œè¦ºå¾—æœ‰é»å¤ªéº»ç…©äº†ï¼Œè€Œä¸”é€™å€‹åŠŸèƒ½æ‡‰è©²ä¹Ÿä¸éœ€è¦åšåˆ°é€™éº¼è‡ªå‹•åŒ–(ç•¢ç«Ÿæš«æ™‚åªæœ‰æˆ‘è¦ç”¨)ã€‚\næ‰€ä»¥å¾Œä¾†ç™¼ç¾ payload ç•¶ä¸­æœ‰ä¸€å€‹æ¬„ä½ payload.title æ˜¯æ¯æ¬¡ commit çš„è¨Šæ¯ï¼Œå› çˆ² Netlify çš„è¨­å®šæ˜¯ä¸€ push commit å°±æœƒè§¸ç™¼ deployï¼Œæ‰€ä»¥æ¯æ¬¡ deploy ä¸€å®šéƒ½æœƒæœ‰ä¸€å€‹ commit msgã€‚æ–¼æ˜¯æƒ³åˆ°å¯ä»¥ç›´æ¥åˆ©ç”¨ commit msg å¸¶å…¥æ–°æ–‡ç« çš„ slugï¼Œåœ¨ payload ä¸­å–å¾— payload.title è§£æå‡º slug å­—ä¸²å¾Œçµ„å‡ºæ–°æ–‡ç« çš„ç¶²å€ã€‚é›–ç„¶å¥½åƒæœ‰é»åœŸæ³•ç…‰é‹¼ï¼Œä¸éæ„Ÿè¦ºé‚„æŒºå¯è¡Œçš„ã€‚\nä¸²æ¥ Google Indexing API ç¢ºå®šè³‡æ–™çš„å–å¾—éƒ½æ²’å•é¡Œå¾Œï¼Œæ¥ä¸‹ä¾†å°±æ˜¯é€²å…¥ä¸²æ¥ Indexing API çš„éƒ¨åˆ†äº†ã€‚å®Œæˆå®˜æ–¹æ–‡ä»¶äº‹å‰æº–å‚™çš„æ­¥é©Ÿã€Œç‚ºç”¨æˆ¶ç«¯å»ºç«‹å°ˆæ¡ˆã€ã€ã€Œå»ºç«‹æœå‹™å¸³æˆ¶ã€ã€ã€Œå°‡æœå‹™å¸³æˆ¶æ–°å¢ç‚ºç¶²ç«™æ“æœ‰è€…ã€ä¹‹å¾Œï¼Œå°±å¯ä»¥æ ¹æ“šè¦ä½¿ç”¨çš„ç¨‹å¼èªè¨€å®‰è£ google api sdk ç¨‹å¼ï¼Œé€™é‚Šé¸æ“‡ä½¿ç”¨ Golang çš„ sdkã€‚\nå‰›å‰›ç¬¬äºŒå€‹æ­¥é©Ÿã€Œå»ºç«‹æœå‹™å¸³æˆ¶ã€æ™‚ï¼Œä¸‹è¼‰äº†ä¸€å€‹é‡‘é‘°æª”æ¡ˆ(æŒ‰ç…§å»ºè­°æª”æ¡ˆé¡å‹é¸æ“‡JSON)å­˜åœ¨æœ¬åœ°é›»è…¦è£¡ï¼Œä½¿ç”¨é€™å€‹é‡‘é‘°çš„æ–¹å¼å¾ˆç°¡å–®ï¼Œæœ¬åœ°ç«¯é–‹ç™¼çš„è©±ï¼Œåªè¦åœ¨å‘½ä»¤åˆ—å®£å‘Šå€‹ç’°å¢ƒè®Šæ•¸ï¼šRef\n$ export GOOGLE_APPLICATION_CREDENTIALS=\u0026#34;KEY_PATH\u0026#34; //KEY_PATH å–ä»£ç‚ºå‰›å‰›ä¸‹è¼‰çš„é‡‘é‘°æª”æ¡ˆè·¯å¾‘ å…ˆæ¸¬è©¦ä¸€ä¸‹ä¸²æ¥æœ‰æ²’æœ‰æˆåŠŸï¼Œå¸¶å€‹æ¸¬è©¦ç¶²å€ç™¼é€çœ‹çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // ./netlify/functions/deploy-succeeded/deploy-succeeded.go package main import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;github.com/aws/aws-lambda-go/events\u0026#34; \u0026#34;github.com/aws/aws-lambda-go/lambda\u0026#34; \u0026#34;google.golang.org/api/indexing/v3\u0026#34; ) func handler(request events.APIGatewayProxyRequest) (*events.APIGatewayProxyResponse, error) { ctx := context.Background() indexingService, err := indexing.NewService(ctx) if err != nil { log.Fatalln(err) } fullUrl := \u0026#34;https://emmie.work/posts/test\u0026#34; //å…ˆå¯«æ­»ä¸€å€‹æ¸¬è©¦ç¶²å€ notification := \u0026amp;indexing.UrlNotification{ Url: fullUrl, Type: \u0026#34;URL_UPDATED\u0026#34;, } res, err := indexingService.UrlNotifications.Publish(notification).Do() if err != nil { log.Fatalln(err) } log.Println(res.ServerResponse) return \u0026amp;events.APIGatewayProxyResponse{ StatusCode: 200, Body: fmt.Sprintf(\u0026#34;Success send request to notify Google of new article, url: %s\u0026#34;, fullUrl), }, nil } func main() { lambda.Start(handler) } åœ¨åŒå€‹å‘½ä»¤åˆ— session ä¸‹å‰›å‰›çš„ netlify functions:serve æŒ‡ä»¤ï¼Œçœ‹èµ·ä¾†æ˜¯ work çš„ã€‚ OKï¼Œå•é¡Œåˆä¾†äº†ï¼Œç•¶é€™æ®µç¨‹å¼è¦æ”¾åœ¨ Netlify ä¸Šé¢è·‘æ™‚ï¼Œé›£ä¸æˆè¦æŠŠé€™å€‹é‡‘é‘°æª”æ¡ˆä¹Ÿé€£åŒä¸Šå‚³åˆ° github repo å—ï¼Œè½èµ·ä¾†æœ‰é»ä¸å¤ªå®‰å…¨ï¼Œè€Œä¸”é‚„è¨˜å¾—å‰›å‰›æåˆ° function è£¡é¢ç„¡æ³•å­˜å–å°ˆæ¡ˆç•¶ä¸­çš„æª”æ¡ˆï¼Œæ‰€ä»¥é€™æ¢è·¯ä¹Ÿä¸å¯è¡Œã€‚é‚£è©²æ€è¾¦å‘¢ï¼Ÿå¾Œä¾†çœ‹åˆ°æœ‰ç¶²å‹ä¹Ÿæœ‰é¡ä¼¼å•é¡Œï¼ˆä½†æˆ‘çªç„¶æ‰¾ä¸åˆ°åŸç™¼å•é€£çµï¼‰ï¼Œç¸½ä¹‹æœ€å¾Œæ¡ç”¨çš„æ–¹æ³•æ˜¯å°‡ç’°å¢ƒè®Šæ•¸çš„å€¼æ”¹æˆé‡‘é‘° JSON æª”å…§å®¹ï¼Œç„¶å¾Œåœ¨ç¨‹å¼è£¡é¢å–å¾—ç’°å¢ƒè®Šæ•¸çš„å€¼å¾Œï¼Œé€é option è¨­å®šé‡‘é‘°çš„å€¼ï¼š\n$ export GOOGLE_APPLICATION_CREDENTIALS=\u0026#39;{ \u0026#34;type\u0026#34;: \u0026#34;service_account\u0026#34;, \u0026#34;project_id\u0026#34;: \u0026#34;emmie-hugo-blog\u0026#34;, \u0026#34;private_key_id\u0026#34;:\u0026#34;xxxxxx\u0026#34;, //... }\u0026#39; 1 2 3 4 5 6 func handler(request events.APIGatewayProxyRequest) (*events.APIGatewayProxyResponse, error) { //... credentialJsonStr := os.Getenv(\u0026#34;GOOGLE_APPLICATION_CREDENTIALS\u0026#34;) indexingService, err := indexing.NewService(ctx, option.WithCredentialsJSON([]byte(credentialJsonStr))) //... } é€™æ¨£ä¸€ä¾†ï¼Œå°±èƒ½å¤ å–®ç´”é€éè¨­å®šç’°å¢ƒè®Šæ•¸çš„å€¼å–ä»£éœ€è¦å­˜å–æª”æ¡ˆçš„æ–¹å¼ã€‚ä½†è¦åœ¨éƒ¨ç½²æ™‚åŠ ä¸Šé€™å€‹è®Šæ•¸ï¼Œæˆ‘å€‘é‚„å¾—å†åšå…©å€‹å‹•ä½œï¼Œä¸€æ˜¯åœ¨ ./netlify.toml æª”æ¡ˆï¼Œè¨­å®šç’°å¢ƒè®Šæ•¸çš„ KEYï¼š\n1 2 3 4 # ./netlify.toml [context.production.environment] HUGO_ENV = \u0026#34;production\u0026#34; GOOGLE_APPLICATION_CREDENTIALS = \u0026#34;$GOOGLE_APPLICATION_CREDENTIALS\u0026#34; äºŒæ˜¯åˆ° Netlify å¾Œå°è¨­å®šç’°å¢ƒè®Šæ•¸çš„å€¼ï¼š ç„¶å¾Œå°±å¤§åŠŸå‘Šæˆäº†ï¼ï¼\né€™é‚Šç›´æ¥é™„ä¸Šæœ€å¾Œå®Œæˆçš„ codeï¼š https://github.com/linxinemily/google-indexing-netlify-function/blob/main/deploy-succeeded.go\nå†ä¾†æ¸¬è©¦çœ‹çœ‹ç™¼ä¸€å€‹ commit ç„¶å¾Œ push:\ngit commit -m \u0026#34;new article: netlify-function-google-indexing-api\u0026#34; \u0026amp;\u0026amp; git push é©—è­‰ä¸€ä¸‹æ˜¯å¦æœ‰æˆåŠŸæäº¤ç´¢å¼•ï¼Œåˆ°å¾Œå°çœ‹ function æœ‰æ²’æœ‰ logï¼Œæœ‰é¡¯ç¤ºä»£è¡¨æˆåŠŸï¼š å¾Œè¨˜ ä»¥ä¸Šï¼Œå¤§æ¦‚å°±å®Œæˆäº† 90% çš„äººå·¥ä½œæ¥­ï¼ˆå‰©ä¸‹ 10ï¼… æ˜¯è¦è‡ªå·±æ‰“ commit msg çš„éƒ¨åˆ†ï¼‰ï¼Œä¸éä¹Ÿå·²ç¶“å¿ƒæ»¿æ„è¶³äº†ï¼æ¯”è¼ƒå¤§çš„æ”¶ç©«å°±æ˜¯ç™¼æ˜äº† Netlify Functions é€™å€‹ä¸éŒ¯ç”¨çš„åŠŸèƒ½ï¼Œä»¥åŠé‡æº«ä¸€ä¸‹ä¸² Google API çš„å›æ†¶ã€‚ ç¾åœ¨èƒ½æƒ³åˆ°å”¯ä¸€çš„ç¼ºé™·æ˜¯ï¼Œç•¶ä¸€æ¬¡æ¨å¤šå€‹ commit æ™‚ï¼Œç”±æ–¼ deploy çš„ payload åªæœƒæœ‰æœ€æ–°ä¸€å€‹ commit çš„ç›¸é—œè³‡è¨Šï¼Œæ‰€ä»¥å¦‚æœé€™å¹¾å€‹ commit éƒ½åŒ…å«æœ‰ä¸€ç¯‡æ–°æ–‡ç« ï¼Œé‚£å°±åªæœ‰æœ€å¾Œç™¼çš„é‚£å€‹ commit çš„æ–‡ç« æœƒè¢«æäº¤ç´¢å¼•ï¼Œä¸éæˆ‘å¯«æ–‡é »ç‡æ²’æœ‰é«˜æˆé‚£æ¨£æ‰€ä»¥æ‡‰è©²æ˜¯ä¸å¤ªå¯èƒ½æœƒé‡åˆ°é€™ç¨®æƒ…æ³ï¼Œæ‰€ä»¥å°±å…ˆç•¥éäº†ã€‚å‰©ä¸‹çš„éƒ¨åˆ†å°±çœ‹æœªä¾†æœ‰æ²’æœ‰é‡åˆ°ä»€éº¼ä½¿ç”¨ä¸Šçš„å›°é›£å†ä¾†å„ªåŒ–å§ï¼\n","date":"Feb 27","permalink":"//localhost:1313/posts/netlify-function-google-indexing-api/","tags":["Golang","Third-Party Integration"],"title":"è®“æ¶åœ¨ Netlify ä¸Šçš„ç¶²ç«™ç™¼æ–‡åŒæ™‚å‘ Google è¦æ±‚ç‚ºæ–°é é¢å»ºç«‹ç´¢å¼•! - ä½¿ç”¨ Netlify Functions ä¸²æ¥ Google Indexing API"},{"categories":null,"contents":"å‰å¹¾å¤©é–±è®€åˆ°é€™ç¯‡å®˜æ–¹ wiki ï¼Œå…¶ä¸­çš„ Using reference to loop iterator variableï¼Œä¹Ÿå°±æ˜¯é—œæ–¼åœ¨è¿´åœˆç•¶ä¸­å¼•ç”¨è¿­ä»£è®Šæ•¸å¸¸çŠ¯çš„éŒ¯èª¤ã€‚ç•¶ä¸­æœ‰å€‹ç¯„ä¾‹ä¸€é–‹å§‹è®“æˆ‘ä¸æ˜¯å¾ˆç†è§£ï¼Œå¾Œä¾†çµ‚æ–¼ææ‡‚ï¼Œæ‰€ä»¥æ‰æƒ³èªªç­†è¨˜ä¸‹ä¾†ï¼Œä¹Ÿé †ä¾¿é‡æ¸…ä¸€ä¸‹æ€è·¯ã€‚\né¦–å…ˆï¼Œç¬¬ä¸€å€‹ç¯„ä¾‹æ»¿å¥½ç†è§£çš„ï¼š\n1 2 3 4 5 6 7 8 func main() { var out []*int for i := 0; i \u0026lt; 3; i++ { out = append(out, \u0026amp;i) } fmt.Println(\u0026#34;Values:\u0026#34;, *out[0], *out[1], *out[2]) fmt.Println(\u0026#34;Addresses:\u0026#34;, out[0], out[1], out[2]) } è¼¸å‡ºçš„çµæœæœƒæ˜¯ï¼š\nValues: 3 3 3 Addresses: 0x40e020 0x40e020 0x40e020 åŸå› æ˜¯ï¼Œç”±æ–¼ append åˆ° out é€™å€‹ slice çš„åƒæ•¸æ˜¯ \u0026amp;i ï¼Œå‚³å…¥çš„æ˜¯ä¸€å€‹ int é¡å‹çš„è®Šæ•¸æŒ‡æ¨™ï¼ˆ out çš„å‹åˆ¥ä¹Ÿæ˜¯ä¸€å€‹ å­˜æ”¾å¤šå€‹ int é¡å‹çš„è®Šæ•¸æŒ‡æ¨™ çš„ sliceï¼‰ï¼Œæ‰€ä»¥æ¯å€‹è¿­ä»£éƒ½æ˜¯æŠŠåŒä¸€å€‹è®Šæ•¸æŒ‡æ¨™ append åˆ° out è£¡é¢ï¼Œå› æ­¤ç•¶è¿­ä»£åˆ°æœ€å¾Œä¸€æ¬¡æ™‚ï¼Œè©²è®Šæ•¸æŒ‡æ¨™è£¡é¢å­˜æ”¾çš„å€¼å·²ç¶“è®Šæˆ 3 ï¼Œæ‰€ä»¥å°å‡ºä¾†å°±æ˜¯éƒ½æ˜¯ 3 ã€‚\nè€Œè§£æ±ºçš„è¾¦æ³•å°±æ˜¯æŠŠ i çš„å€¼è¤‡è£½åˆ°å¦ä¸€å€‹æ–°è®Šæ•¸ä¸Šï¼š\n1 2 3 4 for i := 0; i \u0026lt; 3; i++ { i := i // Copy i into a new variable. out = append(out, \u0026amp;i) } é€™æ¨£ä¸€ä¾†ï¼Œ å°±èƒ½ä¿è­‰æ¯æ¬¡è¿­ä»£ç•¶ä¸­çš„ \u0026amp;i å°±æ˜¯ç•¶å‰è¿­ä»£æ‰€å‰µé€ çš„æ–°è®Šæ•¸çš„æŒ‡æ¨™ï¼Œä¸æœƒå°è‡´éé æœŸçš„çµæœï¼Œä¹Ÿè®“åŸæœ¬åªèƒ½å­˜æ´»åœ¨ for scope ç•¶ä¸­çš„è®Šæ•¸ i èƒ½å¤ åœ¨è¿´åœˆä¹‹å¤–è¢«å¼•ç”¨ï¼Œä¸æœƒåœ¨è¿´åœˆçµæŸå¾Œå°±è¢«å›æ”¶ã€‚\næ¥ä¸‹ä¾†çš„å¦ä¸€å€‹ç¯„ä¾‹ï¼Œå°±æ˜¯è®“æˆ‘ä¸€é–‹å§‹ä¸æ˜¯å¾ˆèƒ½ç†è§£çš„åœ°æ–¹ï¼š\n1 2 3 4 5 6 7 func main() { var out [][]int for _, i := range [][1]int{{1}, {2}, {3}} { out = append(out, i[:]) } fmt.Println(\u0026#34;Values:\u0026#34;, out) } ä»¥ä¸Šç¨‹å¼çš„è¼¸å‡ºæ˜¯ï¼š\nValues: [[3] [3] [3]] ä½†å¦‚æœç•¶åªæ”¹å‹•ä¸€å€‹åœ°æ–¹ï¼š\n1 2 3 4 5 6 7 func main() { var out [][]int for _, i := range [][]int{{1}, {2}, {3}} { // æŠŠé•·åº¦ 1 æ‹¿æ‰ out = append(out, i[:]) } fmt.Println(\u0026#34;Values:\u0026#34;, out) } ä»¥ä¸Šçš„è¼¸å‡ºå°±è®Šæˆé æœŸçš„çµæœï¼š\nValues: [[1] [2] [3]] ..ç­‰ç­‰ï¼Œä¸æ˜¯æ‰å·®ä¸€å€‹å­—å—ï¼Ÿå¯¦éš›ææ‡‚å¾Œï¼Œå·®ä¸€å€‹å­—ä½†å…¶å¯¦å·®å¾ˆå¤šï¼Œå› ç‚ºé€™å…©å€‹ç¯„ä¾‹ç•¶ä¸­çš„è¿­ä»£è®Šæ•¸é¡å‹å®Œå…¨ä¸åŒã€‚\nåŸæœ¬çš„ç¯„ä¾‹ç•¶ä¸­ï¼Œè¢«è¿­ä»£çš„ slice è£é¢æ”¾çš„æ˜¯ é•·åº¦ç‚º 1 ä¸”å…§å®¹ç‰©ç‚º int é¡å‹ çš„é™£åˆ—ï¼š [][1]int{{1}, {2}, {3}} ï¼Œè€Œå¾Œé¢æ›´å‹•çš„ç‰ˆæœ¬ï¼Œè¢«è¿­ä»£çš„ slice è£¡é¢æ”¾çš„æ˜¯å¦ä¸€å€‹ sliceï¼š [][]int{{1}, {2}, {3}} ã€‚å› ç‚ºåœ¨ Golang ç•¶ä¸­ï¼Œå®£å‘Šé™£åˆ—å’Œ slice çš„å¯«æ³•å¾ˆåƒï¼Œå·®åˆ¥åœ¨æ–¼é™£åˆ—æ˜¯éœ€è¦æŒ‡å®šé•·åº¦çš„ï¼Œä¸æŒ‡å®šé•·åº¦çš„è©±æœƒè®Šæˆ sliceã€‚\n1 2 var a [1]int // å¸¶æŒ‡å®šé•·åº¦æœƒæ˜¯é™£åˆ— var b []int // ä¸å¸¶é•·åº¦æœƒæ˜¯ slice è€Œä¸”é™£åˆ—å’Œå…¶ä»–ç´”å€¼é¡å‹ä¸€æ¨£æ˜¯å±¬æ–¼ value typeã€‚ä¹Ÿå°±æ˜¯ç•¶æŠŠé™£åˆ—è³¦å€¼çµ¦å¦ä¸€å€‹è®Šæ•¸æ™‚ï¼Œç­‰åŒæ‹·è²ä¸€ä»½ä¸€æ¨£çš„é™£åˆ—é€²å»æ–°çš„è®Šæ•¸ï¼ŒåŸå§‹é™£åˆ—ä¸æœƒå—åˆ°è©²æ–°é™£åˆ—çš„æ›´å‹•å½±éŸ¿ï¼š\n1 2 3 4 5 arr := [1]int{1} arr2 := arr arr2[0] = 2 fmt.Println(arr) // output: [1] å› æ­¤ï¼Œåœ¨å…©å€‹ç¯„ä¾‹ç•¶ä¸­ i[:] æ‰€ä»£è¡¨çš„æ„ç¾©å°±ä¸åŒã€‚ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­çš„ i æ˜¯é™£åˆ—ï¼Œi[:] ä»£è¡¨ä¸€å€‹å¼•ç”¨ i é€™å€‹é™£åˆ—çš„ slice ï¼ˆslice åº•å±¤æŒ‡å‘çš„é™£åˆ—æŒ‡æ¨™ = \u0026amp;iï¼‰ï¼Œé›–ç„¶æ¯å€‹è¿­ä»£ä¸­éƒ½æœƒå‰µé€ ä¸€å€‹æ–°çš„ sliceï¼Œä½†é€™äº› slice åº•å±¤æ‰€å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€å€‹è®Šæ•¸æŒ‡æ¨™ ã€‚\nåˆ°é€™é‚Šå°±å¯ä»¥çœ‹å‡ºï¼Œå…¶å¯¦é€™å€‹ç‹€æ³è·Ÿæœ€ä¸€é–‹å§‹ i ç‚º int é¡å‹è®Šæ•¸çš„ç¯„ä¾‹ä¸€æ¨£ï¼Œ ç”±æ–¼æ¯æ¬¡è¿­ä»£æ™‚ï¼Œ i çš„å€¼éƒ½ä¸€ç›´åœ¨æ›¿æ›ï¼Œç›´åˆ°è¿´åœˆçµæŸï¼Œ i çš„å€¼åœç•™åœ¨æœ€å¾Œä¸€æ¬¡è¿­ä»£ç•¶ä¸­è¢«è³¦äºˆçš„å€¼ã€‚\nè€Œç¬¬äºŒå€‹ç¯„ä¾‹ä¸­ï¼Œ i[:] æ˜¯ä»£è¡¨å°‡åŸå…ˆ i é€™å€‹ slice è¤‡è£½å‡ºä¸€ä»½ sliceï¼Œè€ŒåŸºæ–¼è¤‡è£½ slice çš„åŸç†ï¼Œé€™å…©å€‹ slice åº•å±¤éƒ½æœƒæŒ‡å‘åŒä¸€å€‹é™£åˆ—ï¼ˆè¤‡è£½çš„æ˜¯ slice çš„ headerï¼ŒåŒ…å«é™£åˆ—çš„(ç¬¬ä¸€å€‹å…ƒç´ çš„)æŒ‡æ¨™ã€é•·åº¦çš„å€¼ï¼‰\nWhat exactly is this slice variable? Itâ€™s not quite the full story, but for now think of a slice as a little data structure with two elements: a length and a pointer to an element of an array. You can think of it as being built like this behind the scenes:\ntype sliceHeader struct { Length int ZerothElement *byte } ä½† slice æœ¬èº«ä»æ˜¯ä¸€å€‹ value\nItâ€™s important to understand that even though a slice contains a pointer, it is itself a value. Under the covers, it is a struct value holding a pointer and a length. It isÂ not a pointer to a struct.\næ‰€ä»¥ç•¶ä¸‹ä¸€æ¬¡è¿­ä»£æ™‚ï¼Œ i çš„å…§å®¹æ›æˆä¸‹ä¸€å€‹ sliceï¼Œæœƒå†æ¬¡è¤‡è£½ i çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ header çš„éƒ¨åˆ†çµ¦æ–°çš„ sliceï¼Œæ¯æ¬¡è¿­ä»£ä¸­ç”¢ç”Ÿçš„æ–° slice éƒ½å’Œè¿­ä»£ç•¶ä¸‹çš„ slice æœ‰ç›¸åŒçš„ headerï¼Œæ¯å€‹è¤‡è£½ä¹Ÿéƒ½å¼•ç”¨å’Œè¤‡è£½å°è±¡ç›¸åŒçš„åº•å±¤é™£åˆ—ã€‚æ•´å€‹æµç¨‹å§‹çµ‚æ²’æœ‰å»å¼•ç”¨åˆ° i çš„æŒ‡æ¨™ï¼Œä¹Ÿå°±ä¸æœƒæœ‰ä¸Šé¢ç¯„ä¾‹çš„å•é¡Œã€‚\nç¸½çµï¼Œè¿­ä»£è®Šæ•¸åœ¨è¿­ä»£åŒæ™‚ï¼Œå€¼ä¹Ÿæœƒä¸æ–·æ”¹è®Šï¼Œå¦‚æœåœ¨è¿´åœˆä¸­æœ‰å¼•ç”¨åˆ°è¿­ä»£è®Šæ•¸ï¼Œå¯èƒ½æœƒæœ‰éé æœŸçš„è¡Œç‚ºã€‚\nReferences CommonMistakes\nresearch!rsc: Go Data Structures\nArrays, slices (and strings): The mechanics of \u0026lsquo;append\u0026rsquo; - The Go Programming Language\n","date":"Feb 21","permalink":"//localhost:1313/posts/golang-using-reference-to-loop-iterator-variable/","tags":["Golang"],"title":"Golang å¸¸è¦‹éŒ¯èª¤ - åœ¨è¿´åœˆç•¶ä¸­å¼•ç”¨è¿­ä»£è®Šæ•¸(iterator variable)"},{"categories":null,"contents":" å‰æƒ…æè¦ å‰é™£å­å°‡å…¬å¸ä¸€å€‹ Laravel å°ˆæ¡ˆç•¶ä¸­é€šçŸ¥çš„åŠŸèƒ½éƒ¨åˆ†åˆ‡å‡ºåˆ°å¦ä¸€å€‹ç”¨ Golang æ§‹å»ºçš„æœå‹™ï¼Œä¸¦ä¸”æŠŠè³‡æ–™å¾ MariaDB é·ç§»åˆ° AWS DynamoDBã€‚æƒ³èªªç¨å¾®ç´€éŒ„ä¸€ä¸‹é€™å€‹éç¨‹ï¼Œç®—æ˜¯ä¸€å€‹æ”¶ç©«æ»¿å¤šçš„ç¶“é©—ã€‚\nç”±æ–¼åŸæœ¬å­˜åœ¨ MariaDB çš„é€šçŸ¥è³‡æ–™é‡æ—¥ç›Šè‚¥å¤§ï¼Œé›–ç„¶ç•¶å‰ä»ä¸ç®—æ˜¯å·¨é‡è³‡æ–™ï¼Œå¤§ç´„åƒè¬ç´šè³‡æ–™é‡è€Œå·²ï¼Œä½†æ˜¯å…‰æ˜¯é€™å€‹ç­‰ç´šçš„è³‡æ–™é‡ï¼Œåªè¦ä¸å°å¿ƒä¸‹ä¸€å€‹ç¯„åœæ€§çš„ select èªå¥éƒ½æœ‰å¯èƒ½æœƒé€ æˆæ•´å€‹ DB å¡æ­»ç„¶å¾Œæœå‹™æ›æ‰ï¼ˆçœŸå¯¦ç™¼ç”Ÿéåœ¨ production ç’°å¢ƒä¸Šçš„äº‹ä»¶â€¦ï¼‰ã€‚ç„¶è€Œé€šçŸ¥åœ¨æˆ‘å€‘çš„ç³»çµ±ç•¶ä¸­å…¶å¯¦åƒ…æ˜¯ä¸€å€‹è¼”åŠ©çš„åŠŸèƒ½ï¼Œä½†ä¸€æœ‰å•é¡Œå»å¯èƒ½ç›´æ¥å°è‡´æ•´å€‹æœå‹™åœæ“ºï¼Œæ€éº¼æƒ³éƒ½ä¸å¤ªåˆç†ã€‚å› æ­¤ï¼Œã€Œéš”é›¢ã€å°±æ˜¯æˆ‘å€‘é¦–è¦çš„ç›®çš„â€”â€”é€šçŸ¥çš„è³‡æ–™ä¸è©²å’Œä¸»æœå‹™çš„è³‡æ–™æ“ºåœ¨åŒå€‹è³‡æ–™åº«è£¡ ã€‚\nğŸ“ Note: ç•¶è³‡æ–™é‡åˆ°é”ç™¾è¬ç´šä»¥ä¸Šå¾Œï¼Œcount(*) èªæ³•æ˜é¡¯é€Ÿåº¦è®Šå¾ˆæ…¢ï¼Œåƒé€™æ¨£çš„æŸ¥è©¢èªå¥ select count(*) from UserNotification where id \u0026gt; 51306320 and id \u0026lt;= 57615005 order by id åŸ·è¡Œèµ·ä¾†å°±è¦å…©ç§’å¤šã€‚\næ—¢ç„¶è¦æŠŠè³‡æ–™æ¬å‡ºå»ï¼Œè¦æ¬åˆ°å“ªè£¡å°±æ˜¯å°±æ˜¯ç¬¬äºŒå€‹å•é¡Œï¼Œè€Œæˆ‘å€‘å¾Œä¾†æœƒé¸ç”¨ AWS DynamoDB çš„åŸå› åŒ…æ‹¬ï¼š\né¢å°ä¹˜è¼‰è³‡æ–™é‡çš„è®ŠåŒ–ï¼ŒDB å¯ä»¥è‡ªå‹•éš¨ä¹‹æ“´å±•å’Œç¸®æ¸› æŸ¥è©¢æœ‰æ—¢å®šçš„æ¨¡å¼å’Œè¦å‰‡ï¼Œä¸å¤ªæœƒæœ‰è®Šå‹•ï¼ˆå¦‚ï¼šå–å¾—é€šçŸ¥æœªè®€æ•¸é‡ã€å°‡é€šçŸ¥å·²è®€ etc.ï¼‰ï¼Œä¹Ÿä¸éœ€è¦è¤‡é›œçš„ join æˆ– sub queries ç­‰ç­‰ ä¸éœ€è¦åš´æ ¼çš„çš„è³‡æ–™ä¸€è‡´æ€§ï¼Œåªè¦æœ‰æœ€çµ‚ä¸€è‡´å³å¯ï¼ˆDynamoDB Consistency Model çš„é è¨­å€¼ï¼Œä¹Ÿæ˜¯èƒ½ä¿æŒæœ€ä½³æ•ˆèƒ½çš„æ¨è–¦é¸é …ï¼‰ åŸæœ¬å°±æœ‰åœ¨ä½¿ç”¨ AWS çš„æœå‹™ï¼Œä¹‹å¾Œè‹¥æœ‰éœ€è¦å’Œ AWS å…¶ä»–æœå‹™æ•´åˆæ™‚ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿ è€Œä¹‹æ‰€ä»¥æœƒå¦å»ºä¸€å€‹æœå‹™ï¼Œä¸»è¦æ˜¯ç‚ºäº†å°‡éš”é›¢æ€§æé«˜åˆ°æ‡‰ç”¨å±¤çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿ä¹‹å¾Œå°‡å…¶ä»–é€šçŸ¥ç›¸é—œçš„åŠŸèƒ½éƒ½åˆ‡å‡ºå»ï¼ˆex: æ¨æ’­ï¼‰ï¼Œé¸æ“‡ Golang å‰‡æ˜¯å› ç‚ºå…¶ç°¡å–®å¿«é€Ÿçš„ç‰¹æ€§ï¼Œä¹Ÿå¾ˆé©åˆæ‹¿ä¾†æ­å»ºå¾®æœå‹™ï¼ˆé‚„æœ‰ä¸€éƒ¨åˆ†ç§å¿ƒæ˜¯æƒ³å¯¦éš›å°‡ Golang é‹ç”¨åœ¨å…¬å¸å°ˆæ¡ˆä¸Šï¼‰ã€‚ æ­¤å¤–ï¼Œä½¿ç”¨ Golang é‚„æœ‰ä¸€å€‹å¥½è™•å°±æ˜¯èƒ½å¤ ä½¿ç”¨è¿¸ç™¼ç¨‹å¼å° DynamoDB é€²è¡Œæ“ä½œã€‚DynamoDB æœ¬èº«å°±æœ‰èƒ½åŠ›æ¶ˆåŒ–åŒæ™‚æ•¸åƒå€‹ä»¥ä¸Šå¯«å…¥/è®€å–çš„è«‹æ±‚ï¼ˆæ¯ç§’çš„è«‹æ±‚ååé‡ä¸Šé™å–æ±ºæ–¼æ‰€é¸æ“‡çš„è¨ˆåƒ¹æ–¹å¼/ Read/write capacity modeï¼‰ï¼Œéå¸¸é©åˆæ­é…æ”¯æ´ concurrency çš„ç¨‹å¼èªè¨€ä½¿ç”¨ï¼Œåœ¨éœ€è¦çš„æ™‚å€™å¯ä»¥é€éè¿¸ç™¼ç¨‹å¼å¤§å¹…æé«˜è™•ç†å¤§é‡è³‡æ–™çš„æ•ˆç‡ã€‚\nMigrate ä¹‹å‰çš„æº–å‚™ åœ¨ migrate è³‡æ–™ä¹‹å‰ï¼Œæˆ‘å€‘æ‰€é€²è¡Œçš„æœå‹™æ›¿æ›æ˜¯é€™æ¨£çš„ï¼š\nåŸæœ¬æ‰€æœ‰ notification ç›¸é—œ API éƒ½ä¸å‹•ï¼Œåˆ†åˆ¥æ–°å¢æ¯ä¸€éš» API å°æ‡‰çš„ API åŠ ä¸Š v2 å‰ç¶´ã€‚è€Œ v2 æ‰€åšçš„äº‹æƒ…éƒ½å’Œ v1 ç›¸åŒï¼Œåªæ˜¯åŸæœ¬æ“ä½œè³‡æ–™æ™‚æ˜¯å° MariaDB æ“ä½œï¼Œéƒ½æ”¹æˆå°å¤–éƒ¨é€šçŸ¥æœå‹™æ“ä½œã€‚\nè€Œåœ¨æ–°å¢é€šçŸ¥è³‡æ–™çš„éƒ¨åˆ†ï¼Œç”±æ–¼é€šçŸ¥æ˜¯åœ¨ä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºæ™‚æ‰æœƒè¢«å»ºç«‹ï¼Œæ‰€ä»¥é€™å€‹éƒ¨åˆ†çš„æ”¹å‹•æ˜¯åœ¨æ¯å€‹æ“ä½œè¡Œç‚ºä¹‹å¾ŒåŸæœ¬æœƒè§¸ç™¼æ–°å¢é€šçŸ¥çš„åœ°æ–¹ï¼Œå…¨éƒ¨ä¹Ÿéƒ½åŠ ä¸Šè§¸ç™¼æ–°å¢ v2 çš„é€šçŸ¥ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œæ–°å¢é€šçŸ¥èˆ‡æ¨æ’­é€šçŸ¥æ˜¯ç¨ç«‹é‹ä½œçš„ï¼š\nä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºï¼Œè§¸ç™¼æ–°å¢é€šçŸ¥äº‹ä»¶ï¼š ç•¶ä¸‹ç«‹å³æ–°å¢é€šçŸ¥è³‡æ–™ï¼ŒåŒæ™‚æ´¾ç™¼ä¸€å€‹æ¨æ’­é€šçŸ¥çš„ queue jobï¼ˆæ–°å¢è³‡æ–™çš„ id æœƒå‚³çµ¦ queue jobï¼‰ Queue worker æ¶ˆåŒ– job æ¨æ’­é€šçŸ¥ï¼š é€éå‚³é€²ä¾†çš„ id æ‰¾åˆ°æ¬²æ¨æ’­çš„è³‡æ–™ï¼Œå†é€²è¡Œæ¨æ’­ åœ¨é€™å€‹ç‰ˆæœ¬ç•¶ä¸­ï¼Œæ–°èˆŠçš„ Notification API æœƒä¸¦å­˜ï¼ˆAPI ä¸»è¦å°±æ˜¯æä¾›è®€å–é€šçŸ¥åˆ—è¡¨ã€æ›´æ–°é€šçŸ¥å·²è®€ç‹€æ…‹ï¼‰ï¼Œä¸”åŒæ™‚å„²å­˜æ–°èˆŠç‰ˆé€šçŸ¥è³‡æ–™ï¼Œä½†åœ¨æ¨æ’­çš„ job ç•¶ä¸­æ˜¯åˆ°æ–° DB æ‰¾è³‡æ–™ã€‚\nMigrate æ™‚é‡åˆ°çš„å•é¡Œèˆ‡è§£æ³• æˆ‘å€‘æ‰“ç®—è¦ migrate æœ€è¿‘ä¸‰å€‹æœˆçš„è³‡æ–™ï¼Œå…ˆå‰å·²ç¶“æœ‰æº–å‚™å¥½ä¸€éš»å°‡ MariaDB è³‡æ–™ migrate åˆ° DynamoDB çš„ç¨‹å¼ã€‚ç…§åŸæœ¬è¨ˆåŠƒåœ¨ä¸Šç‰ˆå‰è¦å…ˆè·‘ migrateï¼Œç¸½å…±æœ‰ 600 å¤šè¬ç­†è³‡æ–™ï¼Œä¼°è¨ˆè‡³å°‘è¦ä¸€å€‹å°æ™‚ä»¥ä¸Šæ‰è·‘å¾—å®Œï¼Œä½†èˆŠè³‡æ–™æœ‰å¯èƒ½æœƒåœ¨é€™æ®µæœŸé–“å…§è¢«æ›´æ–°ï¼ˆå·²è®€ç‹€æ…‹ï¼‰ï¼Œå°è‡´æ–°èˆŠè³‡æ–™ä¸åŒæ­¥çš„å•é¡Œï¼š\nmigrate éç¨‹ä¸­ï¼ŒèˆŠè³‡æ–™å¯èƒ½æœƒè¢«æ›´æ–°ï¼Œæ–°è³‡æ–™å»æ²’æœ‰è¢«æ›´æ–°ï¼Œå°è‡´è³‡æ–™ä¸åŒæ­¥ã€‚\nè§£æ±ºé€™å€‹å•é¡Œçš„æ–¹æ³•å…¶å¯¦é¡¯è€Œæ˜“è¦‹ï¼Œå°±æ˜¯ åœ¨æ›´æ–°èˆŠ DB è³‡æ–™çš„åŒæ™‚ï¼Œä¹Ÿé€£åŒæ›´æ–°åœ¨æ–° DB çš„åŒä¸€ç­†è³‡æ–™ã€‚ åŒæ¨£åœ°ï¼Œç‚ºäº†ç›¸å®¹æ€§ï¼ˆå‰ç«¯ web/APP ä¹Ÿè¦æ›´æ›æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼Œä½† web æœƒå…ˆæ›´æ–°ã€APP å°šæœªæº–å‚™å¥½ï¼‰ï¼Œæ›´æ–°æ–° DB è³‡æ–™æ™‚ä¹Ÿè¦é€£åŒæ›´æ–°åœ¨èˆŠ DB çš„åŒä¸€ç­†è³‡æ–™ï¼Œé€™æ¨£å°±ç®—å‰ç«¯æ›æˆæ‰“ v2 å¾Œ APP ä»åœ¨æ‰“ v1ï¼Œå…©é‚Šçš„è³‡æ–™ä¹Ÿéƒ½æœƒæ˜¯åŒæ­¥çš„ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œ migrate ä¹Ÿå°±ä¸éœ€è¦åœ¨ä¸Šç‰ˆå‰åšï¼Œè€Œæ˜¯åœ¨ä¸Šç‰ˆä¹‹å¾Œé‚„èƒ½å¤ å¾ˆæœ‰é¤˜è£•åœ°æ…¢æ…¢è·‘ã€‚\næ–¼æ˜¯åŠ ä¸Šä¿®æ”¹ä¹ŸåŒæ­¥ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†çš„æµç¨‹å¤§æ¦‚æ˜¯é€™æ¨£ï¼š\nå¾Œç«¯ä¸Šç‰ˆï¼ˆæ–°å¢ä¿®æ”¹çš†åŒæ­¥è³‡æ–™çš„ç‰ˆæœ¬ï¼‰ è·‘ migrate æŒ‡ä»¤ migrate å®Œæˆå¾Œï¼Œå‰ç«¯/APP å†ä¸Šç‰ˆ ï¼ˆæ”¹æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼‰ å…¶å¯¦æ›´ç„¡ç¸«çš„æ–¹æ³•æ˜¯ç›´æ¥æŠŠ v1 API èƒŒå¾Œéƒ½æ”¹æˆä¸²æ¥æ–°æœå‹™ï¼Œä¸¦æä¾›ç›¸åŒçš„å›å‚³è³‡æ–™æ ¼å¼ï¼Œå¦‚æ­¤çš„è©±å‰ç«¯ä¹Ÿç„¡éœ€æ›¿æ›æ¥å£ã€‚ä½†ç”±æ–¼åœ¨ã€Œè®€å–åˆ—è¡¨ã€API çš„åˆ†é åƒæ•¸æœ‰åšæ”¹å‹•ï¼ˆåŸæœ¬ v1 æ˜¯ä½¿ç”¨é æ•¸å»å–ä¸åŒåˆ†é çš„è³‡æ–™ï¼Œä½†åœ¨ DynamoDB å–è³‡æ–™æ™‚ç„¡æ³•ç”¨æŒ‡å®šé æ•¸çš„æ–¹å¼ï¼Œä¸æ”¯æŒåƒæ˜¯ SQL çš„ offset èªæ³•çš„ç”¨æ³•æˆ–å¯ä»¥é”åˆ°é¡ä¼¼æ•ˆæœçš„æ–¹æ³•ï¼Œè€Œæ˜¯è¦æŒ‡å®šå¾å“ªç­†è³‡æ–™é–‹å§‹å¾€ä¸‹å–å¹¾ç­†çš„æ–¹å¼ï¼Œé¡ä¼¼ Cursor çš„æ¦‚å¿µï¼‰ï¼Œå‰ç«¯å¿…å®šå¾—é€²è¡Œç›¸å°æ‡‰çš„ä¿®æ”¹ï¼Œç„¡æ³•ç›´æ¥æŠ½æ›ã€‚\nä¸éé€éä»¥ä¸Šçš„åšæ³•ï¼Œå·²ç¶“èƒ½å¤ åœ¨ä¸è®“ä½¿ç”¨è€…è¦ºå¯Ÿçš„å‰æä¸‹ï¼Œå°‡è³‡æ–™åº«é€²è¡ŒæŠ½æ›ä¸¦å®Œæˆè³‡æ–™çš„æ¬ç§»ã€‚å¾ŒçºŒå°±åªéœ€è¦æŒçºŒè¿½è¹¤ Logï¼Œå¦‚æœ v1 API éƒ½æ²’æœ‰å†è¢«å‘¼å«çš„è©±ï¼Œå°±å¯ä»¥ç›´æ¥æŠŠ v1 éƒ½æ‹”æ‰ï¼Œä¹Ÿç„¡éœ€å†åŒæ­¥å°‡è³‡æ–™å¯«å…¥èˆŠ DBã€æ›´æ–°èˆŠ DB çš„è³‡æ–™ ã€‚\n","date":"Feb 08","permalink":"//localhost:1313/posts/migrate-data-from-mariadb-to-dynamodb/","tags":["DynamoDB"],"title":"å°‡è³‡æ–™å¾ MariaDB é·ç§»è‡³ AWS DynamoDB éç¨‹ç´€éŒ„"},{"categories":null,"contents":"åœ¨ Laravel ç•¶ä¸­ï¼Œæˆ‘å€‘å¯ä»¥é€éã€Œå‹•æ…‹é—œè¯å±¬æ€§(Dynamic relationship properties)ã€ç›´æ¥å–å¾— Model çš„é—œè¯è³‡æ–™ï¼Œè€Œè©²è¡Œç‚ºè¢«å®˜æ–¹ç¨±ç‚º ã€ŒLazy Loadingã€ï¼Œç•¶å–å€¼æ™‚å°±æœƒè‡ªå‹•å°‡é—œè¯è³‡æ–™è¼‰å…¥ï¼Œéå¸¸æ–¹ä¾¿ã€‚ä½†ä½¿ç”¨ä¸Šä¸€ä¸å°å¿ƒå°±å¾ˆæœ‰å¯èƒ½æœƒé€ æˆ N+1 å•é¡Œã€‚\nN+1 å•é¡Œé€šå¸¸æ˜¯æŒ‡ï¼Œåœ¨å¾—åˆ°ä¸€å€‹ Models of Collection/Array å¾Œï¼Œåˆåœ¨éæ­·æ¯å€‹ Model æ™‚ï¼Œé€é Lazy Loading å–å¾—å…¶é—œè¯è³‡æ–™ï¼Œæœƒå°è‡´ æœ‰ N å€‹ Model å°±æœƒåŸ·è¡Œ N+1 æ¬¡ Queryã€‚éå¤šçš„ DB Query æ¬¡æ•¸å¯èƒ½æœƒå°æ•ˆèƒ½é€ æˆåš´é‡å½±éŸ¿ã€‚\nLaravel 8 é–‹å§‹å°±æœ‰æä¾›é¿å… Lazy Loading çš„æ–¹æ³•ï¼Œ åªè¦åœ¨ App\\Providers\\AppServiceProvider ç•¶ä¸­çš„ boot() æ–¹æ³•è£¡é¢åŠ ä¸Šï¼š\n1 2 3 4 5 6 7 // app/Providers/AppServiceProvider.php use Illuminate\\Database\\Eloquent\\Model; public function boot() { Model::preventLazyLoading(! app()-\u0026gt;isProduction()); //é è¨­ç‚º true } å¦‚æ­¤ä¸€ä¾†ï¼Œç•¶ Lazy Loading è¢«è§¸ç™¼æ™‚ï¼Œå°±æœƒç›´æ¥æ‹‹å‡ºä¾‹å¤– (Illuminate\\Database\\LazyLoadingViolationException)\nè€Œç•¶åˆè©²æ–°åŠŸèƒ½ç™¼å¸ƒæ™‚ï¼Œlaravel-news ç¶²ç«™æœ‰ä¸€ç¯‡æ–‡ç« å°±åœ¨ä»‹ç´¹é€™å€‹åŠŸèƒ½ã€‚è©²ç¯‡æ–‡ç« ç•¶ä¸­èˆ‰çš„ä¾‹å­ç‚ºï¼Œæœ‰å…©å€‹ Model - User å’Œ Posts ç‚ºä¸€å°å¤šé—œä¿‚ï¼š\n1 2 3 $user = User::first(); $user-\u0026gt;posts; // é€™é‚Šå°±æœƒè§¸ç™¼ Lazy Loading, å°‡æ‰€æœ‰ user çš„ post éƒ½å¾ DB æ’ˆå‡º æ‰€ä»¥å¦‚æœåŠ ä¸Š Model::preventLazyLoading() ï¼ŒåŸ·è¡Œä¸Šé¢ç¯„ä¾‹æ™‚æ‡‰è©²å°±æœƒæ‹‹å‡º Illuminate\\Database\\LazyLoadingViolationException é˜»æ­¢æˆ‘å€‘é€é Lazy Loading å¾—åˆ° postsã€‚\næ–¼æ˜¯æ‰“é–‹å°ˆæ¡ˆä¾†è©¦è©¦ï¼Œå»ç™¼ç¾ä¸€åˆ‡æ­£å¸¸ï¼Œæ²’æœ‰ä¾‹å¤–æ‹‹å‡º\u0026hellip;\nä½†å¦‚æœæ›ä¸€å€‹æ–¹æ³•è©¦è©¦ï¼š\né€™æ™‚å€™æ‰æœƒå¦‚é æœŸæ‹‹å‡ºä¾‹å¤–ã€‚\nå¦å¤–ï¼Œå¦‚æœç•¶ DB è£¡åªæœ‰ä¸€ç­† user è³‡æ–™ï¼Œå°±ç®—åƒä¸Šé¢é€™æ¨£å– all()ï¼Œä¹Ÿä¸æœƒæ‹‹å‡ºä¾‹å¤–ã€‚\nä¸€é–‹å§‹å¾ˆç–‘æƒ‘ç‚ºä»€éº¼ç¯„ä¾‹çš„ code åŸ·è¡Œå¾Œæ²’æœ‰æ‹‹å‡ºä¾‹å¤–ï¼Œæ‰€ä»¥å°±ç ”ç©¶äº†ä¸€ä¸‹åŸå§‹ç¢¼çš„éƒ¨åˆ†ï¼Œé †ä¾¿çœ‹ä¸€ä¸‹é€™å€‹åŠŸèƒ½æ˜¯å¦‚ä½•å¯¦ç¾çš„ã€‚\nåŸå§‹ç¢¼åˆ†æ é¦–å…ˆï¼Œå¾ Illuminate\\Database\\Eloquent\\Model::preventLazyLoading() é€™å€‹æ–¹æ³•é–‹å§‹çœ‹èµ·ï¼š\n1 2 3 4 public static function preventLazyLoading($value = true) { static::$modelsShouldPreventLazyLoading = $value; } é€™é‚Šæœƒå°‡ Illuminate\\Database\\Eloquent\\Model ç•¶ä¸­çš„ä¸€å€‹éœæ…‹å±¬æ€§ $modelsShouldPreventLazyLoading è¨­å€¼æˆå‚³å…¥çš„å¸ƒæ—å€¼ã€‚\nè©²å±¬æ€§é è¨­ç‚º falseï¼š\n1 protected static $modelsShouldPreventLazyLoading = false; ä½†å…¶å¯¦ Illuminate\\Database\\Eloquent\\Model å¦å¤–é‚„æœ‰ä¸€å€‹ééœæ…‹å±¬æ€§ $preventsLazyLoadingï¼ˆå¾…æœƒæœƒæåˆ°åœ¨å“ªè£¡è¢«ä½¿ç”¨ï¼‰\n1 public $preventsLazyLoading = false; ç•¶åŸ·è¡Œ DB Queryï¼Œå–å¾— App\\Models\\User æ™‚(eg: User::first();)ï¼Œæœƒé€²å…¥ä»¥ä¸‹æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //src/Illuminate/Database/Eloquent/Builder.php public function hydrate(array $items) { $instance = $this-\u0026gt;newModelInstance(); return $instance-\u0026gt;newCollection(array_map(function ($item) use ($items, $instance) { $model = $instance-\u0026gt;newFromBuilder($item); if (count($items) \u0026gt; 1) { $model-\u0026gt;preventsLazyLoading = Model::preventsLazyLoading(); } return $model; }, $items)); } å¦‚æœåŸ·è¡Œ User::first()ï¼Œæ­¤è™•çš„ $items å¼•æ•¸æœƒæ˜¯ä¸€å€‹é™£åˆ—ï¼Œå…§å«ä¸€å€‹ stdClass ç‰©ä»¶ (å¾ users table å–å‡ºçš„ç¬¬ä¸€å€‹ row çš„è³‡æ–™)ï¼Œåƒé€™æ¨£ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 array:1 [ 0 =\u0026gt; {#4352 +\u0026#34;id\u0026#34;: 1 +\u0026#34;name\u0026#34;: \u0026#34;Mrs. Gisselle Sauer\u0026#34; +\u0026#34;email\u0026#34;: \u0026#34;dion.kiehn@example.com\u0026#34; +\u0026#34;email_verified_at\u0026#34;: \u0026#34;2022-12-22 03:53:59\u0026#34; +\u0026#34;password\u0026#34;: \u0026#34;$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi\u0026#34; +\u0026#34;remember_token\u0026#34;: \u0026#34;jq4qLUs2qQ\u0026#34; +\u0026#34;created_at\u0026#34;: \u0026#34;2022-12-22 03:53:59\u0026#34; +\u0026#34;updated_at\u0026#34;: \u0026#34;2022-12-22 03:53:59\u0026#34; } ] æ¥è‘—åœ¨éæ­·é™£åˆ—çš„éç¨‹ä¸­ï¼Œå°‡éæ­·åˆ°çš„ stdClass ç‰©ä»¶è½‰æˆ Eloquent Model æ™‚ï¼Œæœƒå…ˆåˆ¤æ–·å¦‚æœ $items é™£åˆ—é•·åº¦å¤§æ–¼ 1ï¼Œæ‰æœƒå°‡é€™å€‹ Model(åœ¨æ­¤ç¯„ä¾‹ä¹Ÿå°±æ˜¯ App\\Models\\User)çš„ $preventsLazyLoading å±¬æ€§è¨­ç‚ºModel::preventsLazyLoading() çš„å€¼ï¼Œè€Œé€™å€‹éœæ…‹æ–¹æ³•å…¶å¯¦å›å‚³çš„å°±æ˜¯å…ˆå‰æˆ‘å€‘åœ¨ App\\Providers\\AppServiceProvider è¨­å®šçš„éœæ…‹å±¬æ€§ $modelsShouldPreventLazyLoadingï¼š\n1 2 3 4 public static function preventsLazyLoading() { return static::$modelsShouldPreventLazyLoading; } æ¥è‘—ï¼Œç•¶å‘¼å« $user-\u0026gt;posts æ™‚ï¼Œæœƒé€²å…¥ Illuminate\\Database\\Eloquent\\Concerns\\HasAttributes ç•¶ä¸­çš„ getRelationValue() æ–¹æ³•:\n1 2 3 4 5 6 7 8 9 10 11 // src/Illuminate/Database/Eloquent/Concerns/HasAttributes.php public function getRelationValue($key) { ... if ($this-\u0026gt;preventsLazyLoading) { // here $this-\u0026gt;handleLazyLoadingViolation($key); } return $this-\u0026gt;getRelationshipFromMethod($key); } ç•¶ $preventsLazyLoading ç‚º true æ™‚ï¼Œå°±æœƒæ‹‹å‡ºä¾‹å¤–\n1 2 3 4 5 6 7 // src/Illuminate/Database/Eloquent/Concerns/HasAttributes.php protected function handleLazyLoadingViolation($key) { ... throw new LazyLoadingViolationException($this, $key); } ä¹Ÿå°±æ˜¯èªªï¼Œå¾ DB å–å‡ºçš„è³‡æ–™ç­†æ•¸éœ€å¤§æ–¼ 1 ï¼Œå°è©² Model å–é—œè¯æ™‚æ‰æœƒè§¸ç™¼ Prevent Lazy Loading çš„æ•ˆæœã€‚\næ‰€ä»¥å¦‚æœæ’ˆå‡ºçš„çµæœéƒ½æ˜¯ä¸€ç­†è³‡æ–™ï¼Œå°±ä¹Ÿä¸æœƒè§¸ç™¼ Prevent Lazy Loading äº†ã€‚\n1 2 3 4 5 $user = User::first(); // åªæœ‰å¾ DB æ’ˆå‡ºä¸€ç­†è³‡æ–™ $user-\u0026gt;posts; // no exception $users = User::all(); // å‡ä½¿ DB è£å…¶å¯¦ä¹Ÿåªæœ‰ä¸€ç­† user è³‡æ–™ $users[0]-\u0026gt;posts; // no exception å…¶å¯¦æŒ‰ç…§å¸¸ç†ï¼Œå¤§æ¦‚èƒ½å¤ ç†è§£çˆ²ä»€éº¼æœƒæœ‰é€™ç¨®æ•ˆæœï¼Œå› ç‚ºåªæœ‰ä¸€å€‹ Model çš„æ™‚å€™ï¼Œå–å¾—å…¶åº•ä¸‹é—œè¯ï¼Œæ‡‰è©²ä¸èƒ½ç®—æ˜¯ N+1 å•é¡Œã€‚ï¼ˆä¸éè©²ç¶²ç«™çš„ä¾‹å­ç‚ºä»€éº¼é€™æ¨£èˆ‰å°±ä¸å¾—è€ŒçŸ¥ï¼Œç®—æ˜¯å°è¸©å‘äº†ä¸‹ï¼‰\n","date":"Dec 29","permalink":"//localhost:1313/posts/laravel-prevent-lazy-loading/","tags":["Laravel"],"title":"Laravel Prevent Lazy Loading è¸©å‘å¿ƒå¾—åŠåŸç†åˆ†æ"},{"categories":null,"contents":"å‰å¹¾å¤©é‡åˆ°ä¸€å€‹ç‹€æ³ï¼ŒåŸæœ¬ç¨‹å¼è£¡æœ‰ä¸€æ®µé‚è¼¯æ˜¯ ã€Œå¦‚æœè©²ç­†è³‡æ–™ä¸å­˜åœ¨ï¼Œå°±å¯«å…¥æ–°è³‡æ–™ï¼Œä½†å¦‚æœå·²å­˜åœ¨ï¼Œå°±ç›´æ¥å›å‚³è©²ç­†å·²å­˜åœ¨çš„è³‡æ–™ã€ï¼Œç¨‹å¼ç¢¼å¤§æ¦‚é•·é€™æ¨£ï¼š\n1 2 3 4 5 6 7 8 9 $snapshot = OrderSnapshot::where(\u0026#39;order_id\u0026#39;, $order-\u0026gt;id)-\u0026gt;first(); if (!empty($snapshot)) { return $snapshot; } // do something... return OrderSnapshot::create([\u0026#39;payload\u0026#39; =\u0026gt; $order_array]); ä¸Šé¢ç¨‹å¼ç¢¼å…¶å¯¦ä¹Ÿå¯ä»¥ä½¿ç”¨ Laravel çš„ firstOrCreate æ–¹æ³•åšç°¡åŒ–:\n1 2 3 4 return OrderSnapshot::firstOrCreate( [\u0026#39;order_id\u0026#39; =\u0026gt; $order-\u0026gt;id], [\u0026#39;payload\u0026#39; =\u0026gt; $order_array] ) é€™æ®µé‚è¼¯çœ‹èµ·ä¾†å¾ˆç°¡å–®ï¼Œåœ¨å–®ä¸€ process çš„æƒ…æ³ä¸‹ï¼Œé€™æ®µç¨‹å¼ç¢¼ç¢ºå¯¦æ²’æœ‰ä»»ä½•å•é¡Œï¼Œä½†å¦‚æœä»Šå¤©åŒæ™‚æœ‰å…©å€‹ process è¦åŸ·è¡Œé€™æ®µç¨‹å¼çš„è©±ï¼Œå°±å¯èƒ½æœƒæœ‰éé æœŸçš„çµæœå‡ºç¾ã€‚ ç”±æ–¼ä¸è«–æ˜¯ä¸Šé¢çš„ç¨‹å¼ç¢¼ï¼Œæˆ–æ˜¯ç°¡åŒ–å¾Œçš„ç¨‹å¼ç¢¼ï¼Œå¦‚æœæ²’æœ‰æ’ˆå‡ºè³‡æ–™çš„è©±ï¼ˆä¹Ÿå°±æ˜¯è³‡æ–™ä¸å­˜åœ¨ï¼‰ï¼Œéƒ½æ˜¯è¦ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œæ–°å¢è³‡æ–™çš„å‹•ä½œï¼Œè€Œã€Œæ’ˆå‡ºè³‡æ–™ã€å’Œã€Œæ–°å¢è³‡æ–™ã€éƒ½æ˜¯å–®ç¨çš„ Queryï¼Œæ‰€ä»¥å¦‚æœå¹¾ä¹åŒæ™‚åŸ·è¡Œé€™æ®µç¨‹å¼æ™‚ï¼Œå¯èƒ½å°±æœƒç”¢ç”Ÿå…©ç­†ç›¸åŒçš„è³‡æ–™ï¼š\nè€Œè¦è§£æ±ºé€™å€‹å•é¡Œï¼Œå¤§æ¦‚æœ‰ä»¥ä¸‹å¹¾ç¨®è¾¦æ³•ï¼š\n1. é¿å…å¤šå€‹ process åŸ·è¡Œ å¦‚æœæ˜¯å› ç‚ºæ”¾åœ¨ job è£¡é¢ï¼ŒåŒæ™‚æœ‰å¤šå€‹ queue worker åœ¨æ¶ˆåŒ–é€™äº› jobï¼Œå°±ä¿æŒ queue worker çš„æ•¸é‡ç‚º 1ã€‚ ä½†æˆ‘å€‘é€™æ¬¡é‡åˆ°çš„æƒ…æ³ä¸¦ä¸é©ç”¨ï¼Œå› ç‚ºé‚„å¯ä»¥é€é API Request realtime åŸ·è¡Œé€™æ®µç¨‹å¼ã€‚è€Œä¸”å¦‚æœé‡åˆ°çœŸçš„å¾ˆè€—æ™‚çš„å·¥ä½œï¼Œä¹Ÿä¸å¯èƒ½ç‚ºæ­¤åªé–‹ä¸€å€‹ workerã€‚\n2. ä½¿ç”¨ INSERT INTO .. ON DUPLICATE KEY èªæ³• ä¹Ÿå°±æ˜¯èªªå°‡å…©å€‹ Query åˆä½µæˆä¸€å€‹ Queryï¼Œè®“è³‡æ–™åº«å»åˆ¤æ–·è³‡æ–™å­˜ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±æ–°å¢ï¼Œå­˜åœ¨å‰‡æ”¹æˆæ›´æ–°ã€‚ ä½†é€™åˆä¸å¤ªç¬¦åˆæˆ‘å€‘çš„æƒ…å¢ƒï¼Œå› ç‚ºå¦‚æœå·²å­˜åœ¨ï¼Œä¸¦ä¸éœ€è¦å°è©²ç­†è³‡æ–™åšæ›´æ–°ï¼Œç›´æ¥å–å‡ºå³å¯ã€‚\n3. åˆ©ç”¨å¤–éƒ¨æœå‹™å¯¦ç¾åˆ†å¸ƒå¼é–æ©Ÿåˆ¶ ç”±æ–¼ PHP å–®åŸ·è¡Œç·’çš„ç‰¹æ€§ï¼Œæœ¬èº«æ²’æœ‰é€™ç¨®æ©Ÿåˆ¶ï¼Œæ‰€ä»¥åªèƒ½è—‰ç”±å¤–éƒ¨çš„æœå‹™ä¾†å¯¦ç¾åˆ†å¸ƒå¼é–çš„åŠŸèƒ½ï¼Œ åƒæ˜¯ Redis å°±æ˜¯ä¸€å€‹å¸¸è¢«æ‹¿ä¾†åšåˆ†å¸ƒå¼é–çš„å·¥å…·ï¼Œè€Œ Laravel æœ¬èº«æœ‰æä¾› Redis Lock ç›¸é—œçš„ APIï¼Œæ‰€ä»¥æœ€å¾Œæ¡ç”¨äº†é€™å€‹è§£æ³•ã€‚\næˆ‘å€‘è¦é”åˆ°çš„ç›®çš„å…¶å¯¦å¾ˆç°¡å–®ï¼Œä¹Ÿå°±æ˜¯è¦æŠŠã€Œæ’ˆå‡ºè³‡æ–™ã€å’Œã€Œæ–°å¢è³‡æ–™ã€é€™å…©å€‹æ“ä½œè¦–ç‚ºä¸€å€‹åŸå­æ€§çš„æ“ä½œï¼Œå¦‚æœç¬¬ä¸€å€‹ç¨‹åºé‚„æ²’åŸ·è¡Œå®Œï¼Œç¬¬äºŒå€‹ç¨‹åºå¿…é ˆç­‰å¾…ç¬¬ä¸€å€‹åšå®Œå¾Œï¼Œæ‰èƒ½æ¥è‘—åšã€‚åˆ©ç”¨åˆ†å¸ƒå¼é–çš„è©±å°±èƒ½å¤ å¯¦ç¾é€™å€‹è¡Œç‚ºï¼š ç•¶æŸä¸€å€‹ç¨‹åºé‚„åœ¨åŸ·è¡Œé€™äº›å‹•ä½œçš„æ™‚å€™ï¼ˆé‚„æ‹¿è‘—é€™å€‹é–ï¼‰ï¼Œå…¶ä»–ç¨‹åºéƒ½å¿…é ˆç­‰å¾…å®ƒåŸ·è¡Œå®Œï¼ˆé‡‹æ”¾é–ï¼‰ä¹‹å¾Œæ‰èƒ½æ¥è‘—åŸ·è¡Œï¼ˆç²å¾—é–ï¼‰ã€‚å¦‚æ­¤ä¸€ä¾†å°±ä¸æœƒç™¼ç”Ÿç”¢ç”Ÿç›¸åŒè³‡æ–™çš„å•é¡Œã€‚\nåœ¨ä½¿ç”¨ Laravel Redis Lock ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹åœ¨ Redis ç•¶ä¸­æ˜¯æ€éº¼å¯¦ç¾ Lock æ©Ÿåˆ¶çš„ã€‚\nRedis Lock æ©Ÿåˆ¶ é¦–å…ˆï¼Œåœ¨ redis-cli ä¸‹ä¸€å€‹æŒ‡ä»¤å–å¾—é–\nSET resource_name my_random_value NX PX 30000 resource_nameï¼šé–çš„ Key\nmy_random_valueï¼šé–çš„ Valueï¼Œå¯¦ä½œä¸Šé€šå¸¸æœƒè¨­ç½®ä¸€ä¸² Random Stringï¼Œç•¶ä½œå–å¾—è©²é–çš„ Client è­˜åˆ¥ç¬¦ï¼Œåœ¨é‡‹æ”¾é–æ™‚éœ€æª¢æŸ¥ Key æ‰€å°æ‡‰çš„ Value æ˜¯ä¸æ˜¯å’Œå–å¾—é–æ™‚æ‰€è¨­ç½®çš„ Value ç›¸åŒï¼Œé¿å…é–è¢«å…¶ä»– Client é‡‹æ”¾\nNXï¼šåªæœ‰ç•¶ resource_name ä¸å­˜åœ¨æ‰å‰µå»ºé€™å€‹ Key\nPX 30000ï¼š Key çš„æœ‰æ•ˆæœŸé–“æ˜¯ 30000 æ¯«ç§’ï¼Œè¶…éæœƒè‡ªå‹•å¤±æ•ˆ\nå°±é€™æ¨£ï¼è€Œã€Œé‡‹æ”¾é–ã€çš„å¯¦ä½œï¼Œé€šå¸¸æœƒå¯«æˆä¸€å€‹ LUA è…³æœ¬ï¼Œçµ¦ Redis ä¾†åŸ·è¡Œï¼š\n1 2 3 4 5 6 if redis.call(\u0026#34;GET\u0026#34;,KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;DEL\u0026#34;,KEYS[1]) else return 0 end æ¥è‘—æˆ‘å€‘å¯ä»¥å›åˆ° Laravel ç•¶ä¸­å»ä½¿ç”¨ Redis Lock äº†ï¼\nLaravel Redis Lock å»ºç«‹ä¸¦å–å¾—é– é¦–å…ˆè¦å»ºç«‹ä¸€å€‹é–ï¼Œè¦å…ˆ new ä¸€å€‹ Illuminate\\Cache\\RedisLock\nIlluminate\\Cache\\RedisLock å¯¦ä½œ Illuminate\\Contracts\\Cache\\Lock interfaceï¼Œå¯¦ç¾å–å¾—é–ã€é‡‹æ”¾é–ç­‰åŠŸèƒ½ï¼Œä¸¦ç¹¼æ‰¿ Illuminate\\Cache\\Lock abstract class å…±äº«åˆ†å¸ƒå¼é–çš„ç›¸åŒåŠŸèƒ½ã€‚\n1 2 3 4 use Illuminate\\Cache\\RedisLock; use Illuminate\\Support\\Facades\\Redis; $lock = new RedisLock(Redis::connection(), \u0026#34;creating:snapshot:$order-\u0026gt;id\u0026#34;, 15); ä¾†çœ‹ä¸€ä¸‹ Illuminate\\Cache\\RedisLock çš„å»ºæ§‹å­å¯«äº†ä»€éº¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php /** * Create a new lock instance. * * @param \\Illuminate\\Redis\\Connections\\Connection $redis * @param string $name * @param int $seconds * @param string|null $owner * @return void */ public function __construct($redis, $name, $seconds, $owner = null) { parent::__construct($name, $seconds, $owner); $this-\u0026gt;redis = $redis; } $name ï¼šé–çš„ Keyã€‚åœ¨æˆ‘å€‘çš„ä¾‹å­ç•¶ä¸­ï¼ŒKey å€¼æ‡‰è©²æœƒæ˜¯ OrderSnapshot çš„ order_idï¼Œå› ç‚ºæˆ‘å€‘å°±æ˜¯ç‚ºäº†é¿å…ç›¸åŒ order_id çš„ OrderSnapshot è¢«å»ºç«‹ï¼Œæ‰€ä»¥è¦è™•ç†ç‰¹å®š order_id æ™‚ï¼Œæ‡‰è©²è¦å–å¾—ä¸€å€‹é–ï¼Œé¿å…å…¶ä»–åŸ·è¡Œåºä¹Ÿå°ç›¸åŒ order_id åšè™•ç†ã€‚\n$secondsï¼šKey çš„æœ‰æ•ˆæœŸé–“\n$ownerï¼š é–çš„ Valueã€‚å¦‚æœä¸å¸¶è©²åƒæ•¸ï¼ŒLaravel æœƒå¹«æˆ‘å€‘ç”¢ç”Ÿä¸€ä¸²äº‚æ•¸ç•¶æˆ Valueã€‚åœ¨ Illuminate\\Cache\\Lock çš„å»ºæ§‹å­ç•¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // vendor/laravel/framework/src/Illuminate/Cache/Lock.php public function __construct($name, $seconds, $owner = null) { if (is_null($owner)) { $owner = Str::random(); } $this-\u0026gt;name = $name; $this-\u0026gt;owner = $owner; $this-\u0026gt;seconds = $seconds; } ç„¶å¾Œå‘¼å« acquire æ–¹æ³•æ™‚ï¼Œæ‰æœƒçœŸçš„å‘ Redis ä¸‹æŒ‡ä»¤å»ºç«‹é–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php /** * Attempt to acquire the lock. * * @return bool */ public function acquire() { if ($this-\u0026gt;seconds \u0026gt; 0) { return $this-\u0026gt;redis-\u0026gt;set($this-\u0026gt;name, $this-\u0026gt;owner, \u0026#39;EX\u0026#39;, $this-\u0026gt;seconds, \u0026#39;NX\u0026#39;) == true; } else { return $this-\u0026gt;redis-\u0026gt;setnx($this-\u0026gt;name, $this-\u0026gt;owner) === 1; } } é‡‹æ”¾é– åŒæ¨£å®šç¾©åœ¨ RedisLock çš„å¯¦ä½œè£¡ï¼Œä½¿ç”¨äº†å‰›å‰›æåˆ°çš„ Lua è…³æœ¬ï¼Œå‚³çµ¦ Redis å»åŸ·è¡Œï¼Œè…³æœ¬å…§å®¹å°±æ˜¯åŒæ¨£çš„å…§å®¹ï¼Œé€™é‚Šå°±ä¸è²¼äº†\n1 2 3 4 5 6 7 8 9 10 11 // vendor/laravel/framework/src/Illuminate/Cache/RedisLock.php /** * Release the lock. * * @return bool */ public function release() { return (bool) $this-\u0026gt;redis-\u0026gt;eval(LuaScripts::releaseLock(), 1, $this-\u0026gt;name, $this-\u0026gt;owner); } å–å¾—é–å’Œé‡‹æ”¾é–çš„æµç¨‹æ‡‰è©²æœƒé¡ä¼¼é€™æ¨£(å½ä»£ç¢¼)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 while { if ($lock-\u0026gt;acquire()) { // è™•ç†æ¥­å‹™é‚è¼¯ $lock-\u0026gt;release(); break; } //maybe wait for seconds? sleep(); } è€Œ RedisLock ç•¶ä¸­æœ‰ä¸€å€‹ block æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼Œå·²ç¶“å¹«æˆ‘å€‘è™•ç†äº†æµç¨‹æ§åˆ¶çš„éƒ¨åˆ†ï¼Œé‚„èƒ½é¡å¤–è¨­ç½®ç­‰å¾…é‡‹æ”¾é–çš„è¶…æ™‚æ™‚é–“ï¼ˆè¶…éæœƒæ‹‹å‡ºç•°å¸¸ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public function block($seconds, $callback = null) { $starting = $this-\u0026gt;currentTime(); while (! $this-\u0026gt;acquire()) { // - 7.x ä¹‹å¾Œçš„ laravel æœƒæœ‰ sleepMilliseconds åƒæ•¸ï¼Œé è¨­ç‚º 250 æ¯«ç§’ // - 7.x ä»¥å‰çš„ç›´æ¥å¯«æ­» 250 æ¯«ç§’ usleep($this-\u0026gt;sleepMilliseconds * 1000); if ($this-\u0026gt;currentTime() - $seconds \u0026gt;= $starting) { throw new LockTimeoutException; } } // å–å¾—é–ä¹‹å¾ŒåŸ·è¡Œ callback ä¸¦é‡‹æ”¾é– if (is_callable($callback)) { try { return $callback(); } finally { $this-\u0026gt;release(); } } return true; } æœ€å¾Œä½¿ç”¨ block æ–¹æ³•ï¼Œæ”¹å¯«æˆ‘å€‘ä¸€é–‹å§‹çš„ç¨‹å¼ç¢¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $lock = new RedisLock(Redis::connection(), \u0026#34;creating:snapshot:$order-\u0026gt;id\u0026#34;, 15); return $lock-\u0026gt;block(5, function () use ($order) { $snapshot = OrderSnapshot::where(\u0026#39;order_id\u0026#39;, $order-\u0026gt;id)-\u0026gt;first(); if (!empty($snapshot)) { return $snapshot; } // do something... return OrderSnapshot::create([\u0026#39;payload\u0026#39; =\u0026gt; $order_array]); }); ","date":"Nov 06","permalink":"//localhost:1313/posts/%E5%9C%A8-laravel-%E7%95%B6%E4%B8%AD%E4%BD%BF%E7%94%A8-redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%8E%96-%E9%81%BF%E5%85%8D-race-condition-%E9%87%8D%E8%A4%87%E6%8F%92%E5%85%A5%E7%9B%B8%E5%90%8C%E8%B3%87%E6%96%99%E5%95%8F%E9%A1%8C/","tags":["Laravel","Redis"],"title":"åœ¨ Laravel ç•¶ä¸­ä½¿ç”¨ Redis åˆ†å¸ƒå¼é– é¿å… race condition é‡è¤‡æ’å…¥ç›¸åŒè³‡æ–™å•é¡Œ"},{"categories":null,"contents":" recycle æ–¹æ³•çš„ä½¿ç”¨æƒ…å¢ƒåŠæ¬²è§£æ±ºä¹‹å•é¡Œ åœ¨ laravel 9 factory çš„æ–‡ä»¶ç•¶ä¸­æœ€å¾Œä¸€æ®µæ˜¯åœ¨èªªæ˜ recycle çš„ä½¿ç”¨æƒ…å¢ƒèˆ‡æ–¹æ³•ï¼š\nIf you have models that share a common relationship with another model, you may use theÂ recycleÂ method to ensure a single instance of the related model is recycled for all of the relationships.\nFor example, imagine you haveÂ Airline,Â Flight, andÂ TicketÂ models, where the ticket belongs to an airline and a flight, and the flight also belongs to an airline. When creating tickets, you will probably want the same airline for both the ticket and the flight, so you may pass an airline instance to theÂ recycleÂ method:\nå¤§è‡´ä¸Šæ˜¯èªªåœ¨é‡åˆ°ä»¥ä¸‹é¡å‹çš„é—œè¯æ™‚\nä¸€å€‹ ticket å±¬æ–¼ä¸€å€‹ flight èˆ‡ ä¸€å€‹ airlineï¼ˆticket èº«ä¸Šæœ‰ flight_id èˆ‡ airline_id)ï¼Œè€Œ ticket æ‰€å±¬æ–¼çš„ flight ï¼ˆflight èº«ä¸Šæœ‰ airline_idï¼‰ä¹Ÿæœƒå±¬æ–¼å’Œ ticket ç›¸åŒçš„ airline ï¼ˆticket çš„airline_id å’Œ flight çš„ airline_id ç›¸åŒï¼‰\nå¯ä»¥ä½¿ç”¨ recycle æ–¹æ³•ä¾†å‚³å…¥æœƒå…±ç”¨çš„ airline model å¯¦é«”ï¼š\n1 2 3 Ticket::factory() -\u0026gt;recycle(Airline::factory()-\u0026gt;create()) -\u0026gt;create(); okï¼Œç„¶å¾Œé€™æ®µè§£èªªå°±çµæŸäº†ã€‚æˆ‘çœ‹äº†å¥½å¤šéé‚„æ˜¯æ»¿é ­ç–‘æƒ‘ã€‚ç›´åˆ°æŸ¥åˆ°äº†é€™å€‹åŸå§‹çš„ PRï¼Œçœ‹äº†è£¡é¢çš„ç¯„ä¾‹ç¨‹å¼ç¢¼æ‰ç†è§£äº† recycle çš„ç”¨æ„ã€‚\nPR çš„ä½œè€…å±•ç¤ºäº†åœ¨æ²’æœ‰ recycle æ–¹æ³•æ™‚ï¼Œå¦‚æœè¦å»ºä¸€å€‹æ»¿è¶³éœ€æ±‚ï¼ˆticket å±¬æ–¼ flight ä¹Ÿå±¬æ–¼ airlineï¼Œä¸” flight çš„ airline å’Œ ticket çš„ airline ç›¸åŒï¼‰çš„ Ticket æœƒéœ€è¦é€™æ¨£å¯«ï¼š\n1 2 3 4 5 $airline = Airline::factory()-\u0026gt;create(); Ticket::factory() -\u0026gt;for($airline) -\u0026gt;for(Flight::factory()-\u0026gt;for($airline)) -\u0026gt;create(); ä½†æœ‰äº† recycle ä¹‹å¾Œï¼Œå¯ä»¥æ”¹æˆé€™æ¨£å¯«ï¼š\n1 2 3 4 $airline = Airline::factory()-\u0026gt;create(); Ticket::factory() -\u0026gt;recycle($airline) -\u0026gt;create(); ç­‰æ–¼ recycle å¹«æˆ‘å€‘æŠŠ ticket æ‰€å±¬æ–¼çš„ airline ï¼Œä»¥åŠ ticket æ‰€å±¬çš„ flight æ‰€å±¬çš„ airline éƒ½æŒ‡å®šæˆç•¶æˆåƒæ•¸å‚³å…¥ recycle æ–¹æ³•çš„é‚£ä¸€å€‹ airline å¯¦ä¾‹ã€‚ ä¹Ÿå°±æ˜¯èªªåœ¨å»ºç«‹ ticket çš„éç¨‹ä¸­ï¼Œç•¶éœ€è¦å»ºç«‹å…¶é—œè¯ï¼ˆé—œè¯çš„é—œè¯ã€é—œè¯çš„é—œè¯çš„é—œè¯â‹¯â‹¯ï¼‰model æ™‚ï¼Œåªè¦é‡åˆ° \u0026ldquo;BelongsTo airline\u0026rdquo; çš„é—œè¯ï¼Œéƒ½æœƒç›´æ¥ä½¿ç”¨è©² airline å¯¦ä¾‹ã€‚\næ¸¬è©¦ä¸€ä¸‹æ˜¯ä¸æ˜¯ç¬¦åˆæˆ‘å€‘çš„æƒ³åƒï¼Œé¦–å…ˆå…ˆé–‹å‡ºé€™ä¸‰å€‹ Model èˆ‡ migration å¾Œï¼Œå†åˆ†åˆ¥å®šç¾©ä¸‰è€…çš„ Factoryï¼š\nAirline 1 2 3 4 5 6 7 8 9 10 11 12 13 14 class Airline extends Model { use HasFactory; public function tickets() { return $this-\u0026gt;hasMany(Ticket::class); } public function flights() { return $this-\u0026gt;hasMany(Flight::class); } } 1 2 3 4 5 6 7 8 9 10 // airline migration // default public function up() { Schema::create(\u0026#39;airlines\u0026#39;, function (Blueprint $table) { $table-\u0026gt;id(); $table-\u0026gt;timestamps(); }); } 1 2 3 4 5 6 7 8 9 // AirlineFactory ... public function definition() { return [ // ]; } Flights 1 2 3 4 5 6 7 8 9 10 11 12 13 14 class Flight extends Model { use HasFactory; public function tickets() { return $this-\u0026gt;hasMany(Ticket::class); } public function airline() { return $this-\u0026gt;belongsTo(Airline::class); } } 1 2 3 4 5 6 7 8 9 10 // flight migration ... public function up() { Schema::create(\u0026#39;flights\u0026#39;, function (Blueprint $table) { $table-\u0026gt;id(); $table-\u0026gt;timestamps(); $table-\u0026gt;foreignId(\u0026#39;airline_id\u0026#39;)-\u0026gt;constrained(); }); } 1 2 3 4 5 6 7 8 // FlightFactory ... public function definition() { return [ \u0026#39;airline_id\u0026#39; =\u0026gt; Airline::factory() ]; } Tickets 1 2 3 4 5 6 7 8 9 10 11 12 13 14 class Ticket extends Model { use HasFactory; public function flight() { return $this-\u0026gt;belongsTo(Flight::class); } public function airline() { return $this-\u0026gt;belongsTo(Airline::class); } } 1 2 3 4 5 6 7 8 9 10 11 // tickets migration ... public function up() { Schema::create(\u0026#39;tickets\u0026#39;, function (Blueprint $table) { $table-\u0026gt;id(); $table-\u0026gt;timestamps(); $table-\u0026gt;foreignId(\u0026#39;flight_id\u0026#39;)-\u0026gt;constrained(); $table-\u0026gt;foreignId(\u0026#39;airline_id\u0026#39;)-\u0026gt;constrained(); }); } 1 2 3 4 5 6 7 8 9 // TicketFactory ... public function definition() { return [ \u0026#39;flight_id\u0026#39; =\u0026gt; Flight::factory(), \u0026#39;airline_id\u0026#39; =\u0026gt; Airline::factory() ]; } tinker åŸ·è¡Œçµæœï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026gt;\u0026gt;\u0026gt; $ticket = App\\Models\\Ticket::factory()-\u0026gt;recycle(App\\Models\\Airline::factory()-\u0026gt;create())-\u0026gt;create(); =\u0026gt; App\\Models\\Ticket {#4619 flight_id: 1, airline_id: 1, updated_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, created_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, id: 1, } \u0026gt;\u0026gt;\u0026gt; $ticket-\u0026gt;airline =\u0026gt; App\\Models\\Airline {#3647 id: 1, created_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, updated_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, } \u0026gt;\u0026gt;\u0026gt; $ticket-\u0026gt;flight-\u0026gt;airline =\u0026gt; App\\Models\\Airline {#3628 id: 1, created_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, updated_at: \u0026#34;2022-10-05 11:02:54\u0026#34;, } ç¢ºå¯¦ ticket çš„ airline å’Œ ticket çš„ flight çš„ airline éƒ½æ˜¯ id ç‚º 1 çš„ airlineã€‚\nåŸå§‹ç¢¼åˆ†æ æ¥è‘—ä¾†çœ‹ä¸€ä¸‹é€™å€‹ç¥å¥‡çš„åŠŸèƒ½æ˜¯å¦‚ä½•è¢«å¯¦ç¾çš„ã€‚\né¦–å…ˆ recyle æ–¹æ³•æœƒå°‡è¦å…±ç”¨çš„å¯¦ä¾‹æš«å­˜åœ¨ Factory ç•¶ä¸­çš„ recyle å±¬æ€§ç•¶ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 //vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php L627 public function recycle($model) { // Group provided models by the type and merge them into existing recycle collection return $this-\u0026gt;newInstance([ \u0026#39;recycle\u0026#39; =\u0026gt; $this-\u0026gt;recycle -\u0026gt;flatten() -\u0026gt;merge( Collection::wrap($model instanceof Model ? func_get_args() : $model) -\u0026gt;flatten() )-\u0026gt;groupBy(fn ($model) =\u0026gt; get_class($model)), ]); } create æ–¹æ³•è¢«å‘¼å«å¾Œï¼Œé€²åˆ° make ï¼Œ å†é€²åˆ° $this-\u0026gt;count === null if æ•˜è¿°è£¡é¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 //vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php public function make($attributes = [], ?Model $parent = null) { if (! empty($attributes)) { return $this-\u0026gt;state($attributes)-\u0026gt;make([], $parent); } if ($this-\u0026gt;count === null) { return tap($this-\u0026gt;makeInstance($parent), function ($instance) { // here $this-\u0026gt;callAfterMaking(collect([$instance])); }); } ... } æ¥è‘—é€²åˆ° makeInstance ï¼Œç•¶ä¸­ newModel æ™‚å‘¼å«äº† getExpandedAttributes æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 protected function makeInstance(?Model $parent) { return Model::unguarded(function () use ($parent) { return tap($this-\u0026gt;newModel($this-\u0026gt;getExpandedAttributes($parent)), function ($instance) { if (isset($this-\u0026gt;connection)) { $instance-\u0026gt;setConnection($this-\u0026gt;connection); } }); }); } å°‡ $this-\u0026gt;getRawAttributes($parent) è¿”å›å€¼ï¼ˆæˆ‘å€‘å‰›å‰›åœ¨æ¯å€‹ Model Factory ç•¶ä¸­çš„ defination æ–¹æ³•å›å‚³çš„é™£åˆ—ï¼‰ç•¶ä½œåƒæ•¸å¡é€² expandAttributes ä¸¦å›å‚³çµæœ\n1 2 3 4 protected function getExpandedAttributes(?Model $parent) { return $this-\u0026gt;expandAttributes($this-\u0026gt;getRawAttributes($parent)); } é‡é»å°±åœ¨é€™è£¡ï¼Œé‚„è¨˜å¾—å‰é¢æ‰€å»ºç«‹çš„ Model Factory ç•¶ä¸­æˆ‘å€‘å°‡ foreign key åˆ†åˆ¥æŒ‡å®šç‚ºå°æ‡‰çš„ Factory\n1 2 3 4 5 6 7 8 9 // TicketFactory ... public function definition() { return [ \u0026#39;flight_id\u0026#39; =\u0026gt; Flight::factory(), \u0026#39;airline_id\u0026#39; =\u0026gt; Airline::factory() ]; } åœ¨åŸ·è¡Œåˆ°\nApp\\Models\\Ticket::factory()-\u0026gt;recycle(App\\Models\\Airline::factory()-\u0026gt;create())-\u0026gt;create()\nçš„ç¬¬äºŒå€‹ create ï¼ˆ TicketFactory::createï¼‰ä¸¦ä¸”é€²åˆ° expandAttributes æ–¹æ³•è£¡ï¼Œç•¶ä¸­çš„ $definition å…¶å¯¦å°±ç­‰åŒä¸Šé¢é€™å€‹é™£åˆ—å…§å®¹ï¼ˆè©³æƒ…å¯è¦‹ getRawAttributes æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥ $attribute åˆ†åˆ¥æœƒæ˜¯ Flight::factory() å’Œ Airline::factory()\nè€ŒåŸ·è¡Œç¬¬ä¸€å€‹è¿­ä»£æ™‚ï¼ˆ $this = TicketFactory, $attribute = Flight::factory() ï¼‰ç”±æ–¼åœ¨æš«å­˜çš„ recycle å±¬æ€§ä¸­æ‰¾ä¸åˆ°å°æ‡‰çš„ Flight Modelï¼Œæ‰€ä»¥å°‡ Flight::factory() ä¹Ÿå‚³å…¥ç•¶å‰çš„ recycle å±¬æ€§å¾Œå† createã€‚å°±æ˜¯åœ¨é€™å€‹åœ°æ–¹å½¢æˆéè¿´ï¼Œä¸æ–·æŠŠ recycle å‚³çµ¦ä¸‹ä¸€å€‹å±¬æ–¼çš„é—œè¯å¾Œå†å»ºç«‹é—œè¯ Modelã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 protected function expandAttributes(array $definition) { return collect($definition) -\u0026gt;map($evaluateRelations = function ($attribute) { if ($attribute instanceof self) { ///*** $attribute = $this-\u0026gt;getRandomRecycledModel($attribute-\u0026gt;modelName()) ?? $attribute-\u0026gt;recycle($this-\u0026gt;recycle)-\u0026gt;create()-\u0026gt;getKey(); ///*** } elseif ($attribute instanceof Model) { $attribute = $attribute-\u0026gt;getKey(); } return $attribute; }) ... } ç¸½çµ ä¹‹æ‰€ä»¥æœƒæœ‰ recycle é€™å€‹æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç‚ºäº†å¯ä»¥ä½¿ç”¨åŒä¸€å€‹å¯¦ä¾‹ä½œç‚ºé—œè¯ä¸”ä¸éœ€å·¢ç‹€å‘¼å« for æ–¹æ³•ã€‚ é‡é»åœ¨æ–¼ éœ€äº‹å…ˆåœ¨ Model Factory ç•¶ä¸­å°‡ {model}_idæŒ‡å®šç‚ºå°æ‡‰çš„ Factory ({model}::factory()) ï¼Œè¦é”åˆ°é€™é» recycle æ‰æœƒæœ‰ä½œç”¨ã€‚\nå€‹äººæ˜¯è¦ºå¾—æ–‡ä»¶æ²’æœ‰å¯«å¾—éå¸¸æ¸…æ¥šï¼ŒèŠ±äº†ä¸€ç•ªåŠ›æ°£æ‰çœŸæ­£ç†è§£å®ƒçš„ç”¨æ³•ï¼Œä½†ä¹Ÿå‰›å¥½å¯ä»¥ç†è§£ä¸€ä¸‹åŸç†å•¦ã€‚\n","date":"Oct 05","permalink":"//localhost:1313/posts/laravel-9-factory-recycle-method-%E7%94%A8%E6%B3%95%E8%88%87%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/","tags":["Laravel"],"title":"Laravel 9 factory recycle method ç”¨æ³•èˆ‡åŸç†åˆ†æ"},{"categories":null,"contents":" slice è³‡æ–™çµæ§‹ Golang åº•å±¤ä½¿ç”¨ SliceHeader å»æè¿°é‹è¡Œæ™‚çš„ slice\n1 2 3 4 5 type SliceHeader struct { Data uintptr Len int Cap int } å°æ‡‰ä¸€å€‹ slice å…·å‚™çš„ä¸‰å€‹å±¬æ€§ï¼š\nLen - slice çš„é•·åº¦ Cap - åº•å±¤é™£åˆ—å¤§å° Data - åº•å±¤ array ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ slice æœ‰é»é¡ä¼¼ java çš„ ArrayListï¼Œlen å°±ç­‰åŒæ–¼ sizeï¼Œè¡¨ç¤º list ç•¶ä¸­çš„å…ƒç´ æ•¸é‡ï¼Œè€Œ cap å‰‡å°æ‡‰ ArrayList çš„ capacityï¼Œä¹Ÿå°±æ˜¯åº•å±¤é™£åˆ—çš„å¤§å°ã€‚\nä¹‹æ‰€ä»¥ç‰¹åˆ¥å¼·èª¿ slice æ‰€è¨˜éŒ„çš„åº•å±¤é™£åˆ—æŒ‡æ¨™æ˜¯ã€Œé™£åˆ—ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ã€ï¼Œæ˜¯å› ç‚ºè¦æé†’ä¸è¦å¿˜äº†é™£åˆ—çš„æœ¬è³ªå°±æ˜¯ä¸€ä¸²é€£çºŒçš„è¨˜æ†¶é«”ç©ºé–“ï¼Œå„²å­˜ç¬¬ä¸€å€‹å…ƒç´ æŒ‡æ¨™ï¼ˆä½å€ï¼‰å¾Œå³å¯è—‰ç”±ç´¢å¼•åŠå…ƒç´ å¤§å°ä¾†è¨ˆç®—å‡ºå…¶ä»–ç´¢å¼•ç¢ºåˆ‡çš„è¨˜æ†¶é«”ä½å€ã€‚\nSlice Assignment 1 2 3 s1 := make([]int, 0) s2 := s1 åŸ·è¡Œ s2 := s1 æ™‚ï¼Œé›–ç„¶æ˜¯è¤‡è£½å‡ºå¦ä¸€å€‹ sliceï¼ˆè¨˜æ†¶é«”ä½ç½®ä¸åŒï¼‰ï¼Œä½†å…©è€…çš„æŒ‡æ¨™ä»æ˜¯åŒä¸€å€‹ï¼Œéƒ½æŒ‡å‘ç›¸åŒçš„é™£åˆ—ï¼ˆèµ·å§‹ä½ç½®ï¼‰\né™¤éå…¶ä¸­ä¸€å€‹ slice åœ¨ append æ™‚ï¼Œç™¼ç¾åŸæœ¬é™£åˆ—ç©ºé–“ä¸å¤ ï¼Œå› æ­¤å»ºå¦ä¸€å€‹æ–°çš„é™£åˆ—ï¼Œæ‰æœƒé€ æˆå…©è€…æ‰€æŒ‡å‘çš„åº•å±¤é™£åˆ—ä¸åŒï¼Œæœ‰é—œ append çš„ reallocate æ©Ÿåˆ¶ï¼Œåƒè€ƒï¼šhttps://go.dev/blog/slices\næ‰€ä»¥ç•¶æ–°å¢ä¸€å€‹å¦‚ä¸‹çš„ sliceï¼š\n1 2 3 4 5 s1 := make([]int, 5, 10) fmt.Println(s1) // [0, 0, 0, 0, 0] fmt.Println(len(s1), cap(s1), \u0026amp;s1[0]) // 5 10 0xc0000ac002 ç­‰åŒæ–°å»ºä¸€å€‹å¤§å°ç‚º 10 çš„é™£åˆ—ï¼Œä¸¦åœ¨é™£åˆ—å¡«å…¥ 5 å€‹ int é¡å‹çš„ zero valueï¼Œå†æŠŠ slice çš„ len è¨­ç‚º 5ï¼Œ cap è¨­ç‚º 10ï¼Œä¸¦ä¸”ç´€éŒ„é™£åˆ—ç¬¬ä¸€å€‹å…ƒç´ çš„æŒ‡æ¨™ã€‚\nç”¨åœ–ç¤ºè¡¨ç¤ºï¼š\næ‰€ä»¥ç•¶æˆ‘å€‘è¦å–è¶…é slice é•·åº¦(len)çš„å…ƒç´ \n1 fmt.Println(s1[5]) æœƒç²å¾—ä¸€å€‹ runtime error: index out of range [5] with length 5 çš„ panic\nSlice Assignment + append æ–¹æ³•çš„éé æœŸè¡Œç‚º ç•¶è¦å¾€ä¸€å€‹ len ç‚º 0 çš„ slice ç•¶ä¸­æ·»åŠ å…ƒç´ æ™‚ï¼Œæœƒéœ€è¦ä½¿ç”¨ append æ–¹æ³•ï¼Œè©²æ–¹æ³•æœƒå›å‚³ä¸€å€‹æ›´æ–°å¾Œçš„ sliceã€‚é€šå¸¸éƒ½æœƒé€™æ¨£ä½¿ç”¨ï¼š\n1 2 nums := make([]int, 0, 8) nums = append(nums, 1) // append éå¾Œçš„çµæœç›´æ¥è³¦å€¼çµ¦ nums è®Šæ•¸ å»¶ä¼¸ä¸Šé¢æåˆ°çš„ slice assignment æ¦‚å¿µï¼Œç•¶å¦å¤–ä¸€å€‹è®Šæ•¸ newNums ä¹Ÿæ¥æ”¶ append å¾Œå›å‚³çš„æ–° sliceï¼Œå…©å€‹ slice (nums \u0026amp; newNums) æ‰€æŒ‡å‘åº•å±¤é™£åˆ—ç›¸åŒæ™‚ï¼Œä»¥ä¸‹ç¨‹å¼ç¢¼æœƒå°å‡ºä»€éº¼ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 nums := make([]int, 0, 8) nums = append(nums, 1) nums = append(nums, 2) nums = append(nums, 3) nums = append(nums, 4) nums = append(nums, 5) newNums := append(nums, 6) newNums = append(newNums, 7) nums = append(nums, 7) fmt.Println(newNums) fmt.Println(nums) çµæœæœƒæ˜¯ï¼š\n1 2 [1 2 3 4 5 7 7] [1 2 3 4 5 7] å¦‚æœè¦ºå¾—æ„å¤–çš„è©±ï¼Œæˆ‘å€‘å°±ä¸€å€‹å€‹ä¾†çœ‹ç©¶ç«Ÿç™¼ç”Ÿä»€éº¼äº‹å§ã€‚\né¦–å…ˆï¼Œåœ¨å»ºç«‹ newNums ä¹‹å‰ï¼Œ nums è·Ÿåº•å±¤é™£åˆ—é•·é€™æ¨£ï¼š\næ¥è‘—åˆ°äº† newNums := append(nums, 6) é€™è¡Œï¼Œå»ºç«‹æ–°çš„ slice ä¸¦ä¸”åŠ äº†ä¸€å€‹æ–°çš„å…ƒç´  6 åˆ°é™£åˆ—ï¼š\né€™æ™‚å¯èƒ½æœ‰äººæœƒå•ï¼Œæ—¢ç„¶åº•å±¤é™£åˆ—å¤šäº†ä¸€å€‹å…ƒç´ ï¼Œç„¶å¾ŒåŸæœ¬çš„ nums ä¹ŸæŒ‡å‘é€™å€‹é™£åˆ—ï¼Œé‚£ nums ä¸å°±ä¹Ÿæœƒå¤šä¸€å€‹å…ƒç´ å—ï¼Ÿ\nä½†å…¶å¯¦å‹•åˆ°çš„æ˜¯åº•å±¤é™£åˆ—è€Œä¸æ˜¯ num é€™å€‹ sliceï¼Œå› ç‚º nums æœ¬èº«çš„ len ä¸¦æ²’æœ‰æ”¹è®Šï¼ˆæ”¹è®Šçš„æ˜¯ newNumsçš„ len ï¼‰ï¼Œå‰›å‰›å‰é¢æœ‰æåˆ°ï¼Œç•¶è¦å–è¶…é slice é•·åº¦(len)çš„å…ƒç´ ï¼Œæœƒæ‹‹å‡ºä¾‹å¤–ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œåœ¨ nums é€™å€‹ slice é›–ç„¶æœ¬èº«åº•å±¤é™£åˆ—å·²ç¶“é­åˆ°æ”¹å‹•äº†ï¼Œä½†å› çˆ²æˆ‘å€‘éƒ½æ˜¯é€é slice å»å°åº•å±¤é™£åˆ—å–å€¼çš„ ï¼Œè€Œ nums çš„ len é‚„æ˜¯ 5ï¼Œæ ¹æœ¬ç„¡æ³• reach åˆ° index ç‚º 5 çš„å…ƒç´ ã€‚\nç¹¼çºŒå¾€ä¸‹åˆ° newNums = append(newNums, 7) é€™ä¸€è¡Œï¼Œåº•å±¤é™£åˆ—åˆå¤šäº†ä¸€å€‹ 7ï¼š\næ¥è‘—åˆ° nums = append(nums, 7) é€™è¡Œï¼Œç”±æ–¼ nums slice æœ€å¾Œä¸€å€‹å…ƒç´ çš„ index ç­‰æ–¼ 4ï¼Œæ‰€ä»¥ append æ–¹æ³•æ˜¯æœƒå°‡é™£åˆ— index 4+1=5 çš„ä½ç½®æ”¾å…¥ 7 é€™å€‹å€¼ï¼Œæ‰€ä»¥å°±é€ æˆ index 5 åŸæœ¬çš„å€¼è¢«å–ä»£ï¼š\né©—è­‰ nums index 5 å’Œ newNums index 5 çš„æŒ‡æ¨™ï¼ˆè¨˜æ†¶é«”ä½ç½®ï¼‰ç¢ºå¯¦ç›¸åŒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 newNums := append(nums, 6) fmt.Println(newNums[5], \u0026amp;newNums[5]) // 6 0xc000128068 -\u0026gt;é€™æ™‚å€™é‚„æ˜¯ 6 newNums = append(newNums, 7) fmt.Println(newNums[6], \u0026amp;newNums[6]) // 7 0xc000128070 nums = append(nums, 7) fmt.Println(nums[5], \u0026amp;nums[5]) // 7 0xc000128068 -\u0026gt;è¢«ä¸Šé¢é‚£è¡Œæ”¹æˆ 7 fmt.Println(newNums[5], \u0026amp;newNums[5]) // 7 0xc000128068 -\u0026gt;å’Œ nums ç‚ºåŒä¸€å€‹è¨˜æ†¶é«”ä½ç½® fmt.Println(nums) // [1 2 3 4 5 7] fmt.Println(newNums) // [1 2 3 4 5 7 7] -\u0026gt; index 5 çš„å€¼å·²è¢«è¦†è“‹ ç¸½çµï¼Œslice å¯ä»¥è¦–ä½œåœ¨é™£åˆ—ä¹‹ä¸Šçš„ä¸€å±¤â€œç‰‡æ®µè³‡è¨Šâ€ï¼Œè—‰ç”±é€™å€‹ç‰‡æ®µï¼Œæˆ‘å€‘å¯ä»¥å°åº•å±¤é™£åˆ—å–å€¼ã€å¢åˆªæ”¹å…ƒç´ ï¼ŒåŒæ™‚ä¹Ÿå…è¨±å¤šå€‹ç‰‡æ®µå‘åŒå€‹é™£åˆ—æ“ä½œï¼Œä¸åŒç‰‡æ®µå–çš„ç´¢å¼•ç¯„åœå¯èƒ½ä¹Ÿä¸åŒã€‚ä½†ä¹Ÿæ˜¯å› æ­¤å¿…é ˆéå¸¸å°å¿ƒï¼Œå› ç‚ºåªè¦åº•å±¤é™£åˆ—ä¸€è¢«æ”¹å‹•ï¼Œæ‰€æœ‰åƒè€ƒè©²é™£åˆ—çš„ slice éƒ½å¯èƒ½æœƒå—åˆ°å½±éŸ¿ã€‚\n","date":"Aug 16","permalink":"//localhost:1313/posts/golang-slice-assignment-%E8%88%87-append-%E6%96%B9%E6%B3%95/","tags":["Golang"],"title":"Golang Slice Assignment èˆ‡ append æ–¹æ³•"},{"categories":null,"contents":"æ¸¬è©¦æ™‚è‹¥æ¶‰åŠç¬¬ä¸‰æ–¹æœå‹™ï¼Œå¾€å¾€æœƒéœ€è¦é‹ç”¨åˆ° Mock ï¼ˆæ¸¬è©¦æ›¿èº«ï¼‰çš„æ¦‚å¿µï¼Œå°‡å¤–éƒ¨æ¨¡çµ„ä»£æ›æˆä¸€å€‹å‡çš„ç‰©ä»¶ï¼Œä¸¦æ¨¡æ“¬å…¶è¡Œç‚ºèˆ‡å›å‚³å€¼ï¼Œè®“æˆ‘å€‘èƒ½å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯çš„å–®å…ƒæ¸¬è©¦ã€‚\nç•¶å‰çš„æƒ…å¢ƒç‚ºï¼Œåœ¨ Repository è£¡ä½¿ç”¨ aws SDK for go ç•¶ä¸­çš„ dynamodb client ä¾†å»ºç«‹èˆ‡ dynamodb çš„é€£ç·šä»¥åŠå¾ŒçºŒç›¸é—œå°è³‡æ–™åº«çš„æ“ä½œã€‚ä½†åœ¨é€²è¡Œæ¸¬è©¦æ™‚ï¼Œç‚ºäº†é¿å…æ¯æ¬¡è·‘æ¸¬è©¦éƒ½è¦çœŸçš„æˆ³è³‡æ–™åº«ï¼ˆå› åœ¨å–®å…ƒæ¸¬è©¦ä¸­ï¼Œæˆ‘å€‘åªæƒ³è¦ç¢ºå®šèˆ‡ dynamodb client çš„äº’å‹•æœ‰ç¢ºå¯¦å‘¼å«é æœŸçš„æ–¹æ³•ã€å‚³å…¥ç›¸æ‡‰çš„åƒæ•¸ï¼Œè€Œä¸åœ¨ä¹è³‡æ–™åº«åˆ°åº•æœ‰æ²’æœ‰å¯«å…¥è³‡æ–™é€™ç¨®äº‹ï¼‰ï¼Œæœƒéœ€è¦å°‡é€™å€‹ client æ›¿æ›æˆ Mock ç‰©ä»¶ã€‚\nè€Œ aws SDK for go å°±æä¾›äº†ä¸€å€‹æ–¹ä¾¿é–‹ç™¼è€…é€²è¡Œ mocking çš„ interfaceï¼šdynamodb interface\næˆ‘å€‘å¯ä»¥ç›´æ¥ä½¿ç”¨ dynamodb interface ä½œç‚ºä¾è³´çš„é¡å‹ï¼Œä¹Ÿå°±æ˜¯èªªå¦‚æœè¦æ”¾ä¸€å€‹ dynamodb client åœ¨ struct è£¡é¢ï¼ŒåŸæœ¬å¯èƒ½æœƒç›´æ¥ä½¿ç”¨ *dynamodb.DynamoDB é¡å‹ï¼š\n1 2 3 4 5 6 7 8 type dynamodbUserNotificationRepository struct { Client *dynamodb.DynamoDB } // å¯¦ä¾‹åŒ–æ™‚æ³¨å…¥ dynamodb client ä¾è³´ func NewDynamondbUserNotificationRepository(Client *dynamodb.DynamoDB) domain.UserNotificationRepository { return \u0026amp;dynamodbUserNotificationRepository{Client} } ä½†ç‚ºäº†ä¹‹å¾Œæ–¹ä¾¿åœ¨æ¸¬è©¦æ™‚èƒ½è¼•é¬†æ³¨å…¥ Mock ç‰©ä»¶ï¼Œå¯ä»¥æ›¿æ›æˆ dynamodbiface.DynamoDBAPI ï¼š\n1 2 3 4 5 6 7 type dynamodbUserNotificationRepository struct { Client dynamodbiface.DynamoDBAPI // instead of *dynamodb.DynamoDB } func NewDynamondbUserNotificationRepository(Client dynamodbiface.DynamoDBAPI) domain.UserNotificationRepository { return \u0026amp;dynamodbUserNotificationRepository{Client} } ç¹¼çºŒå®Œæ•´é€™å€‹ç¯„ä¾‹ï¼Œå‡è¨­ dynamodbUserNotificationRepository æœ‰ä¸€å€‹ Store æ–¹æ³•ï¼š\n1 2 3 func (d *dynamodbUserNotificationRepository) Store(ctx context.Context, user_notification_input *domain.UserNotificationRequestInputStore, batch string) (user_notification *domain.UserNotification, err error) { // è£¡é¢æœƒå‘¼å«åˆ° d.Client.PutItem æ–¹æ³• } è¦æ¸¬è©¦ä¸Šé¢é€™å€‹ Store æ–¹æ³•ï¼Œéœ€è¦å°‡ dynamodbUserNotificationRepository è£¡é¢çš„ Client å–ä»£æˆ Mock ç‰©ä»¶ï¼Œæ‰€ä»¥æˆ‘å€‘å…ˆæŒ‰ç…§å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹å®šç¾©ä¸€å€‹ Mock client structï¼š\n1 2 3 type MockDynamoDBClient struct { dynamodbiface.DynamoDBAPI } æ¥è‘—è¤‡å¯« PutItem æ–¹æ³•ï¼Œå›å‚³ dummy è³‡æ–™ï¼š\n1 2 3 func (m *mockDynamoDBClient) PutItem(input *dynamodb.PutItemInput) (*dynamodb.PutItemOutput,error) { return \u0026amp;dynamodb.PutItemOutput{}, nil } ç„¶å¾Œå°±å¯ä»¥åœ¨æ¸¬è©¦ä¸­ new ä¸€å€‹ mockDynamoDBClient å‚³å…¥ NewDynamondbUserNotificationRepositoryï¼š\n1 2 3 4 5 func TestStore(t *testing.T) { mockSvc := \u0026amp;mockDynamoDBClient{} repo := repository.NewDynamondbUserNotificationRepository(mockSvc) // do something... } æ„Ÿè¦ºå°±å¾ˆé–‹å¿ƒåœ°å¯«å®Œæ¸¬è©¦äº†ã€‚ä½†å¦‚æœåŒæ™‚æœ‰å¦å¤–ä¸€å€‹æ–¹æ³•ä¹Ÿæœƒå‘¼å« PutItem ï¼Œè€Œåœ¨ç‚ºé€™å€‹æ–¹æ³•å¯«æ¸¬è©¦æ™‚ï¼ŒPutItem çš„å›å‚³å€¼å¿…é ˆä¸åŒï¼Œè©²æ€éº¼è¾¦ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å¯èƒ½æ˜¯å†å¦å¤–å¯«å€‹ Mock client 2ï¼Œä½†æœ‰ n å€‹é›£é“è¦å¯« n æ¬¡å—ï¼Ÿ\né€™å°±æ˜¯ testify/mock å‡ºå ´çš„æ™‚å€™äº†ï¼Œä½¿ç”¨å®ƒèƒ½è®“æˆ‘å€‘åœ¨å€‹åˆ¥æ¸¬è©¦è£¡å®šç¾© Mock ç‰©ä»¶æœƒè¢«å‘¼å«çš„æ–¹æ³•ååŠå…¶å›å‚³å€¼ã€‚\nå°‡ MockDynamoDBClient ä¿®æ”¹ç‚ºï¼š\n1 2 3 4 type MockDynamoDBClient struct { dynamodbiface.DynamoDBAPI // 1. mock.Mock // (å¤šåŠ ä¸Šçš„éƒ¨åˆ†) 2. } é€™è£¡åŒæ™‚ä½¿ç”¨åˆ°å…©å€‹ package æä¾›çš„ interface ä»¥åŠ struct\naws/aws-sdk-go dynamodbiface.DynamoDBAPI: ä¾ç…§å®˜æ–¹æ–‡ä»¶ç¯„ä¾‹ï¼Œå°‡ dynamodbiface.DynamoDBAPI interface ç”¨åŒ¿åçš„æ–¹å¼åµŒé€² Mock client struct è£¡é¢ï¼Œä½¿å¾—è©² struct ç­‰åŒâ€ç¹¼æ‰¿â€äº†é€™äº› interface ç•¶ä¸­çš„æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥è¢«è¦–ç‚ºä¸€å€‹æœ‰å¯¦ç¾è©² interface çš„ structã€‚ stretchr/testify mock.Mock: ä¾ç…§å®˜æ–¹ç¯„ä¾‹ï¼Œåœ¨å®šç¾© Mock client struct ç•¶ä¸­åµŒå…¥ mock.Mockï¼ˆåŒæ¨£æœƒæœ‰â€ç¹¼æ‰¿â€œ mock.Mock è£çš„æ–¹æ³•çš„æ•ˆæœï¼‰ã€‚ å…©è€…éƒ½åˆ©ç”¨åˆ°äº† golang struct embed çš„ç‰¹æ€§ï¼Œé—œæ–¼ golang çš„ struct with embedded anonymous interface æœ‰ç©ºæœƒå†å¯«å¦ä¸€ç¯‡ç­†è¨˜ä¾†è§£é‡‹ã€‚ Refï¼šhttps://stackoverflow.com/a/24546029/10943670\næ¥è‘—å®šç¾© mock client å¾…æœƒåœ¨æ¸¬è©¦ä¸­æœƒè¢«å‘¼å«åˆ°çš„æ–¹æ³•ï¼š\n1 2 3 4 func (m *MockDynamoDBClient) PutItem(input *dynamodb.PutItemInput) (*dynamodb.PutItemOutput,error) { arg := m.Called(input) // 1. return arg.Get(0).(*dynamodb.PutItemOutput), arg.Error(1) // 2. } å–å¾—åƒæ•¸: é€™è£çš„ Called æ–¹æ³•æœƒå–å¾— PutItem æ–¹æ³•è¢«å‘¼å«ä¹‹å¾Œæ‡‰è©²è¦å›å‚³çš„åƒæ•¸ï¼Œå¾…æœƒæœƒåœ¨å¯«æ¸¬è©¦æ™‚å¯¦éš›å®šç¾©ï¼Œç¸½ä¹‹é€™é‚Šå°±æ˜¯é æœŸæœƒå¾—åˆ°ä¸€çµ„åœ¨æ¸¬è©¦æ™‚å®šç¾©çš„å›å‚³åƒæ•¸ã€‚ é¡å‹æª¢æŸ¥: æª¢æŸ¥å¾—åˆ°çš„åƒæ•¸æ˜¯å¦ç¬¦åˆé¡å‹ï¼Œæ˜¯çš„è©±æ‰æœƒçœŸçš„å°‡å…¶ç•¶æˆ PutItem æ–¹æ³•çš„å›å‚³å€¼å‚³å‡ºå»ã€‚ arg.Get(0).(*dynamodb.PutItemOutput) è¡¨ç¤ºå¾—åˆ°çš„ç¬¬ä¸€å€‹åƒæ•¸å¿…é ˆæ˜¯ *dynamodb.PutItemOutput é¡å‹ï¼Œarg.Error(1) è¡¨ç¤ºå¾—åˆ°çš„ç¬¬äºŒå€‹åƒæ•¸å¿…é ˆæ˜¯ Error é¡å‹ï¼Œè‹¥ä¸ç¬¦åˆé¡å‹æœƒå¼•ç™¼ panicã€‚ å®˜æ–¹æ–‡ä»¶ï¼šhttps://github.com/stretchr/testify/blob/master/mock/doc.go\næœ€å¾Œä¾†è·‘ä¸€æ¬¡åŠ å…¥äº† mock.Mock ä¹‹å¾Œçš„æ•´å€‹æ¸¬è©¦æµç¨‹å§ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func TestStore(t *testing.T) { mockSvc := \u0026amp;mockDynamoDBClient{} // 1. mockSvc.On(\u0026#34;PutItem\u0026#34;, mock.Anything).Return(\u0026amp;dynamodb.PutItemOutput{}, nil).Once() // 2. repo := repository.NewDynamondbUserNotificationRepository(mockSvc) // 3. // other arrangements... // action ret, err := repo.Store(context.TODO(), mockedInput, batch) // 4. // assertions... } é¦–å…ˆå¯¦ä¾‹åŒ–ä¸€å€‹ Mock client é‡é»åœ¨æ–¼é€™å€‹éƒ¨åˆ†ï¼Œä½¿ç”¨äº† mock.Mock ç•¶ä¸­çš„æ–¹æ³•ï¼Œåˆ†åˆ¥è§£é‡‹å„å€‹æ–¹æ³•ä½œç”¨ï¼š On(\u0026quot;PutItem\u0026quot;, mock.Anything) ï¼šæ–·è¨€å‘¼å«è©²ç‰©ä»¶çš„ PutItem æ–¹æ³•æ™‚æœƒæ”¶åˆ°ä¸€å€‹ä»»æ„åƒæ•¸ mock.Anything Return(\u0026amp;dynamodb.PutItemOutput{}, nil) ï¼šä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„ Called æ–¹æ³•è¢«å‘¼å«å¾Œçš„å›å‚³å€¼ Once() ï¼šæ–·è¨€è©²æ–¹æ³•æ‡‰è©²è¦è¢«å‘¼å«ä¸€æ¬¡ å†ä¾†å°‡ Mock client ç‰©ä»¶æ³¨å…¥ NewDynamondbUserNotificationRepository å‘¼å« repo.Store(context.TODO(), mockedInput, batch) æ™‚ï¼Œè£¡é¢å°‡æœƒå‘¼å« Mock client çš„ PutItem æ–¹æ³• ä»¥ä¸Šå°±æ˜¯çµåˆ aws SDK for go æ‰€æä¾›çš„ dynamodb interface æ­é… testify/mock é€²è¡Œå–®å…ƒæ¸¬è©¦çš„æ–¹æ³•ï½\n","date":"Aug 04","permalink":"//localhost:1313/posts/mock-dynamodb-clientuse-aws-sdk-for-golang-with-testify-mock/","tags":["Golang","Testing"],"title":"Mock Dynamodb Client(use aws SDK for golang) with testify/mock"},{"categories":null,"contents":" ç”±æ–¼ä»¥ä¸‹æ‰€åˆ†æçš„åŸå§‹ç¢¼æ˜¯èˆŠç‰ˆ(5.5)çš„ laravelï¼Œä½†å› ç‚ºæœ¬æ–‡ä¸»è¦æ¢è¨ IoC åœ¨ç‰¹å®š method çš„ä¾è³´è§£æï¼Œæ ¸å¿ƒæ¦‚å¿µæ˜¯ä¸è®Šçš„ï¼Œä½†å¯èƒ½ä¸åŒç‰ˆæœ¬åœ¨éƒ¨åˆ†ç¨‹å¼ç¢¼ä¸Šé¢æœƒæœ‰äº›è¨±å·®ç•°ã€‚\nç†Ÿæ‚‰ Laravel çš„äººæ‡‰è©²éƒ½æ›‰å¾— IoC Container çš„å¼·å¤§ä¹‹è™•ï¼Œåœ¨ laravel ç•¶ä¸­ï¼Œå¯ä»¥ç°¡å–®åœ°é€éä¸€è¡Œ app(MyClass::class) å–å¾—å·²ç¶“è¢«æ³¨å…¥ä¾è³´å¾Œ Class çš„å¯¦ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 class Dependence1 { function foo() { echo \u0026#34;foo\u0026#34;; } } class Dependence2 { function foo2() { echo \u0026#34;foo2\u0026#34;; } } final class MyClass { private $dep1; private $dep2; public function __construct( Dependence1 $dependence1, Dependence2 $dependence2 ) { $this-\u0026gt;dep1 = $dependence1; $this-\u0026gt;dep2 = $dependence2; } } app(MyClass::class); // maybe $this-\u0026gt;app-\u0026gt;make(MyClass::class) in ServiceProvider é€™æ˜¯ä¸€å€‹ laravel å¯¦ç¾æ§åˆ¶åè½‰(IoC)çš„ç°¡å–®ä¾‹å­ ï¼ŒMyClass çš„å»ºæ§‹å­ç•¶ä¸­çš„å…©å€‹å¼•æ•¸(ä¾è³´çš„Class) è¢« container è®€å–åˆ°å¾Œï¼Œå…ˆåˆ†åˆ¥è¢«å¯¦ä¾‹åŒ–ä¸¦ä½œç‚ºåƒæ•¸å‚³é€² MyClass çš„å»ºæ§‹å­ï¼Œæœ€å¾Œè¿”å›å¯¦ä¾‹åŒ–å®Œæˆçš„ MyClass ç‰©ä»¶ã€‚(æ¯æ¬¡æ‹œè®€åˆ°é€™é‚ŠçœŸçš„æ˜¯æƒ³è·ª laravel ä½œè€…ï¼‰\nIoC çš„æ ¸å¿ƒç†å¿µå°±æ˜¯å°‡åŸæœ¬åœ¨ä¸‹å±¤ï¼ˆå…·é«”ï¼‰çš„ç¨‹å¼ç¢¼ä¸­ã€Œæ³¨å…¥ä¾è³´ã€é€™å€‹è¡Œç‚ºï¼Œæå‡è‡³ä¸Šå±¤ï¼ˆæŠ½è±¡ï¼‰å»æ§åˆ¶æ±ºå®šè¦çµ¦è©² Class æ³¨å…¥ä»€éº¼ä¾è³´ï¼Œä¹Ÿå°±æ˜¯èªªä¸‹å±¤çš„ Class éœ€è¦ä¾è³´æ™‚ï¼Œéƒ½æœƒå‘ä¸Šå±¤å»è¦ä»–æ‰€éœ€è¦çš„ä¾è³´å¯¦ä¾‹ï¼ˆç‰¹å®š Class æˆ–æ˜¯ implement ç‰¹å®š Interface çš„å¯¦ä¾‹ï¼‰ã€‚\nlaravel ç•¶ä¸­è¨±å¤šåŸºç¤æ ¸å¿ƒçš„ Class åœ¨åº•å±¤ä¹Ÿæ˜¯é€™éº¼é‹ä½œçš„ï¼Œä¾‹å¦‚ Controller ä¹Ÿæ˜¯ç¶“ç”± IoC Container å¯¦ä¾‹åŒ–ï¼Œæ‰€ä»¥æˆ‘å€‘æ‰èƒ½å¤ åœ¨ Controller å»ºæ§‹å­çš„å¼•æ•¸å¯«ä¸€å †ä¾è³´ç„¶å¾Œé–‹å¿ƒåœ°ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 class MyController extends Controller { protected $logger; public function __construct(Logger $logger) { $this-\u0026gt;logger = $logger; } public function index() { $this-\u0026gt;logger-\u0026gt;error(\u0026#39;Something happened\u0026#39;); } } ç„¶è€Œï¼Œlaravel ä¸åªæœƒè‡ªå‹•è§£æåœ¨å»ºæ§‹å­å¼•æ•¸ç•¶ä¸­çš„ Dependenciesï¼Œåœ¨æŸäº›ç‰¹å®š Class ç•¶ä¸­ï¼Œlaravel ä¹Ÿæœƒè‡ªå‹•è§£æ method å¼•æ•¸ä¸­çš„ä¾è³´ï¼Œæœ€å¸¸è¦‹çš„çš„å°±æ˜¯æˆ‘å€‘çš„ Controllerï¼š\n1 2 3 4 5 6 7 8 class MyController extends Controller { public function show(Logger $logger, $id) { $logger-\u0026gt;error(\u0026#39;Something happened\u0026#39;); } } åˆ°åº•å…¶èƒŒå¾Œæ˜¯æ€éº¼å¯¦ç¾é€™å€‹åŠŸèƒ½çš„å‘¢ï¼Ÿä»¥ä¸‹å°±é–‹å§‹ trace code ä¾†çœ‹çœ‹å§ã€‚\né¦–å…ˆï¼Œä¸€å€‹ Request çš„æ—…ç¨‹å°±æ˜¯å¾ Illuminate\\Contracts\\Http\\Kernel é–‹å§‹ï¼Œ åœ¨ index.php ç•¶ä¸­ï¼Œå¯¦ä¾‹åŒ– Kernel Class ä¹‹å¾Œï¼Œ å‘¼å«äº† handle é€™å€‹ methodï¼š\n1 2 3 4 5 6 7 // public/index.php $kernel = $app-\u0026gt;make(Illuminate\\Contracts\\Http\\Kernel::class); $response = $kernel-\u0026gt;handle( $request = Illuminate\\Http\\Request::capture() ); å¯ä»¥åœ¨ bootstrap/app.php ç•¶ä¸­æ‰¾åˆ°è©²æŠ½è±¡å°æ‡‰çš„ç¶å®šï¼Œä¹Ÿå°±æ˜¯ App\\Http\\Kernel ï¼š\n1 2 3 4 5 6 // bootstrap/app.php $app-\u0026gt;singleton( Illuminate\\Contracts\\Http\\Kernel::class, App\\Http\\Kernel::class ); æ¥è‘—ï¼Œ App\\Http\\Kernel åˆ extend äº† Illuminate\\Foundation\\Http\\Kernel ï¼Œhandle æ–¹æ³•å°±åœ¨é€™å€‹ Class ç•¶ä¸­å®šç¾©ï¼Œé‡é»æ˜¯ sendRequestThroughRouter é€™å€‹ methodï¼Œæº–å‚™è¦å°‡ Request åˆ†é…çµ¦ Router (ä¸Šé¢éƒ½é‚„åœ¨ application å±¤ï¼Œå¾é€™é‚Šé–‹å§‹é€²åˆ° framework è£¡é¢)ï¼š\n1 2 3 4 5 6 7 8 9 10 // vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php public function handle($request) { try { $request-\u0026gt;enableHttpMethodParameterOverride(); $response = $this-\u0026gt;sendRequestThroughRouter($request); ... } 1 2 3 4 5 6 7 8 9 10 11 // vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php protected function sendRequestThroughRouter($request) { ... return (new Pipeline($this-\u0026gt;app)) -\u0026gt;send($request) -\u0026gt;through($this-\u0026gt;app-\u0026gt;shouldSkipMiddleware() ? [] : $this-\u0026gt;middleware) -\u0026gt;then($this-\u0026gt;dispatchToRouter()); // å°‡ Request åˆ†é…çµ¦ Router } 1 2 3 4 5 6 7 8 9 10 // vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php protected function dispatchToRouter() { return function ($request) { $this-\u0026gt;app-\u0026gt;instance(\u0026#39;request\u0026#39;, $request); return $this-\u0026gt;router-\u0026gt;dispatch($request); }; } æ¥ä¸‹ä¾†è¦é€²å…¥åˆ° Router çš„éšæ®µï¼Œæœ‰äº›ä¸æ˜¯å¾ˆç›¸é—œçš„éƒ¨åˆ†å°±ç›´æ¥è·³éä¸è²¼ç¨‹å¼ç¢¼äº†ï¼Œé€²åˆ° Router å¾Œçš„ method å‘¼å«é †åºæ˜¯ dispatch â†’ dispatchToRoute â†’ runRoute -\u0026gt; runRouteWithinStack\nä¾†çœ‹ä¸€ä¸‹ åœ¨ runRouteWithinStack ç•¶ä¸­å€’æ•¸ç¬¬ä¸‰è¡Œ $route-\u0026gt;run() ï¼Œé€™è£¡å³å°‡è¦æº–å‚™è§£æåœ¨ routes/xxx.php ç•¶ä¸­æ‰€å®šç¾©çš„ Route æ‰€æŒ‡å®šçš„å°æ‡‰ Controller ä»¥åŠ Controller methodï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // vendor/laravel/framework/src/Illuminate/Routing/Router.php protected function runRouteWithinStack(Route $route, Request $request) { ... return (new Pipeline($this-\u0026gt;container)) -\u0026gt;send($request) -\u0026gt;through($middleware) -\u0026gt;then(function ($request) use ($route) { return $this-\u0026gt;prepareResponse( $request, $route-\u0026gt;run() ); }); } é€™é‚Šé€²å…¥äº† Routeï¼Œä¸»è¦åœ¨æº–å‚™åŸ·è¡Œ Route æŒ‡å®šå°æ‡‰çš„ Controller ä»¥åŠ Controller methodï¼Œé€²åˆ° $this-\u0026gt;runController() çš„éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // vendor/laravel/framework/src/Illuminate/Routing/Route.php public function run() { $this-\u0026gt;container = $this-\u0026gt;container ?: new Container; try { if ($this-\u0026gt;isControllerAction()) { return $this-\u0026gt;runController(); // !!! } return $this-\u0026gt;runCallable(); } catch (HttpResponseException $e) { return $e-\u0026gt;getResponse(); } } é€™è£¡æœƒå‘¼å«åˆ° ControllerDispatcher çš„ dispatch æ–¹æ³•æ¥æ‰‹è™•ç†ï¼š\n1 2 3 4 5 6 7 8 // vendor/laravel/framework/src/Illuminate/Routing/Route.php protected function runController() { return $this-\u0026gt;controllerDispatcher()-\u0026gt;dispatch( $this, $this-\u0026gt;getController(), $this-\u0026gt;getControllerMethod() ); } æŒ–äº†é€™éº¼æ·±ï¼Œçµ‚æ–¼è¦åˆ°é‡é ­æˆ²äº†ï¼Œä¹Ÿå°±æ˜¯å‘¼å«äº† $this-\u0026gt;resolveClassMethodDependencies é€™å€‹ methodï¼Œä¸¦å°‡è·¯ç”±ä¸Šé¢æ‰€å¸¶çš„åƒæ•¸ã€å·²å¯¦ä¾‹åŒ–å¾Œçš„ Controller ä»¥åŠ method åç¨±åšç‚ºåƒæ•¸å‚³å…¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php public function dispatch(Route $route, $controller, $method) { $parameters = $this-\u0026gt;resolveClassMethodDependencies( $route-\u0026gt;parametersWithoutNulls(), $controller, $method ); ... return $controller-\u0026gt;{$method}(...array_values($parameters)); } resolveClassMethodDependencies å‘¼å«äº† resolveMethodDependenciesï¼Œä¸¦å°‡å‰›å‰›çš„è·¯ç”±åƒæ•¸ä»¥åŠä¸€å€‹æ–°çš„ ReflectionMethod å¯¦ä¾‹åšç‚ºåƒæ•¸å‚³å…¥ï¼ŒåŸä¾†å¯¦ç¾ Method Dependency injection çš„é‡è¦åŠŸè‡£å°±æ˜¯ ReflectionMethod é€™å€‹æ±è¥¿ï¼Œè—‰ç”± ReflectionMethodï¼Œæˆ‘å€‘å¯ä»¥ç²å¾—æŸå€‹ instance è£¡é¢é—œæ–¼æŸå€‹ method çš„è³‡è¨Šï¼ŒåŒ…æ‹¬å¯ä»¥çŸ¥é“ä»–æœ‰å“ªäº›å¼•æ•¸ï¼Œè€Œé€™ä¹Ÿå°±æ˜¯å¦‚ä½•å¾—ä»¥åµæ¸¬åˆ°é€™äº› method éœ€è¦çš„ä¾è³´ï¼Œä¸¦ä¸”é å…ˆè§£æå¥½ç‰©ä»¶ç•¶çœŸæ­£è¦å‘¼å«é€™å€‹ method æ™‚å†å°‡å·²è§£æå¥½çš„ç‰©ä»¶å¸¶å…¥çš„é—œéµã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 // vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php protected function resolveClassMethodDependencies(array $parameters, $instance, $method) { if (! method_exists($instance, $method)) { return $parameters; } return $this-\u0026gt;resolveMethodDependencies( $parameters, new ReflectionMethod($instance, $method) ); } æˆ‘å€‘ä¾†çœ‹çœ‹ resolveMethodDependencies è£¡é¢åšäº†ä»€éº¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php public function resolveMethodDependencies(array $parameters, ReflectionFunctionAbstract $reflector) { $instanceCount = 0; $values = array_values($parameters); foreach ($reflector-\u0026gt;getParameters() as $key =\u0026gt; $parameter) { $instance = $this-\u0026gt;transformDependency( $parameter, $parameters ); if (! is_null($instance)) { $instanceCount++; $this-\u0026gt;spliceIntoParameters($parameters, $key, $instance); } elseif (! isset($values[$key - $instanceCount]) \u0026amp;\u0026amp; $parameter-\u0026gt;isDefaultValueAvailable()) { $this-\u0026gt;spliceIntoParameters($parameters, $key, $parameter-\u0026gt;getDefaultValue()); } } return $parameters; } é€™é‚Šå¦å¤–æ³¨æ„ï¼Œå‚³å…¥çš„ parameters ç•¶ä¸­å¯èƒ½åŒ…å« primitive å€¼ï¼Œå› ç‚ºåœ¨ Route ç•¶ä¸­å¯èƒ½æœƒé€™æ¨£å®šç¾©ï¼š\n1 2 3 4 5 6 7 8 9 10 // in routes Route::get(\u0026#39;countries.{country}\u0026#39;, \u0026#39;CountryController@show\u0026#39;)-\u0026gt;name(\u0026#39;countries.show\u0026#39;); // in Controllers public function show($country, Request $request) { ... } è‹¥ endpoint ç‚º /api/countries/1 ï¼Œæˆ‘å€‘å°‡ $parameters ã€ $reflector-\u0026gt;getParameters() dd å‡ºä¾†çœ‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // $parameters array:1 [ \u0026#34;country\u0026#34; =\u0026gt; \u0026#34;1\u0026#34; ] // $reflector-\u0026gt;getParameters() array:2 [ 0 =\u0026gt; ReflectionParameter {#1228 +name: \u0026#34;country\u0026#34; position: 0 } 1 =\u0026gt; ReflectionParameter {#1229 +name: \u0026#34;request\u0026#34; position: 1 typeHint: \u0026#34;Illuminate\\Http\\Request\u0026#34; } ] æ‰€ä»¥åœ¨éæ­·æ¯å€‹å¾ ReflectionMethod å¾—åˆ°çš„ method å¼•æ•¸æ™‚ ($reflector-\u0026gt;getParameters())ï¼Œé¦–å…ˆæœƒå˜—è©¦æ ¹æ“š TypeHint å°‡å…¶å¯¦ä¾‹åŒ–ï¼ˆå¦‚æœè©²å¼•æ•¸æœ‰ typeHint ï¼‰ï¼Œè‹¥èƒ½æˆåŠŸè§£æå‡ºå¯¦ä¾‹ï¼Œå†æŒ‰ç…§æ­£ç¢ºä½ç½®å¡å…¥ $parameters ç•¶ä¸­ï¼Œæœ€å¾Œå›å‚³è©² $parameters é™£åˆ—çµ¦vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher@dispatch\nå°‡é€™äº›è§£æå®Œç•¢çš„ä¾è³´åƒæ•¸å‚³å…¥ç›¸å°æ‡‰çš„ Controller method åŸ·è¡Œï¼š\n1 $controller-\u0026gt;{$method}(...array_values($parameters)); è‡³æ­¤å·²ç¶“å¤§è‡´å°‡ laravel å¯¦ç¾ Controller method è‡ªå‹•æ³¨å…¥ä¾è³´çš„æ ¸å¿ƒéƒ¨åˆ†éƒ½çœ‹å®Œäº†ï¼Œç†è§£äº†æ ¸å¿ƒæ¦‚å¿µå†ä¾†çœ‹é€™äº›å¯¦ä½œçš„ç¨‹å¼ç¢¼å¾Œï¼Œæ„Ÿè¦ºä¸€åˆ‡ä¸å†é‚£éº¼ magic äº†ï½\nåƒè€ƒè³‡æ–™ Laravel: Up \u0026amp; Running (Book) CHAPTER 11. The The Container https://www.php.net/manual/en/class.reflectionmethod.php ","date":"Jul 18","permalink":"//localhost:1313/posts/laravel-ioc-container-%E5%A6%82%E4%BD%95%E8%A7%A3%E6%9E%90-controller-method-%E7%95%B6%E4%B8%AD%E7%9A%84%E4%BE%9D%E8%B3%B4/","tags":["Laravel"],"title":"Laravel IoC Container å¦‚ä½•è§£æ Controller method ç•¶ä¸­çš„ä¾è³´(DI)"},{"categories":null,"contents":"æœ¬ä¾†ä¸€ç›´éƒ½ç”¨è¿´åœˆå»è™•ç†åŒæ™‚ç™¼å¤šå€‹ requestï¼ˆå¾ˆå¥½æ‡‚ä½†æœ‰é»é›£è™•ç† Errorï¼‰ï¼Œé€™æ¬¡è¦ªè‡ªä¾†è©¦è©¦ Promise.all() ç¸½ç®—é«”é©—åˆ°å¹³è¡Œè™•ç†éåŒæ­¥çš„å¨åŠ›ï¼ˆï¼Ÿï¼‰æ–¼æ˜¯ç´€éŒ„ä¸€ä¸‹å¿ƒå¾—ä»¥åŠå’Œ await + axios é€£ç”¨æ™‚çš„ä¸€äº›çœ‰è§’ã€‚\nPromise.all() ç”¨æ³• Promise.all (iterable) æ¥å—ä¸€å€‹ iterable ç‰©ä»¶ï¼ˆé€šå¸¸æ˜¯é™£åˆ—ï¼‰ä½œç‚ºåƒæ•¸ï¼Œç•¶è£¡é¢æ¯å€‹å…ƒç´ éƒ½æ˜¯ Promise ç‰©ä»¶æ™‚(ä¹Ÿå¯ä»¥ä¸æ˜¯ï¼Œå¾…æœƒæœƒæåˆ°ï¼‰ï¼Œå®ƒå°±æœƒå¹³è¡Œå»è™•ç†é€™äº› Promiseã€‚ç”±æ–¼å…¶æœ¬èº«æœƒå›å‚³ä¸€å€‹ Promise ç‰©ä»¶ï¼Œæ‰€ä»¥æˆ‘å€‘åŒæ¨£å¯ä»¥ç”¨ then æˆ– await å»æ¥ä»–çš„ resolve/rejectã€‚ ç•¶æ‰€æœ‰çš„ Promise éƒ½è¢« resolve å¾Œæ‰æœƒå›å‚³ resolveï¼Œå…¶å€¼æœƒæ˜¯å…¨éƒ¨çš„ Promise è™•ç†å®Œå¾Œæ‰€å›å‚³çš„ resolve å€¼æ‰€çµ„æˆçš„é™£åˆ—ã€‚ä½†è‹¥å…¶ä¸­æœ‰ä¸€å€‹ Promise è¢« reject å°±æœƒç›´æ¥æ‹‹å‡ºè©² Promise æ‰€å›å‚³çš„éŒ¯èª¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 const array1 = [1, 4, 9, 16]; const promiseArr = array1.map(x =\u0026gt; Promise.resolve(x)); console.log(promiseArr) //Â [Promise, Promise, Promise, Promise] // ç”¨ then æ¥çµæœ Promise.all(promiseArr).then(vals =\u0026gt; { console.log(vals) // [1, 4, 9, 16] }) // ç”¨ await æ¥çµæœ const vals = await Promise.all(promiseArr) console.log(vals) // [1, 4, 9, 16] æé†’ï¼š await å¾Œé¢æ¥çš„ä¸€å®šæœƒæ˜¯ä¸€å€‹ Promise ï¼ˆæˆ– async functionï¼‰ï¼Œä»–æœƒå¹«æˆ‘å€‘æŠŠ Promise è™•ç†å®Œå¾Œç›´æ¥åçµ¦æˆ‘å€‘ resovle æˆ– reject çš„å€¼ã€‚\nè€Œç•¶é™£åˆ—è£¡é¢æœ‰é Promise ç‰©ä»¶çš„å…ƒç´ å­˜åœ¨æ™‚ï¼ŒPromise.all() ä»æœƒè¼¸å‡ºè©²å…ƒç´ çš„å€¼ï¼š\n1 2 3 4 let a = 1 let b = Promise.resolve(2) let result = await Promise.all([a, b]) console.log(result) // [1, 2] Promise.all() + axios æˆ‘å€‘å¯ä»¥å…ˆé€é map() è™•ç†åŸå§‹é™£åˆ—ï¼ˆmap()æœƒå›å‚³æ–°çš„é™£åˆ—ï¼‰ï¼ŒæŠŠåŸå§‹é™£åˆ—æ”¹æˆä¸€çµ„ Promise é™£åˆ—ã€‚ä»¥ä¸‹é¢ç¨‹å¼ç¢¼ç‚ºä¾‹ï¼Œ products ç‚ºä¸€çµ„å•†å“ç‰©ä»¶çš„é™£åˆ—ï¼Œåœ¨æ­¤å³åˆ©ç”¨ map () éæ­·æ¯å€‹å•†å“ç‰©ä»¶ï¼Œåœ¨ map() çš„ callback function è£¡ç›´æ¥å‘¼å« axios å°‡å•†å“è³‡è¨Šå¸¶å…¥ request body ç™¼é€è«‹æ±‚ï¼Œç”±æ–¼ axios æœ¬èº«å°±æœƒå›å‚³ Promiseï¼Œæ‰€ä»¥æˆ‘å€‘å°±èƒ½æˆåŠŸæ‹¿åˆ°ä¸€çµ„ Promise é™£åˆ—ä¸¦ç›´æ¥å¡é€² Promise.all è£¡é¢å›‰ï¼\n1 2 3 4 5 6 7 8 let data = await Promise.all(this.products.map((product) =\u0026gt; { return this.$axios.post(\u0026#39;http://localhost:8000/api/products\u0026#39;, { name: product.name, price: product.price, order_id: myOrder_id }) })) console.log(data) æ‰€ä»¥æˆ‘å€‘æœƒå¾—åˆ°ä¸€å€‹é™£åˆ—é•·é€™æ¨£ï¼š\né€™æ™‚ç™¼ç¾å®ƒé•·å¾—å¥½åƒä¸æ˜¯æˆ‘å€‘è¦çš„ response dataï¼Œé‚£æ˜¯å› ç‚º axios çš„ response ï¼ˆresolve valueï¼‰ä¸¦éç›´æ¥å› server çµ¦æˆ‘å€‘çš„è³‡æ–™ ï¼Œè€Œè£¡é¢é‚£å±¤ data æ‰æ˜¯æˆ‘å€‘è¦çš„è³‡æ–™ï¼š\n1 2 3 4 5 6 7 8 { data: {}, //é€™æ‰æ˜¯ server å›çµ¦æˆ‘å€‘çš„è³‡æ–™ status: 200, statusText: \u0026#39;OK\u0026#39;, headers: {}, config: {}, request: {} } ","date":"Jun 30","permalink":"//localhost:1313/posts/promise-all%E8%88%87async-await%E5%92%8Caxios/","tags":["Javascript"],"title":"Promise.all() èˆ‡ async/await"},{"categories":null,"contents":"å¹³å¸¸åœ¨å¯¦ä½œ Vue çµ„ä»¶ä¹‹é–“çš„è³‡æ–™å‚³éå¤§éƒ¨åˆ†éƒ½æ˜¯é€é props åŠ $emitï¼Œæˆ–æ˜¯ç›´æ¥ç¶“ç”± Vuex é€²è¡Œç‹€æ…‹ç®¡ç†ï¼Œè€Œé™¤äº†é€™å…©ç¨®æ–¹æ³•ï¼Œé‚„æœ‰å¦å¤–ä¸€ç¨®åšæ³•æ˜¯é€é $attrs åŠ $listenterã€‚\næœ¬èº«ä¹Ÿæ˜¯å› ç‚ºä¹‹å‰å¶ç„¶åœ¨æŸ¥è³‡æ–™çš„æ™‚å€™çœ‹åˆ°é€™å…©å€‹ APIï¼Œä½†ç•¶æ™‚çœ‹éåˆ¥äººå¯«çš„æ–‡ç« å¾Œå»åªæ˜¯ä¼¼æ‡‚éæ‡‚ï¼Œé ‚å¤šçŸ¥é“æœ‰é€™å€‹æ±è¥¿ä½†ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨æˆ–è©²ç”¨åœ¨ä»€éº¼å ´åˆï¼Œä¸€ç›´åˆ°å¯¦ä½œæ™‚æ‰çœŸæ­£ç†è§£å®ƒçš„ç”¨æ³•ï¼Œä½†å¤šçœ‹å¤šè®€ç¸½æ˜¯å¥½çš„ï¼Œæœ‰ä¸€å¤©æˆ–è¨±æ´¾å¾—ä¸Šç”¨å ´ã€‚\n$attrs å…¶å¯¦ç°¡å–®èªªå°±æ˜¯å­çµ„ä»¶å¯ä»¥é€é$attrså–å¾—çˆ¶çµ„ä»¶ç•¶ä¸­é™¤äº† Props ä»¥å¤–çš„æ‰€æœ‰è³‡æ–™ã€‚\nä¹çœ‹ä¹‹ä¸‹å¥½åƒæ²’ä»€éº¼ï¼Œé‚£ä¸å°±ç›´æ¥ç”¨ Props å°±å¥½äº†å—ï¼Ÿ ä½†ç•¶åœ¨å¤šé‡çµ„ä»¶åµŒå¥—çš„æƒ…æ³ä¹‹ä¸‹ï¼Œå°±æœƒé¡¯å¾—å¾ˆæœ‰ç”¨ã€‚æˆ‘å€‘å…ˆå®šç¾©å‡ºä¸‰å€‹çµ„ä»¶ï¼Œä»–å€‘åˆ†åˆ¥æ˜¯ï¼š a-componentï¼ˆçˆºçµ„ä»¶/æ¨¡æ¿ï¼‰ã€b-componentï¼ˆçˆ¶çµ„ä»¶ï¼‰ã€c-componentï¼ˆå­«çµ„ä»¶ï¼‰\næˆ‘å€‘å¯ä»¥åœ¨ a ä½¿ç”¨ bï¼š\n1 2 3 4 5 6 // a-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;b-component :msg=\u0026#34;hello\u0026#34;/\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; æ¥è‘—åœ¨ b ä¸­æˆ‘å€‘å¯ä»¥ä½¿ç”¨ $attrs è€Œä¸ç”¨é€é Props æ‹¿åˆ° apiUrlï¼Œä¸¦ä¸”å°‡ $attrs é€é v-bind ç¶å®šåœ¨ c ä¸Šå‚³çµ¦ c ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 // b-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt;{{ $attrs.data }}\u0026lt;/h1\u0026gt; \u0026lt;c-component v-bind=\u0026#34;$attrs\u0026#34;/\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; ç„¶å¾ŒåŒæ¨£åœ¨ c ç•¶ä¸­æˆ‘å€‘å°±èƒ½å¤ é€é$attrså–å¾— a çš„è³‡æ–™ ã€‚é€™æ¨£ä¸€ä¾†çš„å¥½è™•å°±æ˜¯ç•¶æˆ‘å€‘æœ‰å¤šå€‹è³‡æ–™è¦å¾ a å‚³çµ¦ b è·Ÿ c å…±ç”¨æ™‚ï¼Œä¸ç”¨æ¯ä¸€å±¤éƒ½è¦è²æ˜ Propsï¼Œç„¶å¾Œé‚„è¦å°‡æ¯å€‹ Props å¯«åœ¨ component çš„æ¨™ç±¤è£¡é¢ï¼š\n1 2 3 4 5 6 // c-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;h1\u0026gt;{{ $attrs.data }}\u0026lt;/h1\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; å’Œ $attrs ç›¸é—œçš„ API é‚„æœ‰ inheritAttrsï¼Œå…¶å€¼ç‚ºå¸ƒæ—å€¼ï¼Œé è¨­ç‚º trueï¼Œä¹Ÿå°±æ˜¯å¦‚æœæˆ‘å€‘æ²’æœ‰ç‰¹åˆ¥å°‡å…¶è¨­å®šæˆ falseï¼Œå­çµ„ä»¶é»˜èªå¯ä»¥é€é $attrs å–å¾—åœ¨çˆ¶çµ„ä»¶ç•¶ä¸­éé€é Props ç¹¼æ‰¿çš„è³‡æ–™ã€‚\n$listeners æ‡‰è©²ä¸é›£çŒœæƒ³ï¼Œ $attrs å°æ‡‰ Props ï¼Œ$listeners å‰‡å°æ‡‰ $emitã€‚ ç°¡å–®ä¾†èªªå°±æ˜¯çˆ¶çµ„ä»¶å¯ä»¥é€é $listeners å–å¾—æ‰€æœ‰å­çµ„ä»¶ $emit æ‰“å‡ºä¾†çš„äº‹ä»¶ã€‚åŒæ¨£ä»¥ä¸Šé¢ä¸‰å€‹çµ„ä»¶ç‚ºä¾‹ï¼š\n1 2 3 4 5 6 // c-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;button @click=\u0026#34;$emit(\u0026#39;sayHi\u0026#39;)\u0026#34;\u0026gt; click me!\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; åœ¨ b ç•¶ä¸­åŒæ¨£å¯ä»¥é€é v-on=\u0026quot;$listeners\u0026quot;å°‡ c äº‹ä»¶å§”ä»»çµ¦ aï¼š\n1 2 3 4 5 6 // b-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;c-component v-on=\u0026#34;$listeners\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; a å°±å¯ä»¥ç›´æ¥è™•ç† c æ‰“å‡ºçš„$emitäº‹ä»¶ï¼Œè€Œä¸ç”¨é€é b å† emit ä¸€æ¬¡\n1 2 3 4 5 6 // a-component \u0026lt;template\u0026gt; \u0026lt;div\u0026gt; \u0026lt;b-component @sayHi=\u0026#34;anEventHandler\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/template\u0026gt; ç¸½çµ æ‰€ä»¥ç•¶å¤šé‡çµ„ä»¶ä¹‹é–“éœ€è¦æºé€šå‚³éï¼Œä½†ä¸æƒ³ç”¨ Vuex æ™‚ï¼Œå¯ä»¥å˜—è©¦æ¡ç”¨é€™å…©ç¨®æ–¹æ³•ï¼š * $attrsï¼šå­«çµ„ä»¶å–å¾—çˆºçµ„ä»¶çš„è³‡æ–™ * $listenersï¼šçˆºçµ„ä»¶ç›´æ¥è§¸ç™¼å­«çµ„ä»¶çš„äº‹ä»¶\n","date":"Jun 23","permalink":"//localhost:1313/posts/vue%E7%88%BA%E5%AD%AB%E7%B5%84%E4%BB%B6%E8%B3%87%E6%96%99%E5%82%B3%E9%81%9E/","tags":["Vue"],"title":"Vue $attrs/$listeners çˆºå­«çµ„ä»¶è³‡æ–™å‚³é"},{"categories":null,"contents":"ç¬¬ä¸€æ¬¡ä½¿ç”¨ Echarts é€™å¥—åœ–å½¢ libraryï¼Œåœ¨ vue ä¸­ä½¿ç”¨ Echarts å¯ä»¥ç›´æ¥è£ vue-echartï¼Œå®˜æ–¹æ–‡ä»¶æ¨è–¦å…©å€‹éƒ½è£ï¼š\n$ npm install echarts vue-echarts é æ–™ä¹‹ä¸­çš„è¸©äº†ä¸å°‘å‘ï¼Œåœ¨æ­¤ç´€éŒ„ä¸€äº›é‡é»ã€‚\nå®‰è£å®Œå¾Œå¼•å…¥ä¸¦è¨»å†Šåœ–è¡¨ component 1 2 3 4 5 6 7 8 9 import Vue from \u0026#39;vue\u0026#39; import ECharts from \u0026#39;vue-echarts\u0026#39; import \u0026#39;echarts/lib/chart/bar\u0026#39; import \u0026#39;echarts/lib/component/tooltip\u0026#39; import \u0026#39;echarts-gl\u0026#39; //ç­‰ç­‰æœƒä½¿ç”¨ grapic è¨­å®šåœ–å½¢æ–‡å­—ï¼Œæ•…éœ€è¼‰å…¥æ­¤ module Vue.component(\u0026#39;v-chart\u0026#39;, ECharts) // è¨»å†Šç‚º global component åŸºç¤ä½¿ç”¨ åœ¨ template ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨åœ–è¡¨ componentï¼Œå…¶æ¥æ”¶ options ç‚º propsï¼Œè£¡é¢çš„serieså±¬æ€§ç‚ºè¨­ç½®ç‰¹å®šé¡å‹åœ–è¡¨çš„å±¬æ€§ï¼Œåœ¨æ­¤ä½¿ç”¨å°ˆæ¡ˆä¸­çš„åœ“é¤…åœ–ç•¶ç¯„ä¾‹ï¼š\n1 \u0026lt;v-chart :options=\u0026#34;options\u0026#34; /\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 data() { return { options: { series: [ { type: \u0026#39;pie\u0026#39;, // å¿…é ˆ name: \u0026#39;test\u0026#39;, // å¿…é ˆ radius: [\u0026#39;50%\u0026#39;, \u0026#39;70%\u0026#39;], label: { normal: { show: false }, emphasis: { show: true, formatter: \u0026#39;{b} {@percentage}%\u0026#39; } }, data: [ { name: \u0026#39;éŸ“åœ‹\u0026#39;, value: 70 }, { name: \u0026#39;æ—¥æœ¬\u0026#39;, value: 10 }, { name: \u0026#39;å°ç£\u0026#39;, value: 10 }, { name: \u0026#39;è¶Šå—\u0026#39;, value: 6 }, { name: \u0026#39;ä¸­åœ‹\u0026#39;, value: 3 }, { name: \u0026#39;å…¶ä»–\u0026#39;, value: 1 } ] } ] } } } åœ“é¤…åœ–ä¸­é–“åŠ å…¥æ–‡å­— æ³¨æ„ï¼šä¸€å®šè¦è£ echarts-gl æ¨¡çµ„ï¼Œå¦å‰‡æœƒç„¡æ³•é¡¯ç¤ºã€‚ å¯ä»¥ç›´æ¥åˆ©ç”¨å®˜æ–¹æä¾›çš„å±¬æ€§grapicç‚ºåœ–è¡¨è‡ªè¡Œæ·»åŠ åœ–å½¢å…ƒç´ ï¼Œä¸¦æ–°å¢ç‰¹å®šæ–‡å­—ï¼ˆå¯ä»¥æ–°å¢çš„åœ–å½¢å…ƒç´ é¡å‹é‚„æœ‰åœ–ç‰‡ã€åœ–å½¢ç­‰ï¼Œå¯ä»¥åƒè€ƒæ–‡ä»¶ï¼‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 graphic: [ { type: \u0026#39;text\u0026#39;, left: \u0026#39;center\u0026#39;, top: \u0026#39;center\u0026#39;, style: { text: \u0026#39;å­¸ç”Ÿåœ‹ç±æ¯”ä¾‹\u0026#39;, textAlign: \u0026#39;center\u0026#39;, fill: \u0026#39;#666\u0026#39;, font: \u0026#39;20px \u0026#34;STHeiti\u0026#34;, sans-serif\u0026#39; } } ] åœ–ä¾‹èªªæ˜ï¼ˆlegendï¼‰éœ€è¦æ·»åŠ  value è³‡æ–™ echarts æä¾›çš„ formater callback function åªæœ‰çµ¦æˆ‘å€‘ name é€™å€‹åƒæ•¸ï¼Œæ‰€ä»¥è¦åŒæ™‚æ‹¿åˆ° value çš„è©±ï¼Œæœƒéœ€è¦è‡ªå·±å¾åœ–è¡¨å¯¦ä¾‹è£¡é¢æ‰¾ã€‚\næ³¨æ„ï¼šå¿…é ˆä½¿ç”¨ç®­é ­å‡½å¼æ‰èƒ½æ‹¿åˆ°é€™å€‹ component çš„å¯¦ä¾‹ï¼Œé€²è€Œå–å¾— options.series[0].data å¾—åˆ°æˆ‘å€‘è¦çš„ value\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 legend: { orient: \u0026#39;verticle\u0026#39;, left: \u0026#39;left\u0026#39;, bottom: \u0026#39;middle\u0026#39;, textStyle: { fontSize: 16 }, formatter: name =\u0026gt; { const data = this.options.series[0].data let targetValue data.map(item =\u0026gt; { if (item.name === name) { targetValue = item.value } }) return name + \u0026#39; \u0026#39; + targetValue + \u0026#39;%\u0026#39; } }, åœ–è¡¨çš„éŸ¿æ‡‰ ç”±æ–¼ä¸€é–‹å§‹è¨­å®šåœ–ä¾‹çš„æ’åˆ—æ–¹å¼ç‚ºå‚ç›´æ’åˆ—ã€é å·¦ä¸¦ç½®ä¸­ï¼Œä½†åœ¨è¡Œå‹•è£ç½®ä¸Šé€™æ¨£æœƒç ´ç‰ˆï¼Œæ‰€ä»¥é¦–å…ˆç¬¬ä¸€æ­¥å…ˆè¨­å®šè®“æ•´å€‹ Canvas å¯ä»¥è‡ªé©æ‡‰å®¹å™¨å¤§å°ç¸®æ”¾ï¼Œå¯¦ç¾æ–¹æ³•å…¶å¯¦åªè¦ä¿®æ”¹ CSS å³å¯ï¼š\n1 2 3 4 .echarts { width: 100%; height: 400px; } æ¥è‘—å°±æœƒé¢è‡¨åˆ°åœ–ä¾‹è·Ÿåœ–è¡¨æœ¬é«”é‡ç–Šçš„å•é¡Œï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åµæ¸¬è¦–çª—å¯¬åº¦å¤§å°ï¼Œéš¨è‘—è£ç½®å¯¬åº¦ä¸åŒæ”¹è®Šåœ–ä¾‹æ’åˆ—çš„æ–¹å¼ã€‚\n1. é¦–å…ˆå…ˆåœ¨ component ä¸Šç¶å®š ref 1 \u0026lt;v-chart ref=\u0026#34;myChart\u0026#34; :options=\u0026#34;options\u0026#34; /\u0026gt; 2. åœ¨ mounted ç•¶ä¸­ç›£è½ window çš„ load eventï¼Œç•¶é é¢è¼‰å…¥æ™‚è¨ˆç®—ç•¶å‰è¢å¹•å¯¬åº¦å¤§å°ï¼Œå†é€é ref å±¬æ€§è¨ªå•è©²åœ–è¡¨å¯¦ä¾‹ä¸¦ä¿®æ”¹å…¶ options.legend å±¬æ€§ï¼ˆå’Œåœ–ä¾‹å®šä½ç›¸é—œçš„å±¬æ€§ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 window.addEventListener(\u0026#39;load\u0026#39;, () =\u0026gt; { this.windowWidth = window.screen.width let orient, left, bottom if (this.windowWidth \u0026lt; 480) { orient = \u0026#39;horizontal\u0026#39; left = \u0026#39;center\u0026#39; bottom = \u0026#39;bottom\u0026#39; } else { orient = \u0026#39;vertical\u0026#39; left = \u0026#39;left\u0026#39; bottom = \u0026#39;middle\u0026#39; } if (this.$refs.myChart) { this.$refs.myChart.options.legend.orient = orient this.$refs.myChart.options.legend.left = left this.$refs.myChart.options.legend.bottom = bottom } }) æ³¨æ„ï¼šæ­¤ç¶å®šæ–¹æ³•åªæœ‰åœ¨é é¢ç¬¬ä¸€æ¬¡æ¸²æŸ“æ™‚æ‰æœƒæœ‰æ•ˆï¼Œå¦‚æœè¦å¯¦ç¾ RWD è¦å†å¦å¤–ç›£è½ resize äº‹ä»¶ã€‚\nçµèª 1. å¦‚æœè¦ç”¨åˆ°è¼ƒå¤šå®¢è£½åŒ–åŠŸèƒ½è¦ç”¨ Echartsï¼Œå¦å‰‡æ‰ç”¨ v-charts åœ¨åŠ å…¥åœ“é¤…ä¸­é–“æ–‡å­—é‚£è£¡å¡æ»¿ä¹…ï¼ŒåŸå› æ˜¯ä¸€é–‹å§‹è£çš„æ˜¯ v-chartsï¼ˆç®—æ˜¯è¼•é‡ç°¡åŒ–ç‰ˆçš„ Echartsï¼‰ï¼Œæ¨æ¸¬ç›®å‰é‚„æ²’æœ‰æ”¯æ´åˆ°å¯ä»¥ä½¿ç”¨åœ–å½¢æ–‡å­—ï¼ˆå„ç¨®æ–¹å¼åŠ å…¥ graphic å±¬æ€§éƒ½æœªèµ·ä½œç”¨ï¼‰ï¼Œé›–ç„¶ä¹Ÿå¯èƒ½åªæ˜¯å°šæœªæ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆï¼ˆç¿»æ–‡ä»¶å¿«ç¿»åˆ°ç™¼ç˜‹ï¼‰ã€‚\n2. åœ¨ Vue ç•¶ä¸­å–å¾—åœ–è¡¨å¯¦ä¾‹çš„æ–¹æ³• åœ¨ options å…§éƒ¨è‹¥ç”¨åˆ°å…¶æä¾›çš„å›èª¿å‡½å¼ï¼Œå¿…é ˆä½¿ç”¨ç®­é ­å‡½å¼ï¼Œæ‹¿åˆ°çš„ thisæ‰æœƒæ˜¯æˆ‘å€‘è¦çš„åœ–è¡¨å¯¦ä¾‹ç‰©ä»¶ï¼ˆå¦å‰‡æœƒæ˜¯ undefinedï¼‰ã€‚ä½†åœ¨å…¶ä»–åœ°æ–¹ï¼ˆVue çš„ç’°å¢ƒä¸­ï¼‰å‰‡è¦é€éè¨ªå• DOM å…ƒç´ æ‰èƒ½å¾—åˆ°åœ–è¡¨å¯¦ä¾‹ç‰©ä»¶ã€‚ ç›®å‰çš„æ–¹æ³•æ˜¯é€™æ¨£ï¼Œä½†å…¶å¯¦å®˜æ–¹å¥½åƒæœ‰æä¾›å…¶ä»–å¯ä»¥è¨ªå• optionsçš„ APIï¼ˆå¦‚ computedOptionsï¼Œå¯åƒè€ƒæ–‡ä»¶ï¼‰ ï¼Œä½†æˆ‘ç›®å‰æ˜¯éƒ½æ²’æœ‰æˆåŠŸé QwQï¼Œå¯èƒ½é‚„éœ€å¦å¤–ç ”ç©¶ã€‚\n","date":"Jun 11","permalink":"//localhost:1313/posts/%E4%BD%BF%E7%94%A8vue-echarts%E8%B8%A9%E7%9A%84%E5%9D%91/","tags":["Vue"],"title":"ä½¿ç”¨ vue-echarts è¸©çš„å‘"},{"categories":null,"contents":"ä»¥å‰æœ¬ä¾†æœƒç™¼è¡¨æ–‡ç« åœ¨ Mediumï¼Œä½†æŸå¤©å¯¦åœ¨æ˜¯å—ä¸äº† Medium çš„é†œç¨‹å¼ç¢¼å€å¡Šäº†ã€‚æƒ³èµ·å¾ˆä¹…ä»¥å‰æœ‰ç”¨ Github Pages æ¶éä¸€å€‹ Hexo éƒ¨è½æ ¼ï¼Œä½†è’å»¢è¨±ä¹…ï¼Œä¹Ÿæƒ³ç©é»æ–°æ±è¥¿ï¼Œå°±åˆç”¨ Hugo å¼„äº†ä¸€å€‹ã€‚æŠŠ Hexo åƒ…å­˜çš„å…©ä¸‰ç¯‡æ–‡ç« æ¬éä¾†ï¼Œä½† Medium çš„å°±æ‡¶å¾—æ¬äº†ã€‚æ–¼æ˜¯æœ‰äº†é€™å€‹éƒ¨è½æ ¼ã€‚\nP.S.ä½†å…¶å¯¦ Medium åœ¨ 2022 å¹´åº•æ™‚çš„æ”¹ç‰ˆæœ‰æ”¯æ´æ¯”è¼ƒç¾è§€çš„ç¨‹å¼ç¢¼å€å¡Šï¼Œä¸éæˆ‘ä¹Ÿæ‡¶å¾—å†æ›å›å»äº†ã€‚\nèº«ç‚ºä¸€å€‹æœ‰é»å¼·è¿«ç—‡çš„äººå¯«æ–‡ç« çœŸçš„ä¸æ˜¯ä¸€ä»¶ç°¡å–®çš„äº‹ï¼Œç¸½è¦ä¿è­‰æ¯å€‹å­—å¥éƒ½é€šé †ï¼Œçœ‹ä¸æ…£æœƒä¸€ç›´æƒ³æ”¹ã€‚ä¸éå› ç‚ºå¯¦åœ¨ Z\u0026gt;Bï¼Œé‚„æ˜¯æœŸè¨±è‡ªå·±èƒ½å¤ ç¹¼çºŒä¸‹å»ï¼Œä¸€é‚Šå­¸ç¿’ä¸€é‚Šç´€éŒ„ã€‚å¦‚æœèƒ½å› æ­¤å¹«åŠ©åˆ°ä¸€äº›ä¹Ÿé‡éç›¸åŒå•é¡Œçš„äººï¼Œé‚£å°±æ›´é–‹å¿ƒäº†ï¼å…§æ–‡ä¸­æœ‰ä»»ä½•éŒ¯èª¤æˆ–ç–‘æ…®çš„åœ°æ–¹ï¼Œä¹Ÿè«‹ä¸åæŒ‡æ­£ï¼Œæˆ‘æœƒéå¸¸ï½æ„Ÿè¬çš„ï¼\nä¸»è¦å°±æ˜¯ç™¼è¡¨ä¸€äº›ç¶²é /ç¨‹å¼/è»Ÿé«”é–‹ç™¼ç›¸é—œçš„æŠ€è¡“ç­†è¨˜ã€‚æ­¡è¿ç•™è¨€æˆ–ä¾†ä¿¡äº¤æµæˆ–ç”³è«‹åŠ å…¥å…”å…”æ•™ï¼ˆä¸¦æ²’æœ‰é€™ç¨®æ±è¥¿ï¼‰â¸œ( Ë™ Ë˜ Ë™)â¸\n","date":"Jan 01","permalink":"//localhost:1313/about/","tags":null,"title":"About"},{"categories":null,"contents":"","date":"Jan 01","permalink":"//localhost:1313/articles/","tags":null,"title":"Articles"}]