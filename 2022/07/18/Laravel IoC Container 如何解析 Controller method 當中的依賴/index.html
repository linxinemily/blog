<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ä½¿Laravel IoC Container å¦‚ä½•è§£æ Controller method ç•¶ä¸­çš„ä¾è³´(DI) Â· Emmie's Blog</title><meta name="description" content="ä½¿Laravel IoC Container å¦‚ä½•è§£æ Controller method ç•¶ä¸­çš„ä¾è³´(DI) - Emmie"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://linxinemily.github.io/atom.xml" title="Emmie's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/linxinemily" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/categories/" target="_self" class="nav-list-link">CATEGORIES</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ä½¿Laravel IoC Container å¦‚ä½•è§£æ Controller method ç•¶ä¸­çš„ä¾è³´(DI)</h1><a class="article-category-link" href="/categories/Laravel/">Laravel</a><div class="post-info">Jul 18, 2022</div><div class="post-content"><aside>
ğŸ’¡ ç”±æ–¼ä»¥ä¸‹æ‰€åˆ†æçš„åŸå§‹ç¢¼æ˜¯èˆŠç‰ˆ(5.5)çš„ laravelï¼Œä½†å› ç‚ºæœ¬æ–‡ä¸»è¦æ¢è¨ IoC åœ¨ç‰¹å®š method çš„ä¾è³´è§£æï¼Œæ ¸å¿ƒæ¦‚å¿µæ˜¯ä¸è®Šçš„ï¼Œä½†å¯èƒ½ä¸åŒç‰ˆæœ¬åœ¨éƒ¨åˆ†ç¨‹å¼ç¢¼ä¸Šé¢æœƒæœ‰äº›è¨±å·®ç•°

</aside>

<p>ç†Ÿæ‚‰ Laravel çš„äººæ‡‰è©²éƒ½æ›‰å¾— IoC Container çš„å¼·å¤§ä¹‹è™•ï¼Œåœ¨ laravel ç•¶ä¸­ï¼Œå¯ä»¥ç°¡å–®åœ°é€éä¸€è¡Œ</p>
<p><code>app(MyClass::class)</code> å–å¾—å·²ç¶“è¢«æ³¨å…¥ä¾è³´å¾Œ Class çš„å¯¦ä¾‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dependence1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"foo"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dependence2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"foo2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $dep1;</span><br><span class="line">    <span class="keyword">private</span> $dep2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Dependence1 $dependence1,</span></span></span><br><span class="line"><span class="function"><span class="params">        Dependence2 $dependence2</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dep1 = $dependence1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dep2 = $dependence2;       </span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app(MyClass::class); <span class="comment">// maybe $this-&gt;app-&gt;make(MyClass::class) in ServiceProvider</span></span><br></pre></td></tr></table></figure>

<p>é€™æ˜¯ä¸€å€‹ laravel å¯¦ç¾æ§åˆ¶åè½‰(IoC)çš„ç°¡å–®ä¾‹å­ ï¼ŒMyClass çš„å»ºæ§‹å­ç•¶ä¸­çš„å…©å€‹å¼•æ•¸(ä¾è³´çš„Class) è¢« container è®€å–åˆ°å¾Œï¼Œå…ˆåˆ†åˆ¥è¢«å¯¦ä¾‹åŒ–ä¸¦ä½œç‚ºåƒæ•¸å‚³é€² MyClass çš„å»ºæ§‹å­ï¼Œæœ€å¾Œè¿”å›å¯¦ä¾‹åŒ–å®Œæˆçš„ MyClass ç‰©ä»¶ã€‚(æ¯æ¬¡æ‹œè®€åˆ°é€™é‚ŠçœŸçš„æ˜¯æƒ³è·ª laravel ä½œè€…ï¼‰</p>
<p>laravel ç•¶ä¸­è¨±å¤šåŸºç¤æ ¸å¿ƒçš„ Class åœ¨åº•å±¤ä¹Ÿæ˜¯é€™éº¼é‹ä½œçš„ï¼Œä¾‹å¦‚ Controller ä¹Ÿæ˜¯ç¶“ç”± IoC Container å¯¦ä¾‹åŒ–ï¼Œæ‰€ä»¥æˆ‘å€‘æ‰èƒ½å¤ åœ¨ Controller å»ºæ§‹å­è£¡é¢å¯«ä¸€å †ä¾è³´ç‰©ä»¶ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"> <span class="keyword">protected</span> $logger;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Logger $logger)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"> <span class="keyword">$this</span>-&gt;logger = $logger;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;error(<span class="string">'Something happened'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œï¼Œlaravel ä¸åªæœƒè‡ªå‹•è§£æåœ¨å»ºæ§‹å­å¼•æ•¸ç•¶ä¸­çš„ Dependenciesï¼Œåœ¨æŸäº›ç‰¹å®š Class ç•¶ä¸­ï¼Œlaravel ä¹Ÿæœƒè‡ªå‹•è§£æ method å¼•æ•¸ä¸­çš„ä¾è³´ï¼Œæœ€å¸¸è¦‹çš„çš„å°±æ˜¯æˆ‘å€‘çš„ Controller</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(Logger $logger, $id)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    $logger-&gt;error(<span class="string">'Something happened'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°åº•å…¶èƒŒå¾Œæ˜¯æ€éº¼å¯¦ç¾é€™å€‹åŠŸèƒ½çš„å‘¢ï¼Ÿä»¥ä¸‹å°±é–‹å§‹ trace code ä¾†çœ‹çœ‹å§ã€‚</p>
<p>é¦–å…ˆï¼Œä¸€å€‹ Request çš„æ—…ç¨‹å°±æ˜¯å¾ <code>Illuminate\Contracts\Http\Kernel</code> é–‹å§‹ï¼Œ åœ¨ index.php ç•¶ä¸­ï¼Œå¯¦ä¾‹åŒ– Kernel Class ä¹‹å¾Œï¼Œ å‘¼å«äº† handle é€™å€‹ methodï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// public/index.php</span></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨ bootstrap/app.php ç•¶ä¸­æ‰¾åˆ°è©²æŠ½è±¡å°æ‡‰çš„ç¶å®šï¼Œä¹Ÿå°±æ˜¯ <code>App\Http\Kernel</code> ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bootstrap/app.php </span></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>æ¥è‘—ï¼Œ <code>App\Http\Kernel</code> åˆ extend äº† <code>Illuminate\Foundation\Http\Kernel</code> ï¼Œhandle æ–¹æ³•å°±åœ¨é€™å€‹ Class ç•¶ä¸­å®šç¾©ï¼Œé‡é»æ˜¯ sendRequestThroughRouter é€™å€‹ methodï¼Œæº–å‚™è¦å°‡ Request åˆ†é…çµ¦ Router (ä¸Šé¢éƒ½é‚„åœ¨ application å±¤ï¼Œå¾é€™é‚Šé–‹å§‹é€²åˆ° framework è£¡é¢)ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">            $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">                    -&gt;send($request)</span><br><span class="line">                    -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">                    -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter()); <span class="comment">// å°‡ Request åˆ†é…çµ¦ Router</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹ä¾†è¦é€²å…¥åˆ° Router çš„éšæ®µï¼Œæœ‰äº›ä¸æ˜¯å¾ˆç›¸é—œçš„éƒ¨åˆ†å°±ç›´æ¥è·³éä¸è²¼ç¨‹å¼ç¢¼äº†ï¼Œé€²åˆ° Router å¾Œçš„ method å‘¼å«é †åºæ˜¯ dispatch  â†’ dispatchToRoute â†’ runRoute -&gt; runRouteWithinStack</p>
<p>ä¾†çœ‹ä¸€ä¸‹ åœ¨ runRouteWithinStack ç•¶ä¸­å€’æ•¸ç¬¬ä¸‰è¡Œ <code>$route-&gt;run()</code> ï¼Œé€™è£¡å³å°‡è¦æº–å‚™è§£æåœ¨ routes/xxx.php ç•¶ä¸­æ‰€å®šç¾©çš„ Route æ‰€æŒ‡å®šçš„å°æ‡‰ Controller ä»¥åŠ Controller method</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Router.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</span><br><span class="line">                        -&gt;send($request)</span><br><span class="line">                        -&gt;through($middleware)</span><br><span class="line">                        -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</span><br><span class="line">                                $request, $route-&gt;run()</span><br><span class="line">                            );</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é€™é‚Šé€²å…¥äº† Routeï¼Œä¸»è¦åœ¨æº–å‚™åŸ·è¡Œ Route æŒ‡å®šå°æ‡‰çš„ Controller ä»¥åŠ Controller methodï¼Œé€²åˆ° <code>$this-&gt;runController()</code> çš„éƒ¨åˆ†</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Route.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = <span class="keyword">$this</span>-&gt;container ?: <span class="keyword">new</span> Container;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runController(); <span class="comment">// !!!</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runCallable();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> $e-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é€™è£¡æœƒå‘¼å«åˆ° ControllerDispatcher çš„ dispatch æ–¹æ³•æ¥æ‰‹è™•ç†</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Route.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runController</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controllerDispatcher()-&gt;dispatch(</span><br><span class="line">            <span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getController(), <span class="keyword">$this</span>-&gt;getControllerMethod()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æŒ–äº†é€™éº¼æ·±ï¼Œçµ‚æ–¼è¦åˆ°é‡é ­æˆ²äº†ï¼Œä¹Ÿå°±æ˜¯å‘¼å«äº† <code>$this-&gt;resolveClassMethodDependencies</code> é€™å€‹ methodï¼Œä¸¦å°‡è·¯ç”±ä¸Šé¢æ‰€å¸¶çš„åƒæ•¸ã€å·²å¯¦ä¾‹åŒ–å¾Œçš„ Controller ä»¥åŠ method åç¨±åšç‚ºåƒæ•¸å‚³å…¥</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Route $route, $controller, $method)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parameters = <span class="keyword">$this</span>-&gt;resolveClassMethodDependencies(</span><br><span class="line">            $route-&gt;parametersWithoutNulls(), $controller, $method</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> $controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>resolveClassMethodDependencies  å‘¼å«äº† resolveMethodDependenciesï¼Œä¸¦å°‡å‰›å‰›çš„è·¯ç”±åƒæ•¸ä»¥åŠä¸€å€‹æ–°çš„ ReflectionMethod å¯¦ä¾‹åšç‚ºåƒæ•¸å‚³å…¥ï¼ŒåŸä¾†å¯¦ç¾ Method Dependency injection çš„é‡è¦åŠŸè‡£å°±æ˜¯ ReflectionMethod é€™å€‹æ±è¥¿ï¼Œè—‰ç”± ReflectionMethodï¼Œæˆ‘å€‘å¯ä»¥ç²å¾—æŸå€‹ instance è£¡é¢é—œæ–¼æŸå€‹ method çš„è³‡è¨Šï¼ŒåŒ…æ‹¬<strong>å¯ä»¥çŸ¥é“ä»–æœ‰å“ªäº›å¼•æ•¸</strong>ï¼Œè€Œé€™ä¹Ÿå°±æ˜¯å¦‚ä½•å¾—ä»¥åµæ¸¬åˆ°é€™äº› method éœ€è¦çš„ä¾è³´ï¼Œä¸¦ä¸”é å…ˆè§£æå¥½ç‰©ä»¶ç•¶çœŸæ­£è¦å‘¼å«é€™å€‹ method æ™‚å†å°‡å·²è§£æå¥½çš„ç‰©ä»¶å¸¶å…¥çš„é—œéµ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClassMethodDependencies</span><span class="params">(array $parameters, $instance, $method)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! method_exists($instance, $method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $parameters;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolveMethodDependencies(</span><br><span class="line">            $parameters, <span class="keyword">new</span> ReflectionMethod($instance, $method)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘å€‘ä¾†çœ‹çœ‹ resolveMethodDependencies è£¡é¢åšäº†ä»€éº¼</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMethodDependencies</span><span class="params">(array $parameters, ReflectionFunctionAbstract $reflector)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instanceCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $values = array_values($parameters);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($reflector-&gt;getParameters() <span class="keyword">as</span> $key =&gt; $parameter) &#123;</span><br><span class="line">            $instance = <span class="keyword">$this</span>-&gt;transformDependency(</span><br><span class="line">                $parameter, $parameters</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (! is_null($instance)) &#123;</span><br><span class="line">                $instanceCount++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $instance);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (! <span class="keyword">isset</span>($values[$key - $instanceCount]) &amp;&amp;</span><br><span class="line">                      $parameter-&gt;isDefaultValueAvailable()) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $parameter-&gt;getDefaultValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $parameters;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå‚³å…¥çš„ parameters ç•¶ä¸­å¯èƒ½åŒ…å« primitive å€¼ï¼Œå› ç‚ºåœ¨ Route ç•¶ä¸­å¯èƒ½æœƒé€™æ¨£å®šç¾©ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in routes</span></span><br><span class="line">Route::get(<span class="string">'countries.&#123;country&#125;'</span>, <span class="string">'CountryController@show'</span>)-&gt;name(<span class="string">'countries.show'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// in Controllers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($country, Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‹¥ endpoint ç‚º <code>/api/countries/1</code> ï¼Œæˆ‘å€‘å°‡ <code>$parameters</code> ã€ <code>$reflector-&gt;getParameters()</code> dd å‡ºä¾†çœ‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $parameters</span></span><br><span class="line"><span class="keyword">array</span>:<span class="number">1</span> [</span><br><span class="line">  <span class="string">"country"</span> =&gt; <span class="string">"1"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// $reflector-&gt;getParameters()</span></span><br><span class="line"><span class="keyword">array</span>:<span class="number">2</span> [</span><br><span class="line">  <span class="number">0</span> =&gt; ReflectionParameter &#123;<span class="comment">#1228</span></span><br><span class="line">    +name: <span class="string">"country"</span></span><br><span class="line">    position: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">1</span> =&gt; ReflectionParameter &#123;<span class="comment">#1229</span></span><br><span class="line">    +name: <span class="string">"request"</span></span><br><span class="line">    position: <span class="number">1</span></span><br><span class="line">    typeHint: <span class="string">"Illuminate\Http\Request"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¦‚æœå¼•æ•¸æ˜¯æœ‰ typeHint ä¸¦å¯ä»¥è¢«å¯¦ä¾‹åŒ–ï¼Œå°±å°‡å®Œæˆè§£æçš„å¯¦ä¾‹æŒ‰ç…§æ­£ç¢ºä½ç½®å¡å…¥åŸå§‹çš„ $parameters ç•¶ä¸­ï¼Œæœ€å¾Œå›å‚³è©² $parameters é™£åˆ—çµ¦vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher@dispatch</p>
<p>å°‡é€™äº›è§£æå®Œç•¢çš„ä¾è³´åƒæ•¸å‚³å…¥ç›¸å°æ‡‰çš„ Controller method åŸ·è¡Œ</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œç•¶ç„¶å°±æ˜¯ call stack ä¸€å€‹ä¸€å€‹è¿”å›ï¼Œé€™é‚Šå°±ä¸è´…è¿°äº†ï¼Œä½†è‡³æ­¤å·²ç¶“å°‡ laravel å¯¦ç¾ Controller  method è‡ªå‹•æ³¨å…¥ä¾è³´çš„æ ¸å¿ƒéƒ¨åˆ†çˆ¬å®Œäº†ï¼Œæ”¶å·¥ï¼</p>
<h2 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h2><ul>
<li>Laravel: Up &amp; Running (Book)</li>
<li><a href="https://www.php.net/manual/en/class.reflectionmethod.php" target="_blank" rel="noopener">https://www.php.net/manual/en/class.reflectionmethod.php</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/30/Promise-allèˆ‡async-awaitï¼ˆå’Œaxiosï¼‰/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2015 - 2022 <a href="https://linxinemily.github.io">Emmie</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>