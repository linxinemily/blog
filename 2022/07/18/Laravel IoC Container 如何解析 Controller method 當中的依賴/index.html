<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Laravel IoC Container 如何解析 Controller method 當中的依賴(DI) · Emmie's Blog</title><meta name="description" content="Laravel IoC Container 如何解析 Controller method 當中的依賴(DI) - Emmie"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://linxinemily.github.io/atom.xml" title="Emmie's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/linxinemily" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/categories/" target="_self" class="nav-list-link">CATEGORIES</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Laravel IoC Container 如何解析 Controller method 當中的依賴(DI)</h1><a class="article-category-link" href="/categories/Laravel/">Laravel</a><div class="post-info">Jul 18, 2022</div><div class="post-content"><blockquote>
<p>由於以下所分析的原始碼是舊版(5.5)的 laravel，但因為本文主要探討 IoC 在特定 method 的依賴解析，核心概念是不變的，但可能不同版本在部分程式碼上面會有些許差異。</p>
</blockquote>
<p>熟悉 Laravel 的人應該都曉得 IoC Container 的強大之處，在 laravel 當中，可以簡單地透過一行 <code>app(MyClass::class)</code> 取得已經被注入依賴後 Class 的實例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dependence1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"foo"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dependence2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"foo2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $dep1;</span><br><span class="line">    <span class="keyword">private</span> $dep2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Dependence1 $dependence1,</span></span></span><br><span class="line"><span class="function"><span class="params">        Dependence2 $dependence2</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dep1 = $dependence1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dep2 = $dependence2;       </span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app(MyClass::class); <span class="comment">// maybe $this-&gt;app-&gt;make(MyClass::class) in ServiceProvider</span></span><br></pre></td></tr></table></figure>

<p>這是一個 laravel 實現控制反轉(IoC)的簡單例子 ，MyClass 的建構子當中的兩個引數(依賴的Class) 被 container 讀取到後，先分別被實例化並作為參數傳進 MyClass 的建構子，最後返回實例化完成的 MyClass 物件。(每次拜讀到這邊真的是想跪 laravel 作者）</p>
<blockquote>
<p>IoC 的核心理念就是將原本在下層（具體）的程式碼中「注入依賴」這個行為，提升至上層（抽象）去控制決定要給該 Class 注入什麼依賴，也就是說下層的 Class 需要依賴時，都會向上層去要他所需要的依賴實例（特定 Class 或是 implement 特定 Interface 的實例）。</p>
</blockquote>
<p>laravel 當中許多基礎核心的 Class 在底層也是這麼運作的，例如 Controller 也是經由 IoC Container 實例化，所以我們才能夠在 Controller 建構子的引數寫一堆依賴然後開心地使用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"> <span class="keyword">protected</span> $logger;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Logger $logger)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line"> <span class="keyword">$this</span>-&gt;logger = $logger;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;error(<span class="string">'Something happened'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而，laravel 不只會自動解析在建構子引數當中的 Dependencies，在某些特定 Class 當中，laravel 也會自動解析 method 引數中的依賴，最常見的的就是我們的 Controller：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(Logger $logger, $id)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    $logger-&gt;error(<span class="string">'Something happened'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到底其背後是怎麼實現這個功能的呢？以下就開始 trace code 來看看吧。</p>
<p>首先，一個 Request 的旅程就是從 <code>Illuminate\Contracts\Http\Kernel</code> 開始， 在 index.php 當中，實例化 Kernel Class 之後， 呼叫了 handle 這個 method：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// public/index.php</span></span><br><span class="line"></span><br><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>可以在 bootstrap/app.php 當中找到該抽象對應的綁定，也就是 <code>App\Http\Kernel</code> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bootstrap/app.php </span></span><br><span class="line"></span><br><span class="line">$app-&gt;singleton(</span><br><span class="line">    Illuminate\Contracts\Http\Kernel::class,</span><br><span class="line">    App\Http\Kernel::class</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>接著， <code>App\Http\Kernel</code> 又 extend 了 <code>Illuminate\Foundation\Http\Kernel</code> ，handle 方法就在這個 Class 當中定義，重點是 sendRequestThroughRouter 這個 method，準備要將 Request 分配給 Router (上面都還在 application 層，從這邊開始進到 framework 裡面)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">            $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">                    -&gt;send($request)</span><br><span class="line">                    -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">                    -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter()); <span class="comment">// 將 Request 分配給 Router</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>接下來要進入到 Router 的階段，有些不是很相關的部分就直接跳過不貼程式碼了，進到 Router 後的 method 呼叫順序是 dispatch  → dispatchToRoute → runRoute -&gt; runRouteWithinStack</p>
<p>來看一下 在 runRouteWithinStack 當中倒數第三行 <code>$route-&gt;run()</code> ，這裡即將要準備解析在 routes/xxx.php 當中所定義的 Route 所指定的對應 Controller 以及 Controller method：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Router.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</span><br><span class="line">                        -&gt;send($request)</span><br><span class="line">                        -&gt;through($middleware)</span><br><span class="line">                        -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</span><br><span class="line">                                $request, $route-&gt;run()</span><br><span class="line">                            );</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>這邊進入了 Route，主要在準備執行 Route 指定對應的 Controller 以及 Controller method，進到 <code>$this-&gt;runController()</code> 的部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Route.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = <span class="keyword">$this</span>-&gt;container ?: <span class="keyword">new</span> Container;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runController(); <span class="comment">// !!!</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runCallable();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (HttpResponseException $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> $e-&gt;getResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>這裡會呼叫到 ControllerDispatcher 的 dispatch 方法接手處理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/Route.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runController</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;controllerDispatcher()-&gt;dispatch(</span><br><span class="line">            <span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getController(), <span class="keyword">$this</span>-&gt;getControllerMethod()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>挖了這麼深，終於要到重頭戲了，也就是呼叫了 <code>$this-&gt;resolveClassMethodDependencies</code> 這個 method，並將路由上面所帶的參數、已實例化後的 Controller 以及 method 名稱做為參數傳入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Route $route, $controller, $method)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parameters = <span class="keyword">$this</span>-&gt;resolveClassMethodDependencies(</span><br><span class="line">            $route-&gt;parametersWithoutNulls(), $controller, $method</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> $controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>resolveClassMethodDependencies  呼叫了 resolveMethodDependencies，並將剛剛的路由參數以及一個新的 ReflectionMethod 實例做為參數傳入，原來實現 Method Dependency injection 的重要功臣就是 ReflectionMethod 這個東西，藉由 ReflectionMethod，我們可以獲得某個 instance 裡面關於某個 method 的資訊，包括<strong>可以知道他有哪些引數</strong>，而這也就是如何得以偵測到這些 method 需要的依賴，並且預先解析好物件當真正要呼叫這個 method 時再將已解析好的物件帶入的關鍵。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveClassMethodDependencies</span><span class="params">(array $parameters, $instance, $method)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! method_exists($instance, $method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $parameters;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;resolveMethodDependencies(</span><br><span class="line">            $parameters, <span class="keyword">new</span> ReflectionMethod($instance, $method)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我們來看看 resolveMethodDependencies 裡面做了什麼：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vendor/laravel/framework/src/Illuminate/Routing/RouteDependencyResolverTrait.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMethodDependencies</span><span class="params">(array $parameters, ReflectionFunctionAbstract $reflector)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $instanceCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        $values = array_values($parameters);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($reflector-&gt;getParameters() <span class="keyword">as</span> $key =&gt; $parameter) &#123;</span><br><span class="line">            $instance = <span class="keyword">$this</span>-&gt;transformDependency(</span><br><span class="line">                $parameter, $parameters</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (! is_null($instance)) &#123;</span><br><span class="line">                $instanceCount++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $instance);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (! <span class="keyword">isset</span>($values[$key - $instanceCount]) &amp;&amp;</span><br><span class="line">                      $parameter-&gt;isDefaultValueAvailable()) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">$this</span>-&gt;spliceIntoParameters($parameters, $key, $parameter-&gt;getDefaultValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $parameters;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>這邊另外注意，傳入的 parameters 當中可能包含 primitive 值，因為在 Route 當中可能會這樣定義：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in routes</span></span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'countries.&#123;country&#125;'</span>, <span class="string">'CountryController@show'</span>)-&gt;name(<span class="string">'countries.show'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// in Controllers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($country, Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若 endpoint 為 <code>/api/countries/1</code> ，我們將 <code>$parameters</code> 、 <code>$reflector-&gt;getParameters()</code> dd 出來看：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $parameters</span></span><br><span class="line"><span class="keyword">array</span>:<span class="number">1</span> [</span><br><span class="line">  <span class="string">"country"</span> =&gt; <span class="string">"1"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// $reflector-&gt;getParameters()</span></span><br><span class="line"><span class="keyword">array</span>:<span class="number">2</span> [</span><br><span class="line">  <span class="number">0</span> =&gt; ReflectionParameter &#123;<span class="comment">#1228</span></span><br><span class="line">    +name: <span class="string">"country"</span></span><br><span class="line">    position: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">1</span> =&gt; ReflectionParameter &#123;<span class="comment">#1229</span></span><br><span class="line">    +name: <span class="string">"request"</span></span><br><span class="line">    position: <span class="number">1</span></span><br><span class="line">    typeHint: <span class="string">"Illuminate\Http\Request"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>所以在遍歷每個從 ReflectionMethod 得到的 method 引數時 (<code>$reflector-&gt;getParameters()</code>)，首先會嘗試根據 TypeHint 將其實例化（如果該引數有 typeHint ），若能成功解析出實例，再按照正確位置塞入 $parameters 當中，最後回傳該 $parameters 陣列給vendor/laravel/framework/src/Illuminate/Routing/ControllerDispatcher@dispatch</p>
<p>將這些解析完畢的依賴參數傳入相對應的 Controller method 執行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br></pre></td></tr></table></figure>

<p>至此已經大致將 laravel 實現 Controller  method 自動注入依賴的核心部分都看完了，理解了核心概念再來看這些實作的程式碼後，感覺一切不再那麼 magic 了～</p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li>Laravel: Up &amp; Running (Book) CHAPTER 11. The The Container</li>
<li><a href="https://www.php.net/manual/en/class.reflectionmethod.php" target="_blank" rel="noopener">https://www.php.net/manual/en/class.reflectionmethod.php</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/30/Promise-all與async-await（和axios）/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://linxinemily.github.io">Emmie</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>