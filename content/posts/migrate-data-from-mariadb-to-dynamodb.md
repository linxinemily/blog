---
title: å°‡è³‡æ–™å¾ MariaDB é·ç§»è‡³ AWS DynamoDB éç¨‹ç´€éŒ„
date: 2023-02-08
tags:
- DynamoDB
---

## å‰æƒ…æè¦

å‰é™£å­å°‡å…¬å¸ä¸€å€‹ Laravel å°ˆæ¡ˆç•¶ä¸­é€šçŸ¥çš„åŠŸèƒ½éƒ¨åˆ†åˆ‡å‡ºåˆ°å¦ä¸€å€‹ç”¨ Golang æ§‹å»ºçš„æœå‹™ï¼Œä¸¦ä¸”æŠŠè³‡æ–™å¾ MariaDB é·ç§»åˆ° AWS DynamoDBã€‚æƒ³èªªç¨å¾®ç´€éŒ„ä¸€ä¸‹é€™å€‹éç¨‹ï¼Œç®—æ˜¯ä¸€å€‹æ”¶ç©«æ»¿å¤šçš„ç¶“é©—ã€‚

ç”±æ–¼åŸæœ¬å­˜åœ¨ MariaDB çš„é€šçŸ¥è³‡æ–™é‡æ—¥ç›Šè‚¥å¤§ï¼Œé›–ç„¶ç•¶å‰ä»ä¸ç®—æ˜¯å·¨é‡è³‡æ–™ï¼Œå¤§ç´„åƒè¬ç´šè³‡æ–™é‡è€Œå·²ï¼Œä½†æ˜¯å…‰æ˜¯é€™å€‹ç­‰ç´šçš„è³‡æ–™é‡ï¼Œåªè¦ä¸å°å¿ƒä¸‹ä¸€å€‹ç¯„åœæ€§çš„ select èªå¥éƒ½æœ‰å¯èƒ½æœƒé€ æˆæ•´å€‹ DB å¡æ­»ç„¶å¾Œæœå‹™æ›æ‰ï¼ˆçœŸå¯¦ç™¼ç”Ÿéåœ¨ production ç’°å¢ƒä¸Šçš„äº‹ä»¶â€¦ï¼‰ã€‚ç„¶è€Œé€šçŸ¥åœ¨æˆ‘å€‘çš„ç³»çµ±ç•¶ä¸­å…¶å¯¦åƒ…æ˜¯ä¸€å€‹è¼”åŠ©çš„åŠŸèƒ½ï¼Œä½†ä¸€æœ‰å•é¡Œå»å¯èƒ½ç›´æ¥å°è‡´æ•´å€‹æœå‹™åœæ“ºï¼Œæ€éº¼æƒ³éƒ½ä¸å¤ªåˆç†ã€‚å› æ­¤ï¼Œã€Œéš”é›¢ã€å°±æ˜¯æˆ‘å€‘é¦–è¦çš„ç›®çš„â€”â€”*é€šçŸ¥çš„è³‡æ–™ä¸è©²å’Œä¸»æœå‹™çš„è³‡æ–™æ“ºåœ¨åŒå€‹è³‡æ–™åº«è£¡* ã€‚


> ğŸ“ Note:
ç•¶è³‡æ–™é‡åˆ°é”ç™¾è¬ç´šä»¥ä¸Šå¾Œï¼Œcount(*) èªæ³•æ˜é¡¯é€Ÿåº¦è®Šå¾ˆæ…¢ï¼Œåƒé€™æ¨£çš„æŸ¥è©¢èªå¥ `select count(*) from UserNotification where id > 51306320 and id <= 57615005 order by id` åŸ·è¡Œèµ·ä¾†å°±è¦å…©ç§’å¤šã€‚


æ—¢ç„¶è¦æŠŠè³‡æ–™æ¬å‡ºå»ï¼Œè¦æ¬åˆ°å“ªè£¡å°±æ˜¯å°±æ˜¯ç¬¬äºŒå€‹å•é¡Œï¼Œè€Œæˆ‘å€‘å¾Œä¾†æœƒé¸ç”¨ AWS DynamoDB çš„åŸå› åŒ…æ‹¬ï¼š

- é¢å°ä¹˜è¼‰è³‡æ–™é‡çš„è®ŠåŒ–ï¼ŒDB å¯ä»¥è‡ªå‹•éš¨ä¹‹æ“´å±•å’Œç¸®æ¸›
- æŸ¥è©¢æœ‰æ—¢å®šçš„æ¨¡å¼å’Œè¦å‰‡ï¼Œä¸å¤ªæœƒæœ‰è®Šå‹•ï¼ˆå¦‚ï¼šå–å¾—é€šçŸ¥æœªè®€æ•¸é‡ã€å°‡é€šçŸ¥å·²è®€ etc.ï¼‰ï¼Œä¹Ÿä¸éœ€è¦è¤‡é›œçš„ join æˆ– sub queries ç­‰ç­‰
- ä¸éœ€è¦åš´æ ¼çš„çš„è³‡æ–™ä¸€è‡´æ€§ï¼Œåªè¦æœ‰æœ€çµ‚ä¸€è‡´å³å¯ï¼ˆDynamoDB Consistency Model çš„é è¨­å€¼ï¼Œä¹Ÿæ˜¯èƒ½ä¿æŒæœ€ä½³æ•ˆèƒ½çš„æ¨è–¦é¸é …ï¼‰
- åŸæœ¬å°±æœ‰åœ¨ä½¿ç”¨ AWS çš„æœå‹™ï¼Œä¹‹å¾Œè‹¥æœ‰éœ€è¦å’Œ AWS å…¶ä»–æœå‹™æ•´åˆæ™‚ä¹Ÿæ¯”è¼ƒæ–¹ä¾¿

è€Œä¹‹æ‰€ä»¥æœƒå¦å»ºä¸€å€‹æœå‹™ï¼Œä¸»è¦æ˜¯ç‚ºäº†å°‡éš”é›¢æ€§æé«˜åˆ°æ‡‰ç”¨å±¤çš„éƒ¨åˆ†ï¼Œä»¥ä¾¿ä¹‹å¾Œå°‡å…¶ä»–é€šçŸ¥ç›¸é—œçš„åŠŸèƒ½éƒ½åˆ‡å‡ºå»ï¼ˆex: æ¨æ’­ï¼‰ï¼Œé¸æ“‡  Golang å‰‡æ˜¯å› ç‚ºå…¶ç°¡å–®å¿«é€Ÿçš„ç‰¹æ€§ï¼Œä¹Ÿå¾ˆé©åˆæ‹¿ä¾†æ­å»ºå¾®æœå‹™ï¼ˆ~~é‚„æœ‰ä¸€éƒ¨åˆ†ç§å¿ƒæ˜¯æƒ³å¯¦éš›å°‡ Golang é‹ç”¨åœ¨å…¬å¸å°ˆæ¡ˆä¸Š~~ï¼‰ã€‚
æ­¤å¤–ï¼Œä½¿ç”¨ Golang é‚„æœ‰ä¸€å€‹å¥½è™•å°±æ˜¯èƒ½å¤ ä½¿ç”¨è¿¸ç™¼ç¨‹å¼å° DynamoDB é€²è¡Œæ“ä½œã€‚DynamoDB æœ¬èº«å°±æœ‰èƒ½åŠ›æ¶ˆåŒ–åŒæ™‚æ•¸åƒå€‹ä»¥ä¸Šå¯«å…¥/è®€å–çš„è«‹æ±‚ï¼ˆæ¯ç§’çš„è«‹æ±‚ååé‡ä¸Šé™å–æ±ºæ–¼æ‰€é¸æ“‡çš„è¨ˆåƒ¹æ–¹å¼/ Read/write capacity modeï¼‰ï¼Œéå¸¸é©åˆæ­é…æ”¯æ´ concurrency çš„ç¨‹å¼èªè¨€ä½¿ç”¨ï¼Œåœ¨éœ€è¦çš„æ™‚å€™å¯ä»¥é€éè¿¸ç™¼ç¨‹å¼å¤§å¹…æé«˜è™•ç†å¤§é‡è³‡æ–™çš„æ•ˆç‡ã€‚

## Migrate ä¹‹å‰çš„æº–å‚™

åœ¨ migrate è³‡æ–™ä¹‹å‰ï¼Œæˆ‘å€‘æ‰€é€²è¡Œçš„æœå‹™æ›¿æ›æ˜¯é€™æ¨£çš„ï¼š

åŸæœ¬æ‰€æœ‰ notification ç›¸é—œ API éƒ½ä¸å‹•ï¼Œåˆ†åˆ¥æ–°å¢æ¯ä¸€éš» API å°æ‡‰çš„ API åŠ ä¸Š v2 å‰ç¶´ã€‚è€Œ v2 æ‰€åšçš„äº‹æƒ…éƒ½å’Œ v1 ç›¸åŒï¼Œåªæ˜¯åŸæœ¬æ“ä½œè³‡æ–™æ™‚æ˜¯å° MariaDB æ“ä½œï¼Œéƒ½æ”¹æˆå°å¤–éƒ¨é€šçŸ¥æœå‹™æ“ä½œã€‚

è€Œåœ¨æ–°å¢é€šçŸ¥è³‡æ–™çš„éƒ¨åˆ†ï¼Œç”±æ–¼é€šçŸ¥æ˜¯åœ¨ä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºæ™‚æ‰æœƒè¢«å»ºç«‹ï¼Œæ‰€ä»¥é€™å€‹éƒ¨åˆ†çš„æ”¹å‹•æ˜¯åœ¨æ¯å€‹æ“ä½œè¡Œç‚ºä¹‹å¾ŒåŸæœ¬æœƒè§¸ç™¼æ–°å¢é€šçŸ¥çš„åœ°æ–¹ï¼Œå…¨éƒ¨ä¹Ÿéƒ½åŠ ä¸Šè§¸ç™¼æ–°å¢ v2 çš„é€šçŸ¥ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œ**æ–°å¢é€šçŸ¥**èˆ‡**æ¨æ’­é€šçŸ¥**æ˜¯ç¨ç«‹é‹ä½œçš„ï¼š

- **ä½¿ç”¨è€…é€²è¡ŒæŸäº›ç‰¹å®šè¡Œç‚ºï¼Œè§¸ç™¼æ–°å¢é€šçŸ¥äº‹ä»¶ï¼š** ç•¶ä¸‹ç«‹å³æ–°å¢é€šçŸ¥è³‡æ–™ï¼ŒåŒæ™‚æ´¾ç™¼ä¸€å€‹æ¨æ’­é€šçŸ¥çš„ queue jobï¼ˆæ–°å¢è³‡æ–™çš„ id æœƒå‚³çµ¦  queue jobï¼‰
- **Queue worker æ¶ˆåŒ– job æ¨æ’­é€šçŸ¥ï¼š** é€éå‚³é€²ä¾†çš„ id æ‰¾åˆ°æ¬²æ¨æ’­çš„è³‡æ–™ï¼Œå†é€²è¡Œæ¨æ’­

åœ¨é€™å€‹ç‰ˆæœ¬ç•¶ä¸­ï¼Œæ–°èˆŠçš„ Notification API æœƒä¸¦å­˜ï¼ˆAPI ä¸»è¦å°±æ˜¯æä¾›è®€å–é€šçŸ¥åˆ—è¡¨ã€æ›´æ–°é€šçŸ¥å·²è®€ç‹€æ…‹ï¼‰ï¼Œä¸”åŒæ™‚å„²å­˜æ–°èˆŠç‰ˆé€šçŸ¥è³‡æ–™ï¼Œä½†åœ¨æ¨æ’­çš„ job ç•¶ä¸­æ˜¯åˆ°æ–° DB æ‰¾è³‡æ–™ã€‚

## Migrate æ™‚é‡åˆ°çš„å•é¡Œèˆ‡è§£æ³•

æˆ‘å€‘æ‰“ç®—è¦ migrate æœ€è¿‘ä¸‰å€‹æœˆçš„è³‡æ–™ï¼Œå…ˆå‰å·²ç¶“æœ‰æº–å‚™å¥½ä¸€éš»å°‡ MariaDB è³‡æ–™ migrate åˆ° DynamoDB çš„ç¨‹å¼ã€‚ç…§åŸæœ¬è¨ˆåŠƒåœ¨ä¸Šç‰ˆå‰è¦å…ˆè·‘ migrateï¼Œç¸½å…±æœ‰ 600 å¤šè¬ç­†è³‡æ–™ï¼Œä¼°è¨ˆè‡³å°‘è¦ä¸€å€‹å°æ™‚ä»¥ä¸Šæ‰è·‘å¾—å®Œï¼Œä½†èˆŠè³‡æ–™æœ‰å¯èƒ½æœƒåœ¨é€™æ®µæœŸé–“å…§è¢«æ›´æ–°ï¼ˆå·²è®€ç‹€æ…‹ï¼‰ï¼Œå°è‡´æ–°èˆŠè³‡æ–™ä¸åŒæ­¥çš„å•é¡Œï¼š

![migrate éç¨‹ä¸­ï¼ŒèˆŠè³‡æ–™å¯èƒ½æœƒè¢«æ›´æ–°ï¼Œæ–°è³‡æ–™å»æ²’æœ‰è¢«æ›´æ–°ï¼Œå°è‡´è³‡æ–™ä¸åŒæ­¥ã€‚](images/migrate-1.png)

migrate éç¨‹ä¸­ï¼ŒèˆŠè³‡æ–™å¯èƒ½æœƒè¢«æ›´æ–°ï¼Œæ–°è³‡æ–™å»æ²’æœ‰è¢«æ›´æ–°ï¼Œå°è‡´è³‡æ–™ä¸åŒæ­¥ã€‚

è§£æ±ºé€™å€‹å•é¡Œçš„æ–¹æ³•å…¶å¯¦é¡¯è€Œæ˜“è¦‹ï¼Œå°±æ˜¯ **åœ¨æ›´æ–°èˆŠ DB è³‡æ–™çš„åŒæ™‚ï¼Œä¹Ÿé€£åŒæ›´æ–°åœ¨æ–° DB çš„åŒä¸€ç­†è³‡æ–™ã€‚** åŒæ¨£åœ°ï¼Œç‚ºäº†ç›¸å®¹æ€§ï¼ˆå‰ç«¯ web/APP ä¹Ÿè¦æ›´æ›æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼Œä½† web æœƒå…ˆæ›´æ–°ã€APP å°šæœªæº–å‚™å¥½ï¼‰ï¼Œ**æ›´æ–°æ–° DB è³‡æ–™æ™‚ä¹Ÿè¦é€£åŒæ›´æ–°åœ¨èˆŠ DB çš„åŒä¸€ç­†è³‡æ–™**ï¼Œé€™æ¨£å°±ç®—å‰ç«¯æ›æˆæ‰“ v2 å¾Œ APP ä»åœ¨æ‰“ v1ï¼Œå…©é‚Šçš„è³‡æ–™ä¹Ÿéƒ½æœƒæ˜¯åŒæ­¥çš„ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œ migrate ä¹Ÿå°±ä¸éœ€è¦åœ¨ä¸Šç‰ˆå‰åšï¼Œè€Œæ˜¯åœ¨ä¸Šç‰ˆä¹‹å¾Œé‚„èƒ½å¤ å¾ˆæœ‰é¤˜è£•åœ°æ…¢æ…¢è·‘ã€‚

![Untitled](images/migrate-2.png)

æ–¼æ˜¯åŠ ä¸Šä¿®æ”¹ä¹ŸåŒæ­¥ä¹‹å¾Œï¼Œæ¥ä¸‹ä¾†çš„æµç¨‹å¤§æ¦‚æ˜¯é€™æ¨£ï¼š

1. å¾Œç«¯ä¸Šç‰ˆï¼ˆæ–°å¢ä¿®æ”¹çš†åŒæ­¥è³‡æ–™çš„ç‰ˆæœ¬ï¼‰
2. è·‘ migrate æŒ‡ä»¤
3. migrate å®Œæˆå¾Œï¼Œå‰ç«¯/APP å†ä¸Šç‰ˆ ï¼ˆæ”¹æˆæ‰“ v2 API çš„ç‰ˆæœ¬ï¼‰

å…¶å¯¦æ›´ç„¡ç¸«çš„æ–¹æ³•æ˜¯ç›´æ¥æŠŠ v1 API èƒŒå¾Œéƒ½æ”¹æˆä¸²æ¥æ–°æœå‹™ï¼Œä¸¦æä¾›ç›¸åŒçš„å›å‚³è³‡æ–™æ ¼å¼ï¼Œå¦‚æ­¤çš„è©±å‰ç«¯ä¹Ÿç„¡éœ€æ›¿æ›æ¥å£ã€‚ä½†ç”±æ–¼åœ¨ã€Œè®€å–åˆ—è¡¨ã€API çš„åˆ†é åƒæ•¸æœ‰åšæ”¹å‹•ï¼ˆåŸæœ¬ v1 æ˜¯ä½¿ç”¨é æ•¸å»å–ä¸åŒåˆ†é çš„è³‡æ–™ï¼Œä½†åœ¨ DynamoDB å–è³‡æ–™æ™‚ç„¡æ³•ç”¨æŒ‡å®šé æ•¸çš„æ–¹å¼ï¼Œ*ä¸æ”¯æŒåƒæ˜¯ SQL çš„ offset èªæ³•çš„ç”¨æ³•æˆ–å¯ä»¥é”åˆ°é¡ä¼¼æ•ˆæœçš„æ–¹æ³•*ï¼Œè€Œæ˜¯è¦æŒ‡å®šå¾å“ªç­†è³‡æ–™é–‹å§‹å¾€ä¸‹å–å¹¾ç­†çš„æ–¹å¼ï¼Œé¡ä¼¼ Cursor çš„æ¦‚å¿µï¼‰ï¼Œå‰ç«¯å¿…å®šå¾—é€²è¡Œç›¸å°æ‡‰çš„ä¿®æ”¹ï¼Œç„¡æ³•ç›´æ¥æŠ½æ›ã€‚

ä¸éé€éä»¥ä¸Šçš„åšæ³•ï¼Œå·²ç¶“èƒ½å¤ åœ¨ä¸è®“ä½¿ç”¨è€…è¦ºå¯Ÿçš„å‰æä¸‹ï¼Œå°‡è³‡æ–™åº«é€²è¡ŒæŠ½æ›ä¸¦å®Œæˆè³‡æ–™çš„æ¬ç§»ã€‚å¾ŒçºŒå°±åªéœ€è¦æŒçºŒè¿½è¹¤ Logï¼Œå¦‚æœ v1 API éƒ½æ²’æœ‰å†è¢«å‘¼å«çš„è©±ï¼Œå°±å¯ä»¥ç›´æ¥æŠŠ v1 éƒ½æ‹”æ‰ï¼Œä¹Ÿç„¡éœ€å†åŒæ­¥å°‡è³‡æ–™å¯«å…¥èˆŠ DBã€æ›´æ–°èˆŠ DB çš„è³‡æ–™ ã€‚